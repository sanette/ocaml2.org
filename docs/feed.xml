<?xml version="1.0" encoding="UTF-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><icon>http://ocaml.org/img/colour-icon-170x148.png</icon><generator uri="https://ocaml.org/" version="${version:syndic}">OCaml Syndic.Atom feed aggregator</generator><id>urn:md5:45801fb5e6ebc597ada4b4ae41d0b88d</id><title type="text">OCaml Planet</title><updated>2020-03-23T08:47:03-00:00</updated><entry><source><updated>2020-03-23T08:47:03-00:00</updated><logo>http://www.ocamlpro.com/wp-content/uploads/2018/02/apple-touch-icon-152x152-150x150.png</logo><link title="OCamlPro" type="text/html" href="http://www.ocamlpro.com" rel="related"/><link title="OCamlPro" type="application/rss+xml" href="http://www.ocamlpro.com/feed/" rel="self"/><generator>https://wordpress.org/?v=4.9.13</generator><id>http://www.ocamlpro.com</id><title type="text">OCamlPro</title><author><name>OCamlPro</name></author></source><link href="http://www.ocamlpro.com/2020/03/23/ocaml-new-best-fit-garbage-collector/" rel="alternate"/><link href="http://www.ocamlpro.com/2020/03/23/ocaml-new-best-fit-garbage-collector/#comments" rel="related"/><content xml:base="http://www.ocamlpro.com/feed/" type="html">&lt;p&gt;&lt;img class=&quot; wp-image-2613 alignleft&quot; src=&quot;http://www.ocamlpro.com/wp-content/uploads/2025/03/Ocaml-search-300x300.png&quot; alt=&quot;&quot; width=&quot;150&quot; height=&quot;150&quot; /&gt;The Garbage Collector probably is OCaml&amp;#8217;s greatest unsung hero. Its pragmatic approach allows us to allocate without much fear of efficiency loss. In a way, the fact that most OCaml hackers know little about it is a good sign: you want a runtime to gracefully do its job without having to mind it all the time.&lt;/p&gt;
&lt;p&gt;But as OCaml 4.10.0 has now hit the shelves, a very exciting feature is &lt;a href=&quot;https://ocaml.org/releases/4.10.0.html#Changes&quot;&gt;in the changelog&lt;/a&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;span style=&quot;font-size: 10pt;&quot;&gt;- #8809, #9292: Add a best-fit allocator for the major heap; still
experimental, it should be much better than current allocation
policies (first-fit and next-fit) for programs with large heaps,
reducing both GC cost and memory usage.
This new best-fit is not (yet) the default; set it explicitly with
OCAMLRUNPARAM=&quot;a=2&quot; (or Gc.set from the program). You may also want
to increase the `space_overhead` parameter of the GC (a percentage,
80 by default), for example OCAMLRUNPARAM=&quot;o=85&quot;, for optimal
speed.
(Damien Doligez, review by Stephen Dolan, Jacques-Henri Jourdan,
Xavier Leroy, Leo White)&lt;/span&gt;&lt;/pre&gt;
&lt;p&gt;At OCamlPro, some of the tools that we develop, such as the package manager &lt;a href=&quot;https://opam.ocaml.org/&quot;&gt;Opam&lt;/a&gt;, the &lt;a href=&quot;https://alt-ergo.ocamlpro.com/&quot;&gt;Alt-Ergo&lt;/a&gt; SMT solver or the Flambda optimizer, can be quite demanding in memory usage, so we were curious to better understand the properties of this new allocator.&lt;/p&gt;
&lt;h2&gt;Minor heap and Major heap: the GC in a nutshell&lt;/h2&gt;
&lt;p&gt;Not all values are allocated equal. Some will only be useful for the span of local calculations, some will last as long as the program lives. To handle those two kinds of values, the runtime uses a &lt;em&gt;Generational Garbage Collector&lt;/em&gt; with two spaces:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;The minor heap uses the &lt;a href=&quot;https://en.wikipedia.org/wiki/Tracing_garbage_collection#Copying_vs._mark-and-sweep_vs._mark-and-don.27t-sweep&quot;&gt;Stop-and-copy&lt;/a&gt; principle. It is fast but has to stop the computation to perform a full iteration.&lt;/li&gt;
&lt;li&gt;The major heap uses the &lt;a href=&quot;https://en.wikipedia.org/wiki/Tracing_garbage_collection#Na%C3%AFve_mark-and-sweep&quot;&gt;Mark-and-sweep&lt;/a&gt; principle. It has the perk of being incremental and behaves better for long-lived data.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Allocation in the minor heap is straightforward and efficient: values are stored sequentially, and when there is no space anymore, space is emptied, surviving values get allocated in the major heap while dead values are just forgotten for free. However, the major heap is a bit more tricky, since we will have random allocations and deallocations that will eventually produce a scattered memory. This is called &lt;a href=&quot;https://en.wikipedia.org/wiki/Fragmentation_(computing)&quot;&gt;fragmentation&lt;/a&gt;, and this means that you&amp;#8217;re using more memory than necessary. Thankfully, the GC has two strategies to counter that problem:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Compaction: a heavyweight reallocation of everything that will remove those holes in our heap. OCaml&amp;#8217;s compactor is cleverly written to work in constant space, and would be worth its own specific article!&lt;/li&gt;
&lt;li&gt;Free-list Allocation: allocating the newly coming data in the holes (the free-list) in memory, de-scattering it in the process.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Of course, asking the GC to be smarter about how it allocates data makes the GC slower. Coding a good GC is a subtle art: you need to have something smart enough to avoid fragmentation but simple enough to run as fast as possible.&lt;/p&gt;
&lt;h2&gt;Where and how to allocate: the 3 strategies&lt;/h2&gt;
&lt;p&gt;OCaml used to propose 2 free-list allocation strategies: &lt;em&gt;next-fit&lt;/em&gt;, the default, and &lt;em&gt;first-fit&lt;/em&gt;. Version 4.10 of OCaml introduces the new &lt;em&gt;best-fit&lt;/em&gt; strategy. Let&amp;#8217;s compare them:&lt;/p&gt;
&lt;h3&gt;Next-fit, the original and remaining champion&lt;/h3&gt;
&lt;p&gt;OCaml&amp;#8217;s original (and default) &amp;#8220;next-fit&amp;#8221; allocating strategy is pretty simple:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Keep a (circular) list of every hole in memory ordered by increasing addresses;&lt;/li&gt;
&lt;li&gt;Have a pointer on an element of that list;&lt;/li&gt;
&lt;li&gt;When an allocation is needed, if the currently pointed-at hole is big enough, allocate in it;&lt;/li&gt;
&lt;li&gt;Otherwise, try the next hole and so-on.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This strategy is extremely efficient, but a big hole might be fragmented with very small data while small holes stay unused. In some cases, the GC would trigger costly compactions that would have been avoidable.&lt;/p&gt;
&lt;h3&gt;First-fit, the unsuccessful contender&lt;/h3&gt;
&lt;p&gt;To counteract that problem, the &amp;#8220;first-fit&amp;#8221; strategy was implemented in 2008 (OCaml 3.11.0):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Same idea as next-fit, but with an extra allocation table.&lt;/li&gt;
&lt;li&gt;Put the pointer back at the beginning of the list for each allocation.&lt;/li&gt;
&lt;li&gt;Use the allocation table to skip some parts of the list.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Unfortunately, that strategy is slower than the previous one. This is an example of making the GC smarter ends up making it slower. It does, however, reduce fragmentation. It was still useful to have this strategy at hand for the case where compaction would be too costly (on a 100Gb heap, for instance). An application that requires low latency might want to disable compaction and use that strategy.&lt;/p&gt;
&lt;h3&gt;Best-fit: a new challenger enters!&lt;/h3&gt;
&lt;p&gt;This leads us to the brand new &amp;#8220;best-fit&amp;#8221; strategy. This strategy is actually composite and will have different behaviors depending on the size of the data you&amp;#8217;re trying to allocate.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;On small data (up to 32 words), &lt;a href=&quot;https://github.com/ocaml/ocaml/blob/trunk/runtime/freelist.c#L868&quot;&gt;segregated free lists&lt;/a&gt; will allow allocation in (mostly) constant time.&lt;/li&gt;
&lt;li&gt;On big data, a general best-fit allocator based on &lt;a href=&quot;https://en.wikipedia.org/wiki/Splay_tree&quot;&gt;splay trees&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;This allows for the best of the two worlds, as you can easily allocate your numerous small blocks in the small holes in your memory while you take a bit more time to select a good place for your big arrays.&lt;/p&gt;
&lt;p&gt;How will best-fit fare? Let&amp;#8217;s find out!&lt;/p&gt;
&lt;h2&gt;Try it!&lt;/h2&gt;
&lt;p&gt;First, let us remind you that this is still an experimental feature, which from the OCaml development team means &amp;#8220;We&amp;#8217;ve tested it thoroughly on different systems, but only for months and not on a scale as large as the whole OCaml ecosystem&amp;#8221;.&lt;/p&gt;
&lt;p&gt;That being said, we&amp;#8217;d advise you don&amp;#8217;t use it in production code yet.&lt;/p&gt;
&lt;h3&gt;Why you should try it&lt;/h3&gt;
&lt;p&gt;Making benchmarks of this new strategy could be beneficial for you and the language at large: the dev team is hoping for feedback, the more quality feedback &lt;strong&gt;you&lt;/strong&gt; give means the more the future GC will be tuned for your needs.&lt;/p&gt;
&lt;p&gt;In 2008, the first-fit strategy was released with the hope of improving memory usage by reducing fragmentation. However, the lack of feedback meant that the developers were not aware that it didn&amp;#8217;t meet the users&amp;#8217; needs. If more feedback had been given, it&amp;#8217;s possible that work on improving the strategy or on better strategies would have happened sooner.&lt;/p&gt;
&lt;h3&gt;Choosing the allocator strategy&lt;/h3&gt;
&lt;p&gt;Now, there are two ways to control the GC behavior: through the code or through environment variables.&lt;/p&gt;
&lt;h4&gt;First method: Adding instructions in your code&lt;/h4&gt;
&lt;p&gt;This method should be used by those of us who have code that already does some GC fine-tuning. As early as possible in your program, you want to execute the following lines:&lt;/p&gt;
&lt;pre&gt;let () =
Gc.(set
  { (get()) with
    allocation_policy = 2; (* Use the best-fit strategy *)
    space_overhead = 100; (* Let the major GC work a bit less since it's more efficient *)
  })&lt;/pre&gt;
&lt;p&gt;You might also want to add &lt;code&gt;verbose = 0x400;&lt;/code&gt; or &lt;code&gt;verbose = 0x404;&lt;/code&gt; in order to get some GC debug information. See &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/libref/Gc.html&quot;&gt;here&lt;/a&gt; for more details on how to use the &lt;code&gt;GC &lt;/code&gt;module.&lt;/p&gt;
&lt;p&gt;Of course, you&amp;#8217;ll need to recompile your code, and this will apply only after the runtime has initialized itself, triggering a compaction in the process. Also, since you might want to easily switch between different allocation policies and overhead specifications, we suggest you use the second method.&lt;/p&gt;
&lt;h4&gt;Second method: setting &lt;code&gt;$OCAMLRUNPARAM&lt;/code&gt;&lt;/h4&gt;
&lt;p&gt;At OCamlPro, we develop and maintain a program that any OCaml developer should want to run smoothly. It&amp;#8217;s called &lt;a href=&quot;https://opam.ocaml.org/&quot;&gt;Opam&lt;/a&gt;, maybe you&amp;#8217;ve heard of it? Though most commands take a few seconds, some &lt;a href=&quot;https://opam.ocaml.org/doc/man/opam-admin-check.html&quot;&gt;administrative-heavy&lt;/a&gt; commands can be a strain on our computer. In other words: those are perfect for a benchmark.&lt;/p&gt;
&lt;p&gt;Here&amp;#8217;s what we did to benchmark Opam:&lt;/p&gt;
&lt;pre&gt;$ opam update
$ opam switch create 4.10.0
$ opam install opam-devel # or build your own code
$ export OCAMLRUNPARAM='b=1,a=2,o=100,v=0x404'
$ cd my/local/opam-repository
$ perf stat ~/.opam/4.10.0/lib/opam-devel/opam admin check --installability # requires right to execute perf, time can do the trick
&lt;/pre&gt;
&lt;p&gt;If you want to compile and run your own benchmarks, here are a few details on &lt;code&gt;OCAMLRUNPARAM&lt;/code&gt;:&lt;code&gt;&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;b=1&lt;/code&gt; means &amp;#8220;print the backtrace in case of uncaught exception&amp;#8221;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;a=2&lt;/code&gt; means &amp;#8220;use best-fit&amp;#8221; (default is &lt;code&gt;0&lt;/code&gt;, first-fit is &lt;code&gt;1&lt;/code&gt;)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;o=100&lt;/code&gt; means &amp;#8220;do less work&amp;#8221; (default is &lt;code&gt;80&lt;/code&gt;, lower means more work)&lt;/li&gt;
&lt;li&gt;&lt;code&gt;v=0x404&lt;/code&gt; means &amp;#8220;have the gc be verbose&amp;#8221; (&lt;code&gt;0x400&lt;/code&gt; is &amp;#8220;print statistics at exit&amp;#8221;, 0x4 is &amp;#8220;print when changing heap size&amp;#8221;)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;See the &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/runtime.html#s%3Aocamlrun-options&quot;&gt;manual&lt;/a&gt; for more details on &lt;code&gt;OCAMLRUNPARAM&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;You might want to compare how your code fares on all three different GC strategies (and fiddle a bit with the overhead to find your best configuration).&lt;/p&gt;
&lt;h2&gt;Our results on opam&lt;/h2&gt;
&lt;p&gt;Our contribution in this article is to benchmark &lt;code&gt;opam&lt;/code&gt; with the different allocation strategies:&lt;/p&gt;
&lt;table style=&quot;height: 165px; width: 800px; border-style: solid; border-color: #000020;&quot; border=&quot;1&quot; cellspacing=&quot;0&quot;&gt;
&lt;thead&gt;
&lt;tr style=&quot;border-style: solid; border-color: #000000;&quot;&gt;
&lt;td style=&quot;width: 193.867px; background-color: #2392ba; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot;&gt;Strategy:&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;Next-fit&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;First-fit&lt;/td&gt;
&lt;td style=&quot;width: 357.667px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; colspan=&quot;3&quot; scope=&quot;colgroup&quot;&gt;Best-fit&lt;/td&gt;
&lt;/tr&gt;
&lt;tr style=&quot;border-style: solid; border-color: #000000;&quot;&gt;
&lt;td style=&quot;width: 193.867px; background-color: #2392ba; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot;&gt;Overhead:&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;80&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;80&lt;/td&gt;
&lt;td style=&quot;width: 117.05px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;80&lt;/td&gt;
&lt;td style=&quot;width: 117.05px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;100&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;120&lt;/td&gt;
&lt;/tr&gt;
&lt;tr style=&quot;border-style: solid; border-color: #000000;&quot;&gt;
&lt;td style=&quot;width: 193.867px; background-color: #2392ba; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot;&gt;Cycles used (Gcycle)&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;2,040&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;3,808&lt;/td&gt;
&lt;td style=&quot;width: 117.05px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;3,372&lt;/td&gt;
&lt;td style=&quot;width: 117.05px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;2,851&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;2,428&lt;/td&gt;
&lt;/tr&gt;
&lt;tr style=&quot;border-style: solid; border-color: #000000;&quot;&gt;
&lt;td style=&quot;width: 193.867px; background-color: #2392ba; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot;&gt;Maximum heap size (kb)&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;793,148&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;793,148&lt;/td&gt;
&lt;td style=&quot;width: 117.05px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;689,692&lt;/td&gt;
&lt;td style=&quot;width: 117.05px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;689,692&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;793,148&lt;/td&gt;
&lt;/tr&gt;
&lt;tr style=&quot;border-style: solid; border-color: #000000;&quot;&gt;
&lt;td style=&quot;width: 193.867px; background-color: #2392ba; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot;&gt;User time (s)&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;674&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;1,350&lt;/td&gt;
&lt;td style=&quot;width: 117.05px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;1,217&lt;/td&gt;
&lt;td style=&quot;width: 117.05px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;1,016&lt;/td&gt;
&lt;td style=&quot;width: 116.9px; height: 33px; border-style: solid; border-color: #000000; text-align: center;&quot; scope=&quot;colgroup&quot;&gt;791&lt;/td&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;/table&gt;
&lt;p&gt;A quick word on these results. Most of &lt;code&gt;opam&lt;/code&gt;&amp;#8216;s calculations are done by &lt;code&gt;&lt;a href=&quot;http://www.mancoosi.org/software/&quot;&gt;dose&lt;/a&gt;&lt;/code&gt; and rely heavily on small interconnected blocks. We don&amp;#8217;t really have big chunks of data we want to allocate, so the strategy won&amp;#8217;t give us the bonus you might have as it perfectly falls into the best-case scenario of the next-fit strategy. As a matter of fact, for every strategy, we didn&amp;#8217;t have a single GC compaction happen. However, Best-fit still allows for a lower memory footprint!&lt;/p&gt;
&lt;h2&gt;Conclusions&lt;/h2&gt;
&lt;p&gt;If your software is highly reliant on memory usage, you should definitely try the new Best-fit strategy and stay tuned on its future development. If your software requires good performance, knowing if your performances are better with Best-fit (and giving feedback on those) might help you in the long run.&lt;/p&gt;
&lt;p&gt;The different strategies are:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Next-fit: generally good and fast, but has very bad worst cases with big heaps.&lt;/li&gt;
&lt;li&gt;First fit: mainly useful for very big heaps that must avoid compaction as much as possible.&lt;/li&gt;
&lt;li&gt;Best-fit: almost the best of both worlds, with a small performance hit for programs that fit well with next-fit.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Remember that whatever works best for you, it&amp;#8217;s still better than having to &lt;code&gt;malloc&lt;/code&gt; and &lt;code&gt;free&lt;/code&gt; by hand. Happy allocating!&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;About OCamlPro&lt;/p&gt;
&lt;p&gt;OCamlPro is a R&amp;amp;D lab founded in 2011, with the mission to help industrial users harness the OCaml state-of-the art programming language.&lt;/p&gt;
&lt;p&gt;We design, create and implement custom ad-hoc software for our clients in state-of-the-art languages (OCaml, Rust&amp;#8230;). We also have a long experience in developing and maintaining open-source tooling for OCaml, such as Opam and ocp-indent, and we contribute to the core-development of OCaml, notably with our work on the Flambda optimizer branch. Another area of expertise is that of Formal Methods, with tools such as our SMT Solver Alt-Ergo (check our &lt;a href=&quot;https://alt-ergo.ocamlpro.com/#club&quot;&gt;Alt-Ergo Users&amp;#8217; Club&lt;/a&gt;). We also provide vocational trainings in OCaml and Rust, and we can build courses on formal methods on-demand. Do not hesitate reach out by email: &lt;a href=&quot;mailto:contact@ocamlpro.com&quot;&gt;contact@ocamlpro.com&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
</content><category term="OCaml"/><id>http://www.ocamlpro.com/?p=2551</id><title type="text">An in-depth Look at OCaml’s new “Best-fit” Garbage Collector Strategy</title><updated>2020-03-23T08:47:03-00:00</updated><author><name>OCamlPro</name></author></entry><entry><source><updated>2020-04-06T09:20:11-00:00</updated><link href="http://psellos.com/atom.xml" rel="self"/><link href="http://psellos.com/" rel="alternate"/><generator uri="http://search.cpan.org/dist/XML-Atom-SimpleFeed/" version="0.86">XML::Atom::SimpleFeed</generator><id>http://psellos.com/</id><title type="text">Psellos Blog</title><author><name>Psellos</name></author></source><link href="http://psellos.com/2020/03/2020.03.how-i-wrote-elastic-man.html" rel="alternate"/><content xml:base="http://psellos.com/atom.xml" type="html">&lt;!--#include virtual=&quot;${Base_URL}/templates/header.html&quot; --&gt;&lt;div class=&quot;date&quot;&gt;March 21, 2020&lt;/div&gt;

&lt;p&gt;I just finished coding up another webapp in OCaml. I thought it would be
cool to publish the sources of a small, completely self-contained app.
It&amp;#8217;s a sliding tile puzzle coded entirely in OCaml, using a few of the
BuckleScript extensions. There are no dependencies on any frameworks or
the like aside from the Js modules of BuckleScript. The app itself
consists of just one JavaScript file&amp;#8212;no images, nothing else.&lt;/p&gt;

&lt;table class=&quot;morelikealist&quot; style=&quot;margin-top: 0.4em;&quot;&gt;
&lt;tr&gt;&lt;td&gt;
&lt;a href=&quot;http://psellos.com/ocaml/example-app-slide24.html&quot;&gt;
&lt;img src=&quot;http://psellos.com/images/slide242-220.png&quot;&gt;&lt;/img&gt;&lt;br /&gt;
&lt;/a&gt;
&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;

&lt;p&gt;You can try out the puzzle or get the sources at the
&lt;a href=&quot;http://psellos.com/ocaml/example-app-slide24.html&quot;&gt;Slide24&lt;/a&gt; page.&lt;/p&gt;

&lt;p&gt;I also tried to make a clean DOM interface based on experience with the
Cassino and Schnapsen apps. I think it came out well, at least for these
self-contained webapps.&lt;/p&gt;

&lt;p&gt;The idea for the DOM interface is that it should expose only abstract
types, but that there should be a subtype relation based on the
JavaScript DOM. It turns out that you can do this pretty easily using
&lt;code&gt;private&lt;/code&gt; declarations. Types for contents of a document look like this:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;type node
type text = private node
type element = private node
type canvas = private element
type box = private element
type div = private box
type span = private box
type button = private box&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, the interface reveals nothing whatsoever about the types except that
they participate in a subtype relation. &lt;code&gt;text&lt;/code&gt; and &lt;code&gt;element&lt;/code&gt; are
subtypes of &lt;code&gt;node&lt;/code&gt;, &lt;code&gt;canvas&lt;/code&gt; is a subtype of &lt;code&gt;element&lt;/code&gt;, and so on.
&lt;code&gt;node&lt;/code&gt; is the supertype of all the document content types.&lt;/p&gt;

&lt;p&gt;What this means is that you can pass a canvas or a button to a function
that expects an element, and so on. I don&amp;#8217;t find the necessity to use
explicit supertype coercion to be too much trouble when working with
non-parameterized types.&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;let style = Pseldom.(element_style (mybutton :&amp;gt; element)) in
. . .&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It seems to me this captures pretty much everything that I want from the
object-oriented approach without the usual complicated baggage. I think
inheritance is more often a hindrance than a help. It&amp;#8217;s too dependent on
implementation details, and is associated with too many informal
(unenforceable) descriptions of how to write subclasses of each class
without messing up the semantics.&lt;/p&gt;

&lt;p&gt;I&amp;#8217;ve never used &lt;code&gt;private&lt;/code&gt; declarations before, but they seem to have
created exactly the structure I was hoping for.&lt;/p&gt;

&lt;p&gt;Posted by: &lt;a href=&quot;http://psellos.com/aboutus.html#jeffreya.scofieldphd&quot;&gt;Jeffrey&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;style type=&quot;text/css&quot;&gt;
.morelikealist {
       float: left;
       margin: 0em 1em 0em 0em;
}
&lt;/style&gt;&lt;/p&gt;
&lt;!--#include virtual=&quot;${Base_URL}/templates/footer.html&quot; --&gt;</content><id>http://psellos.com/2020/03/2020.03.how-i-wrote-elastic-man.html</id><title type="text">Sliding Tile Puzzle, Self-Contained OCaml Webapp</title><updated>2020-03-21T19:00:00-00:00</updated><author><name>Psellos</name></author></entry><entry><source><updated>2020-03-23T08:47:03-00:00</updated><logo>http://www.ocamlpro.com/wp-content/uploads/2018/02/apple-touch-icon-152x152-150x150.png</logo><link title="OCamlPro" type="text/html" href="http://www.ocamlpro.com" rel="related"/><link title="OCamlPro" type="application/rss+xml" href="http://www.ocamlpro.com/feed/" rel="self"/><generator>https://wordpress.org/?v=4.9.13</generator><id>http://www.ocamlpro.com</id><title type="text">OCamlPro</title><author><name>OCamlPro</name></author></source><link href="http://www.ocamlpro.com/2020/03/16/new-version-of-try-ocaml-in-beta/" rel="alternate"/><link href="http://www.ocamlpro.com/2020/03/16/new-version-of-try-ocaml-in-beta/#respond" rel="related"/><content xml:base="http://www.ocamlpro.com/feed/" type="html">&lt;p&gt;We are happy to announce that our venerable &amp;#8220;Try Ocaml&amp;#8221; service is being retired and replaced by a new, modern version based upon our work on &lt;a href=&quot;https://github.com/ocaml-sf/learn-ocaml&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;&gt;Learn-OCaml&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;→ &lt;a href=&quot;https://try.ocamlpro.com&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot;&gt;Try it here&lt;/a&gt; ←&lt;/p&gt;
&lt;p&gt;The new interface provides an editor panel besides the familiar top-level, error and warning positions highlighting, the latest OCaml release (4.10.0), local storage of your session, and more.&lt;/p&gt;
&lt;p&gt;The service is still in beta, so it would be helpful if you could tell us about any hiccups you may encounter &lt;a href=&quot;https://discuss.ocaml.org/t/ann-try-ocaml-2-0-beta&quot;&gt;on the Discuss thread&lt;/a&gt;.&lt;/p&gt;
</content><category term="TryOCaml"/><id>http://www.ocamlpro.com/?p=2543</id><title type="text">New version of Try OCaml in beta!</title><updated>2020-03-16T16:20:23-00:00</updated><author><name>OCamlPro</name></author></entry><entry><source><updated>2020-03-10T17:01:15-00:00</updated><link title="Frama-C RSS News" type="text/html" href="http://frama-c.com/" rel="related"/><link title="Frama-C RSS News" type="application/rss+xml" href="http://frama-c.com/rss.xml" rel="self"/><id>http://frama-c.com/</id><title type="text">Frama-C RSS News</title><author><name>Frama-C</name></author></source><link href="http://frama-c.com/index.html" rel="alternate"/><id>http://frama-c.com/index.html#ba31559a464fbb014138d431364b8cd8</id><title type="text">Frama-Clang 0.0.8 is out. Download it here.</title><updated>2020-03-10T17:01:15-00:00</updated><author><name>Frama-C</name></author></entry><entry><source><updated>2020-03-06T00:00:00-00:00</updated><link title="Drup's thingies" type="text/html" href="https://drup.github.io/" rel="related"/><link title="Drup's thingies" type="application/rss+xml" href="http://drup.github.io/feed-ocaml.xml" rel="self"/><id>https://drup.github.io/</id><title type="text">Drup's thingies</title><author><name>Gabriel Radanne</name></author></source><link href="https://drup.github.io/2020/03/06/tyxml440/" rel="alternate"/><content xml:base="http://drup.github.io/feed-ocaml.xml" type="html">
        
        
        
        &lt;p&gt;I have the pleasure to announce the release of &lt;a href=&quot;https://github.com/ocsigen/tyxml/releases/tag/4.4.0&quot;&gt;TyXML 4.4.0&lt;/a&gt;, with special Reason support!&lt;/p&gt;


        
        </content><id>https://drup.github.io/2020/03/06/tyxml440/</id><title type="text">A reasonable TyXML release | Drup's thingies</title><updated>2020-03-06T00:00:00-00:00</updated><author><name>Gabriel Radanne</name></author></entry><entry><source><updated>2020-03-23T08:47:03-00:00</updated><logo>http://www.ocamlpro.com/wp-content/uploads/2018/02/apple-touch-icon-152x152-150x150.png</logo><link title="OCamlPro" type="text/html" href="http://www.ocamlpro.com" rel="related"/><link title="OCamlPro" type="application/rss+xml" href="http://www.ocamlpro.com/feed/" rel="self"/><generator>https://wordpress.org/?v=4.9.13</generator><id>http://www.ocamlpro.com</id><title type="text">OCamlPro</title><author><name>OCamlPro</name></author></source><link href="http://www.ocamlpro.com/2020/03/03/alt-ergo-userss-club-annual-meeting/" rel="alternate"/><link href="http://www.ocamlpro.com/2020/03/03/alt-ergo-userss-club-annual-meeting/#respond" rel="related"/><content xml:base="http://www.ocamlpro.com/feed/" type="html">&lt;p class=&quot;moz-signature&quot;&gt;&lt;img class=&quot;size-full wp-image-2494 alignleft&quot; src=&quot;http://www.ocamlpro.com/wp-content/uploads/2020/02/altergo.png&quot; alt=&quot;&quot; width=&quot;107&quot; height=&quot;90&quot; /&gt;The second annual meeting of the Alt-Ergo Users&amp;#8217; Club was held in mid-February. Our annual meeting is the perfect place to review each partner&amp;#8217;s needs regarding Alt-Ergo. This year, we had the pleasure of receiving our partners to discuss the roadmap for future Alt-Ergo developments and enhancements.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Alt-Ergo is an automatic mathematical formula checker, jointly developed by &lt;a href=&quot;https://www.lri.fr/index_en.php?lang=EN&quot;&gt;LRI&lt;/a&gt; and OCamlPro (since 2014). For more information or to join the club, visit &lt;a class=&quot;c-link&quot; href=&quot;https://alt-ergo.ocamlpro.com/&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; aria-describedby=&quot;slack-kit-tooltip&quot;&gt;https://alt-ergo.ocamlpro.com&lt;/a&gt;.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p class=&quot;moz-signature&quot;&gt;Our club has several goals, the first of which is to ensure the sustainability of Alt-Ergo by fostering collaboration among club members and strengthening collaboration with formal method communities such as Why3. One of our priorities is to increase our user community by extending our tool to new sectors such as Model Checking. Participation in international competitions is also a way to gain visibility. Finally, the last objective of the club is to find new projects or contracts for the development of long-term functionalities.&lt;/p&gt;
&lt;p class=&quot;moz-signature&quot;&gt;We thank all our members for their support and bid a warm welcome Mitsubishi Electric R&amp;amp;D Centre Europe as they join AdaCore and the CEA list as a member of the club this year. We would also like to highlight the &lt;a href=&quot;http://why3.lri.fr/&quot;&gt;Why3&lt;/a&gt; development team with whom we are working to improve our tools.&lt;/p&gt;
&lt;p class=&quot;moz-signature&quot;&gt;Our members are particularly interested in:&lt;/p&gt;
&lt;ul&gt;
&lt;li class=&quot;moz-signature&quot;&gt;Better generation of models and counter-examples.&lt;/li&gt;
&lt;li class=&quot;moz-signature&quot;&gt;The addition of sequence theory.&lt;/li&gt;
&lt;li class=&quot;moz-signature&quot;&gt;The improvement of non-linear arithmetic support in Alt-Ergo.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These features are now top priorities for us. For more information, you can read our &lt;a href=&quot;http://www.ocamlpro.com/tag/alt-ergo-en/&quot;&gt;articles&lt;/a&gt; on this blog.&lt;/p&gt;
</content><category term="Alt-Ergo"/><id>http://www.ocamlpro.com/?p=2486</id><title type="text">Alt-Ergo Users’ Club Annual Meeting</title><updated>2020-03-03T14:22:35-00:00</updated><author><name>OCamlPro</name></author></entry><entry><source><updated>2020-04-06T09:20:11-00:00</updated><link href="http://psellos.com/atom.xml" rel="self"/><link href="http://psellos.com/" rel="alternate"/><generator uri="http://search.cpan.org/dist/XML-Atom-SimpleFeed/" version="0.86">XML::Atom::SimpleFeed</generator><id>http://psellos.com/</id><title type="text">Psellos Blog</title><author><name>Psellos</name></author></source><link href="http://psellos.com/2020/02/2020.02.kid-charlemagne.html" rel="alternate"/><content xml:base="http://psellos.com/atom.xml" type="html">&lt;!--#include virtual=&quot;${Base_URL}/templates/header.html&quot; --&gt;&lt;div class=&quot;date&quot;&gt;February 24, 2020&lt;/div&gt;

&lt;p&gt;Something like ten years ago we produced two iOS card game apps written
in OCaml, partly as a proof of concept for compiling OCaml to iOS and
partly because we enjoy card games. Unfortunately we weren&amp;#8217;t able to
spark a worldwide craze for writing iOS apps in OCaml or for playing
Schnapsen, as we had hoped. Consequently there was very little financial
return and we all had to move on to other projects.&lt;/p&gt;

&lt;p&gt;Both apps play a very good two-player card game. The apps are
essentially a kind of solitaire where you play against the app as your
opponent. The games are:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Cassino, a classic fishing game said without substantiation to be
of Italian origin (per Wikipedia).&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Schnapsen, a kind of miniature Pinochle very popular in the
territories of the former Austro-Hungarian Empire (again per
Wikipedia).&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The Schnapsen app also plays a closely related game called Sixty-Six,
named after this number in many different languages.&lt;/p&gt;

&lt;p&gt;The images and layout algorithms for the apps quickly fell behind the
formats and display capabilities of later iOS devices, so I was thinking
we might just as well release the apps as is, for free. However there is
a lot of rigamarole (and some cost) associated with the App Store if all
you want to do is release some free apps.&lt;/p&gt;

&lt;table class=&quot;morelikealist&quot; style=&quot;margin-top: 0.4em;&quot;&gt;
&lt;tr&gt;&lt;td&gt;
&lt;a href=&quot;http://cassino.psellos.com&quot;&gt;
&lt;img src=&quot;http://psellos.com/images/cassino-icon45.png&quot;&gt;&lt;/img&gt;&lt;br /&gt;
&lt;strong&gt;Cassino&lt;/strong&gt;
&lt;/a&gt;
&lt;/td&gt;&lt;/tr&gt;
&lt;tr&gt;&lt;td&gt;
&lt;a href=&quot;http://schnapsen.psellos.com&quot;&gt;
&lt;img src=&quot;http://psellos.com/images/schnapsen-icon45.png&quot;&gt;&lt;/img&gt;&lt;br /&gt;
&lt;strong&gt;Master&lt;br /&gt;Schnapsen/66&lt;/strong&gt;
&lt;/a&gt;
&lt;/td&gt;&lt;/tr&gt;
&lt;/table&gt;

&lt;p&gt;Recently I wondered if it wouldn&amp;#8217;t be possible to revive the apps in a
browser environment. These days you can compile OCaml to JavaScript
using &lt;a href=&quot;https://bucklescript.github.io/&quot;&gt;BuckleScript&lt;/a&gt; or
&lt;a href=&quot;https://ocsigen.org/js_of_ocaml/3.5.1/manual/overview&quot;&gt;Js_of_ocaml&lt;/a&gt;.
The HTML 5 canvas element has an interface a lot like the
two-dimensional graphics used by the apps. It seems like it should be
possible.&lt;/p&gt;

&lt;p&gt;So, in fact, that&amp;#8217;s what I did. I ported the two card game apps to run
as webapps. Visually they run in a smallish rectangle exactly the size
of the original iPhone screen. I was able to retain the iPhone behavior
almost unchanged. Computationally they run completely in the browser,
and make no further contact with psellos.com (unless you want to access
the game pages at psellos.com).&lt;/p&gt;

&lt;p&gt;The OCaml code is compiled to JavaScript using the BuckleScript
compiler. Because the target language is JavaScript, there&amp;#8217;s no need for
any stubs or supporting code (as there was in iOS). All of the code for
the apps is in OCaml.&lt;/p&gt;

&lt;p&gt;Once the basic graphics primitives were in place, a lot of the code
worked without any change. The part of the code that actually plays the
game (the &amp;#8220;engine&amp;#8221;) didn&amp;#8217;t change at all.&lt;/p&gt;

&lt;p&gt;As an unexpected and very welcome side effect, two of the old iOS app
team members got interested in the project again. They&amp;#8217;re working on
making the Schnapsen app into an even better player. I added some extra
features to the Schnapsen GUI to make it easier to keep track of what&amp;#8217;s
happened in a hand.&lt;/p&gt;

&lt;p&gt;Neither of the webapps is quite finished yet. But they both are already
playable and in fact quite enjoyable. You can try them by clicking on
the icons above. You can also read about the apps and the games they
play on their own separate pages.&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://psellos.com/cassino&quot;&gt;Cassino Page&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://psellos.com/schnapsen&quot;&gt;Schnapsen Page&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If you have any comments, suggestions, or encouragement, leave them
below or email me at &lt;a href=&quot;&amp;#x6d;&amp;#x61;&amp;#x69;&amp;#108;&amp;#x74;&amp;#x6f;&amp;#x3a;j&amp;#x65;&amp;#x66;&amp;#x66;&amp;#115;&amp;#099;&amp;#x6f;&amp;#064;&amp;#112;&amp;#115;&amp;#x65;l&amp;#x6c;&amp;#x6f;s&amp;#046;&amp;#x63;&amp;#x6f;&amp;#x6d;&quot;&gt;&amp;#106;e&amp;#102;&amp;#x66;&amp;#115;&amp;#099;o&amp;#064;&amp;#112;&amp;#115;&amp;#x65;&amp;#108;l&amp;#x6f;&amp;#x73;&amp;#x2e;&amp;#x63;&amp;#111;&amp;#109;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Posted by: &lt;a href=&quot;http://psellos.com/aboutus.html#jeffreya.scofieldphd&quot;&gt;Jeffrey&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;&lt;style type=&quot;text/css&quot;&gt;
.morelikealist {
       float: left;
       margin: 0em 1em 0em 0em;
}
&lt;/style&gt;&lt;/p&gt;
&lt;!--#include virtual=&quot;${Base_URL}/templates/footer.html&quot; --&gt;</content><id>http://psellos.com/2020/02/2020.02.kid-charlemagne.html</id><title type="text">OCaml iOS Apps Ported to Browser</title><updated>2020-02-24T19:00:00-00:00</updated><author><name>Psellos</name></author></entry><entry><source><updated>2020-02-20T00:00:00-00:00</updated><link title="Jane Street Tech Blog" type="text/html" href="https://blog.janestreet.com" rel="related"/><link title="Jane Street Tech Blog" type="application/rss+xml" href="https://blog.janestreet.com/feed.xml" rel="self"/><id>https://blog.janestreet.com</id><title type="text">Jane Street Tech Blog</title><author><name>Jane Street</name></author></source><link href="https://blog.janestreet.com/watch-all-of-jane-streets-tech-talks/" rel="alternate"/><content xml:base="https://blog.janestreet.com/feed.xml" type="html">&lt;p&gt;Jane Street has been posting tech talks from internal speakers and
invited guests for years—and they’re all available on our YouTube
channel:&lt;/p&gt;

</content><id>https://blog.janestreet.com/watch-all-of-jane-streets-tech-talks/</id><title type="text">Watch all of Jane Street's tech talks</title><updated>2020-02-20T00:00:00-00:00</updated><author><name>Jane Street</name></author></entry><entry><source><updated>2020-02-16T02:12:00-00:00</updated><link title="0branch.com :: blog - All posts" type="text/html" href="http://blog.0branch.com" rel="related"/><link title="0branch.com :: blog - All posts" type="application/rss+xml" href="http://newblog.0branch.com/rss.xml" rel="self"/><id>http://blog.0branch.com</id><title type="text">0branch.com :: blog - All posts</title><author><name>Marc Simpson</name></author></source><link href="http://blog.0branch.com/posts/2020-02-15-prettyconfig-extension.html" rel="alternate"/><content xml:base="http://newblog.0branch.com/rss.xml" type="html">&lt;div id=&quot;blog_post&quot;&gt;
  &lt;div class=&quot;span-22&quot;&gt;
    &lt;div id=&quot;post_title&quot; class=&quot;span-12&quot;&gt;&lt;h1&gt;Mercurial: prettyconfig extension&lt;/h1&gt;&lt;/div&gt;
    &lt;div style=&quot;text-align: right&quot; class=&quot;span-10 last&quot; id=&quot;post_date&quot;&gt;
      &lt;a href=&quot;/index.html&quot;&gt;#&lt;/a&gt; February 16, 2020
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;hr/&gt;
  &lt;div id=&quot;post_body&quot;&gt;
    &lt;p&gt;Since the &lt;a href=&quot;/posts/2020-02-03-bitbucket-migration.html&quot;&gt;Bitbucket migration&lt;/a&gt;, I’ve found myself tinkering&lt;a href=&quot;#fn1&quot; class=&quot;footnote-ref&quot; id=&quot;fnref1&quot;&gt;&lt;sup&gt;1&lt;/sup&gt;&lt;/a&gt; with Mercurial and its extensions system again (after a long hiatus).&lt;/p&gt;
&lt;p&gt;One byproduct of this was a simple, single function &lt;a href=&quot;http://hg.0branch.com/hg-aliases&quot;&gt;extension&lt;/a&gt; for listing aliases in a user-friendly way. I subsequently realised that the same behaviour would be useful for arbitrary config sections (aliases, paths, schemes)… and so, the &lt;a href=&quot;http://hg.0branch.com/hg-prettyconfig&quot;&gt;prettyconfig&lt;/a&gt; fork.&lt;/p&gt;
&lt;p&gt;The &lt;a href=&quot;http://hg.0branch.com/hg-prettyconfig&quot;&gt;prettyconfig&lt;/a&gt; extension defines a single command, &lt;code&gt;prettyconfig&lt;/code&gt;, for colourising and neatly displaying config values. Without arguments, all config name/value pairs are output, where names are qualified with section prefixes (akin to &lt;code&gt;hg showconfig&lt;/code&gt;). Single sections are displayed with the &lt;code&gt;-s&lt;/code&gt; (or &lt;code&gt;--section&lt;/code&gt;) switch, e.g.:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ hg prettyconfig  -s       alias   # display aliases
$ hg prettyconfig --section alias   # same thing&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Colouring can be applied to the output by setting the following two labels in an &lt;code&gt;.hgrc&lt;/code&gt; file (either globally or locally):&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb2&quot;&gt;&lt;pre class=&quot;sourceCode ini&quot;&gt;&lt;code class=&quot;sourceCode ini&quot;&gt;&lt;a class=&quot;sourceLine&quot; id=&quot;cb2-1&quot; data-line-number=&quot;1&quot;&gt;&lt;span class=&quot;kw&quot;&gt;[color]&lt;/span&gt;&lt;/a&gt;
&lt;a class=&quot;sourceLine&quot; id=&quot;cb2-2&quot; data-line-number=&quot;2&quot;&gt;&lt;span class=&quot;dt&quot;&gt;prettyconfig.name &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; yellow&lt;/span&gt;&lt;/a&gt;
&lt;a class=&quot;sourceLine&quot; id=&quot;cb2-3&quot; data-line-number=&quot;3&quot;&gt;&lt;span class=&quot;dt&quot;&gt;prettyconfig.value &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; green&lt;/span&gt;&lt;/a&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So far, I’ve found the following aliases&lt;a href=&quot;#fn2&quot; class=&quot;footnote-ref&quot; id=&quot;fnref2&quot;&gt;&lt;sup&gt;2&lt;/sup&gt;&lt;/a&gt; useful enough to store globally in &lt;code&gt;~/.hgrc&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;sourceCode&quot; id=&quot;cb3&quot;&gt;&lt;pre class=&quot;sourceCode ini&quot;&gt;&lt;code class=&quot;sourceCode ini&quot;&gt;&lt;a class=&quot;sourceLine&quot; id=&quot;cb3-1&quot; data-line-number=&quot;1&quot;&gt;&lt;span class=&quot;kw&quot;&gt;[alias]&lt;/span&gt;&lt;/a&gt;
&lt;a class=&quot;sourceLine&quot; id=&quot;cb3-2&quot; data-line-number=&quot;2&quot;&gt;&lt;span class=&quot;dt&quot;&gt;aliases &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; prettyconfig -s alias&lt;/span&gt;&lt;/a&gt;
&lt;a class=&quot;sourceLine&quot; id=&quot;cb3-3&quot; data-line-number=&quot;3&quot;&gt;&lt;span class=&quot;dt&quot;&gt;schemes &lt;/span&gt;&lt;span class=&quot;ot&quot;&gt;=&lt;/span&gt;&lt;span class=&quot;st&quot;&gt; prettyconfig -s schemes&lt;/span&gt;&lt;/a&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Hopefully others will find &lt;a href=&quot;http://hg.0branch.com/hg-prettyconfig&quot;&gt;prettyconfig&lt;/a&gt; useful too. Feedback is welcome.&lt;/p&gt;
&lt;section class=&quot;footnotes&quot;&gt;
&lt;hr /&gt;
&lt;ol&gt;
&lt;li id=&quot;fn1&quot;&gt;&lt;p&gt;Perusing APIs, making old extensions Python 3 compatible, tweaking web templates, etc.&lt;a href=&quot;#fnref1&quot; class=&quot;footnote-back&quot;&gt;↩&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;li id=&quot;fn2&quot;&gt;&lt;p&gt;Note that the &lt;code&gt;aliases&lt;/code&gt; alias effectively does the same thing as enabling &lt;a href=&quot;http://hg.0branch.com/hg-aliases&quot;&gt;hg-aliases&lt;/a&gt; (from which this extension was derived).&lt;a href=&quot;#fnref2&quot; class=&quot;footnote-back&quot;&gt;↩&lt;/a&gt;&lt;/p&gt;&lt;/li&gt;
&lt;/ol&gt;
&lt;/section&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;hr/&gt;

&lt;div id=&quot;disqus_thread&quot;&gt;&lt;/div&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
  var disqus_shortname = '0branch'; // required: replace example with your forum shortname
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
&lt;/script&gt;
&lt;noscript&gt;Please enable JavaScript to view the &lt;a href=&quot;http://disqus.com/?ref_noscript&quot;&gt;comments powered by Disqus.&lt;/a&gt;&lt;/noscript&gt;
&lt;a href=&quot;http://disqus.com&quot; class=&quot;dsq-brlink&quot;&gt;comments powered by &lt;span class=&quot;logo-disqus&quot;&gt;Disqus&lt;/span&gt;&lt;/a&gt;
</content><id>http://blog.0branch.com/posts/2020-02-15-prettyconfig-extension.html</id><title type="text">Mercurial: prettyconfig extension</title><updated>2020-02-16T02:12:00-00:00</updated><author><name>Marc Simpson</name></author></entry><entry><source><updated>2020-02-16T02:12:00-00:00</updated><link title="0branch.com :: blog - All posts" type="text/html" href="http://blog.0branch.com" rel="related"/><link title="0branch.com :: blog - All posts" type="application/rss+xml" href="http://newblog.0branch.com/rss.xml" rel="self"/><id>http://blog.0branch.com</id><title type="text">0branch.com :: blog - All posts</title><author><name>Marc Simpson</name></author></source><link href="http://blog.0branch.com/posts/2020-02-05-hg-extensions.html" rel="alternate"/><content xml:base="http://newblog.0branch.com/rss.xml" type="html">&lt;div id=&quot;blog_post&quot;&gt;
  &lt;div class=&quot;span-22&quot;&gt;
    &lt;div id=&quot;post_title&quot; class=&quot;span-12&quot;&gt;&lt;h1&gt;Mercurial extensions (update)&lt;/h1&gt;&lt;/div&gt;
    &lt;div style=&quot;text-align: right&quot; class=&quot;span-10 last&quot; id=&quot;post_date&quot;&gt;
      &lt;a href=&quot;/index.html&quot;&gt;#&lt;/a&gt; February  5, 2020
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;hr/&gt;
  &lt;div id=&quot;post_body&quot;&gt;
    &lt;p&gt;In my &lt;a href=&quot;/posts/2020-02-03-bitbucket-migration.html&quot;&gt;previous post&lt;/a&gt;, I mentioned that a couple of old Mercurial extensions are archived on this server: &lt;a href=&quot;http://hg.0branch.com/hg-prettypaths&quot;&gt;hg-prettypaths&lt;/a&gt; and &lt;a href=&quot;http://hg.0branch.com/hg-persona/&quot;&gt;hg-persona&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Both have now been lightly tidied and updated to work with newer versions of Mercurial (tested on 4.5.3, 5.3).&lt;/p&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;hr/&gt;

&lt;div id=&quot;disqus_thread&quot;&gt;&lt;/div&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
  var disqus_shortname = '0branch'; // required: replace example with your forum shortname
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
&lt;/script&gt;
&lt;noscript&gt;Please enable JavaScript to view the &lt;a href=&quot;http://disqus.com/?ref_noscript&quot;&gt;comments powered by Disqus.&lt;/a&gt;&lt;/noscript&gt;
&lt;a href=&quot;http://disqus.com&quot; class=&quot;dsq-brlink&quot;&gt;comments powered by &lt;span class=&quot;logo-disqus&quot;&gt;Disqus&lt;/span&gt;&lt;/a&gt;
</content><id>http://blog.0branch.com/posts/2020-02-05-hg-extensions.html</id><title type="text">Mercurial extensions (update)</title><updated>2020-02-05T17:40:00-00:00</updated><author><name>Marc Simpson</name></author></entry><entry><source><updated>2020-03-23T08:47:03-00:00</updated><logo>http://www.ocamlpro.com/wp-content/uploads/2018/02/apple-touch-icon-152x152-150x150.png</logo><link title="OCamlPro" type="text/html" href="http://www.ocamlpro.com" rel="related"/><link title="OCamlPro" type="application/rss+xml" href="http://www.ocamlpro.com/feed/" rel="self"/><generator>https://wordpress.org/?v=4.9.13</generator><id>http://www.ocamlpro.com</id><title type="text">OCamlPro</title><author><name>OCamlPro</name></author></source><link href="http://www.ocamlpro.com/2020/02/04/2019-at-ocamlpro/" rel="alternate"/><link href="http://www.ocamlpro.com/2020/02/04/2019-at-ocamlpro/#comments" rel="related"/><content xml:base="http://www.ocamlpro.com/feed/" type="html">&lt;p&gt;OCamlPro was created to help OCaml and formal methods spread into the industry. We grew from 1 to 21 engineers, still strongly sharing this ambitious goal! The year 2019 at OCamlPro was very lively, with fantastic accomplishments all along!&lt;/p&gt;
&lt;p&gt;Let&amp;#8217;s quickly review the past years&amp;#8217; works, first in the world of &lt;a href=&quot;#ocaml&quot;&gt;OCaml&lt;/a&gt; (&lt;a href=&quot;#compilation&quot;&gt;flambda2&lt;/a&gt; &amp;amp; compiler optimisations, &lt;a href=&quot;#opam&quot;&gt;opam&lt;/a&gt; 2, our &lt;a href=&quot;#rust&quot;&gt;Rust-based&lt;/a&gt; UI for &lt;a href=&quot;#memthol&quot;&gt;memprof&lt;/a&gt;, tools like tryOCaml, ocp-indent, and supporting the &lt;a href=&quot;#ocsf&quot;&gt;OCaml Software Foundation&lt;/a&gt;), then in the world of &lt;a href=&quot;#formalmethods&quot;&gt;formal methods&lt;/a&gt; (new versions of our SMT Solver &lt;a href=&quot;#altergo&quot;&gt;Alt-Ergo&lt;/a&gt;, launch of the &lt;a href=&quot;#altergoclub&quot;&gt;Alt-Ergo Users&amp;#8217; Club&lt;/a&gt;, the &lt;a href=&quot;#love&quot;&gt;Love language&lt;/a&gt;, etc.).&lt;/p&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;h1&gt;In the World of OCaml&lt;a id=&quot;ocaml&quot;&gt;&lt;/a&gt;&lt;/h1&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;h2&gt;&lt;b&gt;Flambda &amp;amp; Compilation Team&lt;a id=&quot;compilation&quot;&gt;&lt;/a&gt;&lt;br /&gt;
&lt;/b&gt;&lt;/h2&gt;
&lt;p&gt;&lt;i&gt;* Work by Pierre Chambart, Vincent Laviron, Guillaume Bury and Pierrick Couderc&lt;/i&gt;&lt;/p&gt;
&lt;p&gt;&lt;img class=&quot;alignleft wp-image-823&quot; src=&quot;http://www.ocamlpro.com/wp-content/uploads/2018/01/ocaml.png&quot; alt=&quot;&quot; width=&quot;109&quot; height=&quot;95&quot; /&gt;&lt;/p&gt;
&lt;p&gt;Pierre and Vincent&amp;#8217;s considerable work on Flambda 2 (the optimizing intermediate representation of the OCaml compiler &amp;#8211; on which inlining occurs), in close cooperation with Jane Street (Mark Shinwell, Leo White and their team) aims at overcoming some of flambda&amp;#8217;s limitations. We have continued our work on making OCaml programs always faster: internal types are clearer, more concise, and possible control flow transformations are more flexible. Overall a precious outcome for industrial users. In 2019, the major breakthrough was to go from the initial prototype to a complete compiler, which allowed us to compile simple examples first and then to bootstrap it.&lt;/p&gt;
&lt;p&gt;On the OCaml compiler side, we also worked with Leo on two new features: functorized compilation units and functorized packs, and recursive packs. The former will allow any developer to implement &amp;#8216;.ml&amp;#8217; files as if they were functors and not simply modules, and more importantly generate packs that are real functors. As such, this allows to split big functors into several files or to parameterize libraries on other modules. The latter allows two distinct usages: recursive interfaces, to implement recursive types into distinct `.mlis` as long as they do not need any implementation; and recursive packs, whose components are typed and compiled as recursive modules.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;These new features are described on the new &lt;a href=&quot;https://github.com/ocaml/RFCs/pull/11&quot;&gt;RFC repository&lt;/a&gt; for OCaml (a &lt;a href=&quot;https://github.com/ocaml/ocaml/issues/5283&quot;&gt;similar idea&lt;/a&gt; was suggested and implemented in 2011 by Fabrice Le Fessant).&lt;/li&gt;
&lt;li&gt;The implementation is available on GitHub for both &lt;a href=&quot;https://github.com/OCamlPro-Couderc/ocaml/tree/functorized-packs&quot;&gt;functorized packs&lt;/a&gt; and &lt;a href=&quot;https://github.com/OCamlPro-Couderc/ocaml/tree/recursive-units+pack-cleanup&quot;&gt;recursive packs&lt;/a&gt;. Be aware that both are based on an old version of OCaml for now, but should be in sync with the current trunk in the near future.&lt;/li&gt;
&lt;li&gt;See also Vincent&amp;#8217;s &lt;a href=&quot;http://www.ocamlpro.com/2019/08/30/ocamlpros-compiler-team-work-update/&quot; rel=&quot;bookmark&quot;&gt;OCamlPro’s compiler team work update&lt;/a&gt; of August 2019.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;This work is allowed thanks to Jane Street&amp;#8217;s funding.&lt;/em&gt;&lt;/p&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;h2&gt;Work on a formalized type system for OCaml&lt;a id=&quot;typesystem&quot;&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;* &lt;em&gt;Work of Pierrick Couderc&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;At the end of 2018, Pierrick defended his PhD on &amp;#8220;&lt;a href=&quot;https://pastel.archives-ouvertes.fr/tel-02100717/&quot;&gt;Checking type inference results of the OCaml language&lt;/a&gt;&amp;#8220;, leading to a formalized type systems and semantics for a large subset of OCaml, or at least its unique typed intermediate language: the Typedtree. This work led us to work on new aspects of the OCaml compiler as recursive and functorized packs described earlier, and we hope this proves useful in the future for the evolution of the language.&lt;/p&gt;
&lt;h2&gt;The OPAM package manager&lt;a id=&quot;opam&quot;&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;&lt;i&gt;*Work of Raja Boujbel and Louis Gesbert&lt;/i&gt;&lt;/p&gt;
&lt;h2&gt;&lt;img class=&quot;wp-image-820 alignleft&quot; src=&quot;http://www.ocamlpro.com/wp-content/uploads/2018/01/opam-300x261.png&quot; alt=&quot;&quot; width=&quot;109&quot; height=&quot;95&quot; srcset=&quot;http://www.ocamlpro.com/wp-content/uploads/2018/01/opam-300x261.png 300w, http://www.ocamlpro.com/wp-content/uploads/2018/01/opam.png 357w&quot; sizes=&quot;(max-width: 109px) 100vw, 109px&quot; /&gt;&lt;/h2&gt;
&lt;p&gt;&lt;a href=&quot;http://opam.ocaml.org&quot;&gt;OPAM&lt;/a&gt; is maintained and developed at OCamlPro by Louis and Raja. Thanks to their thorough efforts the opam 2.1 first release candidate is soon to be published!&lt;/p&gt;
&lt;p&gt;Back in 2018, the long-awaited opam 2.0 version was finally released. It embedded many changes, in opam itself as well as for the community. The opam file format was redefined to simplify and add new features. With the close collaboration of OCamlLabs and opam repository maintainers, we were able to manage a smooth transition of the repository and whole ecosystem from opam 1.2 format to the new &amp;#8211; and richer &amp;#8211; opam 2.0 format. Other emblematic features are e.g. for practically integrated mccs solver, sandboxing builds, for security issues (we care about your filesystem!), for usability reworking of the pin&amp;#8217; command, etc.&lt;/p&gt;
&lt;p&gt;While the 2.1.0 version is in preparation, the 2.0.0 version is still updated with minor releases to fix issues. The lastest 2.0.6 release is fresh from January.&lt;/p&gt;
&lt;p&gt;In the meantime, we continued to improve opam by integrating some opam plugins (opam lock, opam depext), recursively discover opam files in the file tree when pinning, new definition of a switch compiler, the possibility to use z3 backend instead of mccs, etc.&lt;/p&gt;
&lt;p&gt;All these new features &amp;#8211; among others &amp;#8211; will be integrated in the 2.1.0 release, that is betaplanned for February. The best is yet to come!&lt;/p&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;ul&gt;
&lt;li&gt;More details: on &lt;a href=&quot;http://opam.ocaml.org&quot;&gt;http://opam.ocaml.org &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Releases on Releases on &lt;a href=&quot;https://github.com/ocaml/opam/releases&quot; target=&quot;_blank&quot; rel=&quot;noopener noreferrer&quot; data-saferedirecturl=&quot;https://www.google.com/url?q=https://github.com/ocaml/opam/releases&amp;amp;source=gmail&amp;amp;ust=1580896455680000&amp;amp;usg=AFQjCNF4j8wCWVQHXbTqQ1KaEZY8IJ3UAQ&quot;&gt;https://github.com/ocaml/opam/&lt;wbr /&gt;releases&lt;/a&gt; &amp;amp; &lt;a href=&quot;https://opam.ocaml.org/blog/opam-2-0-6/&quot;&gt;our blog&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;em&gt;This work is allowed thanks to Jane Street&amp;#8217;s funding.&lt;/em&gt;&lt;/p&gt;
&lt;h2&gt;&lt;b class=&quot;im&quot;&gt;Encouraging OCaml adoption&lt;/b&gt;&lt;b&gt;&lt;br /&gt;
&lt;/b&gt;&lt;/h2&gt;
&lt;h3&gt;OCaml Expert trainings for professional programmers&lt;a id=&quot;training&quot;&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;We proposed in 2019 some &lt;a href=&quot;http://www.ocamlpro.com/course-ocaml-expert/&quot;&gt;OCaml expert training&lt;/a&gt; specially designed for developers who want to use advanced features and master all the open-source tools and libraries of OCaml.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;The &amp;#8220;Expert&amp;#8221; OCaml course is for already experienced OCaml programmers to better understand advanced type system possibilities (objects, GADTs), discover GC internals, write &amp;#8220;compiler-optimizable&amp;#8221; code. These sessions are also an opportunity to come discuss with our OPAM &amp;amp; Flambda lead developers and core contributors in Paris.&lt;/p&gt;&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;Next session: 3-4 March 2020, Paris &lt;a href=&quot;http://www.ocamlpro.com/forms/preinscriptions-formation-ocaml/&quot;&gt;(registration)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;h3&gt;Our cheat-sheets on OCaml, the stdlib and opam&lt;a id=&quot;cheatsheets&quot;&gt;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;&lt;i&gt;* Work of Thomas Blanc, Raja Boujbel and Louis Gesbert &lt;/i&gt;&lt;/p&gt;
&lt;p&gt;Thomas announced the release of our up-to-date cheat-sheets for the &lt;a href=&quot;http://www.ocamlpro.com/2019/09/13/updated-cheat-sheets-ocaml-language-and-ocaml-standard-library/&quot;&gt;OCaml language, standard library&lt;/a&gt; and &lt;a href=&quot;http://www.ocamlpro.com/wp-content/uploads/2019/11/ocaml-opam.pdf&quot;&gt;opam&lt;/a&gt;. Our original cheat-sheets were dating back to 2011. This was an opportunity to update them after the &lt;a href=&quot;http://www.ocamlpro.com/2019/09/13/updated-cheat-sheets-ocaml-language-and-ocaml-standard-library/&quot;&gt;many changes&lt;/a&gt; in the language, library and ecosystem overall.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Cheat-sheets are helpful to refer to, as an overview of the documentation when you are programming, especially when you’re starting in a new language. They are meant to be printed and pinned on your wall, or to be kept in handy on a spare screen. &lt;em&gt;They come in handy when your &lt;a href=&quot;https://rubberduckdebugging.com/&quot;&gt;rubber duck&lt;/a&gt; is rubbish at debugging your code!&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;More details on &lt;a href=&quot;http://www.ocamlpro.com/2019/09/13/updated-cheat-sheets-ocaml-language-and-ocaml-standard-library/&quot;&gt;Thomas&amp;#8217; blog post&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;Open Source Tooling and Web IDEs&lt;/h3&gt;
&lt;p&gt;And let&amp;#8217;s not forget the other tools we develop and maintain! We have tools for education such as our interactive editor OCaml-top and  &lt;a href=&quot;https://try.ocamlpro.com/new.html&quot;&gt;Try-OCaml &lt;/a&gt; (from the previous work on the learn-OCaml platform for the OCaml Fun MOOC) which you can use to code in your browser. Developers will appreciate tools like our indentation tool ocp-indent, and ocp-index which gives you easy access to the interface information of installed OCaml libraries for editors like Emacs and Vim.&lt;/p&gt;
&lt;h2&gt;Supporting the OCaml Software Foundation&lt;a id=&quot;ocsf&quot;&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;h2&gt;&lt;img class=&quot;alignleft&quot; src=&quot;http://ocaml-sf.org/img/logo-ocsf.svg&quot; alt=&quot;The OCaml Software Foundation. Logo by Bettina Steinbrecher&quot; width=&quot;162&quot; height=&quot;50&quot; /&gt;&lt;/h2&gt;
&lt;p&gt;OCamlPro was proud to be one of the first supporters of the new Inria&amp;#8217;s &lt;a href=&quot;http://ocaml-sf.org/&quot;&gt;OCaml Software Foundation.&lt;/a&gt; We keep committed to the adoption of OCaml as an industrial language:&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&amp;#8220;[&amp;#8230;] As a long-standing supporter of the OCaml language, we have always been committed to helping spread OCaml&amp;#8217;s adoption and increase the accessibility of OCaml to beginners and students. [&amp;#8230;] We value close and friendly collaboration with the main actors of the OCaml community, and are proud to be contributing to the OCaml language and tooling.&amp;#8221; (August 2019, Advisory Board of the OCSF, ICFP Berlin)&lt;/p&gt;&lt;/blockquote&gt;
&lt;ul&gt;
&lt;li&gt;More information on the &lt;a href=&quot;http://ocaml-sf.org/&quot;&gt;OCaml Software Foundation&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;In the World of Formal Methods&lt;a id=&quot;formalmethods&quot;&gt;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;&lt;em&gt;* By Mohamed Iguernlala, Albin Coquereau, Guillaume Bury&lt;br /&gt;
&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;In 2018, we welcomed five new engineers with a background in formal methods. They consolidate the department of formal methods at OCamlPro, in particular help develop and maintain our SMT solver Alt-Ergo.&lt;/p&gt;
&lt;h2&gt;Release of Alt-Ergo 2.3.0, and version 2.0.0 (free)&lt;a id=&quot;altergo&quot;&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;h2&gt;&lt;img class=&quot;size-medium alignleft&quot; src=&quot;http://www.ocamlpro.com/wp-content/uploads/2016/02/alt-ergo-logo.png&quot; alt=&quot;Alt-Ergo&quot; width=&quot;107&quot; height=&quot;90&quot; /&gt;&lt;/h2&gt;
&lt;p&gt;After the release of &lt;a href=&quot;http://www.ocamlpro.com/2018/04/23/release-of-alt-ergo-2-2-0/&quot;&gt;Alt-Ergo 2.2.0&lt;/a&gt; (with a new front-end that supports the SMT-LIB 2 language, extended prenex polymorphism, implemented as a standalone library) came the version 2.3.0 in 2019 with new features : dune support, ADT / algebraic datatypes, improvement of the if-then-else and let-in support, improvement of the data types.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;More information on the &lt;a href=&quot;https://alt-ergo.ocamlpro.com/&quot;&gt;Alt-Ergo SMT Solver&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;Albin Coquereau defended his PhD thesis in Decembre 2019 &amp;#8220;Improving performance of the SMT solver Alt-Ergo with a better integration of efficient SAT solver&amp;#8221;&lt;/li&gt;
&lt;li&gt;We participated in the SMT-COMP 2019 during the 22nd SAT conference. The results of the competition are detailed &lt;a href=&quot;http://www.ocamlpro.com/2019/07/09/alt-ergo-participation-to-the-smt-comp-2019/&quot;&gt;here.&lt;/a&gt;
&lt;div class=&quot;c-message_kit__gutter&quot;&gt;
&lt;div class=&quot;c-message_kit__gutter__right&quot; data-qa=&quot;message_content&quot;&gt;
&lt;div class=&quot;c-message_kit__blocks c-message_kit__blocks--rich_text&quot;&gt;
&lt;div class=&quot;c-message__message_blocks c-message__message_blocks--rich_text&quot;&gt;
&lt;div class=&quot;p-block_kit_renderer&quot; data-qa=&quot;block-kit-renderer&quot;&gt;
&lt;div class=&quot;p-block_kit_renderer__block_wrapper p-block_kit_renderer__block_wrapper--first&quot;&gt;
&lt;div class=&quot;p-rich_text_block&quot; dir=&quot;auto&quot;&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;c-message_actions__container c-message__actions&quot; role=&quot;group&quot; aria-label=&quot;Message actions&quot;&gt;&lt;/div&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;h2&gt;The launch of the Alt-Ergo Users&amp;#8217; Club&lt;a id=&quot;altergoclub&quot;&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Getting closer to our users, gathering industrial and academic supporters, collecting their needs into the Alt-Ergo roadmap is key to Alt-Ergo&amp;#8217;s development and sustainability.&lt;/p&gt;
&lt;p&gt;The &lt;a href=&quot;https://alt-ergo.ocamlpro.com/#club&quot;&gt;Alt-Ergo Users&amp;#8217; Club&lt;/a&gt; was officially launched beginning of 2019. The first yearly meeting took place in February 2019. We were happy to welcome our first members &lt;a href=&quot;https://www.adacore.com&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Adacore&lt;/a&gt;, &lt;a href=&quot;http://www-list.cea.fr/en/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;CEA List&lt;/a&gt;, &lt;a href=&quot;https://trust-in-soft.com&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Trust-In-Soft&lt;/a&gt;, and now Mitsubishi MERCE.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;More information on the &lt;a href=&quot;https://alt-ergo.ocamlpro.com/#club&quot;&gt;Alt-Ergo Users&amp;#8217; Club&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;h1&gt;Harnessing our language-design expertise: Love&lt;a id=&quot;love&quot;&gt;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;&lt;img class=&quot; wp-image-2410 alignleft&quot; src=&quot;http://www.ocamlpro.com/wp-content/uploads/2020/02/Love-deuxième-jet-couleur-dune-300x300.png&quot; alt=&quot;&quot; width=&quot;158&quot; height=&quot;163&quot; /&gt;&lt;/p&gt;
&lt;p&gt;&lt;i&gt;* Work by David Declerck &amp;amp; Steven de Oliveira&lt;/i&gt;&lt;/p&gt;
&lt;p&gt;Following the launch of Dune network, the Love language for smart-contracts was born from the collaboration of OCamlPro and Origin Labs. This new language, whose syntax is inspired from OCaml and Liquidity, is an alternative to the Dune native smart contract language Michelson. Love is based on system-F, a type system requiring no type inference and allowing polymorphism. The language has successfully been integrated on the network and the first smart contracts are being written.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://medium.com/dune-network/love-a-new-smart-contract-language-for-the-dune-network-a217ab2255be&quot;&gt;LOVE: a New Smart Contract Language for the Dune Network&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://medium.com/dune-network/the-love-smart-contract-language-introduction-key-features-part-i-949d8a4e73c3&quot;&gt;The Love Smart Contract Language: Introduction &amp;amp; Key Features — Part I&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h1&gt;Rust-related activities&lt;a id=&quot;rust&quot;&gt;&lt;/a&gt;&lt;/h1&gt;
&lt;p&gt;The OCaml &amp;amp; Rust combo &lt;em&gt;should&lt;/em&gt; be a candidate for any ambitious software project!&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a id=&quot;memthol&quot;&gt;&lt;/a&gt;A Rust-based UI for memprof: we started in 2019 to work in collaboration with the memprof developer team on a Rust based UI for memprof. See Pierre and Albin&amp;#8217;s exposé at the &lt;a href=&quot;http://jfla.inria.fr/jfla2020.html&quot;&gt;JFLA2020&lt;/a&gt;&amp;#8216;s &amp;#8220;&lt;span class=&quot;commtitle&quot;&gt;Gardez votre mémoire fraiche avec Memthol&amp;#8221; (&lt;/span&gt;Pierre &lt;span class=&quot;name&quot;&gt;Chambart&lt;/span&gt; , Albin &lt;span class=&quot;name&quot;&gt;Coquereau&lt;/span&gt; and Jacques-Henri &lt;span class=&quot;name&quot;&gt;Jourdan)&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.ocamlpro.com/rust-vocational-training/&quot;&gt;Rust training&lt;/a&gt; : R&lt;em&gt;ust borrows heavily from functional programming languages to provide very expressive abstraction mechanisms. Because it is a systems language, these mechanisms are almost always zero-cost. For instance, polymorphic code has no runtime cost compared to a monomorphic version.This concern for efficiency also means that Rust lets developers keep a very high level of control and freedom for optimizations. Rust has no Garbage Collection or any form of runtime memory inspection to decide when to free, allocate or re-use memory. But because manual memory management is almost universally regarded as dangerous, or at least very difficult to maintain, the Rust compiler has a borrow-checker which is responsible for i) proving that the input program is memory-safe (and thread-safe), and ii) generating a safe and “optimal” allocation/deallocation strategy. All of this is done at compile-time.&lt;/em&gt;
&lt;ul&gt;
&lt;li&gt;Next sessions: April 20-24th 2020 &lt;a href=&quot;http://www.ocamlpro.com/forms/preinscriptions-formation-ocaml/&quot;&gt;(registration)&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;h1&gt;&lt;b&gt;OCamlPro around the world&lt;/b&gt;&lt;/h1&gt;
&lt;p&gt;OCamlPro&amp;#8217;s team members attended many events throughout the world:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://icfp19.sigplan.org/&quot;&gt;ICFP 2019&lt;/a&gt; (Berlin)&lt;/li&gt;
&lt;li&gt;The &lt;a href=&quot;https://dpt-info.u-strasbg.fr/~magaud/JFLA2019/lieu.html&quot;&gt;JFLA’2019&lt;/a&gt; (Les Rousses, Haut-Jura)&lt;/li&gt;
&lt;li&gt;The&lt;a href=&quot;https://www.opensourcesummit.paris/&quot;&gt; POSS&amp;#8217;2019 &lt;/a&gt;(Paris)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://retreat.mirage.io/&quot;&gt;MirageOS Retreat&lt;/a&gt; (Marrakech)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As a committed member of the OCaml ecosystem&amp;#8217;s animation, we&amp;#8217;ve organized OCaml meetups too (see the famous &lt;a href=&quot;https://www.meetup.com/fr-FR/ocaml-paris/&quot;&gt;OUPS&lt;/a&gt; meetups in Paris!).&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;Now let&amp;#8217;s jump into the new year 2020, with a team keeping expanding, and new projects ahead: keep posted!&lt;/p&gt;
&lt;/div&gt;
&lt;p&gt;&amp;nbsp;&lt;/p&gt;
&lt;h2&gt;Past projects: blockchain-related achievements (2018-beginning of 2019)&lt;a id=&quot;blockchain&quot;&gt;&lt;/a&gt;&lt;/h2&gt;
&lt;div class=&quot;m_-9073459877353804024moz-forward-container&quot;&gt;
&lt;p&gt;Many people ask us about what happened in 2018! That was an incredibly active year on blockchain-related achievements, and at that time we were hoping to attract clients that would be interested in our blockchain expertise.&lt;/p&gt;
&lt;p&gt;But that is &lt;a href=&quot;http://www.ocamlpro.com/wp-content/uploads/2020/01/Flyer_Blockchains_OSIS2017ok.pdf&quot;&gt;history&lt;/a&gt; now! Still interested? Check the &lt;a href=&quot;https://www.origin-labs.com/&quot;&gt;Origin Labs&lt;/a&gt; team and their partner &lt;a href=&quot;https://www.thegara.ge/&quot;&gt;The Garage&lt;/a&gt; on &lt;a href=&quot;https://dune.network&quot;&gt;Dune Network&lt;/a&gt;!&lt;/p&gt;
&lt;p&gt;For the &lt;a href=&quot;http://www.ocamlpro.com/2019/04/29/blockchains-at-ocamlpro-an-overview/&quot;&gt;record&lt;/a&gt;:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;(April 2019) We had started Techelson: a testing framework for Michelson and Liquidity&lt;/li&gt;
&lt;li&gt;(Nov 2018) &lt;a href=&quot;http://www.ocamlpro.com/2018/11/21/an-introduction-to-tezos-rpcs-signing-operations/&quot; rel=&quot;bookmark&quot;&gt;An Introduction to Tezos RPCs: Signing Operations&lt;/a&gt; / &lt;a href=&quot;http://www.ocamlpro.com/2018/11/15/an-introduction-to-tezos-rpcs-a-basic-wallet/&quot; rel=&quot;bookmark&quot;&gt;An Introduction to Tezos RPCs: a Basic Wallet &lt;/a&gt; / &lt;a href=&quot;http://www.ocamlpro.com/2018/11/06/liquidity-tutorial-a-game-with-an-oracle-for-random-numbers/&quot; rel=&quot;bookmark&quot;&gt;Liquidity Tutorial: A Game with an Oracle for Random Numbers&lt;/a&gt; / &lt;a href=&quot;http://www.ocamlpro.com/2018/11/08/first-open-source-release-of-tzscan/&quot; rel=&quot;bookmark&quot;&gt;First Open-Source Release of TzScan&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;(Oct 2018) &lt;a href=&quot;http://www.ocamlpro.com/2018/10/17/ocamlpros-tzscan-grant-proposal-accepted-by-the-tezos-foundation-joint-press-release/&quot; rel=&quot;bookmark&quot;&gt;OCamlPro’s TZScan grant proposal accepted by the Tezos Foundation – joint press release &lt;/a&gt;&lt;/li&gt;
&lt;li&gt;(Jul 2018) &lt;a href=&quot;http://www.ocamlpro.com/2018/07/20/new-updates-on-tzscan-2/&quot; rel=&quot;bookmark&quot;&gt;OCamlPro’s Tezos block explorer TzScan’s last updates&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;span id=&quot;m_-9073459877353804024result_box&quot; lang=&quot;en&quot;&gt;&lt;/span&gt;(Feb 2018) &lt;a href=&quot;http://www.ocamlpro.com/2018/02/14/release-of-a-first-version-of-tzscan-io-a-tezos-block-explorer/&quot; rel=&quot;bookmark&quot;&gt;Release of a first version of TzScan.io, a Tezos block explorer&lt;/a&gt; / &lt;a href=&quot;http://www.ocamlpro.com/2018/11/06/liquidity-tutorial-a-game-with-an-oracle-for-random-numbers/&quot; rel=&quot;bookmark&quot;&gt;OCamlPro’s Liquidity-lang demo at JFLA2018 – a smart-contract design language&lt;/a&gt; . We were developing &lt;a href=&quot;http://www.liquidity-lang.org/&quot;&gt;Liquidity&lt;/a&gt;, a high level smart contract language, &lt;span id=&quot;m_-9073459877353804024result_box&quot; lang=&quot;en&quot;&gt;human-readable, purely functional, statically-typed, which syntax was very close to the OCaml syntax.&lt;/span&gt;&lt;/li&gt;
&lt;li&gt;&lt;span id=&quot;m_-9073459877353804024result_box&quot; lang=&quot;en&quot;&gt;To garner interest and adoption, we also developed the online editor &lt;a href=&quot;http://www.liquidity-lang.org/edit&quot;&gt;Try Liquidity&lt;/a&gt;&lt;/span&gt;&lt;span id=&quot;m_-9073459877353804024result_box&quot; lang=&quot;en&quot;&gt;. Smart-contract developers could design contracts interactively, directly in the browser, compile them to Michelson, run them and deploy them on the alphanet network of Tezos. &lt;/span&gt;&lt;span id=&quot;m_-9073459877353804024result_box&quot; lang=&quot;en&quot;&gt;Future plans included a full-fledged web-based IDE for Liquidity. Worth mentioning was a neat feature: decompiling a Michelson program back to its Liquidity version, whether it was generated from Liquidity code or not.&lt;/span&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;
</content><category term="Try-OCaml"/><id>http://www.ocamlpro.com/?p=1453</id><title type="text">2019 at OCamlPro</title><updated>2020-02-04T11:00:34-00:00</updated><author><name>OCamlPro</name></author></entry><entry><source><updated>2020-02-16T02:12:00-00:00</updated><link title="0branch.com :: blog - All posts" type="text/html" href="http://blog.0branch.com" rel="related"/><link title="0branch.com :: blog - All posts" type="application/rss+xml" href="http://newblog.0branch.com/rss.xml" rel="self"/><id>http://blog.0branch.com</id><title type="text">0branch.com :: blog - All posts</title><author><name>Marc Simpson</name></author></source><link href="http://blog.0branch.com/posts/2020-02-03-bitbucket-migration.html" rel="alternate"/><content xml:base="http://newblog.0branch.com/rss.xml" type="html">&lt;div id=&quot;blog_post&quot;&gt;
  &lt;div class=&quot;span-22&quot;&gt;
    &lt;div id=&quot;post_title&quot; class=&quot;span-12&quot;&gt;&lt;h1&gt;Bitbucket repository migration&lt;/h1&gt;&lt;/div&gt;
    &lt;div style=&quot;text-align: right&quot; class=&quot;span-10 last&quot; id=&quot;post_date&quot;&gt;
      &lt;a href=&quot;/index.html&quot;&gt;#&lt;/a&gt; February  3, 2020
    &lt;/div&gt;
  &lt;/div&gt;
  &lt;hr/&gt;
  &lt;div id=&quot;post_body&quot;&gt;
    &lt;p&gt;Since Bitbucket are discontinuing Mercurial support in a few months’ time (see &lt;a href=&quot;https://bitbucket.org/blog/sunsetting-mercurial-support-in-bitbucket&quot;&gt;here&lt;/a&gt;), I’ve started migrating a few old repositories:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/0branch/hugo-unix&quot;&gt;hugo-unix&lt;/a&gt; is now hosted on GitHub
&lt;ul&gt;
&lt;li&gt;… and Nikos released &lt;a href=&quot;https://github.com/0branch/hugo-unix/releases/tag/v3.1.05&quot;&gt;v3.1.05&lt;/a&gt; today.&lt;/li&gt;
&lt;li&gt;Conversion was done with &lt;a href=&quot;https://foss.heptapod.net/mercurial/hg-git&quot;&gt;hg-git&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;li&gt;Extensions &lt;a href=&quot;http://hg.0branch.com/hg-prettypaths&quot;&gt;hg-prettypaths&lt;/a&gt; and &lt;a href=&quot;http://hg.0branch.com/hg-persona/&quot;&gt;hg-persona&lt;/a&gt; are now archived on this server.
&lt;ul&gt;
&lt;li&gt;Note that &lt;a href=&quot;http://hg.0branch.com/hg-prettypaths&quot;&gt;hg-prettypaths&lt;/a&gt; is deprecated (broken in newer versions of Mercurial).&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://hg.0branch.com/hg-persona/&quot;&gt;hg-persona&lt;/a&gt; has been updated to work with hg ≥4.3.&lt;/li&gt;
&lt;/ul&gt;&lt;/li&gt;
&lt;/ul&gt;
  &lt;/div&gt;
&lt;/div&gt;

&lt;hr/&gt;

&lt;div id=&quot;disqus_thread&quot;&gt;&lt;/div&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
  var disqus_shortname = '0branch'; // required: replace example with your forum shortname
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
&lt;/script&gt;
&lt;noscript&gt;Please enable JavaScript to view the &lt;a href=&quot;http://disqus.com/?ref_noscript&quot;&gt;comments powered by Disqus.&lt;/a&gt;&lt;/noscript&gt;
&lt;a href=&quot;http://disqus.com&quot; class=&quot;dsq-brlink&quot;&gt;comments powered by &lt;span class=&quot;logo-disqus&quot;&gt;Disqus&lt;/span&gt;&lt;/a&gt;
</content><id>http://blog.0branch.com/posts/2020-02-03-bitbucket-migration.html</id><title type="text">Bitbucket repository migration</title><updated>2020-02-03T19:55:00-00:00</updated><author><name>Marc Simpson</name></author></entry><entry><source><updated>2020-02-20T00:00:00-00:00</updated><link title="Jane Street Tech Blog" type="text/html" href="https://blog.janestreet.com" rel="related"/><link title="Jane Street Tech Blog" type="application/rss+xml" href="https://blog.janestreet.com/feed.xml" rel="self"/><id>https://blog.janestreet.com</id><title type="text">Jane Street Tech Blog</title><author><name>Jane Street</name></author></source><link href="https://blog.janestreet.com/troubleshooting-systemd-with-systemtap/" rel="alternate"/><content xml:base="https://blog.janestreet.com/feed.xml" type="html">&lt;p&gt;When we set up a schedule on a computer, such as a list of commands to
run every day at particular times via Linux &lt;a href=&quot;https://www.ostechnix.com/a-beginners-guide-to-cron-jobs&quot;&gt;cron
jobs&lt;/a&gt;, we
expect that schedule to execute reliably.  Of course we’ll check the
logs to see whether the job has failed, but we never question whether
the cron daemon itself will function.  We always assume that it will,
as it always has done; we are not expecting mutiny in the ranks of the
operating system.&lt;/p&gt;

</content><id>https://blog.janestreet.com/troubleshooting-systemd-with-systemtap/</id><title type="text">Troubleshooting systemd with SystemTap</title><updated>2020-02-03T00:00:00-00:00</updated><author><name>Jane Street</name></author></entry><entry><source><updated>2020-01-20T13:17:34-00:00</updated><link href="https://ocsigen.github.io" rel="alternate"/><link href="https://ocsigen.github.io/feed.xml" rel="self"/><id>https://ocsigen.github.io/</id><title type="text">Ocsigen Blog</title><author><name>Ocsigen project</name></author><author><name>Ocsigen Project</name></author></source><link href="https://ocsigen.github.io/blog/2020/01/20/release/" rel="alternate"/><content xml:base="http://ocsigen.org/feed.xml" type="html">&lt;p&gt;New release: Ocsigen Start 2.15&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ocsigen.org/ocsigen-start/&quot;&gt;Ocsigen Start&lt;/a&gt; is a template for client-server Web and/or mobile app in OCaml or ReasonML.
It contains many standard features like user management, notifications, and many code examples.
Use it to &lt;a href=&quot;https://ocsigen.org/tuto/latest/manual/start&quot;&gt;learn Web/mobile development in OCaml&lt;/a&gt; or to quickly create your own Minimum Viable Product.
&lt;a href=&quot;https://ocsigen-1.inria.fr/ocsigen-start/demo/&quot;&gt;See an online demo&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Last features include:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Get rid of all remaining Camlp4 code&lt;/li&gt;
  &lt;li&gt;compatibility with OCaml 4.09&lt;/li&gt;
&lt;/ul&gt;

</content><id>tag:ocsigen.github.io,2020-01-20:/blog/2020/01/20/release</id><title type="text">Ocsigen Start updated</title><updated>2020-01-20T00:00:00-00:00</updated><author><name>The Ocsigen Team</name></author></entry><entry><source><updated>2020-01-20T13:17:34-00:00</updated><link href="https://ocsigen.github.io" rel="alternate"/><link href="https://ocsigen.github.io/feed.xml" rel="self"/><id>https://ocsigen.github.io/</id><title type="text">Ocsigen Blog</title><author><name>Ocsigen blog</name></author><author><name>Ocsigen Project</name></author></source><link href="https://ocsigen.github.io/blog/2020/01/20/release/" rel="alternate"/><content xml:base="https://ocsigen.github.io/feed.xml" type="html">&lt;p&gt;New release: Ocsigen Start 2.15&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://ocsigen.org/ocsigen-start/&quot;&gt;Ocsigen Start&lt;/a&gt; is a template for client-server Web and/or mobile app in OCaml or ReasonML.
It contains many standard features like user management, notifications, and many code examples.
Use it to &lt;a href=&quot;https://ocsigen.org/tuto/latest/manual/start&quot;&gt;learn Web/mobile development in OCaml&lt;/a&gt; or to quickly create your own Minimum Viable Product.
&lt;a href=&quot;https://ocsigen-1.inria.fr/ocsigen-start/demo/&quot;&gt;See an online demo&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;Last features include:&lt;/p&gt;
&lt;ul&gt;
  &lt;li&gt;Get rid of all remaining Camlp4 code&lt;/li&gt;
  &lt;li&gt;compatibility with OCaml 4.09&lt;/li&gt;
&lt;/ul&gt;

</content><id>tag:ocsigen.github.io,2020-01-20:/blog/2020/01/20/release</id><title type="text">Ocsigen Start updated</title><updated>2020-01-20T00:00:00-00:00</updated><author><name>The Ocsigen Team</name></author></entry><entry><source><updated>2020-03-23T08:47:03-00:00</updated><logo>http://www.ocamlpro.com/wp-content/uploads/2018/02/apple-touch-icon-152x152-150x150.png</logo><link title="OCamlPro" type="text/html" href="http://www.ocamlpro.com" rel="related"/><link title="OCamlPro" type="application/rss+xml" href="http://www.ocamlpro.com/feed/" rel="self"/><generator>https://wordpress.org/?v=4.9.13</generator><id>http://www.ocamlpro.com</id><title type="text">OCamlPro</title><author><name>OCamlPro</name></author></source><link href="http://www.ocamlpro.com/2020/01/16/opam-2-0-6-release/" rel="alternate"/><link href="http://www.ocamlpro.com/2020/01/16/opam-2-0-6-release/#respond" rel="related"/><content xml:base="http://www.ocamlpro.com/feed/" type="html">&lt;p&gt;We are pleased to announce the minor release of &lt;a href=&quot;https://github.com/ocaml/opam/releases/tag/2.0.6&quot;&gt;opam 2.0.6&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;This new version contains some small &lt;a href=&quot;https://github.com/ocaml/opam/pull/3973&quot;&gt;backported&lt;/a&gt; fixes and build update:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Don’t remove git cache objects that may be used [&lt;a href=&quot;https://github.com/ocaml/opam/pull/3831&quot;&gt;#3831&lt;/a&gt; &lt;a href=&quot;https://github.com/AltGr&quot;&gt;@AltGr&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;Don’t include .gitattributes in index.tar.gz [&lt;a href=&quot;https://github.com/ocaml/opam/pull/3873&quot;&gt;#3873&lt;/a&gt; &lt;a href=&quot;https://github.com/dra27&quot;&gt;@dra27&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;Update FAQ uri [&lt;a href=&quot;https://github.com/ocaml/opam/pull/3941&quot;&gt;#3941&lt;/a&gt; &lt;a href=&quot;https://github.com/dra27&quot;&gt;@dra27&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;Lock: add warning in case of missing locked file [&lt;a href=&quot;https://github.com/ocaml/opam/pull/3939&quot;&gt;#3939&lt;/a&gt; &lt;a href=&quot;https://github.com/rjbou&quot;&gt;@rjbou&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;Directory tracking: fix cached entries retrieving with precise tracking [&lt;a href=&quot;https://github.com/ocaml/opam/pull/4038&quot;&gt;#4038&lt;/a&gt; &lt;a href=&quot;https://github.com/hannesm&quot;&gt;@hannesm&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;Build:
&lt;ul&gt;
&lt;li&gt;Add sanity checks [&lt;a href=&quot;https://github.com/ocaml/opam/pull/3934&quot;&gt;#3934&lt;/a&gt; &lt;a href=&quot;https://github.com/dra27&quot;&gt;@dra27&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;Build man pages using dune [&lt;a href=&quot;https://github.com/ocaml/opam/issues/3902&quot;&gt;#3902&lt;/a&gt;] #dra27]&lt;/li&gt;
&lt;li&gt;Add patch and bunzip check for make cold [&lt;a href=&quot;https://github.com/ocaml/opam/pull/4006&quot;&gt;#4006&lt;/a&gt; &lt;a href=&quot;https://github.com/rjbou&quot;&gt;@rjbou&lt;/a&gt; &amp;#8211; fix &lt;a href=&quot;https://github.com/ocaml/opam/issues/3842&quot;&gt;#3842&lt;/a&gt;]&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Shell:
&lt;ul&gt;
&lt;li&gt;fish: add colon for fish manpath [&lt;a href=&quot;https://github.com/ocaml/opam/pull/3886&quot;&gt;#3886&lt;/a&gt; &lt;a href=&quot;https://github.com/rjbou&quot;&gt;@rjbou&lt;/a&gt; &amp;#8211; fix &lt;a href=&quot;https://github.com/ocaml/opam/issues/3878&quot;&gt;#3878&lt;/a&gt;]&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;Sandbox:
&lt;ul&gt;
&lt;li&gt;Add dune cache as rw [&lt;a href=&quot;https://github.com/ocaml/opam/pull/4019&quot;&gt;#4019&lt;/a&gt; &lt;a href=&quot;https://github.com/rjbou&quot;&gt;@rjbou&lt;/a&gt; &amp;#8211; fix &lt;a href=&quot;https://github.com/ocaml/opam/issues/4012&quot;&gt;#4012&lt;/a&gt;]&lt;/li&gt;
&lt;li&gt;Do not fail if $HOME/.ccache is missing [&lt;a href=&quot;https://github.com/ocaml/opam/pull/3957&quot;&gt;#3957&lt;/a&gt; &lt;a href=&quot;https://github.com/mseri&quot;&gt;@mseri&lt;/a&gt;]&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;opam-devel file: avoid copying extraneous files in opam-devel example [&lt;a href=&quot;https://github.com/ocaml/opam/pull/3999&quot;&gt;#3999&lt;/a&gt; &lt;a href=&quot;https://github.com/maroneze&quot;&gt;@maroneze&lt;/a&gt;]&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;As &lt;strong&gt;sandbox scripts&lt;/strong&gt; have been updated, don’t forget to run &lt;code&gt;opam init --reinit -ni&lt;/code&gt; to update yours.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Note: To homogenise macOS name on system detection, we decided to keep &lt;code&gt;macos&lt;/code&gt;, and convert &lt;code&gt;darwin&lt;/code&gt; to &lt;code&gt;macos&lt;/code&gt; in opam. For the moment, to not break jobs &amp;amp; CIs, we keep uploading &lt;code&gt;darwin&lt;/code&gt; &amp;amp; &lt;code&gt;macos&lt;/code&gt; binaries, but from the 2.1.0 release, only &lt;code&gt;macos&lt;/code&gt; ones will be kept.&lt;/p&gt;&lt;/blockquote&gt;
&lt;hr /&gt;
&lt;p&gt;Installation instructions (unchanged):&lt;/p&gt;
&lt;ol type=&quot;1&quot;&gt;
&lt;li&gt;From binaries: run
&lt;pre&gt;&lt;code&gt;sh &amp;lt;(curl -sL https://raw.githubusercontent.com/ocaml/opam/master/shell/install.sh)&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;or download manually from &lt;a href=&quot;https://github.com/ocaml/opam/releases/tag/2.0.6&quot;&gt;the Github “Releases” page&lt;/a&gt; to your PATH. In this case, don’t forget to run &lt;code&gt;opam init --reinit -ni&lt;/code&gt; to enable sandboxing if you had version 2.0.0~rc manually installed or to update you sandbox script.&lt;/li&gt;
&lt;li&gt;From source, using opam:
&lt;pre&gt;&lt;code&gt;opam update; opam install opam-devel&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;(then copy the opam binary to your PATH as explained, and don’t forget to run &lt;code&gt;opam init --reinit -ni&lt;/code&gt; to enable sandboxing if you had version 2.0.0~rc manually installed or to update you sandbox script)&lt;/li&gt;
&lt;li&gt;From source, manually: see the instructions in the &lt;a href=&quot;https://github.com/ocaml/opam/tree/2.0.6#compiling-this-repo&quot;&gt;README&lt;/a&gt;.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;We hope you enjoy this new minor version, and remain open to &lt;a href=&quot;https://github.com/ocaml/opam/issues&quot;&gt;bug reports&lt;/a&gt; and &lt;a href=&quot;https://github.com/ocaml/opam/issues&quot;&gt;suggestions&lt;/a&gt;.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;NOTE: this article is cross-posted on &lt;a href=&quot;https://opam.ocaml.org/blog/&quot;&gt;opam.ocaml.org&lt;/a&gt; and &lt;a href=&quot;http://www.ocamlpro.com/category/blog/&quot;&gt;ocamlpro.com&lt;/a&gt;. Please head to the latter for the comments!&lt;/p&gt;
&lt;div class=&quot;c-message_kit__gutter__right&quot; data-qa=&quot;message_content&quot;&gt;
&lt;div class=&quot;c-message_kit__blocks c-message_kit__blocks--rich_text&quot;&gt;
&lt;div class=&quot;c-message__message_blocks c-message__message_blocks--rich_text&quot;&gt;
&lt;div class=&quot;p-block_kit_renderer&quot; data-qa=&quot;block-kit-renderer&quot;&gt;
&lt;div class=&quot;p-block_kit_renderer__block_wrapper p-block_kit_renderer__block_wrapper--first&quot;&gt;
&lt;div class=&quot;p-rich_text_block&quot; dir=&quot;auto&quot;&gt;
&lt;div class=&quot;p-rich_text_section&quot;&gt;If you need more opam in your life, &lt;a href=&quot;http://www.ocamlpro.com/wp-content/uploads/2019/11/ocaml-opam.pdf&quot;&gt;print our cheat sheet&lt;/a&gt;!&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;/blockquote&gt;
</content><category term="OPAM"/><id>http://www.ocamlpro.com/?p=2318</id><title type="text">opam 2.0.6 release</title><updated>2020-01-16T14:47:58-00:00</updated><author><name>OCamlPro</name></author></entry><entry><source><updated>2020-01-16T00:00:00-00:00</updated><link href="https://opam.ocaml.org/blog/feed.xml" rel="self"/><contributor><uri>mailto:raja.boujbel(%C3%A0)ocamlpro.com</uri><name>{ Raja Boujbel - OCamlPro, Louis Gesbert - OCamlPro }</name></contributor><contributor><uri>mailto:louis.gesbert(%C3%A0)ocamlpro.com</uri><name>{ Louis Gesbert - OCamlPro }</name></contributor><contributor><uri>mailto:David.Allsopp(%C3%A0)cl.cam.ac.uk</uri><name>{ David Allsopp }</name></contributor><contributor><uri>mailto:louis.gesbert(%C3%A0)ocamlpro.com</uri><name>{ Louis Gesbert }</name></contributor><contributor><uri>http://anil.recoil.org</uri><name>{ Anil Madhavapeddy, Louis Gesbert }</name></contributor><contributor><uri>mailto:louis.gesbert(%C3%A0)ocamlpro.com</uri><name>{ Louis Gesbert, Hannes Mehnert }</name></contributor><contributor><uri>https://opam.ocaml.org</uri><name>{ OCaml Platform Team }</name></contributor><contributor><uri>http://dave.recoil.org/</uri><name>{ Dave Scott }</name></contributor><contributor><uri>http://gazagnaire.org</uri><name>{ Thomas Gazagnaire }</name></contributor><contributor><uri>https://github.com/def-lkb</uri><name>{ Frederic Bour, Thomas Refis }</name></contributor><contributor><uri>http://roscidus.com/blog/</uri><name>{ Thomas Leonard }</name></contributor><contributor><uri>https://github.com/diml</uri><name>{ Jérémie Dimino }</name></contributor><contributor><uri>http://ocamlpro.com</uri><name>{ Louis Gesbert }</name></contributor><contributor><uri>http://ocamlpro.com</uri><name>{ Thomas Gazagnaire }</name></contributor><id>https://opam.ocaml.org/blog/</id><title type="text">The OCaml Platform Blog</title><author><name>OCaml Platform</name></author><author><uri>https://opam.ocaml.org/</uri><name>The OCaml Platform Team</name></author></source><link type="text/html" href="https://opam.ocaml.org/blog/opam-2-0-6/" rel="alternate"/><link href="https://opam.ocaml.org/blog/opam-2-0-6/" rel="self"/><content xml:base="http://opam.ocaml.org/blog/feed.xml" type="xhtml"><div xmlns="http://www.w3.org/1999/xhtml">

<p>We are pleased to announce the minor release of <a href="https://github.com/ocaml/opam/releases/tag/2.0.6">opam 2.0.6</a>.</p>
<p>This new version contains some small <a href="https://github.com/ocaml/opam/pull/3973">backported</a> fixes and build update:</p>
<ul><li>Don't remove git cache objects that may be used [<a href="https://github.com/ocaml/opam/pull/3831">#3831</a> <a href="https://github.com/AltGr">@AltGr</a>]</li><li>Don't include .gitattributes in index.tar.gz [<a href="https://github.com/ocaml/opam/pull/3873">#3873</a> <a href="https://github.com/dra27">@dra27</a>]</li><li>Update FAQ uri [<a href="https://github.com/ocaml/opam/pull/3941">#3941</a> <a href="https://github.com/dra27">@dra27</a>]</li><li>Lock: add warning in case of missing locked file [<a href="https://github.com/ocaml/opam/pull/3939">#3939</a> <a href="https://github.com/rjbou">@rjbou</a>]</li><li>Directory tracking: fix cached entries retrieving with precise
 tracking [<a href="https://github.com/ocaml/opam/pull/4038">#4038</a> <a href="https://github.com/hannesm">@hannesm</a>]</li><li>Build:<ul><li>Add sanity checks [<a href="https://github.com/ocaml/opam/pull/3934">#3934</a> <a href="https://github.com/dra27">@dra27</a>]</li><li>Build man pages using dune [<a href="https://github.com/ocaml/opam/issues/3902">#3902</a> ]</li><li>Add patch and bunzip check for make cold [<a href="https://github.com/ocaml/opam/pull/4006">#4006</a> <a href="https://github.com/rjbou">@rjbou</a> - fix <a href="https://github.com/ocaml/opam/issues/3842">#3842</a>]</li></ul></li><li>Shell:<ul><li>fish: add colon for fish manpath [<a href="https://github.com/ocaml/opam/pull/3886">#3886</a> <a href="https://github.com/rjbou">@rjbou</a> - fix <a href="https://github.com/ocaml/opam/issues/3878">#3878</a>]</li></ul></li><li>Sandbox:<ul><li>Add dune cache as rw [<a href="https://github.com/ocaml/opam/pull/4019">#4019</a> <a href="https://github.com/rjbou">@rjbou</a> - fix <a href="https://github.com/ocaml/opam/issues/4012">#4012</a>]</li><li>Do not fail if $HOME/.ccache is missing [<a href="https://github.com/ocaml/opam/pull/3957">#3957</a> <a href="https://github.com/mseri">@mseri</a>]</li></ul></li><li>opam-devel file: avoid copying extraneous files in opam-devel example [<a href="https://github.com/ocaml/opam/pull/3999">#3999</a> <a href="https://github.com/maroneze">@maroneze</a>]</li></ul>

<p>As <strong>sandbox scripts</strong> have been updated, don't forget to run <code>opam init --reinit -ni</code> to update yours.</p>
<blockquote><p>Note: To homogenise macOS name on system detection, we decided to keep <code>macos</code>, and convert <code>darwin</code> to <code>macos</code> in opam. For the moment, to not break jobs &amp; CIs, we keep uploading <code>darwin</code> &amp; <code>macos</code> binaries, but from the 2.1.0 release, only <code>macos</code> ones will be kept.</p>
</blockquote>

<p><hr/>Installation instructions (unchanged):</p>
<ol><li><p>From binaries: run</p>
<pre><code>sh &lt;(curl -sL https://raw.githubusercontent.com/ocaml/opam/master/shell/install.sh)</code></pre>

<p>or download manually from <a href="https://github.com/ocaml/opam/releases/tag/2.0.6">the Github &quot;Releases&quot; page</a> to your PATH. In this case, don't forget to run <code>opam init --reinit -ni</code> to enable sandboxing if you had version 2.0.0~rc manually installed or to update you sandbox script.</p>
</li><li><p>From source, using opam:</p>
<pre><code>opam update; opam install opam-devel</code></pre>

<p>(then copy the opam binary to your PATH as explained, and don't forget to run <code>opam init --reinit -ni</code> to enable sandboxing if you had version 2.0.0~rc manually installed or to update you sandbox script)</p>
</li><li><p>From source, manually: see the instructions in the <a href="https://github.com/ocaml/opam/tree/2.0.6#compiling-this-repo">README</a>.</p>
</li></ol>

<p>We hope you enjoy this new minor version, and remain open to <a href="https://github.com/ocaml/opam/issues">bug reports</a> and <a href="https://github.com/ocaml/opam/issues">suggestions</a>.</p>
<blockquote><p>NOTE: this article is cross-posted on <a href="https://opam.ocaml.org/blog/">opam.ocaml.org</a> and <a href="http://www.ocamlpro.com/category/blog/">ocamlpro.com</a>. Please head to the latter for the comments!</p>
</blockquote></div></content><id>https://opam.ocaml.org/blog/opam-2-0-6/</id><title type="text">opam 2.0.6 release</title><updated>2020-01-16T00:00:00-00:00</updated><author><uri>mailto:raja.boujbel(%C3%A0)ocamlpro.com</uri><name>Raja Boujbel - OCamlPro, Louis Gesbert - OCamlPro</name></author></entry><entry><source><updated>2020-01-08T20:00:00-00:00</updated><subtitle type="text">on building functional operating systems</subtitle><rights type="text">All rights reserved by the author</rights><link type="text/html" href="https://mirage.io/blog/" rel="alternate"/><link href="https://mirage.io/blog/atom.xml" rel="self"/><contributor><uri>https://www.lemonde.fr/signataires/damien-leloup/</uri><name>Damien Leloup</name></contributor><contributor><email>anil@recoil.org</email><uri>http://anil.recoil.org</uri><name>Anil Madhavapeddy</name></contributor><contributor><email>martin@lucina.net</email><uri>https://lucina.net/</uri><name>Martin Lucina</name></contributor><contributor><email>talex5@gmail.com</email><uri>http://roscidus.com/blog/</uri><name>Thomas Leonard</name></contributor><contributor><email>hm519@cam.ac.uk</email><uri>https://github.com/hannesm</uri><name>Hannes Mehnert</name></contributor><contributor><email>mindy.preston@cl.cam.ac.uk</email><uri>https://github.com/yomimono</uri><name>Mindy Preston</name></contributor><contributor><uri>https://linse.me</uri><name>Stefanie Schirmer</name></contributor><contributor><email>thomas@gazagnaire.org</email><uri>http://gazagnaire.org</uri><name>Thomas Gazagnaire</name></contributor><contributor><email>gg417@cl.cam.ac.uk</email><uri>https://github.com/GemmaG</uri><name>Gemma Gordon</name></contributor><contributor><email>drupyog@zoho.com</email><uri>https://github.com/drup</uri><name>Gabriel Radanne</name></contributor><contributor><email>djwillia@us.ibm.com</email><uri>https://github.com/djwillia</uri><name>Dan Williams</name></contributor><contributor><email>haesbaert@haesbaert.org</email><uri>http://www.haesbaert.org/</uri><name>Christiano Haesbaert</name></contributor><contributor><email>amirmc@gmail.com</email><uri>http://amirchaudhry.com</uri><name>Amir Chaudhry</name></contributor><contributor><email>david.mersinjak@cl.cam.ac.uk</email><uri>https://github.com/pqwy</uri><name>David Kaloper</name></contributor><contributor><email>dave@recoil.org</email><uri>http://dave.recoil.org/</uri><name>Dave Scott</name></contributor><contributor><email>jon@recoil.org</email><uri>http://jon.recoil.org</uri><name>Jon Ludlam</name></contributor><contributor><email>jeremy.yallop@cl.cam.ac.uk</email><uri>https://github.com/yallop</uri><name>Jeremy Yallop</name></contributor><contributor><email>mort@cantab.net</email><uri>http://mort.io/</uri><name>Richard Mortier</name></contributor><contributor><email>vb@luminar.eu.org</email><uri>https://github.com/vbmithr</uri><name>Vincent Bernardoff</name></contributor><contributor><email>raphlalou@gmail.com</email><uri>https://github.com/raphael-proust</uri><name>Raphael Proust</name></contributor><id>https://mirage.io/blog/</id><title type="text">The MirageOS Blog</title><author><name>MirageOS</name></author></source><link type="text/html" href="https://mirage.io/blog/ccc-2019-leipzig" rel="alternate"/><content xml:base="https://mirage.io/blog/atom.xml" type="xhtml"><div xmlns="http://www.w3.org/1999/xhtml"><h1 id="Hackers-and-climate-activists-join-forces-in-Leipzig">Hackers and climate activists join forces in Leipzig</h1>

<p><em>By Damien Leloup, special correspondent, Le Monde. Originally <a href="https://www.lemonde.fr/pixels/article/2019/12/30/a-leipzig-hackers-et-militants-pour-le-climat-font-front-commun_6024362_4408996.html">published</a> by Le Monde on December 30, 2019. English translation by the MirageOS Core Team.</em></p>
<p><strong>The Chaos Communication Congress, the world's largest self-managed event dedicated to IT security, hosted its 36th edition this weekend in Germany.</strong></p>
<p>In front of Leipzig station, around fifty students and high school students are gathered.  It's Sunday, but the local branch of the Fridays for Future movement, which organizes demonstrations on Fridays at the call of activist Greta Thunberg, made an exception to its usual calendar to take advantage of the presence, a few kilometers from there, of the Chaos Communication Congress (CCC).</p>
<p>Organized each year for thirty-six years, this gigantic gathering of hackers and activists - 18,000 participants, dozens of conference talks around the clock - invades the Leipzig convention center for four days, in an atmosphere that is both anarcho-libertarian and very family oriented.  For the first time, the slogan of the 2019 edition is devoted to the environment: “Resource exhaustion”, a reference both to a computer <a href="https://en.wikipedia.org/wiki/Resource_exhaustion_attack">attack technique</a> and to the preservation of the planet.</p>
<p><em>&quot;It makes sense: it's a major issue, and the environmental movement is a highlight of the year, isn't it?&quot;</em>, notes, hair dyed pink and megaphone in hand, Rune, one of the organizers of the event. <em>“In any case, we are very happy that the CCC opened its doors to us and supports us.&quot;</em></p>
<p>The conference program gave pride of place to ecological themes and organizations such as Fridays for Future or Extinction Rebellion. These themes were all features in the main talks.  The audience for the event, marked on the far left, is quite sensitive to environmental issues.  <a href="https://www.fridaysforfuture.org/">Fridays for Future's</a> review of the year was sold out;  the track where some scientists explained how they build their climate models was full and was not able to host all the attendees.</p>
<h2 id="Safety-of-power-plants-and-the-right-to-repair">Safety of power plants and the right to repair</h2>

<p>But if the CCC has given a lot of space to environmental issues, it has done it in its own way.  In this mecca of cyber-security, we could for example discover long lists of vulnerabilities affecting the on-board systems used to manage the turbines of power plants. <em>Do not</em> panic: <em>&quot;These flaws do not block a power plant, or cut the power of a city,&quot;</em> relativized Radu Motspan, the author of the study.  Some of them have been corrected;  for others, it is up to plant managers to carry out verifications.  The researcher and his associates produced a small turnkey guide to help them: <em>“No need to hire expensive consultants, you can do everything yourself.&quot;</em></p>
<p>This “do it yourself” spirit, omnipresent in hacker culture in general and at the CCC in particular, easily lends itself to an environmental translation.  The collective <a href="https://runder-tisch-reparatur.de/">Runder Tisch Reparatur</a>, which campaigns for the adoption at European level of a &quot;right to repair&quot;, was thus invited for the first time to the conference.  The philosophy of the movement, which aims above all to reduce the amount of waste produced by obsolescence whether or not it is programmed, is very similar to that of the free software movement, say Eduard and Erik, who run the stand of the association. <em>&quot;An object that you cannot repair does not really belong to you,&quot;</em> they believe, just as the promoters of free software believe that software that you cannot modify yourself deprives you of certain freedoms.</p>
<p>But the main issue, at the heart of many talks during the four days of the CCC, is that of the energy impact of the Internet.  No one in the aisles of the Leipzig congress center plans to reduce their use of the Internet;  but everyone concedes that the network consumes a lot of electricity unnecessarily, or uses too much fossil energy.  <em>&quot;There are simple things to do to improve the carbon footprint of a site or service,&quot;</em> said Chris Adams, environmental activist and member of the Green Web Foundation.  <em>“If your service uses Amazon Web Service [AWS, a very popular cloud service], you can choose the data center you want to use, for example.  The one assigned to you by default may be in a country that produces little renewable electricity and uses a lot of coal for its power plants… ”</em></p>
<p>Existing non-digital systems (like boilers) already have ways to function more efficiently, such as off-peak hours at night, when electricity is both cheaper and more eco-friendly. There are equivalent options for more modern, digital systems, for instance: Chris Adams advocates the use of the <a href="http://ceur-ws.org/Vol-2382/ICT4S2019_paper_28.pdf">Low Carbon Kubernetes Scheduler</a>, an orchestration tool which allows to optimise the power consumption of a server in order to reduce its environmental impact.</p>
<h2 id="Safety-and-minimum-consumption-get-the-best-of-both-worlds">Safety and minimum consumption, get the best of both worlds</h2>

<p>Despite everything, the “greenest” electricity remains that which we do not consume in the first place.  There too, promising solutions exist: <a href="https://hannes.nqsb.io/">Hannes Mehnert</a>, a German computer scientist, presented at the opening of the CCC the MirageOS project, an operating system for ultra-minimalist servers, coded in a language renowned for its lightness, and which runs each process in a dedicated virtual machine.  A radical approach - and reserved for connoisseurs - which allows the software to embed only the bare minimum of lines of code in each compiled version. <em>&quot;Reducing complexity mathematically reduces the number of calculation operations required,&quot;</em> explains Mehnert.  Result: <em>&quot;A carbon footprint that drops drastically, with ten times less computing power used by the processor, and up to twenty-five times less memory used&quot;</em>, according to his measurements.</p>
<p>Above all, and this is a strong argument at a conference dedicated to computer security, minimalism is also a real advantage in terms of potential vulnerabilities: the more compact the code is, the less it risks containing flaws or errors.  And such systems are also better protected and safer than more conventional systems, as they are not vulnerable to memory-safety issues.</p>
<p>But the collaboration between environmentalists and privacy advocates seemed much broader than just focusing on technical issues. That mix was everywhere: for instance the corridor walls had graffiti concerned with the the excessive consumption of CO2 on the planet close to others highlighting the fact that every human being generates, on average, 1.7 MB of data per second. The posters of the anarchist or anti-fascist movements were also mixed with the flyers of the collective Hackers against <a href="https://hacc.uber.space/Main_Page">Climate Change</a>, which attracted the curious with a joke typical of the place: <em>&quot;cli / mate crisis is real&quot;</em>, in reference to Club-Mate, an ubiquitous drink at the event.</p>
<p>This community of views between hackers and climate activists comes as little surprise in Germany, where both movements are very present, and even less in Leipzig, the flagship city of the former GDR where pre-Internet mass surveillance tools from the Stasi were also directed against environmental activists in the 1980s. Some environmental movements feel naturally close to the anarchist spirit of the German hackers of the Chaos Computer Club, which organizes the CCC: a talk by <a href="https://rebellion.earth/">Extinction Rebellion</a> detailed the security measures they took to ensure their privacy, and how they didn't depend on third-party tools from Facebook, Google or Amazon - responsible, in their eyes, both for mass surveillance and <em>green washing</em>.</p>
<p>However, in this atmosphere of global collaboration some questions remained unanswered.  In some specific cases, better IT security can also consume more resources.  A talk dedicated to encrypted messaging thus presented many tools which make it possible to reinforce the confidentiality of exchanges, but also require using more computing power, to encrypt or decrypt messages, or even request the sending of large quantities of data to scramble the origin or volume of a message.  This first CCC under the sign of environmental protection did not really address this contradiction - pending, perhaps, a next edition?</p>
</div></content><id>https://mirage.io/blog/ccc-2019-leipzig</id><title type="text">Hackers and climate activists join forces in Leipzig</title><updated>2020-01-08T20:00:00-00:00</updated><author><uri>https://www.lemonde.fr/signataires/damien-leloup/</uri><name>Damien Leloup</name></author></entry><entry><summary type="text">&lt;p&gt;A tutorial how to deploy authoritative name servers, let&amp;#39;s encrypt, and updating entries from unix services.&lt;/p&gt;
</summary><source><updated>2020-01-07T22:38:21-00:00</updated><link href="https://hannes.nqsb.io/atom" rel="self"/><id>urn:uuid:981361ca-e71d-4997-a52c-baeee78e4156</id><title type="text">full stack engineer</title><author><name>Hannes Mehnert</name></author></source><published>2019-12-23T21:30:53-00:00</published><link href="https://hannes.nqsb.io/Posts/DnsServer" rel="alternate"/><content xml:base="https://hannes.nqsb.io/atom" type="html">

&lt;h2 id=&quot;Goal&quot;&gt;Goal&lt;/h2&gt;

&lt;p&gt;Have your domain served by OCaml-DNS authoritative name servers. Data is stored in a git remote, and let&amp;#39;s encrypt certificates can be requested to DNS. This software is deployed since more than two years for several domains such as &lt;code&gt;nqsb.io&lt;/code&gt; and &lt;code&gt;robur.coop&lt;/code&gt;. This present the authoritative server side, and certificate library of the OCaml-DNS implementation formerly known as &lt;a href='/Posts/DNS'&gt;µDNS&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;Prerequisites&quot;&gt;Prerequisites&lt;/h2&gt;

&lt;p&gt;You need to own a domain, and be able to delegate the name service to your own servers.
You also need two spare public IPv4 addresses (in different /24 networks) for your name servers.
A git server or remote repository reachable via git over ssh.
Servers which support &lt;a href='https://github.com/solo5/solo5'&gt;solo5&lt;/a&gt; guests, and have the corresponding tender installed.
A computer with &lt;a href='https://opam.ocaml.org'&gt;opam&lt;/a&gt; (&amp;gt;= 2.0.0) installed.&lt;/p&gt;
&lt;h2 id=&quot;Data-preparation&quot;&gt;Data preparation&lt;/h2&gt;

&lt;p&gt;Figure out a way to get the DNS entries of your domain in a &lt;a href='https://tools.ietf.org/html/rfc1034'&gt;&amp;quot;master file format&amp;quot;&lt;/a&gt;, i.e. what bind uses.&lt;/p&gt;
&lt;p&gt;This is a master file for the &lt;code&gt;mirage&lt;/code&gt; domain, defining &lt;code&gt;$ORIGIN&lt;/code&gt; to avoid typing the domain name after each hostname (use &lt;code&gt;@&lt;/code&gt; if you need the domain name only; if you need to refer to a hostname in a different domain end it with a dot (&lt;code&gt;.&lt;/code&gt;), i.e. &lt;code&gt;ns2.foo.com.&lt;/code&gt;). The default time to live &lt;code&gt;$TTL&lt;/code&gt; is an hour (3600 seconds).
The zone contains a &lt;a href='https://tools.ietf.org/html/rfc1035#section-3.3.13'&gt;start of authority (&lt;code&gt;SOA&lt;/code&gt;) record&lt;/a&gt; containing the nameserver, hostmaster, serial, refresh, retry, expiry, and minimum.
Also, a single &lt;a href='https://tools.ietf.org/html/rfc1035#section-3.3.11'&gt;name server (&lt;code&gt;NS&lt;/code&gt;) record&lt;/a&gt; &lt;code&gt;ns1&lt;/code&gt; is specified with an accompanying &lt;a href='https://tools.ietf.org/html/rfc1035#section-3.4.1'&gt;address (&lt;code&gt;A&lt;/code&gt;) records&lt;/a&gt; pointing to their IPv4 address.&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;git-repo&amp;gt; cat mirage
$ORIGIN mirage.
$TTL 3600
@    SOA    ns1    hostmaster    1    86400    7200    1048576    3600
@    NS    ns1
ns1     A       127.0.0.1
www    A    1.1.1.1
git-repo&amp;gt; git add mirage &amp;amp;&amp;amp; git commit -m initial &amp;amp;&amp;amp; git push&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&quot;Installation&quot;&gt;Installation&lt;/h2&gt;

&lt;p&gt;On your development machine, you need to install various OCaml packages. You don&amp;#39;t need privileged access if common tools (C compiler, make, libgmp) are already installed. You have &lt;code&gt;opam&lt;/code&gt; installed.&lt;/p&gt;
&lt;p&gt;Let&amp;#39;s create a fresh &lt;code&gt;switch&lt;/code&gt; for the DNS journey:&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;$ opam init
$ opam update
$ opam switch create udns 4.09.0
# waiting a bit, a fresh OCaml compiler is getting bootstrapped
$ eval `opam env` #sets some environment variables&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The last command set environment variables in your current shell session, please use the same shell for the commands following (or run &lt;code&gt;eval $(opam env)&lt;/code&gt; in another shell and proceed in there - the output of &lt;code&gt;opam switch&lt;/code&gt; sohuld point to &lt;code&gt;udns&lt;/code&gt;).&lt;/p&gt;
&lt;h3 id=&quot;Validation-of-our-zonefile&quot;&gt;Validation of our zonefile&lt;/h3&gt;

&lt;p&gt;First let&amp;#39;s check that OCaml-DNS can parse our zonefile:&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;$ opam install dns-cli #installs ~/.opam/udns/bin/ozone and other binaries
$ ozone &amp;lt;git-repo&amp;gt;/mirage # see ozone --help
successfully checked zone&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Great. Error reporting is not great, but line numbers are indicated (&lt;code&gt;ozone: zone parse problem at line 3: syntax error&lt;/code&gt;), &lt;a href='https://github.com/mirage/ocaml-dns/tree/v4.2.0/zone'&gt;lexer and parser are lex/yacc style&lt;/a&gt; (PRs welcome).&lt;/p&gt;
&lt;p&gt;FWIW, &lt;code&gt;ozone&lt;/code&gt; accepts &lt;code&gt;--old &amp;lt;filename&amp;gt;&lt;/code&gt; to check whether an update from the old zone to the new is fine. This can be used as &lt;a href='https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks'&gt;pre-commit hook&lt;/a&gt; in your git repository to avoid bad parse states in your name servers.&lt;/p&gt;
&lt;h3 id=&quot;Getting-the-primary-up&quot;&gt;Getting the primary up&lt;/h3&gt;

&lt;p&gt;The next step is to compile the primary server and run it to serve the domain data. Since the git-via-ssh client is not yet released, we need to add a custom opam repository to this switch.&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;# git via ssh is not yet released, but this opam repository contains the branch information
$ opam repo add git-ssh git+https://github.com/roburio/git-ssh-dns-mirage3-repo.git
# get the `mirage` application via opam
$ opam install lwt mirage

# get the source code of the unikernels
$ git clone -b future https://github.com/roburio/unikernels.git
$ cd unikernels/primary-git

# let&amp;#39;s build the server first as unix application
$ mirage configure --prng fortuna #--no-depext if you have all system dependencies
$ make depend
$ make

# run it
$ ./primary_git
# starts a unix process which clones https://github.com/roburio/udns.git
# attempts to parse the data as zone files, and fails on parse error
$ ./primary-git --remote=https://my-public-git-repository
# this should fail with ENOACCESS since the DNS server tries to listen on port 53

# which requires a privileged user, i.e. su, sudo or doas
$ sudo ./primary-git --remote=https://my-public-git-repository
# leave it running, run the following programs in a different shell

# test it
$ host ns1.mirage 127.0.0.1
ns1.mirage has address 127.0.0.1
$ dig any mirage @127.0.0.1
# a DNS packet printout with all records available for mirage&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;That&amp;#39;s exciting, the DNS server serving answers from a remote git repository.&lt;/p&gt;
&lt;h3 id=&quot;Securing-the-git-access-with-ssh&quot;&gt;Securing the git access with ssh&lt;/h3&gt;

&lt;p&gt;Let&amp;#39;s authenticate the access by using ssh, so we feel ready to push data there as well. The primary-git unikernel already includes an experimental &lt;a href='https://github.com/haesbaert/awa-ssh'&gt;ssh client&lt;/a&gt;, all we need to do is setting up credentials - in the following a RSA keypair and the server fingerprint.&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;# collect the RSA host key fingerprint
$ ssh-keyscan &amp;lt;git-server&amp;gt; &amp;gt; /tmp/git-server-public-keys
$ ssh-keygen -l -E sha256 -f /tmp/git-server-public-keys | grep RSA
2048 SHA256:a5kkkuo7MwTBkW+HDt4km0gGPUAX0y1bFcPMXKxBaD0 &amp;lt;git-server&amp;gt; (RSA)
# we&amp;#39;re interested in the SHA256:yyy only

# generate a ssh keypair
$ awa_gen_key # installed by the make depend step above in ~/.opam/udns/bin
seed is pIKflD07VT2W9XpDvqntcmEW3OKlwZL62ak1EZ0m
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC5b2cSSkZ5/MAu7pM6iJLOaX9tJsfA8DB1RI34Zygw6FA0y8iisbqGCv6Z94ZxreGATwSVvrpqGo5p0rsKs+6gQnMCU1+sOC4PRlxy6XKgj0YXvAZcQuxwmVQlBHshuq0CraMK9FASupGrSO8/dW30Kqy1wmd/IrqW9J1Cnw+qf0C/VEhIbo7btlpzlYpJLuZboTvEk1h67lx1ZRw9bSPuLjj665yO8d0caVIkPp6vDX20EsgITdg+cFjWzVtOciy4ETLFiKkDnuzHzoQ4EL8bUtjN02UpvX2qankONywXhzYYqu65+edSpogx2TuWFDJFPHgcyO/ZIMoluXGNgQlP awa@awa.local
# please run your own awa_gen_key, don&amp;#39;t use the numbers above&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The public key needs is in standard OpenSSH format and needs to be added to the list of accepted keys on your server - the exact steps depend on your git server, if you&amp;#39;re running your own with &lt;a href='https://github.com/tv42/gitosis'&gt;gitosis&lt;/a&gt;, add it as new public key file and grant that key access to the data repository. If you use gitlab or github, you may want to create a new user account and with the generated key.&lt;/p&gt;
&lt;p&gt;The private key is not displayed, but only the seed required to re-generate it, when using the same random number generator, in our case &lt;a href='http://mirleft.github.io/ocaml-nocrypto/doc/Nocrypto.Rng.html'&gt;fortuna implemented by nocrypto&lt;/a&gt; - used by both &lt;code&gt;awa_gen_key&lt;/code&gt; and &lt;code&gt;primary_git&lt;/code&gt;. The seed is provided as command-line argument while starting &lt;code&gt;primary_git&lt;/code&gt;:&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;# execute with git over ssh, authenticator from ssh-keyscan, seed from awa_gen_key
$ ./primary_git --authenticator=SHA256:a5kkkuo7MwTBkW+HDt4km0gGPUAX0y1bFcPMXKxBaD0 --seed=pIKflD07VT2W9XpDvqntcmEW3OKlwZL62ak1EZ0m --remote=ssh://git@&amp;lt;git-server&amp;gt;/repo-name.git
# started up, you can try the host and dig commands from above if you like&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;To wrap up, we now have a primary authoritative name server for our zone running as Unix process, which clones a remote git repository via ssh on startup and then serves it.&lt;/p&gt;
&lt;h3 id=&quot;Authenticated-data-updates&quot;&gt;Authenticated data updates&lt;/h3&gt;

&lt;p&gt;Our remote git repository is the source of truth, if you need to add a DNS entry to the zone, you git pull, edit the zone file, remember to increase the serial in the SOA line, run &lt;code&gt;ozone&lt;/code&gt;, git commit and push to the repository.&lt;/p&gt;
&lt;p&gt;So, the &lt;code&gt;primary_git&lt;/code&gt; needs to be informed of git pushes. This requires a communication channel from the git server (or somewhere else, e.g. your laptop) to the DNS server. I prefer in-protocol solutions over adding yet another protocol stack, no way my DNS server will talk HTTP REST.&lt;/p&gt;
&lt;p&gt;The DNS protocol has an extension for &lt;a href='https://tools.ietf.org/html/rfc1996'&gt;notifications of zone changes&lt;/a&gt; (as a DNS packet), usually used between the primary and secondary servers. The &lt;code&gt;primary_git&lt;/code&gt; accepts these notify requests (i.e. bends the standard slightly), and upon receival pulls the remote git repository, and serves the fresh zone files. Since a git pull may be rather excessive in terms of CPU cycles and network bandwidth, only authenticated notifications are accepted.&lt;/p&gt;
&lt;p&gt;The DNS protocol specifies in another extension &lt;a href='https://tools.ietf.org/html/rfc2845'&gt;authentication (DNS TSIG)&lt;/a&gt; with transaction signatures on DNS packets including a timestamp and fudge to avoid replay attacks. As key material hmac secrets distribued to both the communication endpoints are used.&lt;/p&gt;
&lt;p&gt;To recap, the primary server is configured with command line parameters (for remote repository url and ssh credentials), and serves data from a zonefile. If the secrets would be provided via command line, a restart would be necessary for adding and removing keys. If put into the zonefile, they would be publicly served on request. So instead, we&amp;#39;ll use another file, still in zone file format, in the top-level domain &lt;code&gt;_keys&lt;/code&gt;, i.e. the &lt;code&gt;mirage._keys&lt;/code&gt; file contains keys for the &lt;code&gt;mirage&lt;/code&gt; zone. All files ending in &lt;code&gt;._keys&lt;/code&gt; are parsed with the normal parser, but put into an authentication store instead of the domain data store, which is served publically.&lt;/p&gt;
&lt;p&gt;For encoding hmac secrets into DNS zone file format, the &lt;a href='https://tools.ietf.org/html/rfc4034#section-2'&gt;&lt;code&gt;DNSKEY&lt;/code&gt;&lt;/a&gt; format is used (designed for DNSsec). The &lt;a href='https://www.isc.org/bind/'&gt;bind&lt;/a&gt; software comes with &lt;code&gt;dnssec-keygen&lt;/code&gt; and &lt;code&gt;tsig-keygen&lt;/code&gt; to generate DNSKEY output: flags is 0, protocol is 3, and algorithm identifier for SHA256 is 163 (SHA384 164, SHA512 165). This is reused by the OCaml DNS library. The key material itself is base64 encoded.&lt;/p&gt;
&lt;p&gt;Access control and naming of keys follows the DNS domain name hierarchy - a key has the form name._operation.domain, and has access granted to domain and all subdomains of it. Two operations are supported: update and transfer. In the future there may be a dedicated notify operation, for now we&amp;#39;ll use update. The name part is ignored for the update operation.&lt;/p&gt;
&lt;p&gt;Since we now embedd secret information in the git repository, it is a good idea to restrict access to it, i.e. make it private and not publicly cloneable or viewable. Let&amp;#39;s generate a first hmac secret and send a notify:&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;$ dd if=/dev/random bs=1 count=32 | b64encode -
begin-base64 644 -
kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg=
====
[..]
git-repo&amp;gt; echo &amp;quot;personal._update.mirage. DNSKEY 0 3 163 kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg=&amp;quot; &amp;gt; mirage._keys
git-repo&amp;gt; git add mirage._keys &amp;amp;&amp;amp; git commit -m &amp;quot;add hmac secret&amp;quot; &amp;amp;&amp;amp; git push

# now we need to restart the primary git to get the git repository with the key
$ ./primary_git --seed=... # arguments from above, remote git, host key fingerprint, private key seed

# now test that a notify results in a git pull
$ onotify 127.0.0.1 mirage --key=personal._update.mirage:SHA256:kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg=
# onotify was installed by dns-cli in ~/.opam/udns/bin/onotify, see --help for options
# further changes to the hmac secrets don&amp;#39;t require a restart anymore, a notify packet is sufficient :D&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ok, this onotify command line could be setup as a git post-commit hook, or run manually after each manual git push.&lt;/p&gt;
&lt;h3 id=&quot;Secondary&quot;&gt;Secondary&lt;/h3&gt;

&lt;p&gt;It&amp;#39;s time to figure out how to integrate the secondary name server. An already existing bind or something else that accepts notifications and issues zone transfers with hmac-sha256 secrets should work out of the box. If you encounter interoperability issues, please get in touch with me.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;secondary&lt;/code&gt; subdirectory of the cloned &lt;code&gt;unikernels&lt;/code&gt; repository is another unikernel that acts as secondary server. It&amp;#39;s only command line argument is a list of hmac secrets used for authenticating that the received data originates from the primary server. Data is initially transferred by a &lt;a href='https://tools.ietf.org/html/rfc5936'&gt;full zone transfer (AXFR)&lt;/a&gt;, later updates (upon refresh timer or notify request sent by the primary) use &lt;a href='https://tools.ietf.org/html/rfc1995'&gt;incremental (IXFR)&lt;/a&gt;. Zone transfer requests and data are authenticated with transaction signatures again.&lt;/p&gt;
&lt;p&gt;Convenience by OCaml DNS is that transfer key names matter, and are of the form &amp;lt;primary-ip&amp;gt;.&amp;lt;secondary-ip&amp;gt;._transfer.domain, i.e. &lt;code&gt;1.1.1.1.2.2.2.2._transfer.mirage&lt;/code&gt; if the primary server is 1.1.1.1, and the secondary 2.2.2.2. Encoding the IP address in the name allows both parties to start the communication: the secondary starts by requesting a SOA for all domains for which keys are provided on command line, and if an authoritative SOA answer is received, the AXFR is triggered. The primary server emits notification requests on startup and then on every zone change (i.e. via git pull) to all secondary IP addresses of transfer keys present for the specific zone in addition to the notifications to the NS records in the zone.&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;$ cd ../secondary
$ mirage configure --prng fortuna
# make depend should not be needed since all packages are already installed by the primary-git
$ make
$ ./secondary&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;IP-addresses-and-routing&quot;&gt;IP addresses and routing&lt;/h3&gt;

&lt;p&gt;Both primary and secondary serve the data on the DNS port (53) on UDP and TCP. To run both on the same machine and bind them to different IP addresses, we&amp;#39;ll use a layer 2 network (ethernet frames) with a host system software switch (bridge interface &lt;code&gt;service&lt;/code&gt;), the unikernels as virtual machines (or seccomp-sandboxed) via the &lt;a href='https://github.com/solo5/solo5'&gt;solo5&lt;/a&gt; backend. Using xen is possible as well. As IP address range we&amp;#39;ll use 10.0.42.0/24, and the host system uses the 10.0.42.1.&lt;/p&gt;
&lt;p&gt;The primary git needs connectivity to the remote git repository, thus on a laptop in a private network we need network address translation (NAT) from the bridge where the unikernels speak to the Internet where the git repository resides.&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;# on FreeBSD:
# configure NAT with pf, you need to have forwarding enabled
$ sysctl net.inet.ip.forwarding: 1
$ echo &amp;#39;nat pass on wlan0 inet from 10.0.42.0/24 to any -&amp;gt; (wlan0)&amp;#39; &amp;gt;&amp;gt; /etc/pf.conf
$ service pf restart

# make tap interfaces UP on open()
$ sysctl net.link.tap.up_on_open: 1

# bridge creation, naming, and IP setup
$ ifconfig bridge create
bridge0
$ ifconfig bridge0 name service
$ ifconfig bridge0 10.0.42.1/24

# two tap interfaces for our unikernels
$ ifconfig tap create
tap0
$ ifconfig tap create
tap1
# add them to the bridge
$ ifconfig service addm tap0 addm tap1&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&quot;Primary-and-secondary-setup&quot;&gt;Primary and secondary setup&lt;/h3&gt;

&lt;p&gt;Let&amp;#39;s update our zone slightly to reflect the IP changes.&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;git-repo&amp;gt; cat mirage
$ORIGIN mirage.
$TTL 3600
@    SOA    ns1    hostmaster    2    86400    7200    1048576    3600
@    NS    ns1
@    NS    ns2
ns1     A       10.0.42.2
ns2    A    10.0.42.3

# we also need an additional transfer key
git-repo&amp;gt; cat mirage._keys
personal._update.mirage. DNSKEY 0 3 163 kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg=
10.0.42.2.10.0.42.3._transfer.mirage. DNSKEY 0 3 163 cDK6sKyvlt8UBerZlmxuD84ih2KookJGDagJlLVNo20=
git-repo&amp;gt; git commit -m &amp;quot;udpates&amp;quot; . &amp;amp;&amp;amp; git push&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Ok, the git repository is ready, now we need to compile the unikernels for the virtualisation target (see &lt;a href='https://mirage.io/wiki/hello-world#Building-for-Another-Backend'&gt;other targets&lt;/a&gt; for further information).&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;# back to primary
$ cd ../primary-git
$ mirage configure -t hvt --prng fortuna # or e.g. -t spt (and solo5-spt below)
# installs backend-specific opam packages, recompiles some
$ make depend
$ make
[...]
$ solo5-hvt --net:service=tap0 -- primary_git.hvt --ipv4=10.0.42.2/24 --ipv4-gateway=10.0.42.1 --seed=.. --authenticator=.. --remote=ssh+git://...
# should now run as a virtual machine (kvm, bhyve), and clone the git repository
$ dig any mirage @10.0.42.2
# should reply with the SOA and NS records, and also the name server address records in the additional section

# secondary
$ cd ../secondary
$ mirage configure -t hvt --prng fortuna
$ make
$ solo5-hvt --net:service=tap1 -- secondary.hvt --ipv4=10.0.42.3/24 --keys=10.0.42.2.10.0.42.3._transfer.mirage:SHA256:cDK6sKyvlt8UBerZlmxuD84ih2KookJGDagJlLVNo20=
# an ipv4-gateway is not needed in this setup, but in real deployment later
# it should start up and transfer the mirage zone from the primary

$ dig any mirage @10.0.42.3
# should now output the same information as from 10.0.42.2

# testing an update and propagation
# edit mirage zone, add a new record and increment the serial number
git-repo&amp;gt; echo &amp;quot;foo A 127.0.0.1&amp;quot; &amp;gt;&amp;gt; mirage
git-repo&amp;gt; vi mirage &amp;lt;- increment serial
git-repo&amp;gt; git commit -m &amp;#39;add foo&amp;#39; . &amp;amp;&amp;amp; git push
$ onotify 10.0.42.2 mirage --key=personal._update.mirage:SHA256:kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg=

# now check that it worked
$ dig foo.mirage @10.0.42.2 # primary
$ dig foo.mirage @10.0.42.3 # secondary got notified and transferred the zone&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You can also check the behaviour when restarting either of the VMs, whenever the primary is available the zone is synchronised. If the primary is down, the secondary still serves the zone. When the secondary is started while the primary is down, it won&amp;#39;t serve any data until the primary is online (the secondary polls periodically, the primary sends notifies on startup).&lt;/p&gt;
&lt;h3 id=&quot;Dynamic-data-updates-via-DNS-pushed-to-git&quot;&gt;Dynamic data updates via DNS, pushed to git&lt;/h3&gt;

&lt;p&gt;DNS is a rich protocol, and it also has builtin &lt;a href='https://tools.ietf.org/html/rfc2136'&gt;updates&lt;/a&gt; that are supported by OCaml DNS, again authenticated with hmac-sha256 and shared secrets. Bind provides the command-line utility &lt;code&gt;nsupdate&lt;/code&gt; to send these update packets, a simple &lt;code&gt;oupdate&lt;/code&gt; unix utility is available as well (i.e. for integration of dynamic DNS clients). You know the drill, add a shared secret to the primary, git push, notify the primary, and voila we can dynamically in-protocol update. An update received by the primary via this way will trigger a git push to the remote git repository, and notifications to the secondary servers as described above.&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;# being lazy, I reuse the key above
$ oupdate 10.0.42.2 personal._update.mirage:SHA256:kJJqipaQHQWqZL31Raar6uPnepGFIdtpjkXot9rv2xg= my-other.mirage 1.2.3.4

# let&amp;#39;s observe the remote git
git-repo&amp;gt; git pull
# there should be a new commit generated by the primary
git-repo&amp;gt; git log

# test it, should return 1.2.3.4
$ dig my-other.mirage @10.0.42.2
$ dig my-other.mirage @10.0.42.3&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So we can deploy further &lt;code&gt;oupdate&lt;/code&gt; (or &lt;code&gt;nsupdate&lt;/code&gt;) clients, distribute hmac secrets, and have the DNS zone updated. The source of truth is still the git repository, where the primary-git pushes to. Merge conflicts and timing of pushes is not yet dealt with. They are unlikely to happen since the primary is notified on pushes and should have up-to-date data in storage. Sorry, I&amp;#39;m unsure about the error semantics, try it yourself.&lt;/p&gt;
&lt;h3 id=&quot;Let-39-s-encrypt&quot;&gt;Let&amp;#39;s encrypt!&lt;/h3&gt;

&lt;p&gt;&lt;a href='https://letsencrypt.org/'&gt;Let&amp;#39;s encrypt&lt;/a&gt; is a certificate authority (CA), which certificate is shipped as trust anchor in web browsers. They specified a protocol for &lt;a href='https://tools.ietf.org/html/draft-ietf-acme-acme-05'&gt;automated certificate management environment (ACME)&lt;/a&gt;, used to get X509 certificates for your services. In the protocol, a certificate signing request (publickey and hostname) is sent to let&amp;#39;s encrypt servers, which sends a challenge to proof the ownership of the hostnames. One widely-used way to solve this challenge is running a web server, another is to serve it as text record from the authoritative DNS server.&lt;/p&gt;
&lt;p&gt;Since I avoid persistent storage when possible, and also don&amp;#39;t want to integrate a HTTP client stack in the primary server, I developed a third unikernel that acts as (hidden) secondary server, performs the tedious HTTP communication with let&amp;#39;s encrypt servers, and stores all data in the public DNS zone.&lt;/p&gt;
&lt;p&gt;For encoding of certificates, the DANE working group specified &lt;a href='https://tools.ietf.org/html/rfc6698.html#section-7.1'&gt;TLSA&lt;/a&gt; records in DNS. They are quadruples of usage, selector, matching type, and ASN.1 DER-encoded material. We set usage to 3 (domain-issued certificate), matching type to 0 (no hash), and selector to 0 (full certificate) or 255 (private usage) for certificate signing requests. The interaction is as follows:&lt;/p&gt;
&lt;ol&gt;&lt;li&gt;Primary, secondary, and let&amp;#39;s encrypt unikernels are running&lt;/li&gt;&lt;li&gt;A service (&lt;code&gt;ocertify&lt;/code&gt;, &lt;code&gt;unikernels/certificate&lt;/code&gt;, or the &lt;code&gt;dns-certify.mirage&lt;/code&gt; library) demands a TLS certificate, and has a hmac-secret for the primary DNS&lt;/li&gt;&lt;li&gt;The service generates a certificate signing request with the desired hostname(s), and performs an nsupdate with TLSA 255 &amp;lt;DER encoded signing-request&amp;gt;&lt;/li&gt;&lt;li&gt;The primary accepts the update, pushes the new zone to git, and sends notifies to secondary and let&amp;#39;s encrypt unikernels which (incrementally) transfer the zone&lt;/li&gt;&lt;li&gt;The let&amp;#39;s encrypt unikernel notices while transferring the zone a signing request without a certificate, starts HTTP interaction with let&amp;#39;s encrypt&lt;/li&gt;&lt;li&gt;The let&amp;#39;s encrypt unikernel solves the challenge, sends the response as update of a TXT record to the primary nameserver&lt;/li&gt;&lt;li&gt;The primary pushes the TXT record to git, and notifies secondaries (which transfer the zone)&lt;/li&gt;&lt;li&gt;The let&amp;#39;s encrypt servers request the TXT record from either or both authoritative name servers&lt;/li&gt;&lt;li&gt;The let&amp;#39;s encrypt unikernel polls for the issued certificate and send an update to the primary TLSA 0 &amp;lt;DER encoded certificate&amp;gt;&lt;/li&gt;&lt;li&gt;The primary pushes the certificate to git, notifies secondaries (which transfer the zone)&lt;/li&gt;&lt;li&gt;The service polls TLSA records for the hostname, and use it upon retrieval&lt;/li&gt;&lt;/ol&gt;

&lt;p&gt;Note that neither the signing request nor the certificate contain private key material, thus it is fine to serve them publically. Please also note, that the service polls for the certificate for the hostname in DNS, which is valid (start and end date) certificate and uses the same public key, this certificate is used and steps 3-10 are not executed.&lt;/p&gt;
&lt;p&gt;The let&amp;#39;s encrypt unikernel does not serve anything, it is a reactive system which acts upon notification from the primary. Thus, it can be executed in a private address space (with a NAT). Since the OCaml DNS server stack needs to push notifications to it, it preserves all incoming signed SOA requests as candidates for notifications on update. The let&amp;#39;s encrypt unikernel ensures to always have a connection to the primary to receive notifications.&lt;/p&gt;
&lt;pre class='shell'&gt;&lt;code class='shell'&gt;# getting let&amp;#39;s encrypt up and running
$ cd ../lets-encrypt
$ mirage configure -t hvt --prng fortuna
$ make depend
$ make

# run it
$ solo5-hvt --net:service=tap2 -- letsencrypt.hvt --keys=...

# test it
$ ocertify 10.0.42.2 foo.mirage&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;For actual testing with let&amp;#39;s encrypt servers you need to have the primary and secondary deployed on your remote hosts, and your domain needs to be delegated to these servers. Good luck. And ensure you have backup your git repository.&lt;/p&gt;
&lt;p&gt;As fine print, while this tutorial was about the &lt;code&gt;mirage&lt;/code&gt; zone, you can stick any number of zones into the git repository. If you use a &lt;code&gt;_keys&lt;/code&gt; file (without any domain prefix), you can configure hmac secrets for all zones, i.e. something to use in your let&amp;#39;s encrypt unikernel and secondary unikernel. Dynamic addition of zones is supported, just create a new zonefile and notify the primary, the secondary will be notified and pick it up. The primary responds to a signed SOA for the root zone (i.e. requested by the secondary) with the SOA response (not authoritative), and additionally notifications for all domains of the primary.&lt;/p&gt;
&lt;h3 id=&quot;Conclusion-and-thanks&quot;&gt;Conclusion and thanks&lt;/h3&gt;

&lt;p&gt;This tutorial presented how to use the OCaml DNS based unikernels to run authoritative name servers for your domain, using a git repository as the source of truth, dynamic authenticated updates, and let&amp;#39;s encrypt certificate issuing.&lt;/p&gt;
&lt;p&gt;There are further steps to take, such as monitoring -- have a look at the &lt;code&gt;monitoring&lt;/code&gt; branch of the opam repository above, and the &lt;code&gt;future-robur&lt;/code&gt; branch of the unikernels repository above, which use a second network interface for reporting syslog and metrics to telegraf / influx / grafana. Some DNS features are still missing, most prominently DNSSec.&lt;/p&gt;
&lt;p&gt;I&amp;#39;d like to thank all people involved in this software stack, without other key components, including &lt;a href='https://github.com/mirage/ocaml-git'&gt;git&lt;/a&gt;, &lt;a href='https://irmin.io/'&gt;irmin 2.0&lt;/a&gt;, &lt;a href='https://github.com/mirleft/ocaml-nocrypto'&gt;nocrypto&lt;/a&gt;, &lt;a href='https://github.com/haesbaert/awa-ssh'&gt;awa-ssh&lt;/a&gt;, &lt;a href='https://github.com/mirage/ocaml-cohttp'&gt;cohttp&lt;/a&gt;, &lt;a href='https://github.com/solo5/sol5'&gt;solo5&lt;/a&gt;, &lt;a href='https://github.com/mirage/mirage'&gt;mirage&lt;/a&gt;, &lt;a href='https://github.com/mmaker/ocaml-letsencrypt'&gt;ocaml-letsencrypt&lt;/a&gt;, and more.&lt;/p&gt;
&lt;p&gt;If you want to support our work on MirageOS unikernels, please &lt;a href='https://robur.coop/Donate'&gt;donate to robur&lt;/a&gt;. I&amp;#39;m interested in feedback, either via &lt;a href='https://twitter.com/h4nnes'&gt;twitter&lt;/a&gt;, &lt;a href='https://mastodon.social/@hannesm'&gt;hannesm@mastodon.social&lt;/a&gt; or an issue on the &lt;a href='https://github.com/hannesm/hannes.nqsb.io/issues'&gt;data repository&lt;/a&gt;.&lt;/p&gt;
</content><category scheme="https://hannes.nqsb.io/tags/mirageos" term="mirageos"/><category scheme="https://hannes.nqsb.io/tags/protocol" term="protocol"/><category scheme="https://hannes.nqsb.io/tags/deployment" term="deployment"/><id>urn:uuid:e3d4fd9e-e379-5c86-838e-46034ddd435d</id><title type="text">Deploying authoritative OCaml-DNS servers as MirageOS unikernels</title><updated>2019-12-24T13:02:58-00:00</updated><author><name>hannes</name></author></entry><entry><summary type="text">&lt;p&gt;MirageOS unikernels are reproducible :)&lt;/p&gt;
</summary><source><updated>2020-01-07T22:38:21-00:00</updated><link href="https://hannes.nqsb.io/atom" rel="self"/><id>urn:uuid:981361ca-e71d-4997-a52c-baeee78e4156</id><title type="text">full stack engineer</title><author><name>Hannes Mehnert</name></author></source><published>2019-12-16T18:29:30-00:00</published><link href="https://hannes.nqsb.io/Posts/ReproducibleOPAM" rel="alternate"/><content xml:base="https://hannes.nqsb.io/atom" type="html">

&lt;h2 id=&quot;Reproducible-builds-summit&quot;&gt;Reproducible builds summit&lt;/h2&gt;

&lt;p&gt;I&amp;#39;m just back from the &lt;a href='https://reproducible-builds.org/events/Marrakesh2019/'&gt;Reproducible builds summit 2019&lt;/a&gt;. In 2018, several people developing &lt;a href='https://ocaml.org'&gt;OCaml&lt;/a&gt; and &lt;a href='https://opam.ocaml.org'&gt;opam&lt;/a&gt; and &lt;a href='https://mirage.io'&gt;MirageOS&lt;/a&gt;, attended &lt;a href='https://reproducible-builds.org/events/paris2018/'&gt;the Reproducible builds summit in Paris&lt;/a&gt;. The notes from last year on &lt;a href='https://reproducible-builds.org/events/paris2018/report/#Toc11410_331763073'&gt;opam reproducibility&lt;/a&gt; and &lt;a href='https://reproducible-builds.org/events/paris2018/report/#Toc11681_331763073'&gt;MirageOS reproducibility&lt;/a&gt; are online. After last years workshop, Raja started developing the opam reproducibilty builder &lt;a href='https://github.com/rjbou/orb'&gt;orb&lt;/a&gt;, which I extended at and after this years summit. This year before and after the facilitated summit there were hacking days, which allowed further interaction with participants, writing some code and conduct experiments. I had this year again an exciting time at the summit and hacking days, thanks to our hosts, organisers, and all participants.&lt;/p&gt;
&lt;h2 id=&quot;Goal&quot;&gt;Goal&lt;/h2&gt;

&lt;p&gt;Stepping back a bit, first look on the &lt;a href='https://reproducible-builds.org/'&gt;goal of reproducible builds&lt;/a&gt;: when compiling source code multiple times, the produced binaries should be identical. It should be sufficient if the binaries are behaviourally equal, but this is pretty hard to check. It is much easier to check &lt;strong&gt;bit-wise identity of binaries&lt;/strong&gt;, and relaxes the burden on the checker -- checking for reproducibility is reduced to computing the hash of the binaries. Let&amp;#39;s stick to the bit-wise identical binary definition, which also means software developers have to avoid non-determinism during compilation in their toolchains, dependent libraries, and developed code.&lt;/p&gt;
&lt;p&gt;A &lt;a href='https://reproducible-builds.org/docs/test-bench/'&gt;checklist&lt;/a&gt; of potential things leading to non-determinism has been written up by the reproducible builds project. Examples include recording the build timestamp into the binary, ordering of code and embedded data. The reproducible builds project also developed &lt;a href='https://packages.debian.org/sid/disorderfs'&gt;disorderfs&lt;/a&gt; for testing reproducibility and &lt;a href='https://diffoscope.org/'&gt;diffoscope&lt;/a&gt; for comparing binaries with file-dependent readers, falling back to &lt;code&gt;objdump&lt;/code&gt; and &lt;code&gt;hexdump&lt;/code&gt;. A giant &lt;a href='https://tests.reproducible-builds.org/'&gt;test infrastructure&lt;/a&gt; with &lt;a href='https://tests.reproducible-builds.org/debian/index_variations.html'&gt;lots of variations&lt;/a&gt; between the builds, mostly using Debian, has been setup over the years.&lt;/p&gt;
&lt;p&gt;Reproducibility is a precondition for trustworthy binaries. See &lt;a href='https://reproducible-builds.org/#why-does-it-matter'&gt;why does it matter&lt;/a&gt;. If there are no instructions how to get from the published sources to the exact binary, why should anyone trust and use the binary which claims to be the result of the sources? It may as well contain different code, including a backdoor, bitcoin mining code, outputting the wrong results for specific inputs, etc. Reproducibility does not imply the software is free of security issues or backdoors, but instead of a audit of the binary - which is tedious and rarely done - the source code can be audited - but the toolchain (compiler, linker, ..) used for compilation needs to be taken into account, i.e. trusted or audited to not be malicious. &lt;strong&gt;I will only ever publish binaries if they are reproducible&lt;/strong&gt;.&lt;/p&gt;
&lt;p&gt;My main interest at the summit was to enhance existing tooling and conduct some experiments about the reproducibility of &lt;a href='https://mirage.io'&gt;MirageOS unikernels&lt;/a&gt; -- a unikernel is a statically linked ELF binary to be run as Unix process or &lt;a href='https://github.com/solo5/solo5'&gt;virtual machine&lt;/a&gt;. MirageOS heavily uses &lt;a href='https://ocaml.org'&gt;OCaml&lt;/a&gt; and &lt;a href='https://opam.ocaml.org'&gt;opam&lt;/a&gt;, the OCaml package manager, and is an opam package itself. Thus, &lt;em&gt;checking reproducibility of a MirageOS unikernel is the same problem as checking reproducibility of an opam package&lt;/em&gt;.&lt;/p&gt;
&lt;h2 id=&quot;Reproducible-builds-with-opam&quot;&gt;Reproducible builds with opam&lt;/h2&gt;

&lt;p&gt;Testing for reproducibility is achieved by taking the sources and compile them twice independently. Afterwards the equality of the resulting binaries can be checked. In trivial projects, the sources is just a single file, or originate from a single tarball. In OCaml, opam uses &lt;a href='https://github.com/ocaml/opam-repository'&gt;a community repository&lt;/a&gt; where OCaml developers publish their package releases to, but can also use custom repositores, and in addition pin packages to git remotes (url including branch or commit), or a directory on the local filesystem. Manually tracking and updating all dependent packages of a MirageOS unikernel is not feasible: our hello-world compiled for hvt (kvm/BHyve) already has 79 opam dependencies, including the OCaml compiler which is distribued as opam package. The unikernel serving this website depends on 175 opam packages.&lt;/p&gt;
&lt;p&gt;Conceptually there should be two tools, the &lt;em&gt;initial builder&lt;/em&gt;, which takes the latest opam packages which do not conflict, and exports exact package versions used during the build, as well as hashes of binaries. The other tool is a &lt;em&gt;rebuilder&lt;/em&gt;, which imports the export, conducts a build, and outputs the hashes of the produced binaries.&lt;/p&gt;
&lt;p&gt;Opam has the concept of a &lt;code&gt;switch&lt;/code&gt;, which is an environment where a package set is installed. Switches are independent of each other, and can already be exported and imported. Unfortunately the export is incomplete: if a package includes additional patches as part of the repository -- sometimes needed for fixing releases where the actual author or maintainer of a package responds slowly -- these package neither the patches end up in the export. Also, if a package is pinned to a git branch, the branch appears in the export, but this may change over time by pushing more commits or even force-pushing to that branch. In &lt;a href='https://github.com/ocaml/opam/pull/4040'&gt;PR #4040&lt;/a&gt; (under discussion and review), also developed during the summit, I propose to embed the additional files as base64 encoded values in the opam file. To solve the latter issue, I modified the export mechanism to &lt;a href='https://github.com/ocaml/opam/pull/4055'&gt;embed the git commit hash (PR #4055)&lt;/a&gt;, and avoid sources from a local directory and which do not have a checksum.&lt;/p&gt;
&lt;p&gt;So the opam export contains the information required to gather the exact same sources and build instructions of the opam packages. If the opam repository would be self-contained (i.e. not depend on any other tools), this would be sufficient. But opam does not run in thin air, it requires some system utilities such as &lt;code&gt;/bin/sh&lt;/code&gt;, &lt;code&gt;sed&lt;/code&gt;, a GNU make, commonly &lt;code&gt;git&lt;/code&gt;, a C compiler, a linker, an assembler. Since opam is available on various operating systems, the plugin &lt;code&gt;depext&lt;/code&gt; handles host system dependencies, e.g. if your opam package requires &lt;code&gt;gmp&lt;/code&gt; to be installed, this requires slightly different names depending on host system or distribution, take a look at &lt;a href='https://github.com/ocaml/opam-repository/blob/master/packages/conf-gmp/conf-gmp.1/opam'&gt;conf-gmp&lt;/a&gt;. This also means, opam has rather good information about both the opam dependencies and the host system dependencies for each package. Please note that the host system packages used during compilation are not yet recorded (i.e. which &lt;code&gt;gmp&lt;/code&gt; package was installed and used during the build, only that a &lt;code&gt;gmp&lt;/code&gt; package has to be installed). The base utilities mentioned above (C compiler, linker, shell) are also not recorded yet.&lt;/p&gt;
&lt;p&gt;Operating system information available in opam (such as architecture, distribution, version), which in some cases maps to exact base utilities, is recorded in the build-environment, a separate artifact. The environment variable &lt;a href='https://reproducible-builds.org/specs/source-date-epoch/'&gt;&lt;code&gt;SOURCE_DATE_EPOCH&lt;/code&gt;&lt;/a&gt;, used for communicating the same timestamp when software is required to record a timestamp into the resulting binary, is also captured in the build environment.&lt;/p&gt;
&lt;p&gt;Additional environment variables may be captured or used by opam packages to produce different output. To avoid this, both the initial builder and the rebuilder are run with minimal environment variables: only &lt;code&gt;PATH&lt;/code&gt; (normalised to a whitelist of &lt;code&gt;/bin&lt;/code&gt;, &lt;code&gt;/usr/bin&lt;/code&gt;, &lt;code&gt;/usr/local/bin&lt;/code&gt; and &lt;code&gt;/opt/bin&lt;/code&gt;) and &lt;code&gt;HOME&lt;/code&gt; are defined. Missing information at the moment includes CPU features: some libraries (gmp?, nocrypto) emit different code depending on the CPU feature.&lt;/p&gt;
&lt;h2 id=&quot;Tooling&quot;&gt;Tooling&lt;/h2&gt;

&lt;p&gt;&lt;em&gt;TL;DR: A &lt;strong&gt;build&lt;/strong&gt; builds an opam package, and outputs &lt;code&gt;.opam-switch&lt;/code&gt;, &lt;code&gt;.build-hashes.N&lt;/code&gt;, and &lt;code&gt;.build-environment.N&lt;/code&gt;. A &lt;strong&gt;rebuild&lt;/strong&gt; uses these artifacts as input, builds the package and outputs another &lt;code&gt;.build-hashes.M&lt;/code&gt; and &lt;code&gt;.build-environment.M&lt;/code&gt;.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;The command-line utility &lt;code&gt;orb&lt;/code&gt; can be installed and used:&lt;/p&gt;
&lt;pre class='sh'&gt;&lt;code class='sh'&gt;$ opam pin add orb git+https://github.com/hannesm/orb.git#active
$ orb build --twice --keep-build-dir --diffoscope &amp;lt;your-favourite-opam-package&amp;gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;It provides two subcommands &lt;code&gt;build&lt;/code&gt; and &lt;code&gt;rebuild&lt;/code&gt;. The &lt;code&gt;build&lt;/code&gt; command takes a list of local opam &lt;code&gt;--repos&lt;/code&gt; where to take opam packages from (defaults to &lt;code&gt;default&lt;/code&gt;), a compiler (either a variant &lt;code&gt;--compiler=4.09.0+flambda&lt;/code&gt;, a version &lt;code&gt;--compiler=4.06.0&lt;/code&gt;, or a pin to a local development version &lt;code&gt;--compiler-pin=~/ocaml&lt;/code&gt;), and optionally an existing switch &lt;code&gt;--use-switch&lt;/code&gt;. It creates a switch, builds the packages, and emits the opam export, hashes of all files installed by these packages, and the build environment. The flags &lt;code&gt;--keep-build&lt;/code&gt; retains the build products, opam&amp;#39;s &lt;code&gt;--keep-build-dir&lt;/code&gt; in addition temporary build products and generated source code. If &lt;code&gt;--twice&lt;/code&gt; is provided, a rebuild (described next) is executed after the initial build.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;rebuild&lt;/code&gt; command takes a directory with the opam export and build environment to build the opam package. It first compares the build-environment with the host system, sets the &lt;code&gt;SOURCE_DATE_EPOCH&lt;/code&gt; and switch location accordingly and executes the import. Once the build is finished, it compares the hashes of the resulting files with the previous run. On divergence, if build directories were kept in the previous build, and if diffoscope is available and &lt;code&gt;--diffoscope&lt;/code&gt; was provided, diffoscope is run on the diverging files. If &lt;code&gt;--keep-build-dir&lt;/code&gt; was provided as well, &lt;code&gt;diff -ur&lt;/code&gt; can be used to compare the temporary build and sources, including build logs.&lt;/p&gt;
&lt;p&gt;The builds are run in parallel, as opam does, this parallelism does not lead to different binaries in my experiments.&lt;/p&gt;
&lt;h2 id=&quot;Results-and-discussion&quot;&gt;Results and discussion&lt;/h2&gt;

&lt;p&gt;&lt;strong&gt;All MirageOS unikernels I have deployed are reproducible \o/&lt;/strong&gt;. Also, several binaries such as &lt;code&gt;orb&lt;/code&gt; itself, &lt;code&gt;opam&lt;/code&gt;, &lt;code&gt;solo5-hvt&lt;/code&gt;, and all &lt;code&gt;albatross&lt;/code&gt; utilities are reproducible.&lt;/p&gt;
&lt;p&gt;The unikernel range from hello world, web servers (e.g. this blog, getting its data on startup via a git clone to memory), authoritative DNS servers, CalDAV server. They vary in size between 79 and 200 opam packages, resulting in 2MB - 16MB big ELF binaries (including debug symbols). The &lt;a href='https://github.com/roburio/reproducible-unikernel-repo'&gt;unikernel opam repository&lt;/a&gt; contains some reproducible unikernels used for testing. Some work-in-progress enhancements are needed to achieve this:&lt;/p&gt;
&lt;p&gt;At the moment, the opam package of a MirageOS unikernel is automatically generated by &lt;code&gt;mirage configure&lt;/code&gt;, but only used for tracking opam dependencies. I worked on &lt;a href='https://github.com/mirage/mirage/pull/1022'&gt;mirage PR #1022&lt;/a&gt; to extend the generated opam package with build and install instructions.&lt;/p&gt;
&lt;p&gt;As mentioned above, if locale is set, ocamlgraph needs to be patched to emit a (locale-dependent) timestamp.&lt;/p&gt;
&lt;p&gt;The OCaml program &lt;a href='https://github.com/mirage/ocaml-crunch'&gt;&lt;code&gt;crunch&lt;/code&gt;&lt;/a&gt; embeds a subdirectory as OCaml code into a binary, which we use in MirageOS quite regularly for static assets, etc. This plays in several ways into reproducibility: on the one hand, it needs a timestamp for its &lt;code&gt;last_modified&lt;/code&gt; functionality (and adheres since &lt;a href='https://github.com/mirage/ocaml-crunch/pull/45'&gt;June 2018&lt;/a&gt; to the &lt;code&gt;SOURCE_DATE_EPOCH&lt;/code&gt; spec, thanks to Xavier Clerc). On the other hand, it used before version 3.2.0 (released Dec 14th) hashtables for storing the file contents, where iteration is not deterministic (the insertion is not sorted), &lt;a href='https://github.com/mirage/ocaml-crunch/pull/51'&gt;fixed in PR #51&lt;/a&gt; by using a Map instead.&lt;/p&gt;
&lt;p&gt;In functoria, a tool used to configure MirageOS devices and their dependencies, can emit a list of opam packages which were required to build the unikernel. This uses &lt;code&gt;opam list --required-by --installed --rec &amp;lt;pkgs&amp;gt;&lt;/code&gt;, which uses the cudf graph (&lt;a href='https://github.com/mirage/functoria/pull/189#issuecomment-566696426'&gt;thanks to Raja for explanation&lt;/a&gt;), that is during the rebuild dropping some packages. The &lt;a href='https://github.com/mirage/functoria/pull/189'&gt;PR #189&lt;/a&gt; avoids by not using the &lt;code&gt;--rec&lt;/code&gt; argument, but manually computing the fixpoint.&lt;/p&gt;
&lt;p&gt;Certainly, the choice of environment variables, and whether to vary them (as &lt;a href='https://tests.reproducible-builds.org/debian/index_variations.html'&gt;debian does&lt;/a&gt;) or to not define them (or normalise) while building, is arguably. Since MirageOS does neither support time zone nor internationalisation, there is no need to prematurely solving this issue. On related note, even with different locale settings, MirageOS unikernels are reproducible apart from an &lt;a href='https://github.com/backtracking/ocamlgraph/pull/90'&gt;issue in ocamlgraph #90&lt;/a&gt; embedding the output of &lt;a href='https://pubs.opengroup.org/onlinepubs/9699919799/utilities/date.html'&gt;&lt;code&gt;date&lt;/code&gt;&lt;/a&gt;, which is different depending on &lt;code&gt;LANG&lt;/code&gt; and locale (&lt;code&gt;LC_*&lt;/code&gt;) settings.&lt;/p&gt;
&lt;p&gt;Prior art in reproducible MirageOS unikernels is the &lt;a href='https://github.com/mirage/qubes-mirage-firewall/'&gt;mirage-qubes-firewall&lt;/a&gt;. Since &lt;a href='https://github.com/mirage/qubes-mirage-firewall/commit/07ff3d61477383860216c69869a1ffee59145e45'&gt;early 2017&lt;/a&gt; it is reproducible. Their approach is different by building in a docker container with the opam repository pinned to an exact git commit.&lt;/p&gt;
&lt;h2 id=&quot;Further-work&quot;&gt;Further work&lt;/h2&gt;

&lt;p&gt;I only tested a certain subset of opam packages and MirageOS unikernels, mainly on a single machine (my laptop) running FreeBSD, and am happy if others will test reproducibility of their OCaml programs with the tools provided. There could as well be CI machines rebuilding opam packages and reporting results to a central repository. I&amp;#39;m pretty sure there are more reproducibility issues in the opam ecosystem. I developed an &lt;a href='https://github.com/roburio/reproducible-testing-repo'&gt;reproducible testing opam repository&lt;/a&gt; with opam packages that do not depend on OCaml, mainly for further tooling development. Some tests were also conducted on a Debian system with the same result. The variations, apart from build time, were using a different user, and different locale settings.&lt;/p&gt;
&lt;p&gt;As mentioned above, more environment, such as the CPU features, and external system packages, should be captured in the build environment.&lt;/p&gt;
&lt;p&gt;When comparing OCaml libraries, some output files (cmt / cmti / cma / cmxa) are not deterministic, but contain minimal diverge where I was not able to spot the root cause. It would be great to fix this, likely in the OCaml compiler distribution. Since the final result, the binary I&amp;#39;m interested in, is not affected by non-identical intermediate build products, I hope someone (you?) is interested in improving on this side. OCaml bytecode output also seems to be non-deterministic. There is &lt;a href='https://github.com/coq/coq/issues/11229'&gt;a discussion on the coq issue tracker&lt;/a&gt; which may be related.&lt;/p&gt;
&lt;p&gt;In contrast to initial plans, I did not used the &lt;a href='https://reproducible-builds.org/specs/build-path-prefix-map/'&gt;&lt;code&gt;BUILD_PATH_PREFIX_MAP&lt;/code&gt;&lt;/a&gt; environment variable, which is implemented in OCaml by &lt;a href='https://github.com/ocaml/ocaml/pull/1515'&gt;PR #1515&lt;/a&gt; (and followups). The main reasons are that something in the OCaml toolchain (I suspect the bytecode interpreter) needed absolute paths to find libraries, thus I&amp;#39;d need a symlink from the left-hand side to the current build directory, which was tedious. Also, my installed assembler does not respect the build path prefix map, and BUILD_PATH_PREFIX_MAP is not widely supported. See e.g. the Debian &lt;a href='https://tests.reproducible-builds.org/debian/rb-pkg/unstable/amd64/diffoscope-results/ocaml-zarith.html'&gt;zarith&lt;/a&gt; package with different build paths and its effects on the binary.&lt;/p&gt;
&lt;p&gt;I&amp;#39;m fine with recording the build path (switch location) in the build environment for now - it turns out to end up only once in MirageOS unikernels, likely by the last linking step, which &lt;a href='http://blog.llvm.org/2019/11/deterministic-builds-with-clang-and-lld.html'&gt;hopefully soon be solved by llvm 9.0&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;What was fun was to compare the unikernel when built on Linux with gcc against a built on FreeBSD with clang and lld - spoiler: they emit debug sections with different dwarf versions, it is pretty big. Other fun differences were between OCaml compiler versions: the difference between minor versions (4.08.0 vs 4.08.1) is pretty small (~100kB as human-readable output), while the difference between major version (4.08.1 vs 4.09.0) is rather big (~900kB as human-readable diff).&lt;/p&gt;
&lt;p&gt;An item on my list for the future is to distribute the opam export, build hashes and build environment artifacts in a authenticated way. I want to integrate this as &lt;a href='https://in-toto.io/'&gt;in-toto&lt;/a&gt; style into &lt;a href='https://github.com/hannesm/conex'&gt;conex&lt;/a&gt;, my not-yet-deployed implementation of &lt;a href='https://theupdateframework.github.io/'&gt;tuf&lt;/a&gt; for opam that needs further development and a test installation, hopefully in 2020.&lt;/p&gt;
&lt;p&gt;If you want to support our work on MirageOS unikernels, please &lt;a href='https://robur.coop/Donate'&gt;donate to robur&lt;/a&gt;. I&amp;#39;m interested in feedback, either via &lt;a href='https://twitter.com/h4nnes'&gt;twitter&lt;/a&gt;, &lt;a href='https://mastodon.social/@hannesm'&gt;hannesm@mastodon.social&lt;/a&gt; or an issue on the &lt;a href='https://github.com/hannesm/hannes.nqsb.io/issues'&gt;data repository&lt;/a&gt;.&lt;/p&gt;
</content><category scheme="https://hannes.nqsb.io/tags/mirageos" term="mirageos"/><category scheme="https://hannes.nqsb.io/tags/security" term="security"/><category scheme="https://hannes.nqsb.io/tags/package%20signing" term="package signing"/><id>urn:uuid:09922d6b-56c8-595d-8086-5aef9656cbc4</id><title type="text">Reproducible MirageOS unikernel builds</title><updated>2020-01-07T22:38:21-00:00</updated><author><name>hannes</name></author></entry><entry><source><updated>2020-02-20T00:00:00-00:00</updated><link title="Jane Street Tech Blog" type="text/html" href="https://blog.janestreet.com" rel="related"/><link title="Jane Street Tech Blog" type="application/rss+xml" href="https://blog.janestreet.com/feed.xml" rel="self"/><id>https://blog.janestreet.com</id><title type="text">Jane Street Tech Blog</title><author><name>Jane Street</name></author></source><link href="https://blog.janestreet.com/using-python-and-ocaml-in-the-same-jupyter-notebook/" rel="alternate"/><content xml:base="https://blog.janestreet.com/feed.xml" type="html">&lt;div style=&quot;width: 75%; margin: auto; text-align: center; font-style: italic; font-size: 75%&quot;&gt;
The cover image is based on &lt;a href=&quot;https://commons.wikimedia.org/wiki/File:Jupiter_family.jpg&quot;&gt;Jupiter family&lt;/a&gt; by NASA/JPL.
&lt;/div&gt;

</content><id>https://blog.janestreet.com/using-python-and-ocaml-in-the-same-jupyter-notebook/</id><title type="text">Using Python and OCaml in the same Jupyter notebook</title><updated>2019-12-16T00:00:00-00:00</updated><author><name>Jane Street</name></author></entry><entry><source><updated>2019-12-11T00:00:00-00:00</updated><link title="Tarides RSS Feed" type="text/html" href="https://tarides.com" rel="related"/><link title="Tarides RSS Feed" type="application/rss+xml" href="https://tarides.com/feed.xml" rel="self"/><generator>GatsbyJS</generator><id>https://tarides.com</id><title type="text">Tarides RSS Feed</title><author><name>Tarides</name></author></source><link href="https://tarides.com/blog/2019-12-11-tarides-wins-the-fic-2020-startup-award" rel="alternate"/><content xml:base="https://tarides.com/feed.xml" type="html">&lt;p&gt;We are very excited to announce that Tarides has &lt;a href=&quot;https://www.forum-fic.com/en/home/price/the-fic-start-up-award.htm&quot;&gt;won an
award&lt;/a&gt;
from the International Cybersecurity Forum (FIC 2020).&lt;/p&gt;
&lt;p&gt;Organized every year in Lille (France), the International
Cybersecurity Forum has become the leading European event on
cybersecurity and digital trust. Its main goal is to foster reflection
and exchanges within the European cybersecurity ecosystem.&lt;/p&gt;
&lt;p&gt;We are very happy to have won the &quot;Coup de Coeur&quot; Prize, which will
bring great visibility to our technological innovations. It is also an
opportunity for us to meet experts in the cybersecurity sector and to
consider additional use-cases for our work. We would like to thank the
&lt;a href=&quot;https://ceis.eu/&quot;&gt;CEIS&lt;/a&gt; for organising the event and the members of
the jury for commending &lt;a href=&quot;https://mirage.io&quot;&gt;MirageOS&lt;/a&gt; and
&lt;a href=&quot;https://tarides.com/blog/2019-07-05-i-lab-2019&quot;&gt;OSMOSE&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The next FIC will be held on the 28th, 29th and 30th of January
2020 in Lille. For more details about the FIC and to register, visit
&lt;a href=&quot;https://www.forum-fic.com/en/home.htm&quot;&gt;their website&lt;/a&gt;.&lt;/p&gt;
&lt;br /&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 680px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/dc5973af18f70eb3d969d8aa1c8dfae6/bf5f1/FIC2020.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 47.7326968973747%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAMEAf/EABYBAQEBAAAAAAAAAAAAAAAAAAIAAf/aAAwDAQACEAMQAAABvZVlqB4X/8QAGhAAAgIDAAAAAAAAAAAAAAAAAQIAEBESIf/aAAgBAQABBQINqUYtM9v/xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAwEBPwFX/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGxAAAgEFAAAAAAAAAAAAAAAAAAEREiAhMZH/2gAIAQEABj8CoTfBOcG7P//EABsQAAIDAAMAAAAAAAAAAAAAAAERACFBEGGx/9oACAEBAAE/IczKsvYBTfqE2VONgAQqf//aAAwDAQACAAMAAAAQWD//xAAYEQADAQEAAAAAAAAAAAAAAAAAAREhMf/aAAgBAwEBPxCO9IWQ/8QAFhEBAQEAAAAAAAAAAAAAAAAAABEB/9oACAECAQE/ELiP/8QAHBABAQADAAMBAAAAAAAAAAAAAREAIVExQWGx/9oACAEBAAE/EAN5gjIxWw3eCfgKGDOfMN7JqJzPEnzANISH7hNTxzP/2Q=='); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;FIC2020 Startup Award Winners&quot;
        title=&quot;FIC2020 Startup Award Winners&quot;
        src=&quot;/static/dc5973af18f70eb3d969d8aa1c8dfae6/2f992/FIC2020.jpg&quot;
        srcset=&quot;/static/dc5973af18f70eb3d969d8aa1c8dfae6/c2e49/FIC2020.jpg 170w,
/static/dc5973af18f70eb3d969d8aa1c8dfae6/f8bf2/FIC2020.jpg 340w,
/static/dc5973af18f70eb3d969d8aa1c8dfae6/2f992/FIC2020.jpg 680w,
/static/dc5973af18f70eb3d969d8aa1c8dfae6/bf5f1/FIC2020.jpg 838w&quot;
        sizes=&quot;(max-width: 680px) 100vw, 680px&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;</content><id>https://tarides.com/blog/2019-12-11-tarides-wins-the-fic-2020-startup-award.html</id><title type="text">Tarides wins the FIC 2020 startup award</title><updated>2019-12-11T00:00:00-00:00</updated><author><name>Céline Laplassotte</name></author></entry><entry><source><updated>2020-02-20T00:00:00-00:00</updated><link title="Jane Street Tech Blog" type="text/html" href="https://blog.janestreet.com" rel="related"/><link title="Jane Street Tech Blog" type="application/rss+xml" href="https://blog.janestreet.com/feed.xml" rel="self"/><id>https://blog.janestreet.com</id><title type="text">Jane Street Tech Blog</title><author><name>Jane Street</name></author></source><link href="https://blog.janestreet.com/deep-learning-the-hardest-go-problem-in-the-world/" rel="alternate"/><content xml:base="https://blog.janestreet.com/feed.xml" type="html">&lt;h2 id=&quot;updates-and-a-new-run&quot;&gt;Updates and a New Run&lt;/h2&gt;

</content><id>https://blog.janestreet.com/deep-learning-the-hardest-go-problem-in-the-world/</id><title type="text">Deep-Learning the Hardest Go Problem in the World</title><updated>2019-12-06T00:00:00-00:00</updated><author><name>Jane Street</name></author></entry><entry><source><updated>2020-03-10T17:01:15-00:00</updated><link title="Frama-C RSS News" type="text/html" href="http://frama-c.com/" rel="related"/><link title="Frama-C RSS News" type="application/rss+xml" href="http://frama-c.com/rss.xml" rel="self"/><id>http://frama-c.com/</id><title type="text">Frama-C RSS News</title><author><name>Frama-C</name></author></source><link href="http://frama-c.com/index.html" rel="alternate"/><id>http://frama-c.com/index.html#0a512204f8d8abefc5147aec52f795ee</id><title type="text">Frama-C 20.0 (Calcium) is out. Download it here.</title><updated>2019-12-04T17:00:00-00:00</updated><author><name>Frama-C</name></author></entry><entry><source><updated>2019-12-11T00:00:00-00:00</updated><link title="Tarides RSS Feed" type="text/html" href="https://tarides.com" rel="related"/><link title="Tarides RSS Feed" type="application/rss+xml" href="https://tarides.com/feed.xml" rel="self"/><generator>GatsbyJS</generator><id>https://tarides.com</id><title type="text">Tarides RSS Feed</title><author><name>Tarides</name></author></source><link href="https://tarides.com/blog/2019-12-04-mirageos-talk-at-the-paris-open-source-summit" rel="alternate"/><content xml:base="https://tarides.com/feed.xml" type="html">&lt;p&gt;We are thrilled to have been selected by the &lt;a href=&quot;https://www.opensourcesummit.paris&quot;&gt;Paris Open Source Summit&lt;/a&gt;
committee to talk about “Secure-by-design IoT applications using MirageOS”.&lt;/p&gt;
&lt;p&gt;The Paris Open Source Summit is an annual event where you can connect to
open-source communities and learn from tech leaders, project committers and
CTOs about the latest technical solutions, innovative uses and societal
challenges of open digital technology.&lt;/p&gt;
&lt;p&gt;Thomas Gazagnaire, Tarides CEO/CTO, will explain what makes MirageOS a good
framework to build IoT applications and how we can use embedded devices running
on ARMv8, ESP32 or RISC-V to run secure and end-to-end open-source
infrastructure services such as VPN proxies and email servers. He will also
highlight how this infrastructure will be used to form the basis of OSMOSE: a
secure, distributed and privacy-preserving platform to write user-centric IoT
applications.&lt;/p&gt;
&lt;p&gt;MirageOS is a library operating system (using the MIT license) which enables the
construction of unikernels: specialized services where the runtime binary
contains only the necessary code for execution and no more. Unikernels have a
drastically smaller attack surface than service deployments in traditional
operating systems and could lead to 1000x less code for the full application
stack. Moreover, as MirageOS is written in a memory safe language (OCaml), a
full class of bugs related to memory corruption – representing &lt;a href=&quot;https://msrc-blog.microsoft.com/2019/07/16/a-proactive-approach-to-more-secure-code/&quot;&gt;70% of the
released CVEs&lt;/a&gt; in classic operating systems written in C –
can no longer appear. These two properties combined (and more!) allow MirageOS
to build “secure-by-design” applications where everything – from the high-level
business logic to the low-level device drivers – has been designed to be as
secure as possible.&lt;/p&gt;
&lt;p&gt;To learn more about the project, attend the Paris Open Source Summit! The talk
will take place during the '&lt;a href=&quot;https://www.opensourcesummit.paris/EMBEDDED+%26+IOT_168_5745.html&quot;&gt;Embedded &amp;#x26; IOT&lt;/a&gt;' section
at 14:50 – 15:20 on December 10th, 2019.&lt;/p&gt;
&lt;br/&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 680px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/7826ecb5d3f2934a405f25446b1eb1d8/1f853/poss_2019.jpg&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 50.09765625%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAKABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAUBAgP/xAAVAQEBAAAAAAAAAAAAAAAAAAACA//aAAwDAQACEAMQAAABtpDFSWjUQ//EABgQAQEBAQEAAAAAAAAAAAAAAAESAgAD/9oACAEBAAEFArOCzbD5hUlGM9//xAAbEQACAgMBAAAAAAAAAAAAAAABAwACEiGR8P/aAAgBAwEBPwFiqKsDWYKOyPcn/8QAGBEAAwEBAAAAAAAAAAAAAAAAAAECESH/2gAIAQIBAT8BVOl02kf/xAAaEAACAgMAAAAAAAAAAAAAAAAAAREhMTKR/9oACAEBAAY/ApslWyDAqRquH//EABoQAQADAQEBAAAAAAAAAAAAAAEAESExUZH/2gAIAQEAAT8h+JDU6OEC3jUfoOeSmjl5GmrH/9oADAMBAAIAAwAAABD43//EABkRAQEAAwEAAAAAAAAAAAAAAAERADFhQf/aAAgBAwEBPxAMW9fJJoxbRXpj/8QAGBEBAQADAAAAAAAAAAAAAAAAAQARkfD/2gAIAQIBAT8QTECYHt3/xAAbEAEAAgMBAQAAAAAAAAAAAAABABExQVEhgf/aAAgBAQABPxBQK0aY8fnYpWiiUphg5UAol67BQNohgLAag7LW51DP/9k='); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Thomas at the Paris Open Source Summit&quot;
        title=&quot;Thomas at the Paris Open Source Summit&quot;
        src=&quot;/static/7826ecb5d3f2934a405f25446b1eb1d8/2f992/poss_2019.jpg&quot;
        srcset=&quot;/static/7826ecb5d3f2934a405f25446b1eb1d8/c2e49/poss_2019.jpg 170w,
/static/7826ecb5d3f2934a405f25446b1eb1d8/f8bf2/poss_2019.jpg 340w,
/static/7826ecb5d3f2934a405f25446b1eb1d8/2f992/poss_2019.jpg 680w,
/static/7826ecb5d3f2934a405f25446b1eb1d8/5d177/poss_2019.jpg 1020w,
/static/7826ecb5d3f2934a405f25446b1eb1d8/1f853/poss_2019.jpg 1024w&quot;
        sizes=&quot;(max-width: 680px) 100vw, 680px&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;</content><id>https://tarides.com/blog/2019-12-04-mirageos-talk-at-the-paris-open-source-summit.html</id><title type="text">MirageOS talk at the Paris Open Source Summit</title><updated>2019-12-04T00:00:00-00:00</updated><author><name>Céline Laplassotte</name></author></entry><entry><source><updated>2019-12-03T08:00:00-00:00</updated><logo>http://gallium.inria.fr/blog/</logo><link title="Gagallium" type="text/html" href="http://gallium.inria.fr/blog/index.rss" rel="related"/><link title="Gagallium" type="application/rss+xml" href="http://gallium.inria.fr/blog/index.rss" rel="self"/><generator>Stog</generator><id>http://gallium.inria.fr/blog/index.rss</id><title type="text">Gagallium</title><author><name>GaGallium</name></author></source><link href="http://gallium.inria.fr/blog/an-ocaml-release-story-1" rel="alternate"/><content xml:base="http://gallium.inria.fr/blog/index.rss" type="html">



&lt;p&gt;I (Florian Angeletti) have started working at Inria Paris this August. A part of my new job is to help deal with the day-to-day care for the OCaml compiler, particularly during the release process. This blog post is a short glimpse into the life of an OCaml release.&lt;/p&gt;





&lt;h2 id=&quot;ocaml-and-the-opam-repository&quot;&gt;OCaml and the opam repository&lt;/h2&gt;
&lt;p&gt;Currently, the song of the OCaml development process is a canon with two voices: a compiler release spends the first 6 months of its life as the &lt;code&gt;trunk&lt;/code&gt; branch of the OCaml compiler git repository. Then after those 6 first months, it is named and given a branch on its own. For instance, this happened on October 18 2019 for OCaml &lt;code&gt;4.10&lt;/code&gt;. Starting from this point, the branch is feature-frozen: only bug fixes are merged, whereas new feature development happens in &lt;code&gt;trunk&lt;/code&gt;. Our objective is then to release the new version 3 months later. If we succeed, there are at most two branches active at the same time.&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;span/&gt;    Dev
    Dev
    Dev
    Dev
    Dev
    Dev
    Bug  Dev
    Bug  Dev
    RCs  Dev
         Dev
         Dev
         Dev
         Bug  Dev
         Bug  Dev
         RCs  Dev
              Dev
              Dev
              Dev
              Bug
              Bug
              Rcs
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;However, the OCaml compiler does not live in isolation. It makes little point to release a new version of OCaml which is not compatible with other parts of the OCaml ecosystem.&lt;/p&gt;
&lt;p&gt;The release cycle of OCaml &lt;code&gt;4.08&lt;/code&gt; was particularly painful from this point of view: we refactored parts of the compiler API that were not previously versioned by &lt;a href=&quot;https://github.com/ocaml-ppx/ocaml-migrate-parsetree&quot;&gt;ocaml-migrate-parsetree&lt;/a&gt;, making it more difficult to update. In turn, without a working version of ocaml-migrate-parsetree, ppxses could not be built, breaking all packages that depend on them. It took months to correct the issue. This slip of schedule affected the &lt;code&gt;4.09.0&lt;/code&gt; release and can still be felt on the &lt;code&gt;4.11&lt;/code&gt; schedule.&lt;/p&gt;
&lt;h2 id=&quot;catching-knifes-before-the-fall&quot;&gt;Catching knifes before the fall&lt;/h2&gt;
&lt;p&gt;Lesson learned, we need to test the packages in the opam repository more often. Two tools in current usage can automate such testing: opamcheck and opam-health-check.&lt;/p&gt;
&lt;p&gt;The two tools attack the problem with a different angle. The &lt;a href=&quot;https://github.com/kit-ty-kate/opam-health-check&quot;&gt;opam-health-check&lt;/a&gt; monitoring tool is developed to check the coherency of the opam repository, for released OCaml versions.&lt;/p&gt;
&lt;p&gt;In a complementary way, &lt;a href=&quot;https://github.com/damiendoligez/opamcheck&quot;&gt;opamcheck&lt;/a&gt; was written by Damien Doligez to check how well new versions of the OCaml compiler fare in terms of building the packages in the opam repository.&lt;/p&gt;
&lt;p&gt;A typical difference between opamcheck and opam-health-check is that opamcheck is biased towards newer versions of the compiler: if an opam package builds on the latest unreleased version of the compiler, we don’t need to test it with older compilers. After all, we are mostly interested in packages that are broken by the new release. The handful of packages that may be coincidentally fixed by an unreleased compiler are at most a curiosity; pruning those unlikely events saves us some precious time.&lt;/p&gt;
&lt;p&gt;Since I started at Inria, in the midst of the first beta of OCaml &lt;code&gt;4.09.0&lt;/code&gt;, I have been working with opamcheck to monitor the state of the opam repository.&lt;/p&gt;
&lt;p&gt;The aim here is twofold. First, we want to detect expected breakages that are just a sign that a package needs to be updated before the final release of the new compiler version. The earliest we catch those, the more time the maintainers have to patch their packages. Second, we want to detect unexpected compatibility issues and breakages.&lt;/p&gt;
&lt;p&gt;One fun example of such unexpected compatibility issue appeared in the &lt;code&gt;4.09.0&lt;/code&gt; release cycle. When I first used opamcheck to test the state of the first &lt;code&gt;4.09.0&lt;/code&gt; beta, there was a quite problematic broken package: dune. This was quite stunning at first, because the &lt;code&gt;4.09.0&lt;/code&gt; version of OCaml contained mostly bug fixes and small quality-of-life improvements. That was at least what I had told a few worried people a few days earlier…&lt;/p&gt;
&lt;p&gt;So what was happening here? The issue stemmed from a small change of behaviour in presence of missing compiled interface (&lt;code&gt;cmi&lt;/code&gt;) files : dune was relying on an unspecified OCaml compiler behaviour in such cases, and this behaviour had been altered by a mostly unrelated improvement in the typechecker.&lt;/p&gt;
&lt;p&gt;This change of behaviour was patched and dune worked fine in the second beta release of &lt;code&gt;4.09.0&lt;/code&gt;. And this time, the next run of opamcheck confirmed that that &lt;code&gt;4.09.0&lt;/code&gt; was a quiet release.&lt;/p&gt;
&lt;p&gt;This is currently the main use of opamcheck: check the health status of the opam repository on unreleased version of OCaml before opam-health-check more extensive coverage takes the relay. One of our objectives for the future &lt;code&gt;4.10.0&lt;/code&gt; release is to achieve a much more extensive test coverage, before the first beta.&lt;/p&gt;
&lt;h2 id=&quot;opam-and-the-prs&quot;&gt;Opam and the PRs&lt;/h2&gt;
&lt;p&gt;There is another possible use of opamcheck that is probably much more useful to the anxious OCaml developer: opamcheck can be used to check that a PR or an experimental branch does not break opam packages. A good example is &lt;a href=&quot;https://github.com/ocaml/ocaml/issues/8900&quot;&gt;#8900&lt;/a&gt;: this PR proposes to remove the special handling of abstract types defined inside the current module. This special case looks nice locally, but it allows to write some code which is valid if and only if it is located in the right module, without any possibility to correct this behaviour by making module signatures more precise.&lt;/p&gt;
&lt;p&gt;It is therefore quite tempting to try to remove this special case from the typechecker, but is it reasonable?&lt;/p&gt;
&lt;p&gt;This was another task for opamcheck. First, I added a new opamcheck option to easily check any pull request on the OCaml compiler. After some work, there was some good news: this pattern is mostly unused in the current opam repository.&lt;/p&gt;
&lt;p&gt;Knowing whether there are any opam packages that rely on this feature is definitively a big help when taking these decisions.&lt;/p&gt;
&lt;h2 id=&quot;using-opamcheck&quot;&gt;Using opamcheck&lt;/h2&gt;
&lt;p&gt;So if you are a worried OCaml developer and want to test your fancy compiler PR on the anvil of the opam repositoy, what are the magical incantations?&lt;/p&gt;
&lt;p&gt;One option is to download the docker image &lt;code&gt;octachron/opamcheck&lt;/code&gt; with&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;span/&gt;docker pull octachron/opamcheck
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Beware that the image weighs around 7 GiB. It is also possible to build and run opamcheck locally as detailed in the &lt;a href=&quot;https://github.com/Octachron/opamcheck&quot;&gt;readme&lt;/a&gt;. However, in this short blog post, I will present the latter option. It has the advantages of being relatively lightweight in terms of configuration, and makes it easier to test your legions of PRs simultaneously (you don’t have legions of PRs, do you?)&lt;/p&gt;
&lt;p&gt;Once the image is downloaded, there are three main ways to run it. If you want to compare several versions of the compiler (given as switch names), let’s say &lt;code&gt;4.05&lt;/code&gt;, and &lt;code&gt;4.08.1+flambda&lt;/code&gt; and &lt;code&gt;4.10.0+trunk&lt;/code&gt;, you can run:&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;span/&gt;docker run -v opamcheck:/app/log -p 8080:80 --name=opamcheck opamcheck run -online-summary=10 4.05.0 4.08.1+flambda 4.10.0
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The &lt;code&gt;-name&lt;/code&gt; option is the docker container name. The &lt;code&gt;-p&lt;/code&gt; option maps the port &lt;code&gt;80&lt;/code&gt; of the container to the port &lt;code&gt;8080&lt;/code&gt; of the host, this is used to connect to the http server embedded in the image. Finally, the &lt;code&gt;-v&lt;/code&gt; flag let us choose the location of opamcheck log directory in the host file system. (If you forget this option, a random docker volume name will be used.) Here, it will be at &lt;code&gt;/var/lib/docker/volumes/opamcheck&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;While opamcheck is runnning, its progress can be checked with either&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;span/&gt;sudo tail -f /var/lib/docker/volumes/opamcheck_log/_data/results
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;or by pointing a web browser to &lt;code&gt;localhost:8080/fullindex.html&lt;/code&gt;. Note that the first summary is only generated after the OCaml compiler is built and all uninstallable packages have been discovered. On my machine, this rounds up at a 15 minutes wait before the first summary is generated. Later updates should be more frequent.&lt;/p&gt;
&lt;p&gt;The result should look like this &lt;a href=&quot;https://opamcheck.polychoron.fr/4.10_2019_12_02/fullindex.html&quot;&gt;summary run&lt;/a&gt; for OCaml &lt;code&gt;4.10.0&lt;/code&gt;. The integer parameter in &lt;code&gt;-online-summary=n&lt;/code&gt; corresponds to the update period for this html summary. If the option is not provided, the html summary is only built at the end of the run.&lt;/p&gt;
&lt;p&gt;If you are more interested by testing a specific PR, for instance &lt;a href=&quot;https://github.com/ocaml/ocaml/issues/8900&quot;&gt;#8900&lt;/a&gt;, the &lt;code&gt;prmode&lt;/code&gt; mode works better&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;span/&gt;docker run -p 80:8080 opamcheck --name=opamcheck prmode -online-summary=10 -pr 8900 4.09.0
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This command tries to rebase the given PR on top of the given OCaml version (switch name); it fails immediately if the PR cannot be rebased; in this case you should use the latest &lt;code&gt;trunk&lt;/code&gt; switch as base or use the branch option, described below. When possible, it is a good idea to use a released version as the base: with a released version, there are more unbroken packages to test your patch against.&lt;/p&gt;
&lt;p&gt;If the branch that you want to test is not yet a PR, or needs some manual rebasing to be compared against a specific compiler version, there is a &lt;code&gt;-branch&lt;/code&gt; flag. For instance, let’s say that you have a branch &lt;code&gt;my_very_experimental_branch&lt;/code&gt; at the location &lt;code&gt;nowhere.org&lt;/code&gt;. You can run&lt;/p&gt;
&lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;&lt;span/&gt;docker run -p 80:8080 opamcheck --name=opamcheck prmode -online-summary=10 -branch https://nowhere.org:my_very_experimental_branch 4.09.0
&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;This command downloads the branch at &lt;code&gt;nowhere.org&lt;/code&gt; and compare it against the &lt;code&gt;4.09.0&lt;/code&gt; switch.&lt;/p&gt;
&lt;p&gt;Currently, a full run of opamcheck takes one or two days: you will likely get the results before your first PR review. A limitation is the false positive rate: most opam package descriptions are incomplete or out of date, so packages will fail for reasons unrelated to your PR. Unfortunately, this means that there is still some manual triage needed after an opamcheck run.&lt;/p&gt;
&lt;p&gt;There are four main objectives for opamcheck in the next months:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;improve its usability&lt;/li&gt;
&lt;li&gt;share more code with opam-health-check, at least on the frontend&lt;/li&gt;
&lt;li&gt;reduce the false positive rate&lt;/li&gt;
&lt;li&gt;reduce the time required by a CI run&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;If you want to check on future development for opamcheck, and a potentially more up-to-date readme, you can have a look at &lt;a href=&quot;https://github.com/Octachron/opamcheck&quot;&gt;Octachron/opamcheck&lt;/a&gt;.&lt;/p&gt;

</content><id>http://gallium.inria.fr/blog/an-ocaml-release-story-1</id><title type="text">Testing OCaml releases with opamcheck</title><updated>2019-12-03T08:00:00-00:00</updated><author><name>Florian Angeletti</name></author></entry><entry><source><updated>2019-12-11T00:00:00-00:00</updated><link title="Tarides RSS Feed" type="text/html" href="https://tarides.com" rel="related"/><link title="Tarides RSS Feed" type="application/rss+xml" href="https://tarides.com/feed.xml" rel="self"/><generator>GatsbyJS</generator><id>https://tarides.com</id><title type="text">Tarides RSS Feed</title><author><name>Tarides</name></author></source><link href="https://tarides.com/blog/2019-11-27-introducing-the-graphql-api-for-irmin-2-0" rel="alternate"/><content xml:base="https://tarides.com/feed.xml" type="html">&lt;p&gt;With the release of Irmin 2.0.0, we are happy to announce a new package - &lt;code&gt;irmin-graphql&lt;/code&gt;, which can be used to serve data from Irmin over HTTP. This blog post will give you some examples to help you get started, there is also &lt;a href=&quot;https://irmin.org/tutorial/graphql&quot;&gt;a section in the &lt;code&gt;irmin-tutorial&lt;/code&gt;&lt;/a&gt; with similar information. To avoid writing the same thing twice, this post will cover the basics of getting started, plus a few interesting ideas for queries.&lt;/p&gt;
&lt;p&gt;Getting the &lt;code&gt;irmin-graphql&lt;/code&gt; server running from the command-line is easy:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ irmin graphql --root&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;/tmp/irmin&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;where &lt;code&gt;/tmp/irmin&lt;/code&gt; is the actual path to your repository. This will start the server on &lt;code&gt;localhost:8080&lt;/code&gt;, but it's possible to customize this using the &lt;code&gt;--address&lt;/code&gt; and &lt;code&gt;--port&lt;/code&gt; flags.&lt;/p&gt;
&lt;p&gt;The new GraphQL API has been added to address some of the shortcomings that have been identified with the old HTTP API, as well as enable a number of new features and capabilities.&lt;/p&gt;
&lt;h1 id=&quot;graphql&quot;&gt;&lt;a href=&quot;#graphql&quot; aria-label=&quot;graphql permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;GraphQL&lt;/h1&gt;
&lt;p&gt;&lt;a href=&quot;https://graphql.org/&quot;&gt;GraphQL&lt;/a&gt; is a query language for exposing data as a graph via an API, typically using HTTP as a transport. The centerpiece of a GraphQL API is the &lt;em&gt;schema&lt;/em&gt;, which describes the graph in terms of types and relationships between these types. The schema is accessible by the consumer, and acts as a contract between the API and the consumer, by clearly defining all API operations and fully assigning types to all interactions.&lt;/p&gt;
&lt;p&gt;Viewing Irmin data as a graph turns out to be a natural and useful model. Concepts such as branches and commits fit in nicely, and the stored application data is organized as a tree. Such highly hierarchical data can be challenging to interact with using REST, but is easy to represent and navigate with GraphQL.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 680px;&quot;
    &gt;
      &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 74.125%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsSAAALEgHS3X78AAADFElEQVQ4y51SXUhTcRS/m6l9iuJMDQ0jKC3zIYLyoQ+SSHrxIYKooIcsejAqpYQSC+xBbO5uytxUQstSI5RMUXwoBA3LNM1uzdyHH9vubXfbvZtud37udP4TorIe7A+Hc87/9z+/+zvnXIr64yTQOkpB62UkjqP1iXHq6qvRKt2VzcqqXLzPwzyLYLHqamorraf+eaYmzCFvnZ6gcp69WEfieE3N5YS655Cifwy7ap9C4qMmQELmWtdrOQBQF9u7QzXzc3N/J520GH/LI8sqz0frHkNyRW1wn74+GKutgy1K7Ydf30AQVhOpSu9TpnFDKP4yOhzJGL4mfevrSSprazt8qrHletaT5hvHHzUUnmxsyc9t6zwzPvhuh41lk2YlKYLU2FBtuqqSjIqiBIGViSIX5uTt4QQMSL40ZnTk48D7/l7WOt2z5BHap5jRDsnBdQR4Rxe22iQIQr3JZBx0+XwZpKawszs8Rl0tV9DVslVqjx7IiLqTX7AJC8PRwsjdphOnIwqLi7b/bHMFk/Oae3GrCFBdGqqs9Hodap/fpZmcMLRirhY9nMLtth9BvApNw7GWBo/XQbvc9mIkk21QVhUm0zpmG617G0Pru+LU+l5s+Rhp+Ro+AI/nO2ARYDFJAclOIlZDYqfTCna7GZaX/SBJbuBd9p3R5brR5MaXsP9ZC+xvbIXEpjZI0NTcJYTn5uc94HBMLaO6IPrg4uIsErIHEXsAEADWblkiGHYBgsgJsDyjoEpUpREPtWObldrBjUrtgKy0gqFKyrMpVLYe1aRKASEVYClVkoQ0zHfPzPJhqDYKSffiB0IYEu5xOK0pZLYGs+n2m6Ehfc/wsK6PYSo+Go01LMvmUP9z3IG5cHZ66pLFYLgx9mmkyGL4mi/y/C2X05lNWiYmF0VW/rvn/oqJHocM+u9TgpdNXwj6Dn1mBs7aWPMJr5/PFERb/JqUCQInW/FsLH5Q8vvdwHETZP44hQXA++b/InS5bAqfzwVkYU5+Gs0a+jOQ8NUaCdmQx+WEYXwBF3oTl5iHSvMwL0DVmT8AxGI5cAVaFsEAAAAASUVORK5CYII='); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Git data model&quot;
        title=&quot;Git data model&quot;
        src=&quot;/static/77be7ca8c9940e693b03660d2d5cee01/5e3e6/git-data-model.png&quot;
        srcset=&quot;/static/77be7ca8c9940e693b03660d2d5cee01/924ad/git-data-model.png 170w,
/static/77be7ca8c9940e693b03660d2d5cee01/6103d/git-data-model.png 340w,
/static/77be7ca8c9940e693b03660d2d5cee01/5e3e6/git-data-model.png 680w,
/static/77be7ca8c9940e693b03660d2d5cee01/8ff1e/git-data-model.png 800w&quot;
        sizes=&quot;(max-width: 680px) 100vw, 680px&quot;
        loading=&quot;lazy&quot;
      /&gt;
    &lt;/span&gt;
(image from &lt;a href=&quot;https://git-scm.com/book/en/v2/Git-Internals-Git-Objects&quot;&gt;Pro Git&lt;/a&gt;)&lt;/p&gt;
&lt;p&gt;As a consumer of an API, one of the biggest initial challenges is understanding what operations are exposed and how to use them. Conversely, as a developer of an API, keeping documentation up-to-date is challenging and time consuming. Though no substitute for more free-form documentation, a GraphQL schema provides an excellent base line for understanding a GraphQL API that is guaranteed to be accurate and up-to-date. This issue is definitely true of the old Irmin HTTP API, which was hard to approach for newcomers due to lack of documentation.&lt;/p&gt;
&lt;p&gt;Being able to inspect the schema of a GraphQL API enables powerful tooling. A great example of this is &lt;a href=&quot;graphiql&quot;&gt;GraphiQL&lt;/a&gt;, which is a browser-based IDE for GraphQL queries. GraphiQL can serve both as an interactive API explorer and query designer with intelligent autocompletion, formatting and more.&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 680px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/19632cbb13504bb32d6d6d285ec1f542/e705e/graphiql.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 48.12942366026289%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAABYlAAAWJQFJUiTwAAABe0lEQVQoz3WS2Y6kMAxF+f9PnIeSejRQbNl3Aty2U01VbxPpAgL55Niku91u6Psew3CnDC3TNEEI0bJy1vWZZVkhpYRxESEV7PsOrU2755zRKeOQUkatFRtn2+hjhXMOYhIw2sKFAOdfUVrTZhLLKhrkUbO3dNImzNIBOHGeB66VUsQySfx5m2EsbZoLIhVHuhtjm6VSiiCvGl4dX6xP8Ja0y0OdV4yxAfrFYFgkQqAWbUCICZY24A72ShJHxb5Fes70fDyApVQCanqZyPIyzK2YwbM0cNrDjQreeJStoBcB935A0n+xZYOaLQGp5YOohWZwkBm3fH4QU0oNyDObCOgZOOsGzKVg1glqHVGTIEPfLLm244FeEL7+BmyGNGd3J0NqOxFwqzu2cuLgdhlYYxMiw7NBPuc7cFEvw+BC+0GP7X+uDv9ZfBwu4KosvHLwZMnvEn37LnGlG8exHWw+BoHOm/e+xVqLSD/G+4hRGFiyc//E0/A5pvOr6TtanQh1FESOJwAAAABJRU5ErkJggg=='); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;GraphiQL&quot;
        title=&quot;GraphiQL&quot;
        src=&quot;/static/19632cbb13504bb32d6d6d285ec1f542/5e3e6/graphiql.png&quot;
        srcset=&quot;/static/19632cbb13504bb32d6d6d285ec1f542/924ad/graphiql.png 170w,
/static/19632cbb13504bb32d6d6d285ec1f542/6103d/graphiql.png 340w,
/static/19632cbb13504bb32d6d6d285ec1f542/5e3e6/graphiql.png 680w,
/static/19632cbb13504bb32d6d6d285ec1f542/89b07/graphiql.png 1020w,
/static/19632cbb13504bb32d6d6d285ec1f542/2f8d2/graphiql.png 1360w,
/static/19632cbb13504bb32d6d6d285ec1f542/e705e/graphiql.png 1978w&quot;
        sizes=&quot;(max-width: 680px) 100vw, 680px&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;The combination of introspection and a strongly typed schema also allows creating smart clients using code generation. This is already a quite wide-spread idea with &lt;a href=&quot;apollo-swift&quot;&gt;Apollo for iOS&lt;/a&gt;, &lt;a href=&quot;apollo-java&quot;&gt;Apollo for Android&lt;/a&gt; or &lt;a href=&quot;graphql_ppx&quot;&gt;&lt;code&gt;graphql_ppx&lt;/code&gt;&lt;/a&gt; for OCaml/Reason. Though generic GraphQL client libraries will do a fine job interacting with the Irmin GraphQL API, these highlighted libraries will offer excellent ergonomics and type-safety out of the box.&lt;/p&gt;
&lt;p&gt;One of the problems that GraphQL set out to solve is that of over- and underfetching. When designing REST API response payloads, there is always a tension between including too little data, which will require clients to make more network requests, and including too much data, which wastes resources for both client and server (serialization, network transfer, deserialization, etc).&lt;br/&gt;
The existing low-level Irmin HTTP API is a perfect example of this. Fetching the contents of a particular file on the master branch requires at least 4 HTTP requests (fetch the branch, fetch the commit, fetch the tree, fetch the blob), i.e. massive underfetching. By comparison, this is something easily solved with a single request to the new GraphQL API. More generally, the GraphQL API allows you to fetch &lt;em&gt;exactly&lt;/em&gt; the data you need in a single request without making one-off endpoints.&lt;/p&gt;
&lt;p&gt;For the curious, here's the GraphQL query to fetch the contents of &lt;code&gt;README.md&lt;/code&gt; from the branch &lt;code&gt;master&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;graphql&quot;&gt;&lt;pre class=&quot;language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;query&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  master &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    tree &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;README.md&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The response will look something like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;data&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;master&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;tree&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;get&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;The contents of README.md&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The GraphQL API is not limited to only reading data, you can also write data to your Irmin store. Here's a simple example that will set the key &lt;code&gt;README.md&lt;/code&gt; to &lt;code&gt;&quot;foo&quot;&lt;/code&gt;, and return the hash of that commit:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;graphql&quot;&gt;&lt;pre class=&quot;language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;mutation&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  set&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;README.md&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;foo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    hash
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;By default, GraphQL allows you to do multiple operations in a single query, so you get bulk operations for free. Here's a more complex example that modifies two different branches, &lt;code&gt;branch-a&lt;/code&gt; and &lt;code&gt;branch-b&lt;/code&gt;, and then merges &lt;code&gt;branch-b&lt;/code&gt; into &lt;code&gt;branch-a&lt;/code&gt; &lt;em&gt;all in a single query&lt;/em&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;graphql&quot;&gt;&lt;pre class=&quot;language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;mutation&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token attr-name&quot;&gt;branch_a&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; set&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;branch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;branch-a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;foo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;bar&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    hash
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  &lt;span class=&quot;token attr-name&quot;&gt;branch_b&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; set&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;branch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;branch-a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;baz&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;value&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;qux&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    hash
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

  merge_with_branch&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;branch&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;branch-b&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token attr-name&quot;&gt;from&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;branch-a&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    hash
    tree &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      list_contents_recursively &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        key
        value
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here's what the response might look like:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;data&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;branch_a&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;hash&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;0a1313ae9dfe1d4339aee946dd76b383e02949b6&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;branch_b&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;hash&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;28855c277671ccc180c81058a28d3254f17d2f7b&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;merge_with_branch&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;hash&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;7b17437a16a858816d2710a94ccaa1b9c3506d1f&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;tree&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;list_contents_recursively&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;key&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/foo&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;value&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;bar&quot;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;key&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;/baz&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
            &lt;span class=&quot;token property&quot;&gt;&quot;value&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;qux&quot;&lt;/span&gt;
          &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
        &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Overall, the new GraphQL API operates at a much higher level than the old HTTP API, and offers a number of complex operations that were tricky to accomplish before.&lt;/p&gt;
&lt;h1 id=&quot;customizable&quot;&gt;&lt;a href=&quot;#customizable&quot; aria-label=&quot;customizable permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Customizable&lt;/h1&gt;
&lt;p&gt;With GraphQL, all request and response data is fully described by the schema. Because Irmin allows the user to have custom content types, this leaves the question of what type to assign to such values. By default, the GraphQL API will expose all values as strings, i.e. the serialized version of the data that your application stores. This works quite well when Irmin is used as a simple key-value store, but it can be very inconvenient scheme when storing more complex values. As an example, consider storing contacts (name, email, phone, tags, etc) in your Irmin store, where values have the following type:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;(* Custom content type: a contact *)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; contact &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  name &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; string&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  email &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; string&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;(* ... *)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Fetching such a value will by default be returned to the client as the JSON encoded representation. Assume we're storing a contact under the key &lt;code&gt;john-doe&lt;/code&gt;, which we fetch with the following query:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;graphql&quot;&gt;&lt;pre class=&quot;language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;query&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  master &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    tree &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;john-doe&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The response would then look something like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;master&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;tree&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;get&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;{\&quot;name\&quot;:\&quot;John Doe\&quot;, \&quot;email\&quot;: \&quot;john.doe@gmail.com/&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; ...&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&quot;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The client will have to parse this JSON string and cannot choose to only fetch parts of the value (say, only the email). Optimally we would want the client to get a structured response such as the following:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;master&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;tree&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;get&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;name&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;John Doe&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;john.doe@gmail.com&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt;
        ...
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To achieve this, the new GraphQL API allows providing an &quot;output type&quot; and an &quot;input type&quot; for most of the configurable types in your store (&lt;code&gt;contents&lt;/code&gt;, &lt;code&gt;key&lt;/code&gt;, &lt;code&gt;metadata&lt;/code&gt;, &lt;code&gt;hash&lt;/code&gt;, &lt;code&gt;branch&lt;/code&gt;). The output type specifies how data is presented to the client, while the input type controls how data can be provided by the client. Let's take a closer look at specifying a custom output type.&lt;/p&gt;
&lt;p&gt;Essentially you have to construct a value of type &lt;code&gt;(unit, 'a option) Graphql_lwt.Schema.typ&lt;/code&gt; (from the &lt;a href=&quot;ocaml-graphql-server&quot;&gt;&lt;code&gt;graphql-lwt&lt;/code&gt;&lt;/a&gt; package), assuming your content type is &lt;code&gt;'a&lt;/code&gt;. We could construct a GraphQL object type for our example content type &lt;code&gt;contact&lt;/code&gt; as follows:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;(* (unit, contact option) Graphql_lwt.Schema.typ *)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; contact&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;schema&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;typ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Graphql&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;lwt&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Schema&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;obj &lt;span class=&quot;token string&quot;&gt;&quot;Contact&quot;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;fields&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;
    field &lt;span class=&quot;token string&quot;&gt;&quot;name&quot;&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;typ&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;non&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;null string&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;args&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;resolve&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; contact &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt;
        contact&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;name
      &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token comment&quot;&gt;(* ... more fields *)&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To use the custom type, you need to instantiate the functor &lt;code&gt;Irmin_unix.Graphql.Server.Make_ext&lt;/code&gt; (assuming you're deploying to a Unix target) with an Irmin store (type &lt;code&gt;Irmin.S&lt;/code&gt;) and a custom types module (type &lt;code&gt;Irmin_graphql.Server.CUSTOM_TYPES&lt;/code&gt;). This requires a bit of plumbing:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token comment&quot;&gt;(* Instantiate the Irmin functor somehow *)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; S &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; Irmin&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;S &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; contents &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; contact &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;(* ... *)&lt;/span&gt;

&lt;span class=&quot;token comment&quot;&gt;(* Custom GraphQL presentation module *)&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; Custom&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;types &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;
  &lt;span class=&quot;token comment&quot;&gt;(* Construct default GraphQL types *)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; Defaults &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Irmin&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;graphql&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Server&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Default&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;types &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

  &lt;span class=&quot;token comment&quot;&gt;(* Use the default types for most things *)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; Key &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Defaults&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Key
  &lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; Metadata &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Defaults&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Metadata
  &lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; Hash &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Defaults&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Hash
  &lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; Branch &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Defaults&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Branch

  &lt;span class=&quot;token comment&quot;&gt;(* Use custom output type for contents *)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; Contents &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;include&lt;/span&gt; Defaults&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Contents
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; schema&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;typ &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; contact&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;schema&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;typ
  &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; Remote &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; remote &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Some s&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;remote
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; GQL &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Irmin&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;unix&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Graphql&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Server&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;Make&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;ext &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Remote&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Custom&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;types&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;With this in hand, we can now query specifically for the email of &lt;code&gt;john-doe&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;graphql&quot;&gt;&lt;pre class=&quot;language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;query&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  master &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    tree &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      get&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token attr-name&quot;&gt;key&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;john-doe&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        email
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;... and get a nicely structured JSON response back:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;master&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;tree&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;get&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
        &lt;span class=&quot;token property&quot;&gt;&quot;email&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;john.doe@gmail.com&quot;&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The custom types is very powerful and opens up for transforming or enriching the data at query time, e.g. geocoding the address of a contact, or checking an on-line status.&lt;/p&gt;
&lt;h1 id=&quot;watches&quot;&gt;&lt;a href=&quot;#watches&quot; aria-label=&quot;watches permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Watches&lt;/h1&gt;
&lt;p&gt;A core feature of Irmin is the ability to &lt;em&gt;watch&lt;/em&gt; for changes to the underlying data store in real-time. &lt;code&gt;irmin-graphql&lt;/code&gt; takes advantage of GraphQL subscriptions to expose Irmin watches. Subscriptions are a relative recent addition to the GraphQL spec (&lt;a href=&quot;graphql-spec-june-2018&quot;&gt;June 2018&lt;/a&gt;), which allows clients to &lt;em&gt;subscribe&lt;/em&gt; to changes. These changes are pushed to the client over a suitable transport mechanism, e.g. websockets, Server-Sent Events, or a chunked HTTP response, as a regular GraphQL response.&lt;/p&gt;
&lt;p&gt;As an example, the following query watches for all changes and returns the new hash:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;graphql&quot;&gt;&lt;pre class=&quot;language-graphql&quot;&gt;&lt;code class=&quot;language-graphql&quot;&gt;subscription &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  watch &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    commit &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      hash
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For every change, a message like the following will be sent:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;json&quot;&gt;&lt;pre class=&quot;language-json&quot;&gt;&lt;code class=&quot;language-json&quot;&gt;&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token property&quot;&gt;&quot;watch&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
    &lt;span class=&quot;token property&quot;&gt;&quot;commit&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
      &lt;span class=&quot;token property&quot;&gt;&quot;hash&quot;&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;c01a59bacc16d89e9cdd344a969f494bb2698d8f&quot;&lt;/span&gt;
    &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Under the hood, subscriptions in &lt;code&gt;irmin-graphql&lt;/code&gt; are implemented using Irmin watches, but this is opaque to the client -- this will work with any GraphQL spec compliant client!&lt;/p&gt;
&lt;p&gt;Here's a video, which hows how the GraphQL response changes live as the Irmin store is being manipulated:&lt;/p&gt;
&lt;p&gt;&lt;video controls width=680&gt;&lt;source src=&quot;/blog/2019-11-27-introducing-irmin-graphql/irmin-subscriptions.mp4&quot; type=video/mp4&gt;&lt;/video&gt;&lt;/p&gt;
&lt;p&gt;Note that the current implementation only supports websockets with more transport options coming soon.&lt;/p&gt;
&lt;h1 id=&quot;wrap-up&quot;&gt;&lt;a href=&quot;#wrap-up&quot; aria-label=&quot;wrap up permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Wrap-up&lt;/h1&gt;
&lt;p&gt;Irmin 2.0 ships with a powerful new GraphQL API, that makes it much easier to interact with Irmin over the network. This makes Irmin available for many more languages and contexts, not just applications using OCaml (or Javascript). The new API operates at a much high level than the old API, and offers advanced features such as &quot;bring your own GraphQL types&quot;, and watching for changes via GraphQL subscriptions.&lt;/p&gt;
&lt;p&gt;We're looking forward to seeing what you'll build with it!&lt;/p&gt;</content><id>https://tarides.com/blog/2019-11-27-introducing-the-graphql-api-for-irmin-2-0.html</id><title type="text">Introducing the GraphQL API for Irmin 2.0</title><updated>2019-11-27T00:00:00-00:00</updated><author><name>Andreas Garnaes</name></author></entry><entry><source><updated>2020-01-08T20:00:00-00:00</updated><subtitle type="text">on building functional operating systems</subtitle><rights type="text">All rights reserved by the author</rights><link type="text/html" href="https://mirage.io/blog/" rel="alternate"/><link href="https://mirage.io/blog/atom.xml" rel="self"/><contributor><uri>https://www.lemonde.fr/signataires/damien-leloup/</uri><name>Damien Leloup</name></contributor><contributor><email>anil@recoil.org</email><uri>http://anil.recoil.org</uri><name>Anil Madhavapeddy</name></contributor><contributor><email>martin@lucina.net</email><uri>https://lucina.net/</uri><name>Martin Lucina</name></contributor><contributor><email>talex5@gmail.com</email><uri>http://roscidus.com/blog/</uri><name>Thomas Leonard</name></contributor><contributor><email>hm519@cam.ac.uk</email><uri>https://github.com/hannesm</uri><name>Hannes Mehnert</name></contributor><contributor><email>mindy.preston@cl.cam.ac.uk</email><uri>https://github.com/yomimono</uri><name>Mindy Preston</name></contributor><contributor><uri>https://linse.me</uri><name>Stefanie Schirmer</name></contributor><contributor><email>thomas@gazagnaire.org</email><uri>http://gazagnaire.org</uri><name>Thomas Gazagnaire</name></contributor><contributor><email>gg417@cl.cam.ac.uk</email><uri>https://github.com/GemmaG</uri><name>Gemma Gordon</name></contributor><contributor><email>drupyog@zoho.com</email><uri>https://github.com/drup</uri><name>Gabriel Radanne</name></contributor><contributor><email>djwillia@us.ibm.com</email><uri>https://github.com/djwillia</uri><name>Dan Williams</name></contributor><contributor><email>haesbaert@haesbaert.org</email><uri>http://www.haesbaert.org/</uri><name>Christiano Haesbaert</name></contributor><contributor><email>amirmc@gmail.com</email><uri>http://amirchaudhry.com</uri><name>Amir Chaudhry</name></contributor><contributor><email>david.mersinjak@cl.cam.ac.uk</email><uri>https://github.com/pqwy</uri><name>David Kaloper</name></contributor><contributor><email>dave@recoil.org</email><uri>http://dave.recoil.org/</uri><name>Dave Scott</name></contributor><contributor><email>jon@recoil.org</email><uri>http://jon.recoil.org</uri><name>Jon Ludlam</name></contributor><contributor><email>jeremy.yallop@cl.cam.ac.uk</email><uri>https://github.com/yallop</uri><name>Jeremy Yallop</name></contributor><contributor><email>mort@cantab.net</email><uri>http://mort.io/</uri><name>Richard Mortier</name></contributor><contributor><email>vb@luminar.eu.org</email><uri>https://github.com/vbmithr</uri><name>Vincent Bernardoff</name></contributor><contributor><email>raphlalou@gmail.com</email><uri>https://github.com/raphael-proust</uri><name>Raphael Proust</name></contributor><id>https://mirage.io/blog/</id><title type="text">The MirageOS Blog</title><author><name>MirageOS</name></author></source><link type="text/html" href="https://mirage.io/blog/introducing-irmin-v2" rel="alternate"/><content xml:base="https://mirage.io/blog/atom.xml" type="xhtml"><div xmlns="http://www.w3.org/1999/xhtml"><p>We are pleased to announce <a href="https://github.com/mirage/irmin/releases">Irmin
2.0.0</a>, a major release of the
Git-like distributed branching and storage substrate that underpins MirageOS.
We began the release process for all the components that make up Irmin <a href="https://tarides.com/blog/2019-05-13-on-the-road-to-irmin-v2">back in
May 2019</a>, and
there have been close to 1000 commits since Irmin 1.4.0 release back in June</p>
<ol><li>To celebrate this milestone, we have a new logo and opened a dedicated
website: <a href="https://irmin.org">irmin.org</a>.</li></ol>

<p>You can read more details about the new features in the <a href="https://tarides.com/blog/2019-11-21-irmin-v2">Irmin v2 blog
post</a>.  Enjoy the new release,
and stay tuned for the upcoming Wodan integration in 2020 that will be a stable
filesystem for the hypervisor targets for MirageOS that do not have a
conventional OS kernel underneath them!</p>
</div></content><id>https://mirage.io/blog/introducing-irmin-v2</id><title type="text">Announcing Irmin 2.0.0</title><updated>2019-11-26T15:00:00-00:00</updated><author><email>anil@recoil.org</email><uri>http://anil.recoil.org</uri><name>Anil Madhavapeddy</name></author></entry><entry><source><updated>2019-12-11T00:00:00-00:00</updated><link title="Tarides RSS Feed" type="text/html" href="https://tarides.com" rel="related"/><link title="Tarides RSS Feed" type="application/rss+xml" href="https://tarides.com/feed.xml" rel="self"/><generator>GatsbyJS</generator><id>https://tarides.com</id><title type="text">Tarides RSS Feed</title><author><name>Tarides</name></author></source><link href="https://tarides.com/blog/2019-11-21-irmin-v2" rel="alternate"/><content xml:base="https://tarides.com/feed.xml" type="html">&lt;p&gt;We are pleased to announce &lt;a href=&quot;https://github.com/mirage/irmin/releases&quot;&gt;Irmin
2.0.0&lt;/a&gt;, a major release of the
Git-like distributed branching and storage substrate that underpins
&lt;a href=&quot;https://mirage.io&quot;&gt;MirageOS&lt;/a&gt;.  We began the release process for all the
components that make up Irmin &lt;a href=&quot;https://tarides.com/blog/2019-05-13-on-the-road-to-irmin-v2&quot;&gt;back in May
2019&lt;/a&gt;, and there
have been close to 1000 commits since Irmin 1.4.0 released back in June 2018. To
celebrate this milestone, we have a new logo and opened a dedicated website:
&lt;a href=&quot;https://irmin.org&quot;&gt;irmin.org&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Our focus this year has been on ensuring the production success of our
early adopters -- such as the
&lt;a href=&quot;https://gitlab.com/tezos/tezos/tree/master/src/lib_storage&quot;&gt;Tezos&lt;/a&gt; blockchain
and the &lt;a href=&quot;https://github.com/moby/datakit&quot;&gt;Datakit 9P&lt;/a&gt;
stack -- as well as spawning new research projects into the practical
application of distributed and mergeable data stores.  We are also
very pleased to welcome several new maintainers into the Mirage
project for their contributions to Irmin, namely
&lt;a href=&quot;https://github.com/icristescu&quot;&gt;Ioana Cristescu&lt;/a&gt;,
&lt;a href=&quot;https://github.com/CraigFe&quot;&gt;Craig Ferguson&lt;/a&gt;,
&lt;a href=&quot;https://github.com/andreas&quot;&gt;Andreas Garnaes&lt;/a&gt;,
&lt;a href=&quot;https://github.com/pascutto&quot;&gt;Clément Pascutto&lt;/a&gt; and
&lt;a href=&quot;https://github.com/zshipko&quot;&gt;Zach Shipko&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;new-major-features&quot;&gt;&lt;a href=&quot;#new-major-features&quot; aria-label=&quot;new major features permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;New Major Features&lt;/h2&gt;
&lt;h3 id=&quot;new-cli&quot;&gt;&lt;a href=&quot;#new-cli&quot; aria-label=&quot;new cli permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;New CLI&lt;/h3&gt;
&lt;p&gt;While Irmin is normally used as a library, it is obviously useful to
be able to interact with a data store from a shell.  The &lt;code&gt;irmin-unix&lt;/code&gt;
opam package now provides an &lt;code&gt;irmin&lt;/code&gt; binary that is configured via a
Yaml file and can perform queries and mutations against a Git store.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;shell&quot;&gt;&lt;pre class=&quot;language-shell&quot;&gt;&lt;code class=&quot;language-shell&quot;&gt;$ &lt;span class=&quot;token builtin class-name&quot;&gt;echo&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;root: .&quot;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; irmin.yml
$ irmin init
$ irmin &lt;span class=&quot;token builtin class-name&quot;&gt;set&lt;/span&gt; foo/bar &lt;span class=&quot;token string&quot;&gt;&quot;testing 123&quot;&lt;/span&gt;
$ irmin get foo/bar&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Try &lt;code&gt;irmin --help&lt;/code&gt; to see all the commands and options available.&lt;/p&gt;
&lt;h3 id=&quot;tezos-and-irmin-pack&quot;&gt;&lt;a href=&quot;#tezos-and-irmin-pack&quot; aria-label=&quot;tezos and irmin pack permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Tezos and irmin-pack&lt;/h3&gt;
&lt;p&gt;Another big user of Irmin is the &lt;a href=&quot;https://tezos.com&quot;&gt;Tezos blockchain&lt;/a&gt;,
and we have been optimising the persistent space usage of Irmin as their
network grows.  Because Tezos doesn’t require full Git format support,
we created a hybrid backend that grabs the best bits of Git (e.g. the
packfile mechanism) and engineered a domain-specific backend tailored
for Tezos usage. Crucially, because of the way Irmin is split into
clean libraries and OCaml modules, we only had to modify a small part
of the codebase and could also reuse elements of our
&lt;a href=&quot;https://github.com/mirage/ocaml-git&quot;&gt;OCaml-git&lt;/a&gt; codebase as well.&lt;/p&gt;
&lt;p&gt;The &lt;a href=&quot;https://github.com/mirage/irmin/pull/615&quot;&gt;irmin-pack backend&lt;/a&gt; is available
for &lt;a href=&quot;https://github.com/mirage/irmin/pull/888&quot;&gt;use in the CLI&lt;/a&gt; and provides a
significant improvement in disk usage.  There is a corresponding &lt;a href=&quot;https://gitlab.com/tezos/tezos/merge_requests/1268&quot;&gt;Tezos merge
request&lt;/a&gt; using the Irmin
2.0 code that has been integrated downstream and will become available via
their release process in due course.&lt;/p&gt;
&lt;p&gt;As part of this development process, we also released an efficient multi-level
index implementation (imaginatively dubbed
&lt;a href=&quot;https://github.com/mirage/index&quot;&gt;index&lt;/a&gt; in opam). Our implementation takes an
arbitrary IO implementation and user-supplied content types and supplies a
standard key-value interface for persistent storage. Index provides instance
sharing by default, so each OCaml runtime shares a common singleton instance.&lt;/p&gt;
&lt;h3 id=&quot;irmin-graphql-and-browser-irmin&quot;&gt;&lt;a href=&quot;#irmin-graphql-and-browser-irmin&quot; aria-label=&quot;irmin graphql and browser irmin permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Irmin-GraphQL and “browser Irmin”&lt;/h3&gt;
&lt;p&gt;Another new area of huge interest to us is
&lt;a href=&quot;https://graphql.org&quot;&gt;GraphQL&lt;/a&gt; in order to provide frontends with a rich
query language for Irmin-hosted applications.  Irmin 2.0 includes a
built-in GraphQL server so you can &lt;a href=&quot;https://twitter.com/cuvius/status/1017136581755457539&quot;&gt;manipulate your Git repo via
GraphQL&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If you are interested in (for example) compiling elements of Irmin to
JavaScript or wasm, for usage in frontends, then the Irmin 2.0 release
makes it significantly easier to support this architecture.  We’ve
already seen some exploratory efforts &lt;a href=&quot;https://github.com/mirage/irmin/issues/681&quot;&gt;report issues&lt;/a&gt;
when doing this, and we’ve had it working ourselves in &lt;a href=&quot;http://roscidus.com/blog/blog/2015/04/28/cuekeeper-gitting-things-done-in-the-browser/&quot;&gt;Irmin 1.0 Cuekeeper&lt;/a&gt;
so we are excited by the potential power of applications built using
this model.  If you have ideas/questions, please get in touch on the
&lt;a href=&quot;https://github.com/mirage/irmin/issues&quot;&gt;issue tracker&lt;/a&gt; with your
usecase.&lt;/p&gt;
&lt;h3 id=&quot;wodan&quot;&gt;&lt;a href=&quot;#wodan&quot; aria-label=&quot;wodan permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Wodan&lt;/h3&gt;
&lt;p&gt;Irmin’s storage layer is also well abstracted, so backends other than
a Unix filesystem or Git are supported.  Irmin can run in highly
diverse and OS-free environments, and so we began engineering the
&lt;a href=&quot;https://github.com/mirage/wodan&quot;&gt;Wodan filesystem&lt;/a&gt; as a
domain-specific filesystem designed for MirageOS, Irmin and modern
flash drives.  See &lt;a href=&quot;https://g2p.github.io/research/wodan.pdf&quot;&gt;the OCaml Workshop 2017 abstract on
it&lt;/a&gt; for more design
rationale.&lt;/p&gt;
&lt;p&gt;As part of the Irmin 2.0 release, Wodan is also being prepared for a
release, and you can find &lt;a href=&quot;https://github.com/mirage/wodan/tree/master/src/wodan-irmin&quot;&gt;Irmin 2.0
support&lt;/a&gt;
in the source.  If you’d like a standalone block-device based
persistence environment for Irmin, please try this out.  This is the
preferred backend for using Irmin storage in a unikernel.&lt;/p&gt;
&lt;h3 id=&quot;versioned-caldav&quot;&gt;&lt;a href=&quot;#versioned-caldav&quot; aria-label=&quot;versioned caldav permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt; Versioned CalDAV&lt;/h3&gt;
&lt;p&gt;An application pulling all these pieces together is being developed
by our friends at &lt;a href=&quot;https://robur.io/About%20Us/Team&quot;&gt;Robur&lt;/a&gt;: an Irmin-based
&lt;a href=&quot;https://github.com/roburio/caldav&quot;&gt;CalDAV calendaring server&lt;/a&gt;
that even hosts its DNS server using a versioned Irmin store.  We'll
blog more about this as the components get released and stabilised, but
the unikernel enthusiasts among you may want to browse the
&lt;a href=&quot;https://github.com/roburio/unikernels/tree/future&quot;&gt;Robur unikernels future branch&lt;/a&gt;
to see how they are deploying them today.&lt;/p&gt;
&lt;p&gt;A huge thank you to all our commercial customers, end users and open-source
developers who have contributed their time, expertise and
financial support to help us achieve our goal of delivering a modern
storage stack in the spirit of Git.  Our next steps for Irmin are to
continue to increase the performance and optimise the storage,
and to build more end-to-end applications using the application core
on top of MirageOS.&lt;/p&gt;</content><id>https://tarides.com/blog/2019-11-21-irmin-v2.html</id><title type="text">Irmin v2</title><updated>2019-11-21T00:00:00-00:00</updated><author><name>Thomas Gazagnaire</name></author></entry><entry><source><updated>2019-11-19T00:00:00-00:00</updated><link title="The BAP Blog" type="text/html" href="http://binaryanalysisplatform.github.io/" rel="related"/><link title="The BAP Blog" type="application/rss+xml" href="https://binaryanalysisplatform.github.io/feed.xml" rel="self"/><id>http://binaryanalysisplatform.github.io/</id><title type="text">The BAP Blog</title><author><name>The BAP Blog</name></author></source><link href="http://binaryanalysisplatform.github.io/bap-2-release" rel="alternate"/><content xml:base="https://binaryanalysisplatform.github.io/feed.xml" type="html">&lt;p&gt;The Carnegie Mellon University &lt;a href=&quot;https://github.com/BinaryAnalysisPlatform/bap&quot;&gt;Binary Analysis Platform (CMU BAP)&lt;/a&gt; is a suite of utilities and libraries that enables analysis of programs in their machine representation. BAP is written in OCaml, relies on dynamically loaded plugins for extensibility, and is widely used for security analysis, program verification, and reverse engineering.&lt;/p&gt;

&lt;p&gt;This is a major update that includes lots of new features, libraries, and tools, as well as improvements and bug fixes to the existing code. The following small &lt;a href=&quot;https://t.co/ylzub6LBRq?amp=1&quot;&gt;demo&lt;/a&gt; showcases the modern BAP look and feel.
In this announcement we would like to focus on two very important features of BAP 2.0:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;http://binaryanalysisplatform.github.io/bap/api/odoc/bap-knowledge/Bap_knowledge/Knowledge/index.html&quot;&gt;knowledge representation and reasoning system&lt;/a&gt;;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://binaryanalysisplatform.github.io/bap/api/master/bap-core-theory/Bap_core_theory/index.html&quot;&gt;the tagless final representation of program semantics&lt;/a&gt;.&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&quot;the-knowledge-base&quot;&gt;The Knowledge Base&lt;/h2&gt;

&lt;p&gt;The Knowledge Representation and Reasoning System, or the Knowledge Base (KB) for short, is the central part of our new architecture. The KB is a step forward from the conventional approach to staging multiple analyses in which dependent analyses (aka passes) are ordered topologically, based on their dependencies. The KB is inspired by logic programming and enables an optimal and seamless staging of mutually dependent analyses. Mutually dependent analyses are also present in the source-based program analysis but are much more evident in the field of binary analysis and reverse engineering, where even such basic artifacts as control flow graph and call graph are not available as ground truth (and in general are not even computable).&lt;/p&gt;

&lt;p&gt;Object properties in the KB are represented with directed-complete partially ordered sets.  The KB also imposes the monotonicity restriction that requires that all updates to the property are monotonic, i.e., each consequent value of the same property is a refinement of the previous value. These restrictions enable the KB to compute the least fixed point of any property,  is computed. A property representation could be optionally refined into a complete lattice, which gives the KB users extra control on how properties are computed.&lt;/p&gt;

&lt;p&gt;By storing all information in an external location the KB addresses the scalability issue so relevant to binary analysis and reverse engineering. In the future, we plan to implement a distributed storage for our Knowledge Base as well as experiment with other inference engines. Soon, it should also possible to work with the knowledge base in non-OCaml programs, including our BAP Lisp dialect. That, practically, turns the knowledge base into a common runtime for binary analysis. In the current version of BAP, the Knowledge Base state is fully serializable and portable between different versions of BAP, OCaml, and even between native and bytecode runtimes. The Knowledge Base state could be imported into an application and is integrated with the BAP caching system.&lt;/p&gt;

&lt;h2 id=&quot;new-program-representation&quot;&gt;New Program Representation&lt;/h2&gt;

&lt;p&gt;Employing the tagless final embedding together with our new Knowledge Base we were able to achieve our main goal - to switch to an extensible program representation without compromising any existing code that uses the current, non-extensible, BAP Intermediate Language (BIL). The new representation allows us to add new language features (like floating-point operations or superscalar pipeline manipulations) without breaking (or even recompiling) the existing analyses. The new representation also facilitates creation of new intermediate languages which all can coexist with each other, making it easier to write formally verified analyses.&lt;/p&gt;

&lt;h1 id=&quot;links&quot;&gt;Links&lt;/h1&gt;
&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/BinaryAnalysisPlatform/bap&quot;&gt;The Main Page&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;http://binaryanalysisplatform.github.io/bap/api/odoc/index.html&quot;&gt;Documentation&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://github.com/BinaryAnalysisPlatform/bap-tutorial&quot;&gt;The tutorial&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://gitter.im/BinaryAnalysisPlatform/bap&quot;&gt;Our Chat&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://binaryanalysisplatform.github.io/&quot;&gt;Our Blog&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://discuss.ocaml.org/t/ann-bap-2-0-release/4719&quot;&gt;Discuss the news&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

</content><id>http://binaryanalysisplatform.github.io/bap-2-release</id><title type="text">BAP 2.0 is released</title><updated>2019-11-19T00:00:00-00:00</updated><author><name>The BAP Blog</name></author></entry><entry><source><updated>2019-12-12T11:47:27-00:00</updated><link href="https://roscidus.com/blog/" rel="alternate"/><link href="https://roscidus.com/blog/blog/categories/ocaml/atom.xml" rel="self"/><generator uri="http://octopress.org/">Octopress</generator><id>https://roscidus.com/blog/</id><title type="text">Category: ocaml | Thomas Leonard's blog</title><author><name>Thomas Leonard</name></author></source><link href="https://roscidus.com/blog/blog/2019/11/14/cicd-pipelines/" rel="alternate"/><content xml:base="http://roscidus.com/blog/blog/categories/ocaml/atom.xml" type="html">&lt;p&gt;In this post I describe three approaches to building a language for writing CI/CD pipelines. My first attempt used a &lt;i&gt;monad&lt;/i&gt;, but this prevented static analysis of the pipelines. I then tried using an &lt;i&gt;arrow&lt;/i&gt;, but found the syntax very difficult to use. Finally, I ended up using a light-weight alternative to arrows that I will refer to here as a &lt;i&gt;dart&lt;/i&gt; (I don’t know if this has a name already). This allows for static analysis like an arrow, but has a syntax even simpler than a monad.&lt;/p&gt;

&lt;!-- more --&gt;

&lt;p&gt;&lt;strong&gt;Table of Contents&lt;/strong&gt;&lt;/p&gt;

&lt;ul id=&quot;markdown-toc&quot;&gt;
  &lt;li&gt;&lt;a href=&quot;#introduction&quot;&gt;Introduction&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#attempt-one-a-monad&quot;&gt;Attempt one: a monad&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#attempt-two-an-arrow&quot;&gt;Attempt two: an arrow&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#attempt-three-a-dart&quot;&gt;Attempt three: a dart&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#comparison-with-arrows&quot;&gt;Comparison with arrows&lt;/a&gt;&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#larger-examples&quot;&gt;Larger examples&lt;/a&gt;    &lt;ul&gt;
      &lt;li&gt;&lt;a href=&quot;#ocaml-docker-base-image-builder&quot;&gt;OCaml Docker base image builder&lt;/a&gt;&lt;/li&gt;
      &lt;li&gt;&lt;a href=&quot;#ocaml-ci&quot;&gt;OCaml CI&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
  &lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;#conclusions&quot;&gt;Conclusions&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;( this post also appeared on &lt;a href=&quot;https://www.reddit.com/r/ocaml/comments/dwpxdj/cicd_pipelines_monad_arrow_or_dart/&quot;&gt;Reddit&lt;/a&gt;
and &lt;a href=&quot;https://lobste.rs/s/u5i2t0/ci_cd_pipelines_monad_arrow_dart&quot;&gt;Lobsters&lt;/a&gt; )&lt;/p&gt;

&lt;h2 id=&quot;introduction&quot;&gt;Introduction&lt;/h2&gt;

&lt;p&gt;I was asked to build a system for creating CI/CD pipelines.
The initial use for it was to build a CI for testing OCaml projects on GitHub (testing each commit against multiple versions of the OCaml compiler and on multiple operating systems).
Here’s a simple pipeline that gets the Git commit at the head of a branch, builds it,
and then runs the tests:&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;center&quot; src=&quot;https://roscidus.com/blog/images/cicd/example1.svg&quot; /&gt;&lt;/p&gt;

&lt;p&gt;The colour-scheme here is that green boxes are completed, orange ones are in progress and grey means the step can’t be started yet.&lt;/p&gt;

&lt;p&gt;Here’s a slightly more complex example, which also downloads a Docker base image, builds the commit in parallel using two different versions of the OCaml compiler, and then tests the resulting images. Here the red box indicates that this step failed:&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;center&quot; src=&quot;https://roscidus.com/blog/images/cicd/example2.svg&quot; /&gt;&lt;/p&gt;

&lt;p&gt;A more complex example is testing the project itself and then searching for other projects that depend on it and testing those against the new version too:&lt;/p&gt;

&lt;p&gt;&lt;img class=&quot;center&quot; src=&quot;https://roscidus.com/blog/images/cicd/example3.svg&quot; /&gt;&lt;/p&gt;

&lt;p&gt;Here, the circle means that we should wait for the tests to pass before checking the reverse dependencies.&lt;/p&gt;

&lt;p&gt;We could describe these pipelines using YAML or similar, but that would be very limiting.
Instead, I decided to use an Embedded Domain Specific Language, so that we can use the host
language’s features for free (e.g. string manipulation, variables, functions, imports,
type-checking, etc).&lt;/p&gt;

&lt;p&gt;The most obvious approach is making each box a regular function.
Then the first example above could be (here, using OCaml syntax):&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example1&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;The second could be:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;10&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;docker_pull&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;ocaml/opam2&amp;quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dockerfile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;make_dockerfile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dockerfile&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;4.07&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;4.08&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;And the third might look something like this:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;revdeps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_revdeps&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;nn&quot;&gt;List&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;iter&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example1&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;revdeps&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;However, we’d like to add some extras to the language:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;Pipeline steps should run in parallel when possible.
The &lt;code&gt;example2&lt;/code&gt; function above would do the builds one at a time.&lt;/li&gt;
  &lt;li&gt;Pipeline steps should be recalculated whenever their input changes.
e.g. when a new commit is made we need to rebuild.&lt;/li&gt;
  &lt;li&gt;The user should be able to view the progress of each step.&lt;/li&gt;
  &lt;li&gt;The user should be able to trigger a rebuild for any step.&lt;/li&gt;
  &lt;li&gt;We should be able to generate the diagrams automatically from the code,
so we can see what the pipeline will do before running it.&lt;/li&gt;
  &lt;li&gt;The failure of one step shouldn’t stop the whole pipeline.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The exact extras don’t matter too much to this blog post,
so for simplicity I’ll focus on just running steps concurrently.&lt;/p&gt;

&lt;h2 id=&quot;attempt-one-a-monad&quot;&gt;Attempt one: a monad&lt;/h2&gt;

&lt;p&gt;Without the extra features, we have functions like this:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;You can read this as “&lt;code&gt;build&lt;/code&gt; is a function that takes a &lt;code&gt;source&lt;/code&gt; value and returns a (Docker) &lt;code&gt;image&lt;/code&gt;”.&lt;/p&gt;

&lt;p&gt;These functions compose together easily to make a larger function that will fetch a
commit and build it:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fab&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;&lt;img class=&quot;center&quot; src=&quot;https://roscidus.com/blog/images/cicd/fetch_and_build.svg&quot; /&gt;&lt;/p&gt;

&lt;p&gt;We could also shorten this to &lt;code&gt;build (fetch c)&lt;/code&gt; or to &lt;code&gt;fetch c |&amp;gt; build&lt;/code&gt;.
The &lt;code&gt;|&amp;gt;&lt;/code&gt; (pipe) operator in OCaml just calls the function on its right with the argument on its left.&lt;/p&gt;

&lt;p&gt;To extend these functions to be concurrent, we can make them return promises, e.g.&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;But now we can’t compose them easily using &lt;code&gt;let&lt;/code&gt; (or &lt;code&gt;|&amp;gt;&lt;/code&gt;), because the output type of &lt;code&gt;fetch&lt;/code&gt; doesn’t match the input of &lt;code&gt;build&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;However, we can define a similar operation, &lt;code&gt;let*&lt;/code&gt; (or &lt;code&gt;&amp;gt;&amp;gt;=&lt;/code&gt;) that works with promises. It immediately returns a promise for the final
result, and calls the body of the &lt;code&gt;let*&lt;/code&gt; later, when the first promise is fulfilled. Then we have:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fab&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;In order words, by sprinkling a few &lt;code&gt;*&lt;/code&gt; characters around we can turn our plain old pipeline into a new concurrent one!
The rules for when you can compose promise-returning functions using &lt;code&gt;let*&lt;/code&gt; are exactly the same as the rules about when
you can compose regular functions using &lt;code&gt;let&lt;/code&gt;, so writing programs using promises is just as easy as writing regular programs.&lt;/p&gt;

&lt;p&gt;Just using &lt;code&gt;let*&lt;/code&gt; doesn’t add any concurrency within our pipeline
(it just allows it to execute concurrently with other code).
But we can define extra functions for that, such as &lt;code&gt;all&lt;/code&gt; to evaluate every promise in a list at once,
or an &lt;code&gt;and*&lt;/code&gt; operator to indicate that two things should run in parallel:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;11&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;12&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;13&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;14&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;c&quot;&gt;(* Fetch the source code and Docker base image in parallel: *)&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;docker_pull&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;ocaml/opam2&amp;quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dockerfile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;make_dockerfile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dockerfile&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;c&quot;&gt;(* Build and test against each compiler version in parallel: *)&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;4.07&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;4.08&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;As well as handling promises,
we could also define a &lt;code&gt;let*&lt;/code&gt; for functions that might return errors (the body of the let is called only if the first value
is successful), or for live updates (the body is called each time the input changes), or for all of these things together.
This is the basic idea of a monad.&lt;/p&gt;

&lt;p&gt;This actually works pretty well.
In 2016, I used this approach to make &lt;a href=&quot;https://github.com/moby/datakit/tree/master/ci&quot;&gt;DataKitCI&lt;/a&gt;, which was used initially as the CI system for Docker-for-Mac.
Later, Anil Madhavapeddy used it to create &lt;a href=&quot;https://github.com/avsm/mirage-ci&quot;&gt;opam-repo-ci&lt;/a&gt;, which is the CI system for &lt;a href=&quot;https://github.com/ocaml/opam-repository&quot;&gt;opam-repository&lt;/a&gt;, OCaml’s main package repository.
This checks each new PR to see what packages it adds or modifies,
tests each one against multiple OCaml compiler versions and Linux distributions (Debian, Ubuntu, Alpine, CentOS, Fedora and OpenSUSE),
and then finds all versions of all packages depending on the changed packages and tests those too.&lt;/p&gt;

&lt;p&gt;The main problem with using a monad is that we can’t statically analyse the pipeline.
Consider the &lt;code&gt;example2&lt;/code&gt; function above. Until we have queried GitHub to get a commit to
test, we cannot run the function and therefore have no idea what it will do.
Once we have &lt;code&gt;commit&lt;/code&gt; we can call &lt;code&gt;example2 commit&lt;/code&gt;,
but until the &lt;code&gt;fetch&lt;/code&gt; and &lt;code&gt;docker_pull&lt;/code&gt; operations complete we cannot evaluate the body of the &lt;code&gt;let*&lt;/code&gt; to find out what the pipeline will do next.&lt;/p&gt;

&lt;p&gt;In other words, we can only draw diagrams showing the bits of the pipeline that have already
executed or are currently executing, and we must indicate opportunities for concurrency
manually using &lt;code&gt;and*&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;attempt-two-an-arrow&quot;&gt;Attempt two: an arrow&lt;/h2&gt;

&lt;p&gt;An &lt;a href=&quot;https://en.wikipedia.org/wiki/Arrow_(computer_science)&quot;&gt;arrow&lt;/a&gt; makes it possible to analyse pipelines statically.
Instead of our monadic functions:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;we can define an arrow type:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;source&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;An &lt;code&gt;('a, 'b) arrow&lt;/code&gt; is a pipeline that takes an input of type &lt;code&gt;'a&lt;/code&gt; and produces a result of type &lt;code&gt;'b&lt;/code&gt;.
If we define &lt;code&gt;type ('a, 'b) arrow = 'a -&amp;gt; 'b promise&lt;/code&gt; then this is the same as the monadic version.
However, we can instead make the &lt;code&gt;arrow&lt;/code&gt; type abstract and extend it to store whatever static information we require.
For example, we could label the arrows:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;label&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;string&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;Here, &lt;code&gt;arrow&lt;/code&gt; is a record. &lt;code&gt;f&lt;/code&gt; is the old monadic function and &lt;code&gt;label&lt;/code&gt; is the “static analysis”.&lt;/p&gt;

&lt;p&gt;Users can’t see the internals of the &lt;code&gt;arrow&lt;/code&gt; type, and must build up pipelines using functions provided by the arrow implementation.
There are three basic functions available:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;first&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;((&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;),&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;&lt;code&gt;arr&lt;/code&gt; takes a pure function and gives the equivalent arrow.
For our promise example, that means the arrow returns a promise that is already fulfilled.
&lt;code&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/code&gt; joins two arrows together.
&lt;code&gt;first&lt;/code&gt; takes an arrow from &lt;code&gt;'a&lt;/code&gt; to &lt;code&gt;'b&lt;/code&gt; and makes it work on pairs instead.
The first element of the pair will be processed by the given arrow and
the second component is returned unchanged.&lt;/p&gt;

&lt;p&gt;We can have these operations automatically create new arrows with appropriate &lt;code&gt;f&lt;/code&gt; and &lt;code&gt;label&lt;/code&gt; fields.
For example, in &lt;code&gt;a &amp;gt;&amp;gt;&amp;gt; b&lt;/code&gt;, the resulting label field could be the string &lt;code&gt;{a.label} &amp;gt;&amp;gt;&amp;gt; {b.label}&lt;/code&gt;.
This means that we can display the pipeline without having to run it first,
and we could easily replace &lt;code&gt;label&lt;/code&gt; with something more structured if needed.&lt;/p&gt;

&lt;p&gt;With this our first example changes from:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example1&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;to&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example1&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;That seems quite pleasant, although we did have to give up our variable names.
But things start to get complicated with larger examples. For &lt;code&gt;example2&lt;/code&gt;, we
need to define a few standard combinators:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;11&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;12&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;13&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;14&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;c&quot;&gt;(** Process the second component of a tuple, leaving the first unchanged. *)&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;second&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;swap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;y&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;swap&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;first&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;swap&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;c&quot;&gt;(** [f *** g] processes the first component of a pair with [f] and the second&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;c&quot;&gt;    with [g]. *)&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;***&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;first&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;second&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;c&quot;&gt;(** [f &amp;amp;&amp;amp;&amp;amp; g] processes a single value with [f] and [g] in parallel and&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;c&quot;&gt;    returns a pair with the results. *)&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;***&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;g&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;Then, &lt;code&gt;example2&lt;/code&gt; changes from:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;10&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;docker_pull&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;ocaml/opam2&amp;quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dockerfile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;make_dockerfile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dockerfile&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;4.07&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;4.08&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;to:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;10&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example2&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;first&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;make_dockerfile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build_with_dockerfile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;c&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;docker_pull&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;ocaml/opam2&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;***&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;4.07&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;4.08&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;bp&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;bp&quot;&gt;()&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;We’ve lost most of the variable names and instead have to use tuples, remembering where our values are.
It’s not &lt;em&gt;too&lt;/em&gt; bad here with two values,
but it gets very difficult very quickly as more are added and we start nesting tuples.
We also lost the ability to use an optional labelled argument in &lt;code&gt;build ~dockerfile src&lt;/code&gt;
and instead need to use a new operation that takes a tuple of the dockerfile and the source.&lt;/p&gt;

&lt;p&gt;Imagine that running the tests now requires getting the test cases from the source code.
In the original code, we’d just change &lt;code&gt;test image&lt;/code&gt; to &lt;code&gt;test image ~using:src&lt;/code&gt;.
In the arrow version, we need to duplicate the source before the build step,
run the build with &lt;code&gt;first build_with_dockerfile&lt;/code&gt;,
and make sure the arguments are the right way around for a new &lt;code&gt;test_using&lt;/code&gt;.&lt;/p&gt;

&lt;h2 id=&quot;attempt-three-a-dart&quot;&gt;Attempt three: a dart&lt;/h2&gt;

&lt;p&gt;I started wondering whether there might be an easier way to achieve the same static analysis that you get with arrows,
but without the point-free syntax, and it seems that there is. Consider the monadic version of &lt;code&gt;example1&lt;/code&gt;.
We had:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example1&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;If you didn’t know about monads, there is another way you might try to do this.
Instead of using &lt;code&gt;let*&lt;/code&gt; to wait for the &lt;code&gt;fetch&lt;/code&gt; to complete and then calling &lt;code&gt;build&lt;/code&gt; with
the source, you might define &lt;code&gt;build&lt;/code&gt; and &lt;code&gt;test&lt;/code&gt; to take promises as inputs:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;source&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;results&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;After all, fetching gives you a &lt;code&gt;source promise&lt;/code&gt; and you want an &lt;code&gt;image promise&lt;/code&gt;, so this seems very natural.
We could even have &lt;code&gt;example1&lt;/code&gt; take a promise of the commit.
Then it looks like this:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example1&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;That’s good, because it’s identical to the simple version we started with.
The problem is that it is inefficient:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;We call &lt;code&gt;example1&lt;/code&gt; with the promise of the commit (we don’t know what it is yet).&lt;/li&gt;
  &lt;li&gt;Without waiting to find out which commit we’re testing, we call &lt;code&gt;fetch&lt;/code&gt;, getting back a promise of some source.&lt;/li&gt;
  &lt;li&gt;Without waiting to get the source, we call &lt;code&gt;build&lt;/code&gt;, getting a promise of an image.&lt;/li&gt;
  &lt;li&gt;Without waiting for the build, we call &lt;code&gt;test&lt;/code&gt;, getting a promise of the results.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;We return the final promise of the test results immediately, but we haven’t done any real work yet.
Instead, we’ve built up a long chain of promises, wasting memory.&lt;/p&gt;

&lt;p&gt;However, in this situation what we want is to perform a static analysis.
i.e. we want to build up in memory some data structure representing the pipeline…
and this is exactly what our “inefficient” use of the monad produces!&lt;/p&gt;

&lt;p&gt;To make this useful, we need the primitive operations (such as &lt;code&gt;fetch&lt;/code&gt;)
to provide some information (e.g. labels) for the static analysis.
OCaml’s &lt;code&gt;let&lt;/code&gt; syntax doesn’t provide an obvious place for a label,
but I was able to define an operator (&lt;code&gt;let**&lt;/code&gt;) that returns a function taking a label argument.
It can be used to build primitive operations like this:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;s2&quot;&gt;&amp;quot;fetch&amp;quot;&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;**&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;c&quot;&gt;(* (standard monadic implementation of fetch goes here) *)&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;So, &lt;code&gt;fetch&lt;/code&gt; takes a promise of a commit, does a monadic bind on it to wait for the actual commit and then proceeds as before,
but it labels the bind as a &lt;code&gt;fetch&lt;/code&gt; operation.
If &lt;code&gt;fetch&lt;/code&gt; took multiple arguments, it could use &lt;code&gt;and*&lt;/code&gt; to wait for all of them in parallel.&lt;/p&gt;

&lt;p&gt;In theory, the body of the &lt;code&gt;let**&lt;/code&gt; in &lt;code&gt;fetch&lt;/code&gt; could contain further binds.
In that case, we wouldn’t be able to analyse the whole pipeline at the start.
But as long as the primitives wait for all their inputs at the start and don’t do any binds internally,
we can discover the whole pipeline statically.&lt;/p&gt;

&lt;p&gt;We can choose whether to expose these bind operations to application code or not.
If &lt;code&gt;let*&lt;/code&gt; (or &lt;code&gt;let**&lt;/code&gt;) is exposed, then applications get to use all the expressive power of monads,
but there will be points where we cannot show the whole pipeline until some promise resolves.
If we hide them, then applications can only make static pipelines.&lt;/p&gt;

&lt;p&gt;My approach so far has been to use &lt;code&gt;let*&lt;/code&gt; as an escape hatch, so that any required pipeline can be built,
but I later replace any uses of it by more specialised operations. For example, I added:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;val&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;list_map&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;:&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;kt&quot;&gt;list&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;This processes each item in a list that isn’t known until runtime.
However, we can still know statically what pipeline we will apply to each item,
even though we don’t know what the items themselves are.
&lt;code&gt;list_map&lt;/code&gt; could have been implemented using &lt;code&gt;let*&lt;/code&gt;, but then we wouldn’t be able to see the pipeline statically.&lt;/p&gt;

&lt;p&gt;Here are the other two examples, using the dart approach:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;11&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;12&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;13&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;14&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example2&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;docker_pull&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;ocaml/opam2&amp;quot;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;dockerfile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;      &lt;span class=&quot;n&quot;&gt;make_dockerfile&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;base&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;dockerfile&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;label&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ocaml_version&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;all&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;4.07&amp;quot;&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;s2&quot;&gt;&amp;quot;4.08&amp;quot;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;Compared to the original, we have an &lt;code&gt;all&lt;/code&gt; to combine the results, and there’s an extra &lt;code&gt;let+ base = base&lt;/code&gt; when calculating the dockerfile.
&lt;code&gt;let+&lt;/code&gt; is just another syntax for &lt;code&gt;map&lt;/code&gt;, used here because I chose not to change the signature of &lt;code&gt;make_dockerfile&lt;/code&gt;.
Alternatively, we could have &lt;code&gt;make_dockerfile&lt;/code&gt; take a promise of the base image and do the map inside it instead.
Because &lt;code&gt;map&lt;/code&gt; takes a pure body (&lt;code&gt;make_dockerfile&lt;/code&gt; just generates a string; there are no promises or errors) it doesn’t need its own box
on the diagrams and we don’t lose anything by allowing its use.&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example3&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;fetch&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;commit&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;build&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;test&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;image&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;revdeps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;get_revdeps&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;src&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;gate&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;revdeps&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;on&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;ok&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;|&amp;gt;&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;list_iter&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;~&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pp&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;nn&quot;&gt;Fmt&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;string&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;example1&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;This shows another custom operation: &lt;code&gt;gate revdeps ~on:ok&lt;/code&gt; is a promise that only resolves once both &lt;code&gt;revdeps&lt;/code&gt; and &lt;code&gt;ok&lt;/code&gt; have resolved.
This prevents it from testing the library’s revdeps until the library’s own tests have passed,
even though it could do this in parallel if we wanted it to.
Whereas with a monad we have to enable concurrency explicitly where we want it (using &lt;code&gt;and*&lt;/code&gt;),
with a dart we have to disable concurrency explicitly where we don’t want it (using &lt;code&gt;gate&lt;/code&gt;).&lt;/p&gt;

&lt;p&gt;I also added a &lt;code&gt;list_iter&lt;/code&gt; convenience function,
and gave it a pretty-printer argument so that we can label the cases in the diagrams once the list inputs are known.&lt;/p&gt;

&lt;p&gt;Finally, although I said that you can’t use &lt;code&gt;let*&lt;/code&gt; inside a primitive,
you can still use some other monad (that doesn’t generate diagrams).
In fact, in the real system I used a separate &lt;code&gt;let&amp;gt;&lt;/code&gt; operator for primitives.
That expects a body using non-diagram-generating promises provided by the underlying promise library,
so you can’t use &lt;code&gt;let*&lt;/code&gt; (or &lt;code&gt;let&amp;gt;&lt;/code&gt;) inside the body of a primitive.&lt;/p&gt;

&lt;h2 id=&quot;comparison-with-arrows&quot;&gt;Comparison with arrows&lt;/h2&gt;

&lt;p&gt;Given a “dart” you can create an arrow interface from it easily by defining e.g.&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;type&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arrow&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;a&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;&amp;#39;&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;b&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;promise&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;Then &lt;code&gt;arr&lt;/code&gt; is just &lt;code&gt;map&lt;/code&gt; and &lt;code&gt;f &amp;gt;&amp;gt;&amp;gt; g&lt;/code&gt; is just &lt;code&gt;fun x -&amp;gt; g (f x)&lt;/code&gt;. &lt;code&gt;first&lt;/code&gt; can be defined easily too, assuming you have some kind
of function for doing two things in parallel (like our &lt;code&gt;and*&lt;/code&gt; above).&lt;/p&gt;

&lt;p&gt;So a dart API (even with &lt;code&gt;let*&lt;/code&gt; hidden) is still enough to express any pipeline you can express using an arrow API.&lt;/p&gt;

&lt;p&gt;The &lt;a href=&quot;https://en.wikibooks.org/wiki/Haskell/Arrow_tutorial&quot;&gt;Haskell Arrow tutorial&lt;/a&gt; uses an example where an arrow is a stateful function.
For example, there is a &lt;code&gt;total&lt;/code&gt; arrow that returns the sum of its input and every previous input it has been called with.
e.g. calling it three times with inputs &lt;code&gt;1 2 3&lt;/code&gt; produces outputs &lt;code&gt;1 3 6&lt;/code&gt;.
Running a pipeline on a sequence of inputs returns the sequence of outputs.&lt;/p&gt;

&lt;p&gt;The tutorial uses &lt;code&gt;total&lt;/code&gt; to define a &lt;code&gt;mean1&lt;/code&gt; function like this:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;haskell&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;nf&quot;&gt;mean1&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;total&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;amp;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;&amp;gt;&amp;gt;&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;arr&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uncurry&lt;/span&gt; &lt;span class=&quot;p&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;/&lt;/span&gt;&lt;span class=&quot;p&quot;&gt;))&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;So this pipeline duplicates each input number,
replaces the second one with &lt;code&gt;1&lt;/code&gt;,
totals both streams, and then
replaces each pair with its ratio.
Each time you put another number into the pipeline, you get out the average of all values input so far.&lt;/p&gt;

&lt;p&gt;The equivalent code using the dart style would be (OCaml uses &lt;code&gt;/.&lt;/code&gt; for floating-point division):&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;values&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;values&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;uncurry&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(/.))&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;pair&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;That seems more readable to me.
We can simplify the code slightly by defining the standard operators &lt;code&gt;let+&lt;/code&gt; (for &lt;code&gt;map&lt;/code&gt;) and &lt;code&gt;and+&lt;/code&gt; (for &lt;code&gt;pair&lt;/code&gt;):&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;ocaml&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+)&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;map&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+)&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;pair&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;mean&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;values&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;values&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;ow&quot;&gt;and&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;+&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;n&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;mi&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;  &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/.&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;This is not a great example of an arrow anyway,
because we don’t use the output of one stateful function as the input to another,
so this is actually just a plain &lt;a href=&quot;https://en.wikipedia.org/wiki/Applicative_functor&quot;&gt;applicative&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;We could easily extend the example pipeline with another stateful function though,
perhaps by adding some smoothing.
That would look like &lt;code&gt;mean1 &amp;gt;&amp;gt;&amp;gt; smooth&lt;/code&gt; in the arrow notation,
and &lt;code&gt;values |&amp;gt; mean |&amp;gt; smooth&lt;/code&gt; (or &lt;code&gt;smooth (mean values)&lt;/code&gt;) in the dart notation.&lt;/p&gt;

&lt;p&gt;Note: Haskell does also have an &lt;code&gt;Arrows&lt;/code&gt; syntax extension, which allows the Haskell code to be written as:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;haskell&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;nf&quot;&gt;mean2&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;proc&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;kr&quot;&gt;do&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;value&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt; &lt;span class=&quot;ow&quot;&gt;&amp;lt;-&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;total&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;lt;&lt;/span&gt; &lt;span class=&quot;mi&quot;&gt;1&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;n&quot;&gt;returnA&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;lt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;t&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;/&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;n&lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;That’s more similar to the dart notation.&lt;/p&gt;

&lt;h2 id=&quot;larger-examples&quot;&gt;Larger examples&lt;/h2&gt;

&lt;p&gt;I’ve put up a library using a slightly extended version of these ideas at &lt;a href=&quot;https://github.com/ocurrent/ocurrent&quot;&gt;ocurrent/ocurrent&lt;/a&gt;.
The &lt;code&gt;lib_term&lt;/code&gt; subdirectory is the part relevant to this blog post, with the various combinators described in &lt;a href=&quot;https://github.com/ocurrent/ocurrent/blob/00688f949f3cfbf3d599949f89ca71c8e9e536fc/lib_term/s.ml#L48&quot;&gt;TERM&lt;/a&gt;.
The other directories handle more concrete details, such as integration with the Lwt promise library,
and providing the admin web UI or the Cap’n Proto RPC interface, as well as plugins with primitives
for using Git, GitHub, Docker and Slack.&lt;/p&gt;

&lt;h3 id=&quot;ocaml-docker-base-image-builder&quot;&gt;OCaml Docker base image builder&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/ocurrent/docker-base-images&quot;&gt;ocurrent/docker-base-images&lt;/a&gt; contains a pipeline that builds Docker base images for OCaml for various Linux distributions, CPU architectures, OCaml compiler versions and configuration options.
For example, to test OCaml 4.09 on Debian 10, you can do:&lt;/p&gt;

&lt;div class=&quot;bogus-wrapper&quot;&gt;&lt;notextile&gt;&lt;figure class=&quot;code&quot;&gt;&lt;figcaption&gt;&lt;span&gt;&lt;/span&gt;&lt;/figcaption&gt;&lt;div class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre class=&quot;line-numbers&quot;&gt;&lt;span class=&quot;line-number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;11&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;12&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;13&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;14&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;15&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;16&lt;/span&gt;
&lt;span class=&quot;line-number&quot;&gt;17&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;code class=&quot;bash&quot;&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;docker run --rm -it ocurrent/opam:debian-10-ocaml-4.09
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;ocamlopt --version
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;4.09.0
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;opam depext -i utop
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;o&quot;&gt;[&lt;/span&gt;...&lt;span class=&quot;o&quot;&gt;]&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;:~&lt;span class=&quot;nv&quot;&gt;$ &lt;/span&gt;utop
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;----+-------------------------------------------------------------+------------------
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    | Welcome to utop version 2.4.2 &lt;span class=&quot;o&quot;&gt;(&lt;/span&gt;using OCaml version 4.09.0&lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;! |
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;    +-------------------------------------------------------------+
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;Type &lt;span class=&quot;c&quot;&gt;#utop_help for help about using utop.&lt;/span&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;-&lt;span class=&quot;o&quot;&gt;(&lt;/span&gt; 11:50:06 &lt;span class=&quot;o&quot;&gt;)&lt;/span&gt;-&amp;lt; &lt;span class=&quot;nb&quot;&gt;command &lt;/span&gt;0 &amp;gt;-------------------------------------------&lt;span class=&quot;o&quot;&gt;{&lt;/span&gt; counter: 0 &lt;span class=&quot;o&quot;&gt;}&lt;/span&gt;-
&lt;/span&gt;&lt;span class=&quot;line&quot;&gt;utop &lt;span class=&quot;c&quot;&gt;# &lt;/span&gt;
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/div&gt;&lt;/figure&gt;&lt;/notextile&gt;&lt;/div&gt;

&lt;p&gt;Here’s what the pipeline looks like (click for full-size):&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://roscidus.com/blog/images/cicd/docker-base-images.svg&quot;&gt;&lt;img class=&quot;center&quot; src=&quot;https://roscidus.com/blog/images/cicd/docker-base-images-thumb.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;It pulls the latest Git commit of opam-repository each week, then builds base images containing that and the opam package manager for each distribution version, then builds one image for each supported compiler variant. Many of the images are built on multiple architectures (&lt;code&gt;amd64&lt;/code&gt;, &lt;code&gt;arm32&lt;/code&gt;, &lt;code&gt;arm64&lt;/code&gt; and &lt;code&gt;ppc64&lt;/code&gt;) and pushed to a staging area on Docker Hub. Then, the pipeline combines all the hashes to push a multi-arch manifest to Docker Hub. There are also some aliases (e.g. &lt;code&gt;debian&lt;/code&gt; means &lt;code&gt;debian-10-ocaml-4.09&lt;/code&gt; at the moment). Finally, if there is any problem then the pipeline sends the error to a Slack channel.&lt;/p&gt;

&lt;p&gt;You might wonder whether we really need a pipeline for this, rather than a simple script run from a cron-job.
But having a pipeline allows us to see what the pipeline will do before running it, watch the pipeline’s progress, restart failed jobs individually, etc, with almost the same code we would have written anyway.&lt;/p&gt;

&lt;p&gt;You can read &lt;a href=&quot;https://github.com/ocurrent/docker-base-images/blob/f65663b09d78bbb17c39aca97cbd9425c2e7816e/src/pipeline.ml&quot;&gt;pipeline.ml&lt;/a&gt; if you want to see the full pipeline.&lt;/p&gt;

&lt;h3 id=&quot;ocaml-ci&quot;&gt;OCaml CI&lt;/h3&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/ocurrent/ocaml-ci&quot;&gt;ocurrent/ocaml-ci&lt;/a&gt; is an (experimental) GitHub app for testing OCaml projects.
The pipeline gets the list of installations of the app,
gets the configured repositories for each installation,
gets the branches and PRs for each repository,
and then tests the head of each one against multiple Linux distributions and OCaml compiler versions.
If the project uses ocamlformat, it also checks that the commit is formatted exactly as ocamlformat would do it.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://roscidus.com/blog/images/cicd/ocaml-ci.svg&quot;&gt;&lt;img class=&quot;center&quot; src=&quot;https://roscidus.com/blog/images/cicd/ocaml-ci-thumb.png&quot; /&gt;&lt;/a&gt;&lt;/p&gt;

&lt;p&gt;The results are pushed back to GitHub as the commit status, and also recorded in a local index for the web and tty UIs.
There’s quite a lot of red here mainly because if a project doesn’t support a particular version of OCaml then the build is marked
as failed and shows up as red in the pipeline, although these failures are filtered out when making the GitHub status report.
We probably need a new colour for skipped stages.&lt;/p&gt;

&lt;h2 id=&quot;conclusions&quot;&gt;Conclusions&lt;/h2&gt;

&lt;p&gt;It’s convenient to write CI/CD pipelines as if they were single-shot scripts
that run the steps once, in series, and always succeed,
and then with only minor changes have the pipeline run the steps whenever
the input changes, in parallel, with logging, error reporting, cancellation
and rebuild support.&lt;/p&gt;

&lt;p&gt;Using a monad allows any program to be converted easily to have these features,
but, as with a regular program, we don’t know what the program will do with some
data until we run it. In particular, we can only automatically generate diagrams
showing steps that have already started.&lt;/p&gt;

&lt;p&gt;The traditional way to do static analysis is to use an arrow.
This is a little more limited than a monad, because the structure of the pipeline
can’t change depending on the input data, although we can add limited flexibility
such as optional steps or a choice between two branches.
However, writing pipelines using arrow notation is difficult because we have to
program in a point-free style (without variables).&lt;/p&gt;

&lt;p&gt;We can get the same benefits of static analysis by using a monad in an unusual way,
here referred to as a “dart”.
Instead of functions that take plain values and return wrapped values, our functions
both take and return wrapped values. This results in a syntax that looks
identical to plain programming, but allows static analysis (at the cost of not being
able to manipulate the wrapped values directly).&lt;/p&gt;

&lt;p&gt;If we hide (or don’t use) the monad’s &lt;code&gt;let*&lt;/code&gt; (bind) function then the pipelines we
create can always be determined statically. If we use a bind, then there will be holes
in the pipeline that may expand to more pipeline stages as the pipeline runs.&lt;/p&gt;

&lt;p&gt;Primitive steps can be created by using a single “labelled bind”, where the label
provides the static analysis for the atomic component.&lt;/p&gt;

&lt;p&gt;I haven’t seen this pattern used before (or mentioned in the arrow documentation),
and it seems to provide exactly the same benefits as arrows with much less difficulty.
If this has a proper name, let me know!&lt;/p&gt;

&lt;p&gt;This work was funded by OCaml Labs.&lt;/p&gt;

</content><id>https://roscidus.com/blog/blog/2019/11/14/cicd-pipelines</id><title xml:base="http://roscidus.com/blog/blog/categories/ocaml/atom.xml" type="html">CI/CD pipelines: Monad, Arrow or Dart?</title><updated>2019-11-14T09:59:40-00:00</updated><author><name>Thomas Leonard</name></author></entry><entry><summary xml:base="http://math.andrej.com/feed/" type="html">I forgot to record the fact that already two years ago I wrote a paper on Lawvere's fixed-point theorem in synthetic computability: Andrej Bauer: On fixed-point theorems in synthetic computability. Tbilisi Mathematical Journal, Volume 10: Issue 3, pp. 167–181. It was a special issue in honor of Professors Peter J. Freyd and F. William Lawvere on the occasion of their 80th birthdays. Lawvere's paper &quot;Diagonal arguments and cartesian closed categories proves a beautifully simple fixed point theorem. Theorem: (Lawvere) If $e : A \to B^A$ is a surjection then every $f : B \to B$ has a fixed point. Proof. Because $e$ is a surjection, there is $a \in A$ such that $e(a) = \lambda x : A \,.\, f(e(x)(x))$, but then $e(a)(a) = f(e(a)(a)$. $\Box$ Lawvere's original version is a bit more general, but the one given here makes is very clear that Lawvere's fixed point theorem is the diagonal argument in crystallized form. Indeed, the contrapositive form of the theorem, namely Corollary: If $f : B \to B$ has no fixed point then there is no surjection $e : A \to B^A$. immediately implies a number of famous theorems that rely on the diagonal argument. For example, there can be no surjection $A \to \lbrace 0, 1\rbrace^A$ because the map $x \mapsto 1 - x$ has no fixed point in $\lbrace 0, 1\rbrace$ -- and that is Cantors' theorem. It not easy to find non-trivial instances to which Lawvere's theorem applies. Indeed, if excluded middle holds, then having a surjection $e : A \to B^A$ implies that $B$ is the singleton. We should look for interesting instances in categories other than classical sets. In my paper I do so: I show that countably based $\omega$-cpos in the effective topos are countable and closed under countable products, which gives us a rich supply of objects $B$ such that there is a surjection $\mathbb{N} \to B^\mathbb{N}$. Enjoy the paper!</summary><source><updated>2020-03-15T17:46:54-00:00</updated><subtitle type="text">A blog about mathematics for computers</subtitle><link type="text/html" href="http://math.andrej.com/" rel="alternate"/><link type="application/atom+xml" href="http://math.andrej.com/feed.xml" rel="self"/><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><id>http://math.andrej.com/feed.xml</id><title xml:base="http://math.andrej.com/feed/" type="html">Mathematics and Computation</title><author><name>Andrej Bauer</name></author></source><published>2019-11-06T23:00:00-00:00</published><link title="On fixed-point theorems in synthetic computability" type="text/html" href="http://math.andrej.com/2019/11/07/on-fixed-point-theorems-in-synthetic-computability/" rel="alternate"/><content xml:base="http://math.andrej.com/feed/" type="html">&lt;p&gt;I forgot to record the fact that already two years ago I wrote a paper on
Lawvere's fixed-point theorem in synthetic computability:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;Andrej Bauer: &lt;a href=&quot;https://content.sciendo.com/view/journals/tmj/10/3/article-p167.xml&quot;&gt;&lt;em&gt;On fixed-point theorems in synthetic computability&lt;/em&gt;&lt;/a&gt;.
Tbilisi Mathematical Journal, Volume 10: Issue 3, pp. 167–181.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;It was a special issue in honor of Professors &lt;a href=&quot;https://en.wikipedia.org/wiki/Peter_J._Freyd&quot;&gt;Peter J.
Freyd&lt;/a&gt; and &lt;a href=&quot;https://en.wikipedia.org/wiki/William_Lawvere&quot;&gt;F. William
Lawvere&lt;/a&gt; on the occasion of their
80th birthdays.&lt;/p&gt;

&lt;p&gt;Lawvere's paper &lt;a href=&quot;http://tac.mta.ca/tac/reprints/articles/15/tr15abs.html&quot;&gt;&quot;Diagonal arguments and cartesian closed
categories&lt;/a&gt; proves a
beautifully simple fixed point theorem.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Theorem:&lt;/strong&gt; (Lawvere) &lt;em&gt;If $e : A \to B^A$ is a surjection then every $f : B \to B$ has a fixed point.&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;em&gt;Proof.&lt;/em&gt; Because $e$ is a surjection, there is $a \in A$ such that $e(a) = \lambda x : A \,.\, f(e(x)(x))$, but then $e(a)(a) = f(e(a)(a)$. $\Box$&lt;/p&gt;

&lt;p&gt;Lawvere's original version is a bit more general, but the one given here makes is very clear that Lawvere's fixed point theorem is the diagonal argument in crystallized form. Indeed, the contrapositive form of the theorem, namely&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Corollary:&lt;/strong&gt; &lt;em&gt;If $f : B \to B$ has no fixed point then there is no surjection $e : A \to B^A$.&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;immediately implies a number of famous theorems that rely on the diagonal argument. For example, there can be no surjection $A \to \lbrace 0, 1\rbrace^A$ because the map $x \mapsto 1 - x$ has no fixed point in $\lbrace 0, 1\rbrace$ -- and that is Cantors' theorem.&lt;/p&gt;

&lt;p&gt;It not easy to find non-trivial instances to which Lawvere's theorem applies. Indeed, if excluded middle holds, then having a surjection $e : A \to B^A$ implies that $B$ is the singleton. We should look for interesting instances in categories other than classical sets. In my paper I do so: I show that countably based $\omega$-cpos in the effective topos are countable and closed under countable products, which gives us a rich supply of objects $B$ such that there is a surjection $\mathbb{N} \to B^\mathbb{N}$.&lt;/p&gt;

&lt;p&gt;Enjoy the paper!&lt;/p&gt;</content><id>http://math.andrej.com/2019/11/07/on-fixed-point-theorems-in-synthetic-computability</id><title xml:base="http://math.andrej.com/feed/" type="html">On fixed-point theorems in synthetic computability</title><updated>2019-11-06T23:00:00-00:00</updated><author><name>Andrej Bauer</name></author></entry><entry><summary xml:base="http://math.andrej.com/feed/" type="html">It has been almost a decade since Matija Pretnar and I posted the first blog posts about programming with algebraic effects and handlers and the programming language Eff. Since then handlers have become a well-known control mechanism in programming languages. Handlers and monads excel at simulating effects, either in terms of other effects or as pure computations. For example, the familiar state monad implements mutable state with (pure) state-passing functions, and there are many more examples. But I have always felt that handlers and monads are not very good at explaining how a program interacts with its external environment and how it gets to perform real-world effects. Danel Ahman and I have worked for a while on attacking the question on how to better model external resources and what programming constructs are appropriate for working with them. The time is right for us to show what we have done so far. The theoretical side of things is explained in our paper Runners in action, Danel implemented a Haskell library Haskell-Coop to go with the paper, and I implemented a programming language Coop.</summary><source><updated>2020-03-15T17:46:54-00:00</updated><subtitle type="text">A blog about mathematics for computers</subtitle><link type="text/html" href="http://math.andrej.com/" rel="alternate"/><link type="application/atom+xml" href="http://math.andrej.com/feed.xml" rel="self"/><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><id>http://math.andrej.com/feed.xml</id><title xml:base="http://math.andrej.com/feed/" type="html">Mathematics and Computation</title><author><name>Andrej Bauer</name></author></source><published>2019-10-27T23:00:00-00:00</published><link title="Runners in action" type="text/html" href="http://math.andrej.com/2019/10/28/runners-in-action/" rel="alternate"/><content xml:base="http://math.andrej.com/feed/" type="html">&lt;p&gt;It has been almost a decade since &lt;a href=&quot;http://matija.pretnar.info&quot;&gt;Matija Pretnar&lt;/a&gt;
and I posted the &lt;a href=&quot;http://math.andrej.com/category/eff/&quot;&gt;first blog posts&lt;/a&gt; about
programming with algebraic effects and handlers and the programming language
&lt;a href=&quot;http://www.eff-lang.org&quot;&gt;Eff&lt;/a&gt;. Since then handlers have become a well-known
control mechanism in programming languages.&lt;/p&gt;

&lt;p&gt;Handlers and monads excel at &lt;em&gt;simulating&lt;/em&gt; effects, either in terms of other
effects or as pure computations. For example, the familiar &lt;a href=&quot;https://wiki.haskell.org/State_Monad&quot;&gt;state
monad&lt;/a&gt; implements mutable state with
(pure) state-passing functions, and there are many more examples. But I have
always felt that handlers and monads are not very good at explaining how a
program interacts with its external environment and how it gets to perform
&lt;em&gt;real-world&lt;/em&gt; effects.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://danel.ahman.ee&quot;&gt;Danel Ahman&lt;/a&gt; and I have worked for a while on attacking
the question on how to better model external resources and what programming
constructs are appropriate for working with them. The time is right for us to
show what we have done so far. The theoretical side of things is explained in
our paper &lt;a href=&quot;http://arxiv.org/abs/1910.11629&quot;&gt;&lt;strong&gt;Runners in action&lt;/strong&gt;&lt;/a&gt;, Danel
implemented a Haskell library
&lt;a href=&quot;https://github.com/danelahman/haskell-coop&quot;&gt;&lt;strong&gt;Haskell-Coop&lt;/strong&gt;&lt;/a&gt; to go with the
paper, and I implemented a programming language
&lt;a href=&quot;https://github.com/andrejbauer/coop&quot;&gt;&lt;strong&gt;Coop&lt;/strong&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;!--more--&gt;

&lt;p&gt;General-purpose programming languages, even the so-called pure ones, have to have
&lt;em&gt;some&lt;/em&gt; account of interaction with the external environment. A popular choice is
to provide a foreign-function interface that connects the language with an
external library, and through it with an operating system and the universe. A
more nuanced approach would differentiate between a function that just happens
to be written in a different language, and one that actually performs an effect.
The latter kind is known as an &lt;em&gt;algebraic operation&lt;/em&gt; in the
algebraic-effects-and-handlers way of doing things.&lt;/p&gt;

&lt;p&gt;A &lt;em&gt;bad&lt;/em&gt; approach to modeling the external world is to pretend that it is
internal to the language. One would think that this is obvious but it is not.
For instance, Haskell represents the interface to the external world through the
&lt;a href=&quot;https://www.haskell.org/onlinereport/haskell2010/haskellch41.html#x49-32100041.1&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;IO&lt;/code&gt;
monad&lt;/a&gt;.
But what is this monad &lt;em&gt;really&lt;/em&gt;? How does it get to interact with the external
world? The Haskell Wiki page which answers this question has &lt;a href=&quot;https://wiki.haskell.org/IO_inside#Welcome_to_the_RealWorld.2C_baby&quot;&gt;the following
disclaimer&lt;/a&gt;:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;em&gt;&quot;Warning: The following story about &lt;code class=&quot;highlighter-rouge&quot;&gt;IO&lt;/code&gt; is incorrect in that it cannot
actually explain some important aspects of &lt;code class=&quot;highlighter-rouge&quot;&gt;IO&lt;/code&gt; (including interaction and
concurrency). However, some people find it useful to begin developing an
understanding.&quot;&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;The Wiki goes on to say how &lt;code class=&quot;highlighter-rouge&quot;&gt;IO&lt;/code&gt; is a bit like a state monad with an imaginary
&lt;code class=&quot;highlighter-rouge&quot;&gt;RealWorld&lt;/code&gt; state, except that of course &lt;code class=&quot;highlighter-rouge&quot;&gt;RealWorld&lt;/code&gt; is not really a Haskell
type, or at least not one that actually holds the state of the real world.&lt;/p&gt;

&lt;p&gt;The situation with Eff is not much better: it treats some operations at the
top-level in a special way. For example, if &lt;code class=&quot;highlighter-rouge&quot;&gt;print&lt;/code&gt; percolates to the top level,
it turns into a &lt;em&gt;real&lt;/em&gt; &lt;code class=&quot;highlighter-rouge&quot;&gt;print&lt;/code&gt; that actually causes an effect. So it looks like
there is some sort of &quot;top level handler&quot; that models the real world, but that
cannot be the case: a handler may discard the continuation or run it twice, but
Eff hardly has the ability to discard the external world, or to make it
bifurcate into two separate realities.&lt;/p&gt;

&lt;p&gt;If &lt;code class=&quot;highlighter-rouge&quot;&gt;IO&lt;/code&gt; monad is not an honest monad and a top-level handler is not really a
handler, then what we have is a case of ingenious hackery in need of proper
programming-language design.&lt;/p&gt;

&lt;p&gt;How precisely does an operation call in the program cause an effect in the
external world? As we have just seen, some sort of runtime environment or top
level needs to relate it to the external world. From the viewpoint of the
program, the external world appears as state which is not directly accessible,
or even representable in the language. The effect of calling an operation
$\mathtt{op}(a,\kappa)$ is to change the state of the world, and to get back a
result. We can model the situation with a map $\overline{\mathtt{op}} : A \times
W \to B \times W$, where $W$ is the set of all states of the world, $A$ is the
set of parameters, and $B$ the set of results of the operation. The operation
call $\mathtt{op}(a, \kappa)$ is &quot;executed&quot; in the current world $w \in W$ by
computing $\overline{\mathtt{op}}(a,w) = (b, w')$ to get the next world $w'$ and
a result $b$. The program then proceeds with the continuation $\kappa\,b$ in the
world $w'$. Notice how the world $w$ is an external entity that is manipulated
by the external map $\overline{\mathtt{op}}$ realistically in a &lt;em&gt;linear&lt;/em&gt;
fashion, i.e., the world is neither discarded nor copied, just transformed.&lt;/p&gt;

&lt;p&gt;What I have just described is &lt;em&gt;not&lt;/em&gt; a monad or a handler, but a &lt;em&gt;comodel&lt;/em&gt;, also
known as a &lt;em&gt;runner&lt;/em&gt;, and the map $\overline{\mathtt{op}}$ is not an operation,
but a &lt;em&gt;co-operation&lt;/em&gt;. This was all observed a while ago by &lt;a href=&quot;http://homepages.inf.ed.ac.uk/gdp/&quot;&gt;Gordon
Plotkin&lt;/a&gt; and &lt;a href=&quot;https://scholar.google.co.uk/citations?user=aOCekqQAAAAJ&quot;&gt;John
Power&lt;/a&gt;, &lt;a href=&quot;https://www.ioc.ee/~tarmo/&quot;&gt;Tarmo
Uustalu&lt;/a&gt;, and generalized by &lt;a href=&quot;http://www.itu.dk/people/mogel/&quot;&gt;Rasmus
Møgelberg&lt;/a&gt; and &lt;a href=&quot;https://www.cs.ox.ac.uk/people/samuel.staton/main.html&quot;&gt;Sam
Staton&lt;/a&gt;, see our paper
for references. Perhaps we should replace &quot;top-level&quot; handlers and &quot;special&quot;
monads with runners?&lt;/p&gt;

&lt;p&gt;Danel and I worked out how &lt;em&gt;effectful&lt;/em&gt; runners (a generalization of runners that
supports other effects in addition to state) provide a mathematical model of
resource management. They also give rise to a programming concept that models
top-level external resources, as well as allows programmers to modularly define
their own “virtual machines” and run code inside them. Such virtual machines can
be nested and combined in interesting ways. We capture the core ideas of
programming with runners in an equational calculus $\lambda_{\mathsf{coop}}$,
that guarantees the linear use of resources and execution of finalization code.&lt;/p&gt;

&lt;p&gt;An interesting practical aspect of $\lambda_{\mathsf{coop}}$, that was begotten by
theory, is modeling of extra-ordinary circumstances. The external environment
should have the ability to signal back to the program an extra-ordinary
circumstance that prevents if from returning a result. This is normally
accomplished by an exception mechanism, but since the external world is
stateful, there are &lt;em&gt;two&lt;/em&gt; ways of combining it with exceptions, namely the sum
and the tensor of algebraic theories. Which one is the right one? Both! After a
bit of head scratching we realized that the two options are (analogous to) what
is variously called &lt;a href=&quot;https://docs.oracle.com/javase/tutorial/essential/exceptions/runtime.html&quot;&gt;&quot;checked&quot; and &quot;non-checked&quot;
exceptions&lt;/a&gt;,
&lt;a href=&quot;http://man7.org/linux/man-pages/man3/errno.3.html&quot;&gt;errors&lt;/a&gt; and
&lt;a href=&quot;http://man7.org/linux/man-pages/man7/signal.7.html&quot;&gt;signals&lt;/a&gt;, or &lt;a href=&quot;https://www.repository.cam.ac.uk/bitstream/handle/1810/283239/paper.pdf?sequence=3&amp;amp;isAllowed=y&quot;&gt;synchronous
and asynchronous
exceptions&lt;/a&gt;.
And so we included in $\lambda_{\mathsf{coop}}$ both mechanisms: ordinary
&lt;em&gt;exceptions&lt;/em&gt;, which are special events that disrupt the flow of user code but
can be caught and attended to, and &lt;em&gt;signals&lt;/em&gt; which are unrecoverable failures
that irrevocably &lt;em&gt;kill&lt;/em&gt; user code, but can still be finalized. We proved a finalization
theorem which gives strong guarantees about resources always being properly
finalized.&lt;/p&gt;

&lt;p&gt;If you are familiar with handlers, as a first approximation you can think of
runners as handlers that use the continuation at most once in a tail-call
position. Many handlers are already of this form but not all. Non-determinism,
probability, and handlers that hijack the continuation (&lt;code class=&quot;highlighter-rouge&quot;&gt;delimcc&lt;/code&gt;, threads, and
selection functionals) fall outside of the scope of runners. Perhaps in the
future we can resurrect some of these (in particular it seems like threads, or
even some form of concurrency would be worth investigating). There are many
other directions of possible future investigations: efficient compilation, notions
of correctness, extensions to the simple effect subtyping discipline that we
implemented, etc.&lt;/p&gt;

&lt;p&gt;To find out more, we kindly invite you to have a look at the
&lt;a href=&quot;http://arxiv.org/abs/1910.11629&quot;&gt;paper&lt;/a&gt;, and to try out the implementations.
The prototype programming language &lt;a href=&quot;https://github.com/andrejbauer/coop&quot;&gt;Coop&lt;/a&gt;
implements and extends $\lambda_{\mathsf{coop}}$. You can start by skimming the
&lt;a href=&quot;https://github.com/andrejbauer/coop/blob/master/Manual.md&quot;&gt;Coop manual&lt;/a&gt; and the
&lt;a href=&quot;https://github.com/andrejbauer/coop/tree/master/examples&quot;&gt;examples&lt;/a&gt;. If you
prefer to experiment on your own, you might prefer the
&lt;a href=&quot;https://github.com/danelahman/haskell-coop&quot;&gt;Haskell-Coop&lt;/a&gt; library, as it allows
you to combine runners with everything else that Haskell has to offer.&lt;/p&gt;</content><id>http://math.andrej.com/2019/10/28/runners-in-action</id><title xml:base="http://math.andrej.com/feed/" type="html">Runners in action</title><updated>2019-10-27T23:00:00-00:00</updated><author><name>Andrej Bauer</name></author></entry><entry><source><updated>2019-10-22T10:09:09-00:00</updated><logo>https://cdn-images-1.medium.com/proxy/1*TGH72Nnw24QL3iV9IOm4VA.png</logo><link title="Ocaml in ahrefs on Medium" type="text/html" href="https://tech.ahrefs.com/tagged/ocaml?source=rss----303662d88bae--ocaml" rel="related"/><link title="Ocaml in ahrefs on Medium" type="application/rss+xml" href="https://medium.com/feed/ahrefs/tagged/ocaml" rel="self"/><generator>Medium</generator><id>https://tech.ahrefs.com/tagged/ocaml?source=rss----303662d88bae--ocaml</id><title type="text">Ocaml in ahrefs on Medium</title><author><name>Ahrefs</name></author></source><link href="https://tech.ahrefs.com/how-to-write-a-library-for-bucklescript-and-native-22f45e5e946d?source=rss----303662d88bae--ocaml" rel="alternate"/><content xml:base="https://medium.com/feed/ahrefs/tagged/ocaml" type="html">&lt;p&gt;&lt;em&gt;Written with &lt;/em&gt;&lt;a href=&quot;https://twitter.com/javierwchavarri&quot;&gt;&lt;em&gt;Javier Chávarri&lt;/em&gt;&lt;/a&gt;&lt;em&gt; and &lt;/em&gt;&lt;a href=&quot;https://github.com/feihong/&quot;&gt;&lt;em&gt;Feihong Hsu&lt;/em&gt;&lt;/a&gt;&lt;em&gt;.&lt;/em&gt;&lt;/p&gt;&lt;p&gt;The first &lt;a href=&quot;https://www.reason-conf.us/&quot;&gt;Reason Conf US&lt;/a&gt; just ended. Many talks mentioned native compilation. Sharing code between BuckleScript and native artifacts is a use case which is more and more common. This blog post is an introduction on how to set up a library available for both worlds, sharing as much code as possible.&lt;/p&gt;&lt;h3&gt;The goal&lt;/h3&gt;&lt;p&gt;What we try to produce is a library with an identical interface for BuckleScript and native. But without duplicating code. It should also be possible to have some parts of the library that are a different implementation depending on the target, as we want to be able to leverage existing libraries that are working only in one of the worlds.&lt;/p&gt;&lt;h3&gt;The build systems&lt;/h3&gt;&lt;p&gt;For BuckleScript, there is only one build system: bsb. It is driven by a bsconfig.json file. And is installed as part of the bs-platform.&lt;/p&gt;&lt;p&gt;On the native side, there are a lot of different build systems that are available. But recently one of them became a de facto standard: dune. It works with a very minimal amount of configuration. And it supports the reason syntax by default.&lt;/p&gt;&lt;p&gt;These two tools are working in a way which is pretty similar. They share a lot of concepts. And it is easy to set them up so that both are working in the same codebase.&lt;/p&gt;&lt;p&gt;The main similarities that interest us are:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;The ability to work on specific source directories&lt;/li&gt;&lt;li&gt;Namespacing in bsb and wrapping in dune are both putting all the&lt;br&gt;files of the library under a single module name&lt;/li&gt;&lt;/ul&gt;&lt;h3&gt;The source code file tree&lt;/h3&gt;&lt;p&gt;The code of the library is split into 3 directories.&lt;/p&gt;&lt;pre&gt;├── js/&lt;br&gt;├── native/&lt;br&gt;└── shared/&lt;/pre&gt;&lt;ul&gt;&lt;li&gt;shared is meant to host most of the code and all the code in this directory will be compiled in both modes.&lt;/li&gt;&lt;li&gt;js contains the parts that are specific to BuckleScript.&lt;/li&gt;&lt;li&gt;native contains the parts that are specific to native OCaml.&lt;/li&gt;&lt;/ul&gt;&lt;h3&gt;Set up the build systems&lt;/h3&gt;&lt;p&gt;Once we have our basic skeleton for the library, it is time to set up the build systems. We want to have two configurations as similar as possible to make them easier to understand. Once we are done, the tree will look like this:&lt;/p&gt;&lt;pre&gt;├── bsconfig.json&lt;br&gt;├── dune&lt;br&gt;├── dune-project&lt;br&gt;├── js/&lt;br&gt;├── native/&lt;br&gt;└── shared/&lt;/pre&gt;&lt;h4&gt;BuckleScript&lt;/h4&gt;&lt;p&gt;At the root of the library we need a bsconfig.json file to drive&lt;br&gt;bsb. The documentation is available at &lt;a href=&quot;https://bucklescript.github.io/docs/en/build-configuration](https://bucklescript.github.io/docs/en/build-configuration).&quot;&gt;https://bucklescript.github.io/docs/en/build-configuration&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;The main part for us is sources. We will use it to tell bsb to look at the js and shared folders. We also want to set namespace to true, which will wrap all your project’s files under a common module name.&lt;/p&gt;&lt;pre&gt;  &amp;quot;namespace&amp;quot;: true,&lt;br&gt;  &amp;quot;sources&amp;quot;: [&lt;br&gt;    {&lt;br&gt;      &amp;quot;dir&amp;quot;: &amp;quot;js&amp;quot;,&lt;br&gt;      &amp;quot;subdirs&amp;quot;: true&lt;br&gt;    }, {&lt;br&gt;      &amp;quot;dir&amp;quot;: &amp;quot;shared&amp;quot;,&lt;br&gt;      &amp;quot;subdirs&amp;quot;: true&lt;br&gt;    }&lt;br&gt;  ],&lt;/pre&gt;&lt;p&gt;The rest of the file is as usual.&lt;/p&gt;&lt;pre&gt;{&lt;br&gt;  &amp;quot;name&amp;quot;: &amp;quot;sharedlib&amp;quot;,&lt;br&gt;  &amp;quot;namespace&amp;quot;: true,&lt;br&gt;  &amp;quot;sources&amp;quot;: [&lt;br&gt;    {&lt;br&gt;      &amp;quot;dir&amp;quot;: &amp;quot;js&amp;quot;,&lt;br&gt;      &amp;quot;subdirs&amp;quot;: true&lt;br&gt;    }, {&lt;br&gt;      &amp;quot;dir&amp;quot;: &amp;quot;shared&amp;quot;,&lt;br&gt;      &amp;quot;subdirs&amp;quot;: true&lt;br&gt;    }&lt;br&gt;  ],&lt;br&gt;  &amp;quot;package-specs&amp;quot;: {&lt;br&gt;    &amp;quot;module&amp;quot;: &amp;quot;es6&amp;quot;,&lt;br&gt;    &amp;quot;in-source&amp;quot;: true&lt;br&gt;  },&lt;br&gt;  &amp;quot;refmt&amp;quot;: 3,&lt;br&gt;  &amp;quot;suffix&amp;quot;: &amp;quot;.bs.js&amp;quot;,&lt;br&gt;  &amp;quot;generate-merlin&amp;quot;: true,&lt;br&gt;}&lt;/pre&gt;&lt;h4&gt;Dune&lt;/h4&gt;&lt;p&gt;We must also add a dune file to the root of the library. For dune, we have different options — it is possible to ignore the js directory but read everything else. Or to check only shared and native. To make the configuration similar to BuckleScript, we will go with the second solution.&lt;/p&gt;&lt;p&gt;The dune directive to do that is dirs. By defaults it tells dune to explore every directory except the ones hidden (starting with a dot) or starting with an underscore. &lt;a href=&quot;https://dune.readthedocs.io/en/stable/dune-files.html#dirs-since-1-6&quot;&gt;More details in dune’s documentation&lt;/a&gt;. To make it do what we want, the configuration should be:&lt;/p&gt;&lt;pre&gt;(dirs shared native)&lt;/pre&gt;&lt;p&gt;We also use another option of dune to tell it to include the content of those two directories as if it was at the root of the project. Without this stanza, dune would only use the source files at the root of the project and ignore everything in the sub directories.&lt;/p&gt;&lt;pre&gt;(include_subdirs unqualified)&lt;/pre&gt;&lt;p&gt;Then we need the usual library stanza to give a name to our library, state the dependencies, compilation flags, etc. In our simple case, the only information needed is the name. We can explicitly set wrapped to true, but this is already the default behavior. The &lt;a href=&quot;https://dune.readthedocs.io/en/stable/dune-files.html#library&quot;&gt;documentation for the whole library stanza&lt;/a&gt; describes how to specify more details.&lt;/p&gt;&lt;p&gt;The final dune file looks like this:&lt;/p&gt;&lt;pre&gt;(dirs shared native)&lt;br&gt; (include_subdirs unqualified)&lt;br&gt; (library&lt;br&gt;  (name sharedlib))&lt;/pre&gt;&lt;p&gt;We also want a basic dune-project. If we don’t write it by hand, dune will generate it for us. I am using version 1.10 as an example. But it can be changed to whatever version suits your project.&lt;/p&gt;&lt;pre&gt;(lang dune 1.10)&lt;/pre&gt;&lt;h3&gt;Compilation&lt;/h3&gt;&lt;p&gt;With the setup described above, the compilation for BuckleScript and native is the same as in a setup with only one or the other.&lt;/p&gt;&lt;ul&gt;&lt;li&gt;bsb -make-world for BuckleScript&lt;/li&gt;&lt;li&gt;dune build @all for dune&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;The call to bsb is usally put in package.json in the scripts part, so that the usual yarn build can be used. For native, it depends if you rely on esy or opam.&lt;/p&gt;&lt;h3&gt;How to consume the library&lt;/h3&gt;&lt;p&gt;This is exactly the same setup that would be used in a pure BuckleScript or pure native library.&lt;/p&gt;&lt;p&gt;To use your library in BuckleScript:&lt;/p&gt;&lt;ul&gt;&lt;li&gt;Add the name and version to package.json&lt;/li&gt;&lt;li&gt;Add the name to bsbconfig.json of consuming library/app&lt;/li&gt;&lt;/ul&gt;&lt;p&gt;To use your library in native OCaml, add the name of your library to the libraries part an executable or library stanza, e.g.&lt;/p&gt;&lt;pre&gt;(executable&lt;br&gt; (name main)&lt;br&gt; (libraries sharedlib))&lt;/pre&gt;&lt;h3&gt;Module naming&lt;/h3&gt;&lt;p&gt;If you want your module name to contain capital letters in the middle (e.g. TeenageMutantNinjaTurtles), then be aware that &lt;a href=&quot;https://bucklescript.github.io/docs/en/build-configuration.html#name-namespace&quot;&gt;name munging&lt;/a&gt; works differently between bsbconfig.json and dune. For example, if you want to refer to your module as CoolSharedLib in your code, then the name in bsbconfig.json must be cool-shared-lib, and in dune it must be coolSharedLib.&lt;/p&gt;&lt;h3&gt;Platform specific code&lt;/h3&gt;&lt;p&gt;The whole library does not have to be exactly the same in the two platform. It is possible to add modules that are available only in one mode. Or to have modules with a different interface.&lt;/p&gt;&lt;p&gt;For example, by adding a file Foo.re in js but not in native, the library now has a module Foo available when compiled to javascript. But only when compiled to javascript.&lt;/p&gt;&lt;h3&gt;Downsides&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;Both bsb and dune generate .merlin files when they compile our library. They override each other. It might be troublesome if the version of ocaml used for native code is not 4.02.3. Simply recompile the library for your platform to solve the problem.&lt;/li&gt;&lt;li&gt;Out of the box, this approach doesn’t really allow us to share interface files between both platforms: native and BuckleScript. One workaround for that, if we wanted to share some module Foo, is to:&lt;br&gt;1. add Foo.mli or Foo.rei file in shared&lt;br&gt;2. add include FooImplementation in Foo.ml&lt;br&gt;3. add FooImplementation in both native and js folder&lt;/li&gt;&lt;li&gt;It’s not possible to be platform specific for just a few lines of code (e.g. if IS_NATIVE foo else bar), the minimal per-platform unit is a file/module.&lt;/li&gt;&lt;/ul&gt;&lt;h3&gt;Example project&lt;/h3&gt;&lt;p&gt;We have set up a simple library to showcase what a repository looks like once the whole configuration is in place. It is &lt;a href=&quot;https://github.com/ahrefs/hello-native-bucklescript&quot;&gt;available on github&lt;/a&gt;.&lt;/p&gt;&lt;p&gt;For now the repository contains only a library. But with this setup, it is actually possible to build an executable too. It is also possible to enrich it, for example by adding &lt;a href=&quot;https://tech.ahrefs.com/getting-started-with-atdgen-and-bucklescript-1f3a14004081&quot;&gt;atdgen to communicate between both sides of the library&lt;/a&gt;.&lt;/p&gt;&lt;img src=&quot;https://medium.com/_/stat?event=post.clientViewed&amp;referrerSource=full_rss&amp;postId=22f45e5e946d&quot; width=&quot;1&quot; height=&quot;1&quot;&gt;&lt;hr&gt;&lt;p&gt;&lt;a href=&quot;https://tech.ahrefs.com/how-to-write-a-library-for-bucklescript-and-native-22f45e5e946d&quot;&gt;How to write a library for BuckleScript and Native&lt;/a&gt; was originally published in &lt;a href=&quot;https://tech.ahrefs.com&quot;&gt;ahrefs&lt;/a&gt; on Medium, where people are continuing the conversation by highlighting and responding to this story.&lt;/p&gt;</content><category term="bucklescript"/><id>https://medium.com/p/22f45e5e946d</id><title type="text">How to write a library for BuckleScript and Native</title><updated>2019-10-22T10:09:09-00:00</updated><author><name>Ahrefs</name></author></entry><entry><source><updated>2020-01-08T20:00:00-00:00</updated><subtitle type="text">on building functional operating systems</subtitle><rights type="text">All rights reserved by the author</rights><link type="text/html" href="https://mirage.io/blog/" rel="alternate"/><link href="https://mirage.io/blog/atom.xml" rel="self"/><contributor><uri>https://www.lemonde.fr/signataires/damien-leloup/</uri><name>Damien Leloup</name></contributor><contributor><email>anil@recoil.org</email><uri>http://anil.recoil.org</uri><name>Anil Madhavapeddy</name></contributor><contributor><email>martin@lucina.net</email><uri>https://lucina.net/</uri><name>Martin Lucina</name></contributor><contributor><email>talex5@gmail.com</email><uri>http://roscidus.com/blog/</uri><name>Thomas Leonard</name></contributor><contributor><email>hm519@cam.ac.uk</email><uri>https://github.com/hannesm</uri><name>Hannes Mehnert</name></contributor><contributor><email>mindy.preston@cl.cam.ac.uk</email><uri>https://github.com/yomimono</uri><name>Mindy Preston</name></contributor><contributor><uri>https://linse.me</uri><name>Stefanie Schirmer</name></contributor><contributor><email>thomas@gazagnaire.org</email><uri>http://gazagnaire.org</uri><name>Thomas Gazagnaire</name></contributor><contributor><email>gg417@cl.cam.ac.uk</email><uri>https://github.com/GemmaG</uri><name>Gemma Gordon</name></contributor><contributor><email>drupyog@zoho.com</email><uri>https://github.com/drup</uri><name>Gabriel Radanne</name></contributor><contributor><email>djwillia@us.ibm.com</email><uri>https://github.com/djwillia</uri><name>Dan Williams</name></contributor><contributor><email>haesbaert@haesbaert.org</email><uri>http://www.haesbaert.org/</uri><name>Christiano Haesbaert</name></contributor><contributor><email>amirmc@gmail.com</email><uri>http://amirchaudhry.com</uri><name>Amir Chaudhry</name></contributor><contributor><email>david.mersinjak@cl.cam.ac.uk</email><uri>https://github.com/pqwy</uri><name>David Kaloper</name></contributor><contributor><email>dave@recoil.org</email><uri>http://dave.recoil.org/</uri><name>Dave Scott</name></contributor><contributor><email>jon@recoil.org</email><uri>http://jon.recoil.org</uri><name>Jon Ludlam</name></contributor><contributor><email>jeremy.yallop@cl.cam.ac.uk</email><uri>https://github.com/yallop</uri><name>Jeremy Yallop</name></contributor><contributor><email>mort@cantab.net</email><uri>http://mort.io/</uri><name>Richard Mortier</name></contributor><contributor><email>vb@luminar.eu.org</email><uri>https://github.com/vbmithr</uri><name>Vincent Bernardoff</name></contributor><contributor><email>raphlalou@gmail.com</email><uri>https://github.com/raphael-proust</uri><name>Raphael Proust</name></contributor><id>https://mirage.io/blog/</id><title type="text">The MirageOS Blog</title><author><name>MirageOS</name></author></source><link type="text/html" href="https://mirage.io/blog/announcing-mirage-36-release" rel="alternate"/><content xml:base="https://mirage.io/blog/atom.xml" type="xhtml"><div xmlns="http://www.w3.org/1999/xhtml"><h1 id="MirageOS-3-6-0-release">MirageOS 3.6.0 release</h1>

<p>We are pleased to announce the release of MirageOS 3.6.0. This release updates MirageOS to support <a href="https://github.com/Solo5/solo5">Solo5</a> 0.6.0 and later.</p>
<p>New features:</p>
<ul><li>Support for the Solo5 <code>spt</code> (sandboxed process tender) target via <code>mirage configure -t spt</code>. The <code>spt</code> target runs MirageOS unikernels in a minimal strict seccomp sandbox on Linux <code>x86_64</code>, <code>aarch64</code> and <code>ppc64le</code> hosts.</li><li>Support for the Solo5 <em>application manifest</em>, enabling support for multiple network and block storage devices on the <code>hvt</code>, <code>spt</code> and <code>muen</code> targets. The <code>genode</code> and <code>virtio</code> targets are still limited to using a single network or block storage device.</li><li>Several notable security enhancements to Solo5 targets, such as enabling stack smashing protection throughout the toolchain by default and improved page protections on some targets.  For details, please refer to the Solo5 0.6.0 <a href="https://github.com/Solo5/solo5/releases/tag/v0.6.0">release notes</a>.</li></ul>

<p>Additional user-visible changes:</p>
<ul><li>Solo5 0.6.0 has removed the compile-time specialization of the <code>solo5-hvt</code> tender. As a result, a <code>solo5-hvt</code> binary is no longer built at <code>mirage build</code> time. Use the <code>solo5-hvt</code> binary installed in your <code>$PATH</code> by OPAM to run the unikernel.</li><li><code>mirage build</code> now produces silent <code>ocamlbuild</code> output by default. To get the old behaviour, run with <code>--verbose</code> or set the log level to <code>info</code> or <code>debug</code>.</li><li>New functions <code>Mirage_key.is_solo5</code> and <code>Mirage_key.is_xen</code>, analogous to <code>Mirage_key.is_unix</code>.</li></ul>

<p>Thanks to Hannes Mehnert for help with the release engineering for MirageOS 3.6.0.</p>
</div></content><id>https://mirage.io/blog/announcing-mirage-36-release</id><title type="text">Announcing MirageOS 3.6.0</title><updated>2019-10-18T15:00:00-00:00</updated><author><email>martin@lucina.net</email><uri>https://lucina.net/</uri><name>Martin Lucina</name></author></entry><entry><source><updated>2020-02-20T00:00:00-00:00</updated><link title="Jane Street Tech Blog" type="text/html" href="https://blog.janestreet.com" rel="related"/><link title="Jane Street Tech Blog" type="application/rss+xml" href="https://blog.janestreet.com/feed.xml" rel="self"/><id>https://blog.janestreet.com</id><title type="text">Jane Street Tech Blog</title><author><name>Jane Street</name></author></source><link href="https://blog.janestreet.com/commas-in-big-numbers-everywhere/" rel="alternate"/><content xml:base="https://blog.janestreet.com/feed.xml" type="html">&lt;p&gt;My job involves a lot of staring at large numbers, mostly latencies in
nanoseconds, and picking out magnitudes like microseconds. I noticed
myself constantly counting digits in my text editor, in my terminal,
and in &lt;a href=&quot;https://jupyter.org/&quot;&gt;Jupyter&lt;/a&gt; notebooks in my browser.&lt;/p&gt;

</content><id>https://blog.janestreet.com/commas-in-big-numbers-everywhere/</id><title type="text">Commas in big numbers everywhere: An OpenType adventure</title><updated>2019-10-14T00:00:00-00:00</updated><author><name>Jane Street</name></author></entry><entry><source><updated>2020-03-23T08:47:03-00:00</updated><logo>http://www.ocamlpro.com/wp-content/uploads/2018/02/apple-touch-icon-152x152-150x150.png</logo><link title="OCamlPro" type="text/html" href="http://www.ocamlpro.com" rel="related"/><link title="OCamlPro" type="application/rss+xml" href="http://www.ocamlpro.com/feed/" rel="self"/><generator>https://wordpress.org/?v=4.9.13</generator><id>http://www.ocamlpro.com</id><title type="text">OCamlPro</title><author><name>OCamlPro</name></author></source><link href="http://www.ocamlpro.com/2019/09/25/ocaml-expert-and-beginner-training-by-ocamlpro-in-french-nov-5-6-7-8/" rel="alternate"/><link href="http://www.ocamlpro.com/2019/09/25/ocaml-expert-and-beginner-training-by-ocamlpro-in-french-nov-5-6-7-8/#respond" rel="related"/><content xml:base="http://www.ocamlpro.com/feed/" type="html">&lt;p&gt;In our endeavour to encourage professional programmers to understand and use OCaml, OCamlPro will be giving two training sessions, in French, in our Paris offices:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;http://www.ocamlpro.com/course-ocaml-development/&quot;&gt;OCaml Beginner course&lt;/a&gt; for professional programmers (5-6 Nov)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.ocamlpro.com/course-ocaml-expert/&quot;&gt;OCaml Expertise&lt;/a&gt; (7-8 Nov).&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;The &amp;#8220;Expert&amp;#8221; OCaml course is for already experienced OCaml programmers to better understand advanced type system possibilities (objects, GADTs), discover GC internals, write &amp;#8220;compiler-optimizable&amp;#8221; code.&lt;/p&gt;
&lt;p&gt;These sessions are also an opportunity to come discuss with OCamlPro&amp;#8217;s OPAM &amp;amp; Flambda lead developers and core contributors in Paris.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;Training in English can also be organized, on-demand.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Register link: http://www.ocamlpro.com/forms/preinscriptions-formation-ocaml/&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;em&gt;This complements the excellent &lt;a href=&quot;https://www.fun-mooc.fr/courses/course-v1:parisdiderot+56002+session04/about&quot;&gt;OCaml MOOC&lt;/a&gt; from Université Paris-Diderot and the &lt;a href=&quot;http://ocaml.foundation/learn-ocaml&quot;&gt;learn-OCaml platform&lt;/a&gt; of the OCaml Software Foundation.&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;
</content><category term="Blog"/><id>http://www.ocamlpro.com/?p=2270</id><title type="text">OCaml expert and beginner training by OCamlPro (in French): Nov. 5-6 &amp; 7-8</title><updated>2019-09-25T10:22:33-00:00</updated><author><name>OCamlPro</name></author></entry><entry><source><updated>2019-12-11T00:00:00-00:00</updated><link title="Tarides RSS Feed" type="text/html" href="https://tarides.com" rel="related"/><link title="Tarides RSS Feed" type="application/rss+xml" href="https://tarides.com/feed.xml" rel="self"/><generator>GatsbyJS</generator><id>https://tarides.com</id><title type="text">Tarides RSS Feed</title><author><name>Tarides</name></author></source><link href="https://tarides.com/blog/2019-09-25-mr-mime-parse-and-generate-emails" rel="alternate"/><content xml:base="https://tarides.com/feed.xml" type="html">&lt;p&gt;We're glad to announce the first release of &lt;a href=&quot;https://github.com/mirage/mrmime.git&quot;&gt;&lt;code&gt;mrmime&lt;/code&gt;&lt;/a&gt;, a parser and a
generator of emails. This library provides an &lt;em&gt;OCaml way&lt;/em&gt; to analyze and craft
an email. The eventual goal is to build an entire &lt;em&gt;unikernel-compatible&lt;/em&gt; stack
for email (such as SMTP or IMAP).&lt;/p&gt;
&lt;p&gt;In this article, we will show what is currently possible with &lt;code&gt;mrmime&lt;/code&gt; and
present a few of the useful libraries that we developed along the way.&lt;/p&gt;
&lt;h2 id=&quot;an-email-parser&quot;&gt;&lt;a href=&quot;#an-email-parser&quot; aria-label=&quot;an email parser permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;An email parser&lt;/h2&gt;
&lt;p&gt;Some years ago, Romain gave &lt;a href=&quot;https://www.youtube.com/watch?v=kQkRsNEo25k&quot;&gt;a talk&lt;/a&gt; about what an email really &lt;em&gt;is&lt;/em&gt;.
Behind the human-comprehensible format (or &lt;em&gt;rich-document&lt;/em&gt; as we said a
long time ago), there are several details of emails which complicate the process of
analyzing them (and can be prone to security lapses). These details are mostly described
by three RFCs:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://tools.ietf.org/html/rfc822&quot;&gt;RFC822&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://tools.ietf.org/html/rfc2822&quot;&gt;RFC2822&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://tools.ietf.org/html/rfc5322&quot;&gt;RFC5322&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Even though they are cross-compatible, providing full legacy email parsing is an
archaeological exercise: each RFC retains support for the older design decisions
(which were not recognized as bad or ugly in 1970 when they were first standardized).&lt;/p&gt;
&lt;p&gt;The latest email-related RFC (RFC5322) tried to fix the issue and provide a better
&lt;a href=&quot;https://tools.ietf.org/html/rfc5234&quot;&gt;formal specification&lt;/a&gt; of the email format – but of course, it comes with plenty of
&lt;em&gt;obsolete&lt;/em&gt; rules which need to be implemented. In the standard, you find
both the current grammar rule and its obsolete equivalent.&lt;/p&gt;
&lt;h3 id=&quot;an-extended-email-parser&quot;&gt;&lt;a href=&quot;#an-extended-email-parser&quot; aria-label=&quot;an extended email parser permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;An extended email parser&lt;/h3&gt;
&lt;p&gt;Even if the email format can defined by &quot;only&quot; 3 RFCs, you will
miss email internationalization (&lt;a href=&quot;https://tools.ietf.org/html/rfc6532&quot;&gt;RFC6532&lt;/a&gt;), the MIME format
(&lt;a href=&quot;https://tools.ietf.org/html/rfc2045&quot;&gt;RFC2045&lt;/a&gt;, &lt;a href=&quot;https://tools.ietf.org/html/rfc2046&quot;&gt;RFC2046&lt;/a&gt;, &lt;a href=&quot;https://tools.ietf.org/html/rfc2047&quot;&gt;RFC2047&lt;/a&gt;,
&lt;a href=&quot;https://tools.ietf.org/html/rfc2049&quot;&gt;RFC2049&lt;/a&gt;), or certain details needed to be interoperable with SMTP
(&lt;a href=&quot;https://tools.ietf.org/html/rfc5321&quot;&gt;RFC5321&lt;/a&gt;). There are still more RFCs which add extra features
to the email format such as S/MIME or the Content-Disposition field.&lt;/p&gt;
&lt;p&gt;Given this complexity, we took the most general RFCs and tried to provide an easy way to deal
with them. The main difficulty is the &lt;em&gt;multipart&lt;/em&gt; parser, which deals with email
attachments (anyone who has tried to make an HTTP 1.1 parser knows about this).&lt;/p&gt;
&lt;h3 id=&quot;a-realistic-email-parser&quot;&gt;&lt;a href=&quot;#a-realistic-email-parser&quot; aria-label=&quot;a realistic email parser permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;A realistic email parser&lt;/h3&gt;
&lt;p&gt;Respecting the rules described by RFCs is not enough to be able to analyze any
email from the real world: existing email generators can, and do, produce
&lt;em&gt;non-compliant&lt;/em&gt; email. We stress-tested &lt;code&gt;mrmime&lt;/code&gt; by feeding it a batch of 2
billion emails taken from the wild, to see if it could parse everything (even if
it does not produce the expected result). Whenever we noticed a recurring
formatting mistake, we updated the details of the &lt;a href=&quot;https://tools.ietf.org/html/rfc5234&quot;&gt;ABNF&lt;/a&gt; to enable
&lt;code&gt;mrmime&lt;/code&gt; to parse it anyway.&lt;/p&gt;
&lt;h3 id=&quot;a-parser-usable-by-others&quot;&gt;&lt;a href=&quot;#a-parser-usable-by-others&quot; aria-label=&quot;a parser usable by others permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;A parser usable by others&lt;/h3&gt;
&lt;p&gt;One demonstration of the usability of &lt;code&gt;mrmime&lt;/code&gt; is &lt;a href=&quot;https://github.com/dinosaure/ocaml-dkim.git&quot;&gt;&lt;code&gt;ocaml-dkim&lt;/code&gt;&lt;/a&gt;, which wants to
extract a specific field from your mail and then verify that the hash and signature
are as expected.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;ocaml-dkim&lt;/code&gt; is used by the latest implementation of &lt;a href=&quot;https://github.com/mirage/ocaml-dns.git&quot;&gt;&lt;code&gt;ocaml-dns&lt;/code&gt;&lt;/a&gt; to request
public keys in order to verify email.&lt;/p&gt;
&lt;p&gt;The most important question about &lt;code&gt;ocaml-dkim&lt;/code&gt; is: is it able to
verify your email in one pass? Indeed, currently some implementations of DKIM
need 2 passes to verify your email (one to extract the DKIM signature, the other
to digest some fields and bodies). We focused on verifying in a &lt;em&gt;single&lt;/em&gt; pass in
order to provide a unikernel SMTP &lt;em&gt;relay&lt;/em&gt; with no need to store your email between
verification passes.&lt;/p&gt;
&lt;h2 id=&quot;an-email-generator&quot;&gt;&lt;a href=&quot;#an-email-generator&quot; aria-label=&quot;an email generator permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;An email generator&lt;/h2&gt;
&lt;p&gt;OCaml is a good language for making little DSLs for specialized use-cases. In this
case, we took advantage of OCaml to allow the user to easily craft an email from
nothing.&lt;/p&gt;
&lt;p&gt;The idea is to build an OCaml value describing the desired email header, and
then let the Mr. MIME generator transform this into a stream of characters that
can be consumed by, for example, an SMTP implementation. The description step
is quite simple:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token directive function&quot;&gt;#require&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;mrmime&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token directive function&quot;&gt;#require&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;ptime.clock.os&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;open&lt;/span&gt; Mrmime

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; romain&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;calascibetta &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;open&lt;/span&gt; Mailbox &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  Local&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; w &lt;span class=&quot;token string&quot;&gt;&quot;romain&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; w &lt;span class=&quot;token string&quot;&gt;&quot;calascibetta&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt; Domain&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;domain&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; a &lt;span class=&quot;token string&quot;&gt;&quot;gmail&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; a &lt;span class=&quot;token string&quot;&gt;&quot;com&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; john&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;doe &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;open&lt;/span&gt; Mailbox &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  Local&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; w &lt;span class=&quot;token string&quot;&gt;&quot;john&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;@&lt;/span&gt; Domain&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;domain&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; a &lt;span class=&quot;token string&quot;&gt;&quot;doe&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; a &lt;span class=&quot;token string&quot;&gt;&quot;org&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;|&gt;&lt;/span&gt; with&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;name Phrase&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;v &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; w &lt;span class=&quot;token string&quot;&gt;&quot;John&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; w &lt;span class=&quot;token string&quot;&gt;&quot;D.&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; now &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;open&lt;/span&gt; Date &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  of&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;ptime &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;zone&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;Zone&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;GMT &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Ptime&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;clock&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;now &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; subject &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  Unstructured&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; v &lt;span class=&quot;token string&quot;&gt;&quot;A&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; sp &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; v &lt;span class=&quot;token string&quot;&gt;&quot;Simple&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; sp &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; v &lt;span class=&quot;token string&quot;&gt;&quot;Mail&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; header &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;open&lt;/span&gt; Header &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  Field&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Subject &lt;span class=&quot;token operator&quot;&gt;$&lt;/span&gt; subject&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; Field&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Sender &lt;span class=&quot;token operator&quot;&gt;$&lt;/span&gt; romain&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;calascibetta&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; Field&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;To &lt;span class=&quot;token operator&quot;&gt;$&lt;/span&gt; Address&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; mailbox john&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;doe &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; Field&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Date &lt;span class=&quot;token operator&quot;&gt;$&lt;/span&gt; now &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&lt;/span&gt; empty

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; stream &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Header&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;to&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;stream header

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;rec&lt;/span&gt; go &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; stream &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Some buf &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; print&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;string buf&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; go &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; None &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  go &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This code produces the following header:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;mail&quot;&gt;&lt;pre class=&quot;language-mail&quot;&gt;&lt;code class=&quot;language-mail&quot;&gt;Date: 2 Aug 2019 14:10:10 GMT
To: John &amp;quot;D.&amp;quot; &amp;lt;john@doe.org&amp;gt;
Sender: romain.calascibetta@gmail.com
Subject: A Simple Mail&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;78-character-rule&quot;&gt;&lt;a href=&quot;#78-character-rule&quot; aria-label=&quot;78 character rule permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;78-character rule&lt;/h3&gt;
&lt;p&gt;One aspect about email and SMTP is about some historical rules of how to
generate them. One of them is about the limitation of bytes per line. Indeed, a
generator of mail should emit at most 80 bytes per line - and, of course, it
should emits entirely the email line per line.&lt;/p&gt;
&lt;p&gt;So &lt;code&gt;mrmime&lt;/code&gt; has his own encoder which tries to wrap your mail into this limit.
It was mostly inspired by &lt;a href=&quot;https://github.com/inhabitedtype/faraday&quot;&gt;Faraday&lt;/a&gt; and &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/libref/Format.html&quot;&gt;Format&lt;/a&gt; powered with
GADT to easily describe how to encode/generate parts of an email.&lt;/p&gt;
&lt;h3 id=&quot;a-multipart-email-generator&quot;&gt;&lt;a href=&quot;#a-multipart-email-generator&quot; aria-label=&quot;a multipart email generator permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;A multipart email generator&lt;/h3&gt;
&lt;p&gt;Of course, the main point about email is to be able to generate a multipart
email - just to be able to send file attachments. And, of course, a deep work
was done about that to make parts, compose them into specific &lt;code&gt;Content-Type&lt;/code&gt;
fields and merge them into one email.&lt;/p&gt;
&lt;p&gt;Eventually, you can easily make a stream from it, which respects rules (78 bytes
per line, stream line per line) and use it directly into an SMTP implementation.&lt;/p&gt;
&lt;p&gt;This is what we did with the project &lt;a href=&quot;https://github.com/dinosaure/facteur&quot;&gt;&lt;code&gt;facteur&lt;/code&gt;&lt;/a&gt;. It's a little
command-line tool to send with file attachement mails in pure OCaml - but it
works only on an UNIX operating system for instance.&lt;/p&gt;
&lt;h2 id=&quot;behind-the-forest&quot;&gt;&lt;a href=&quot;#behind-the-forest&quot; aria-label=&quot;behind the forest permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Behind the forest&lt;/h2&gt;
&lt;p&gt;Even if you are able to parse and generate an email, more work is needed to get the expected results.&lt;/p&gt;
&lt;p&gt;Indeed, email is a exchange unit between people and the biggest deal on that is
to find a common way to ensure a understable communication each others. About
that, encoding is probably the most important piece and when a French person wants
to communicate with a &lt;em&gt;latin1&lt;/em&gt; encoding, an American person can still use ASCII.&lt;/p&gt;
&lt;h3 id=&quot;rosetta&quot;&gt;&lt;a href=&quot;#rosetta&quot; aria-label=&quot;rosetta permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Rosetta&lt;/h3&gt;
&lt;p&gt;So about this problem, the choice was made to unify any contents to UTF-8 as the
most general encoding of the world. So, we did some libraries which map an encoding flow
to Unicode code-point, and we use &lt;code&gt;uutf&lt;/code&gt; (thanks to &lt;a href=&quot;https://github.com/dbuenzli&quot;&gt;dbuenzli&lt;/a&gt;) to normalize it to UTF-8.&lt;/p&gt;
&lt;p&gt;The main goal is to avoid a headache to the user about that and even if
contents of the mail is encoded with &lt;em&gt;latin1&lt;/em&gt; we ensure to translate it
correctly (and according RFCs) to UTF-8.&lt;/p&gt;
&lt;p&gt;This project is &lt;a href=&quot;https://github.com/mirage/rosetta&quot;&gt;&lt;code&gt;rosetta&lt;/code&gt;&lt;/a&gt; and it comes with:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/mirage/uuuu&quot;&gt;&lt;code&gt;uuuu&lt;/code&gt;&lt;/a&gt; for ISO-8859 encoding&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/mirage/coin&quot;&gt;&lt;code&gt;coin&lt;/code&gt;&lt;/a&gt; for KOI8-{R,U} encoding&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/mirage/yuscii&quot;&gt;&lt;code&gt;yuscii&lt;/code&gt;&lt;/a&gt; for UTF-7 encoding&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;pecu-and-base64&quot;&gt;&lt;a href=&quot;#pecu-and-base64&quot; aria-label=&quot;pecu and base64 permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Pecu and Base64&lt;/h3&gt;
&lt;p&gt;Then, bodies can be encoded in some ways, 2 precisely (if we took the main
standard):&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A base64 encoding, used to store your file&lt;/li&gt;
&lt;li&gt;A quoted-printable encoding&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So, about the &lt;code&gt;base64&lt;/code&gt; package, it comes with a sub-package &lt;code&gt;base64.rfc2045&lt;/code&gt;
which respects the special case to encode a body according RFC2045 and SMTP
limitation.&lt;/p&gt;
&lt;p&gt;Then, &lt;code&gt;pecu&lt;/code&gt; was made to encode and decode &lt;em&gt;quoted-printable&lt;/em&gt; contents. It was
tested and fuzzed of course like any others MirageOS's libraries.&lt;/p&gt;
&lt;p&gt;These libraries are needed for an other historical reason which is: bytes used
to store mail should use only 7 bits instead of 8 bits. This is the purpose of
the base64 and the &lt;em&gt;quoted-printable&lt;/em&gt; encoding which uses only 127 possibilities
of a byte. Again, this limitation comes with SMTP protocol.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;mrmime&lt;/code&gt; is tackling the difficult task to parse and generate emails according to 50 years of usability, several RFCs and legacy rules.
So, it
still is an experimental project. We reach the first version of it because we
are currently able to parse many mails and then generate them correctly.&lt;/p&gt;
&lt;p&gt;Of course, a &lt;em&gt;bug&lt;/em&gt; (a malformed mail, a server which does not respect standards
or a bad use of our API) can appear easily where we did not test everything. But
we have the feeling it was the time to release it and let people to use
it.&lt;/p&gt;
&lt;p&gt;The best feedback about &lt;code&gt;mrmime&lt;/code&gt; and the best improvement is yours. So don't be
afraid to use it and start to hack your emails with it.&lt;/p&gt;</content><id>https://tarides.com/blog/2019-09-25-mr-mime-parse-and-generate-emails.html</id><title type="text">Mr. MIME - Parse and generate emails</title><updated>2019-09-25T00:00:00-00:00</updated><author><name>Romain Calascibetta</name></author></entry><entry><source><updated>2020-03-23T08:47:03-00:00</updated><logo>http://www.ocamlpro.com/wp-content/uploads/2018/02/apple-touch-icon-152x152-150x150.png</logo><link title="OCamlPro" type="text/html" href="http://www.ocamlpro.com" rel="related"/><link title="OCamlPro" type="application/rss+xml" href="http://www.ocamlpro.com/feed/" rel="self"/><generator>https://wordpress.org/?v=4.9.13</generator><id>http://www.ocamlpro.com</id><title type="text">OCamlPro</title><author><name>OCamlPro</name></author></source><link href="http://www.ocamlpro.com/2019/09/20/a-look-back-on-ocaml/" rel="alternate"/><link href="http://www.ocamlpro.com/2019/09/20/a-look-back-on-ocaml/#comments" rel="related"/><content xml:base="http://www.ocamlpro.com/feed/" type="html">&lt;p&gt;As you already know if you’ve read &lt;a href=&quot;http://www.ocamlpro.com/2019/09/13/updated-cheat-sheets-ocaml-language-and-ocaml-standard-library/&quot;&gt;our last blogpost&lt;/a&gt;, we have updated our OCaml cheat sheets starting with the language and stdlib ones. We know some of you have students to initiate in September and we wanted these sheets to be ready for the start of the school year! We’re working on more sheets for OCaml tools like opam or Dune and important libraries such as &lt;span style=&quot;text-decoration: line-through;&quot;&gt;&lt;span style=&quot;font-size: 8pt;&quot;&gt;Obj&lt;/span&gt;&lt;/span&gt; Lwt or Core. Keep an eye on our blog or the &lt;a href=&quot;https://github.com/OCamlPro/ocaml-cheat-sheets&quot;&gt;repo on GitHub&lt;/a&gt; to follow all the updates.&lt;/p&gt;
&lt;p&gt;Going through the documentation was a journey to the past: we have looked back on 8 years of evolution of the OCaml language and library. New feature after new feature, OCaml has seen many changes. Needless to say, upgrading our cheat sheets to OCaml 4.08.1 was a trip down memory lane. We wanted to share our throwback experience with you!&lt;/p&gt;
&lt;h2&gt;2011&lt;/h2&gt;
&lt;p&gt;Fabrice Le Fessant first published our cheat sheets in 2011, the year OCamlPro was created! At the time, OCaml was in its 3.12 version and just &lt;a href=&quot;https://inbox.ocaml.org/caml-list/E49008DC-30C0-4B22-9939-85827134C8A6@inria.fr/&quot;&gt;got its current name&lt;/a&gt; agreed upon. &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/manual028.html&quot;&gt;First-class modules&lt;/a&gt; were the new big thing, Camlp4 and Camlp5 were battling for the control of the syntax extension world and Godi and Oasis were the packaging rage.&lt;/p&gt;
&lt;h2&gt;2012&lt;/h2&gt;
&lt;p&gt;Right after 3.12 came the switch to OCaml 4.00 which brought a major change: &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/manual033.html&quot;&gt;GADTs&lt;/a&gt; (generalized algebraic data types). Most of OCaml’s developers don’t use their almighty typing power, but the possibilities they provide are really helpful in some cases, most notably the format overhaul. They’re also a fun way to troll a beginner asking how to circumvent the typing system on Stack Overflow. Since most of us might lose track of their exact syntax, GADTs deserve their place in the updated sheet &lt;span style=&quot;font-size: 8pt;&quot;&gt;(if you happen to be OCamlPro’s CTO, &lt;i&gt;of course&lt;/i&gt; the writer of this blogpost remembers how to use GADTs at all times)&lt;/span&gt;.&lt;/p&gt;
&lt;p&gt;On the standard library side, the big change was the switch of &lt;code&gt;Hashtbl&lt;/code&gt; to Murmur 3 and the support for seeded randomization&lt;a href=&quot;https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2012-0839&quot;&gt;.&lt;/a&gt;&lt;/p&gt;
&lt;h2&gt;2013&lt;/h2&gt;
&lt;p&gt;With OCaml 4.01 came &lt;a href=&quot;https://github.com/ocaml/ocaml/issues/5759&quot;&gt;constructor disambiguation&lt;/a&gt;, but there isn’t really a way to add this to the sheet. This feature allows you to avoid misguided usage of polymorphic variants, but that’s a matter of personal taste (there’s a well-known rule that if you refresh the comments section enough times, someone &lt;span style=&quot;font-size: 8pt;&quot;&gt;—usually called Daniel—&lt;/span&gt; will appear to explain polymorphic variants’ superiority to you). &lt;code&gt;-ppx&lt;/code&gt; rewriters were introduced in this version as well.&lt;/p&gt;
&lt;p&gt;The standard library got a few new functions. Notably, &lt;code&gt;Printexc.get_callstack&lt;/code&gt; for stack inspection, the optimized application operators &lt;code&gt;|&amp;gt;&lt;/code&gt; and &lt;code&gt;@@&lt;/code&gt; and &lt;code&gt;Format.asprintf&lt;/code&gt;.&lt;/p&gt;
&lt;h2&gt;2014&lt;/h2&gt;
&lt;p&gt;&lt;em&gt;Gabriel Scherer, on the Caml-list, end of January:&lt;/em&gt;&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;TL;DR: During the six next months, we will follow pull requests (PR) posted on the github mirror of the OCaml distribution, as an alternative to the mantis bugtracker. This experiment hopes to attract more people to participate in the extremely helpful and surprisingly rewarding activity of patch reviews.&lt;/p&gt;&lt;/blockquote&gt;
&lt;p&gt;Can you guess which change to the cheat-sheets came with 4.02? It’s a universally-loved language feature added in 2014. Still don’t know? It is &lt;em&gt;exceptional&lt;/em&gt;! Got it?&lt;/p&gt;
&lt;p&gt;Drum roll… it is the &lt;code&gt;match with exception&lt;/code&gt; &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/patterns.html#sec131&quot;&gt;construction&lt;/a&gt;! It made our codes simpler, clearer and in some cases more efficient. A message to people who want to improve the language: please aim for that.&lt;/p&gt;
&lt;p&gt;This version also added the &lt;code&gt;{quoted|foo|quoted}&lt;/code&gt; &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/lex.html#string-literal&quot;&gt;syntax&lt;/a&gt; (which broke comments), generative functors, attributes and &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/manual036.html&quot;&gt;extension nodes&lt;/a&gt;, extensible data types, module aliases and, of course, immutable strings (which was optional at the time). Immutable strings is the one feature that prompted us to &lt;em&gt;remove&lt;/em&gt; a line from the cheat sheets. More space is good. Camlp4 and Labltk moved out of the distribution.&lt;/p&gt;
&lt;p&gt;In consequence of immutable strings, &lt;code&gt;Bytes&lt;/code&gt; and &lt;code&gt;BytesLabel&lt;/code&gt; were added to the library. For the great pleasure of optimization addicts, &lt;code&gt;raise_notrace&lt;/code&gt; popped up. Under the hood, the &lt;code&gt;format&lt;/code&gt; type was re-implemented using GADTs.&lt;/p&gt;
&lt;h2&gt;2015&lt;/h2&gt;
&lt;p&gt;This release was so big that 4.02.2 feels like a release in itself, with the adding of &lt;code&gt;nonrec&lt;/code&gt; and &lt;code&gt;#...&lt;/code&gt; operators.&lt;/p&gt;
&lt;p&gt;The standard library was spared by this bug-fix themed release. Note that this is the last comparatively slow year of OCaml as the transition to GitHub would soon make features multiply, as hindsight teaches us.&lt;/p&gt;
&lt;h2&gt;2016&lt;/h2&gt;
&lt;p&gt;Speaking of a major release, we’re up to OCaml 4.03! It introduced &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/manual040.html&quot;&gt;inline records&lt;/a&gt;, a GADT exhaustiveness check on steroids (with &lt;code&gt;-&amp;gt; .&lt;/code&gt; to denote unreachability) and standard attributes like &lt;code&gt;warning&lt;/code&gt;, &lt;code&gt;inlined&lt;/code&gt;, &lt;code&gt;unboxed&lt;/code&gt; or &lt;code&gt;immediate&lt;/code&gt;. Colors appeared in the compiler and last but not least, it was the dawn of a new option called &lt;a href=&quot;http://www.ocamlpro.com/tag/flambda2-en/&quot;&gt;Flambda&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The library saw a lot of useful new functions coming in: lots of new iterators for &lt;code&gt;Array&lt;/code&gt;, an &lt;code&gt;equal&lt;/code&gt; function in most basic type modules, &lt;code&gt;Uchar&lt;/code&gt;, the &lt;code&gt;*_ascii&lt;/code&gt; alternatives and, of course, &lt;code&gt;Ephemeron&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;4.04 was much more restrained, but it was the second release in a single year. Local opening of module with the &lt;code&gt;M.{}&lt;/code&gt; syntax was added along with the &lt;code&gt;let exception ...&lt;/code&gt; in construct. &lt;code&gt;String.split_on_char&lt;/code&gt; was notably added to the stdlib which means we don’t have to rewrite it anymore.&lt;/p&gt;
&lt;h2&gt;2017&lt;/h2&gt;
&lt;p&gt;We now get to 4.05… which did not change the language. Not that the development team wasn’t busy, OCaml just got better without any change to the syntax.&lt;/p&gt;
&lt;p&gt;On the library side however, much happened, with the adding of &lt;code&gt;*_opt&lt;/code&gt; functions pretty much everywhere. If you’re using the OCaml compiler from &lt;a href=&quot;https://packages.debian.org/sid/ocaml&quot;&gt;Debian&lt;/a&gt;, this is where you might think the story ends. You’d be wrong…&lt;/p&gt;
&lt;p&gt;…because 4.06 added a lot! My own favorite feature from this release has to be user-defined &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/manual042.html&quot;&gt;indexing operators&lt;/a&gt;. This is also when &lt;code&gt;safe-string&lt;/code&gt; became the default, giving worthwhile work to every late maintainer in the community. This release also added one awesome function in the standard library: &lt;code&gt;Map.update&lt;/code&gt;.&lt;/p&gt;
&lt;h2&gt;2018&lt;/h2&gt;
&lt;p&gt;4.07 was aimed towards solidifying the language. It added empty variants and type-based selection of GADT constructors to the mix.&lt;/p&gt;
&lt;p&gt;On the library side, one old and two new modules were added, with the integration of &lt;code&gt;Bigarray&lt;/code&gt;, &lt;code&gt;Seq&lt;/code&gt; and &lt;code&gt;Float&lt;/code&gt;.&lt;/p&gt;
&lt;h2&gt;2019&lt;/h2&gt;
&lt;p&gt;And here we are with 4.08, in the present day! We can now put exceptions under or-patterns, which is the only language change from this release we propagated to the sheet. Time will tell if we need to add custom &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/manual046.html&quot;&gt;binding operators&lt;/a&gt; or &lt;code&gt;[@@alert]&lt;/code&gt;. &lt;code&gt;Pervasives&lt;/code&gt; is now deprecated in profit of &lt;code&gt;Stdlib&lt;/code&gt; and new modules are popping up (&lt;code&gt;Int&lt;/code&gt;, &lt;code&gt;Bool&lt;/code&gt;, &lt;code&gt;Fun&lt;/code&gt;, &lt;code&gt;Result&lt;/code&gt;… did we miss one?) while &lt;code&gt;Sort&lt;/code&gt; made its final deprecation warning.&lt;/p&gt;
&lt;p&gt;&amp;nbsp;&lt;/p&gt;
&lt;p&gt;We did not add 4.09 to this journey to the past, as this release is still solidly in the &lt;em&gt;now&lt;/em&gt; at the time of this blogpost. Rest assured, we will see much more awesome features in OCaml in the future! In the meantime, we are working on updating more cheat sheets: keep posted!&lt;/p&gt;
</content><category term="OCaml"/><id>http://www.ocamlpro.com/?p=2095</id><title type="text">A look back on OCaml since 2011</title><updated>2019-09-20T16:00:00-00:00</updated><author><name>OCamlPro</name></author></entry><entry><source><updated>2020-03-10T17:01:15-00:00</updated><link title="Frama-C RSS News" type="text/html" href="http://frama-c.com/" rel="related"/><link title="Frama-C RSS News" type="application/rss+xml" href="http://frama-c.com/rss.xml" rel="self"/><id>http://frama-c.com/</id><title type="text">Frama-C RSS News</title><author><name>Frama-C</name></author></source><link href="http://frama-c.com/index.html" rel="alternate"/><id>http://frama-c.com/index.html#15a4e26bacc76bd47501d5f28fea5119</id><title type="text">Frama-C 19.1 (Potassium) is out. Download ithere.</title><updated>2019-09-17T17:10:39-00:00</updated><author><name>Frama-C</name></author></entry><entry><source><updated>2020-03-23T08:47:03-00:00</updated><logo>http://www.ocamlpro.com/wp-content/uploads/2018/02/apple-touch-icon-152x152-150x150.png</logo><link title="OCamlPro" type="text/html" href="http://www.ocamlpro.com" rel="related"/><link title="OCamlPro" type="application/rss+xml" href="http://www.ocamlpro.com/feed/" rel="self"/><generator>https://wordpress.org/?v=4.9.13</generator><id>http://www.ocamlpro.com</id><title type="text">OCamlPro</title><author><name>OCamlPro</name></author></source><link href="http://www.ocamlpro.com/2019/09/13/updated-cheat-sheets-ocaml-language-and-ocaml-standard-library/" rel="alternate"/><link href="http://www.ocamlpro.com/2019/09/13/updated-cheat-sheets-ocaml-language-and-ocaml-standard-library/#comments" rel="related"/><content xml:base="http://www.ocamlpro.com/feed/" type="html">&lt;p&gt;In 2011, we shared several cheat sheets for OCaml. Cheat sheets are helpful to refer to, as an overview of the documentation when you are programming, especially when you&amp;#8217;re starting in a new language. They are meant to be printed and pinned on your wall, or to be kept in handy on a spare screen. We hope they will help you out when your rubber duck is rubbish at debugging your code!&lt;/p&gt;
&lt;p&gt;Since we first shared them, OCaml and its related tools have evolved. We decided to refresh them and started with the two most-used cheat sheets—our own contribution to the start of the school year!&lt;/p&gt;
&lt;p&gt;Download the revised version:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.ocamlpro.com/wp-content/uploads/2019/09/ocaml-lang.pdf&quot;&gt;OCaml Language (lang)&lt;/a&gt; (PDF)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.ocamlpro.com/wp-content/uploads/2019/09/ocaml-stdlib.pdf&quot;&gt;OCaml Standard Library (stdlib)&lt;/a&gt; (PDF)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;You can also find &lt;a href=&quot;https://github.com/OCamlPro/ocaml-cheat-sheets&quot;&gt;the sources on GitHub&lt;/a&gt;. We welcome contributions, feel free to send patches if you see room for improvement! We&amp;#8217;re working on other cheat sheets: keep an eye on our blog to see updates and brand new cheat sheets.&lt;/p&gt;
&lt;p&gt;While we were updating them, we realized how much OCaml had evolved in the last eight years. We&amp;#8217;ll tell you everything about our trip down memory lane very soon in another blogpost!&lt;/p&gt;
</content><category term="Cheat sheets"/><id>http://www.ocamlpro.com/?p=2142</id><title type="text">Updated Cheat Sheets: OCaml Language and OCaml Standard Library</title><updated>2019-09-13T15:11:49-00:00</updated><author><name>OCamlPro</name></author></entry><entry><source><updated>2020-03-10T17:01:15-00:00</updated><link title="Frama-C RSS News" type="text/html" href="http://frama-c.com/" rel="related"/><link title="Frama-C RSS News" type="application/rss+xml" href="http://frama-c.com/rss.xml" rel="self"/><id>http://frama-c.com/</id><title type="text">Frama-C RSS News</title><author><name>Frama-C</name></author></source><link href="http://frama-c.com/index.html" rel="alternate"/><id>http://frama-c.com/index.html#d5210ac3b1953eb689ded312b397cfd3</id><title type="text">Frama-Clang 0.0.7 is out. Download ithere.</title><updated>2019-09-13T12:45:08-00:00</updated><author><name>Frama-C</name></author></entry><entry><source><updated>2019-12-11T00:00:00-00:00</updated><link title="Tarides RSS Feed" type="text/html" href="https://tarides.com" rel="related"/><link title="Tarides RSS Feed" type="application/rss+xml" href="https://tarides.com/feed.xml" rel="self"/><generator>GatsbyJS</generator><id>https://tarides.com</id><title type="text">Tarides RSS Feed</title><author><name>Tarides</name></author></source><link href="https://tarides.com/blog/2019-09-13-decompress-experiences-with-ocaml-optimization" rel="alternate"/><content xml:base="https://tarides.com/feed.xml" type="html">&lt;p&gt;In our &lt;a href=&quot;https://tarides.com/blog/2019-08-26-decompress-the-new-decompress-api.html&quot;&gt;first article&lt;/a&gt; we mostly discussed
the API design of &lt;code&gt;decompress&lt;/code&gt; and did not talk too much about the issue of
optimizing performance. In this second article, we will relate our experiences
of optimizing &lt;code&gt;decompress&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;As you might suspect, &lt;code&gt;decompress&lt;/code&gt; needs to be optimized a lot. It was used by
several projects as an underlying layer of some formats (like Git), so it can be
a real bottleneck in those projects. Of course, we start with a footgun by using
a garbage-collected language; comparing the performance of &lt;code&gt;decompress&lt;/code&gt; with a C
implementation (like &lt;a href=&quot;https://zlib.net/&quot;&gt;zlib&lt;/a&gt; or &lt;a href=&quot;https://github.com/richgel999/miniz&quot;&gt;miniz&lt;/a&gt;) is obviously not very fair.&lt;/p&gt;
&lt;p&gt;However, using something like &lt;code&gt;decompress&lt;/code&gt; instead of C implementations can be
very interesting for many purposes, especially when thinking about &lt;em&gt;unikernels&lt;/em&gt;.
As we said in the previous article, we can take the advantage of the &lt;em&gt;runtime&lt;/em&gt;
and the type-system to provide something &lt;em&gt;safer&lt;/em&gt; (of course, it's not really
true since zlib has received several security audits).&lt;/p&gt;
&lt;p&gt;The main idea in this article is not to give snippets to copy/paste into your
codebase but to explain some behaviors of the compiler / runtime and hopefully
give you some ideas about how to optimize your own code. We'll discuss the
following optimizations:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;specialization&lt;/li&gt;
&lt;li&gt;inlining&lt;/li&gt;
&lt;li&gt;untagged integers&lt;/li&gt;
&lt;li&gt;exceptions&lt;/li&gt;
&lt;li&gt;unrolling&lt;/li&gt;
&lt;li&gt;hot-loop&lt;/li&gt;
&lt;li&gt;caml_modify&lt;/li&gt;
&lt;li&gt;representation sizes&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id=&quot;cautionary-advice&quot;&gt;&lt;a href=&quot;#cautionary-advice&quot; aria-label=&quot;cautionary advice permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Cautionary advice&lt;/h3&gt;
&lt;p&gt;Before we begin discussing optimization, keep this rule in mind:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Only perform optimization at the &lt;strong&gt;end&lt;/strong&gt; of the development process.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;An optimization pass
can change your code significantly, so you need to keep a state of your project
that can be trusted. This state will provide a comparison point for both
benchmarks and behaviors. In other words, your stable implementation will be the
oracle for your benchmarks. If you start with nothing, you'll achieve
arbitrarily-good performance at the cost of arbitrary behavior!&lt;/p&gt;
&lt;p&gt;We optimized &lt;code&gt;decompress&lt;/code&gt; because we are using it in bigger projects for a long
time (2 years). So we have an oracle (even if &lt;code&gt;zlib&lt;/code&gt; can act as an oracle in
this special case).&lt;/p&gt;
&lt;h2 id=&quot;specialization&quot;&gt;&lt;a href=&quot;#specialization&quot; aria-label=&quot;specialization permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Specialization&lt;/h2&gt;
&lt;p&gt;One of the biggest specializations in &lt;code&gt;decompress&lt;/code&gt; is regarding the &lt;code&gt;min&lt;/code&gt;
function. If you don't know, in OCaml &lt;code&gt;min&lt;/code&gt; is polymorphic; you can compare
anything. So you probably have some concerns about how &lt;code&gt;min&lt;/code&gt; is implemented?&lt;/p&gt;
&lt;p&gt;You are right to be concerned: if you examine the details, &lt;code&gt;min&lt;/code&gt; calls the C
function &lt;code&gt;do_compare_val&lt;/code&gt;, which traverses your structure and does a comparison
according the run-time representation of your structure. Of course, for integers, it
should be only a &lt;code&gt;cmpq&lt;/code&gt; assembly instruction. However, some simple code like:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; min &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;will produce this CMM and assembly code:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;cmm&quot;&gt;&lt;pre class=&quot;language-cmm&quot;&gt;&lt;code class=&quot;language-cmm&quot;&gt;(let x/1002 (app{main.ml:1,8-15} &amp;quot;camlStdlib__min_1028&amp;quot; 1 3 val)
   ...)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;.L101:
        movq    $3, %rbx
        movq    $1, %rax
        call    camlStdlib__min_1028@PLT&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note that &lt;em&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Lambda_calculus#Beta_reduction&quot;&gt;beta-reduction&lt;/a&gt;&lt;/em&gt;, &lt;em&gt;&lt;a href=&quot;https://en.wikipedia.org/wiki/Inline_expansion&quot;&gt;inlining&lt;/a&gt;&lt;/em&gt; and
specialization were not done in this code. OCaml does not optimize your code
very much – the good point is predictability of the produced assembly output.&lt;/p&gt;
&lt;p&gt;If you help the compiler a little bit with:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;external&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; int &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; int &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; bool &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&quot;%lessequal&quot;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; min a b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; b &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; a &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt; b &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;@@&lt;/span&gt;inline&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; min &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We have:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;cmm&quot;&gt;&lt;pre class=&quot;language-cmm&quot;&gt;&lt;code class=&quot;language-cmm&quot;&gt;(function{main.ml:2,8-43} camlMain__min_1003 (a/1004: val b/1005: val)
 (if (&amp;lt;= a/1004 b/1005) a/1004 b/1005))

(function camlMain__entry ()
 (let x/1006 1 (store val(root-init) (+a &amp;quot;camlMain&amp;quot; 8) 1)) 1a)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;.L101:
        cmpq    %rbx, %rax
        jg      .L100
        ret&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So we have all optimizations, in this produced code, &lt;code&gt;x&lt;/code&gt; was evaluated as &lt;code&gt;0&lt;/code&gt;
(&lt;code&gt;let x/... (store ... 1)&lt;/code&gt;) (beta-reduction and inlining) and &lt;code&gt;min&lt;/code&gt; was
specialized to accept only integers – so we are able to emit &lt;code&gt;cmpq&lt;/code&gt;.&lt;/p&gt;
&lt;h3 id=&quot;results&quot;&gt;&lt;a href=&quot;#results&quot; aria-label=&quot;results permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Results&lt;/h3&gt;
&lt;p&gt;With specialization, we won 10 Mb/s on decompression, where &lt;code&gt;min&lt;/code&gt; is used
in several places. We completely avoid an indirection and a call to the slow
&lt;code&gt;do_compare_val&lt;/code&gt; function.&lt;/p&gt;
&lt;p&gt;This kind of specialization is already done by &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/flambda.html&quot;&gt;&lt;code&gt;flambda&lt;/code&gt;&lt;/a&gt;, however, we
currently use OCaml 4.07.1. So we decided to this kind of optimization by
ourselves.&lt;/p&gt;
&lt;h2 id=&quot;inlining&quot;&gt;&lt;a href=&quot;#inlining&quot; aria-label=&quot;inlining permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Inlining&lt;/h2&gt;
&lt;p&gt;In the first example, we showed code with the &lt;code&gt;[@@inline]&lt;/code&gt; keyword which is
useful to force the compiler to inline a little function. We will go outside the
OCaml world and study C code (gcc 5.4.0) to really understand
&lt;em&gt;inlining&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;In fact, inlining is not necessarily the best optimization. Consider the
following (nonsensical) C program:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;c&quot;&gt;&lt;pre class=&quot;language-c&quot;&gt;&lt;code class=&quot;language-c&quot;&gt;&lt;span class=&quot;token macro property&quot;&gt;#&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdio.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;#&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;string.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;#&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;unistd.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;#&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;time.h&gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;#&lt;span class=&quot;token directive keyword&quot;&gt;include&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;&amp;lt;stdlib.h&gt;&lt;/span&gt;&lt;/span&gt;

&lt;span class=&quot;token macro property&quot;&gt;#&lt;span class=&quot;token directive keyword&quot;&gt;ifdef&lt;/span&gt; HIDE_ALIGNEMENT&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;__attribute__&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;noinline&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; noclone&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token macro property&quot;&gt;#&lt;span class=&quot;token directive keyword&quot;&gt;endif&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;
&lt;span class=&quot;token function&quot;&gt;hide&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; p&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; ac&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;const&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;av&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;char&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt;s &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;calloc&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;20&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  s &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;hide&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;memset&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;'B'&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;100000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  clock_t start &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;clock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;int&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1280000&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;++&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
    s&lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token function&quot;&gt;strlen&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;'A'&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  clock_t end &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token function&quot;&gt;clock&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token function&quot;&gt;printf&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;%lld\n&quot;&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;long&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;end&lt;span class=&quot;token operator&quot;&gt;-&lt;/span&gt;start&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
&lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We will compile this code with &lt;code&gt;-O2&lt;/code&gt; (the second level of optimization in C),
once with &lt;code&gt;-DHIDE_ALIGNEMENT&lt;/code&gt; and once without. The assembly emitted differs:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;.L3:
	movq	%rbp, %rdi
	call	strlen
	subl	$1, %ebx
	movb	$65, 0(%rbp,%rax)
	jne	.L3&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;.L3:
	movl	(%rdx), %ecx
	addq	$4, %rdx
	leal	-16843009(%rcx), %eax
	notl	%ecx
	andl	%ecx, %eax
	andl	$-2139062144, %eax
	je	.L3&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In the first output (with &lt;code&gt;-DHIDE_ALIGNEMENT&lt;/code&gt;), the optimization pass
decides to disable inlining of &lt;code&gt;strlen&lt;/code&gt;; in the second output (without
&lt;code&gt;-DHIDEAlIGNEMENT&lt;/code&gt;), it decides to inline &lt;code&gt;strlen&lt;/code&gt; (and do some other clever
optimizations). The reason behind this complex behavior from the compiler is
clearly described &lt;a href=&quot;https://stackoverflow.com/a/55589634&quot;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;But what we want to say is that inlining is &lt;strong&gt;not&lt;/strong&gt; an automatic optimization;
it might act as a &lt;em&gt;pessimization&lt;/em&gt;. This is the goal of &lt;code&gt;flambda&lt;/code&gt;: do the right
optimization under the right context. If you are really curious about what &lt;code&gt;gcc&lt;/code&gt;
does and why, even if it's very interesting, the reverse engineering of the
optimization process and which information is relevant about the choice to
optimize or not is deep, long and surely too complicated.&lt;/p&gt;
&lt;p&gt;A non-spontaneous optimization is to annotate some parts of your code with
&lt;code&gt;[@@inline never]&lt;/code&gt; – so, explicitly say to the compiler to not inline the
function. This constraint is to help the compiler to generate a smaller code
which will have more chance to fit under the processor cache.&lt;/p&gt;
&lt;p&gt;For all of these reasons, &lt;code&gt;[@@inline]&lt;/code&gt; should be used sparingly and an oracle to
compare performances if you inline or not this or this function is necessary to
avoid a &lt;em&gt;pessimization&lt;/em&gt;.&lt;/p&gt;
&lt;h3 id=&quot;in-decompress&quot;&gt;&lt;a href=&quot;#in-decompress&quot; aria-label=&quot;in decompress permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;In &lt;code&gt;decompress&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;Inlining in &lt;code&gt;decompress&lt;/code&gt; was done on small functions which need to allocate
to return a value. If we inline them, we can take the opportunity to store
returned value in registers (of course, it depends how many registers are free).&lt;/p&gt;
&lt;p&gt;As we said, the goal of the inflator is to translate a bit sequence to a byte.
The largest bit sequence possible according to RFC 1951 has length 15. So, when
we process an inputs flow, we eat it 15 bits per 15 bits. For each packet, we
want to recognize an existing associated bit sequence and then, binded values
will be the real length of the bit sequence and the byte:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; find &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; bits&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;int &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; int&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; byte&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; int&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;So for each call to this function, we need to allocate a record/tuple. It's
why we choose to inline this function. &lt;code&gt;min&lt;/code&gt; was inlined too and some other
small functions. But as we said, the situation is complex; where we think that
&lt;em&gt;inlining&lt;/em&gt; can help us, it's not systematically true.&lt;/p&gt;
&lt;p&gt;NOTE: we can recognize bits sequence with, at most, 15 bits because a
&lt;a href=&quot;https://zlib.net/feldspar.html&quot;&gt;Huffman coding&lt;/a&gt; is &lt;a href=&quot;https://en.wikipedia.org/wiki/Prefix_code&quot;&gt;prefix-free&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&quot;untagged-integers&quot;&gt;&lt;a href=&quot;#untagged-integers&quot; aria-label=&quot;untagged integers permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Untagged integers&lt;/h2&gt;
&lt;p&gt;When reading assembly, the integer &lt;code&gt;0&lt;/code&gt; is written as &lt;code&gt;$1&lt;/code&gt;.
It's because of the &lt;a href=&quot;https://blog.janestreet.com/what-is-gained-and-lost-with-63-bit-integers/&quot;&gt;GC bit&lt;/a&gt; needed to differentiate a pointer
and an unboxed integer. This is why, in OCaml, we talk about a 31-bits integer
or a 63-bits integer (depending on your architecture).&lt;/p&gt;
&lt;p&gt;We will not try to start a debate about this arbitrary choice on the
representation of an integer in OCaml. However, we can talk about some
operations which can have an impact on performances.&lt;/p&gt;
&lt;p&gt;The biggest example is about the &lt;code&gt;mod&lt;/code&gt; operation. Between OCaml and C, &lt;code&gt;%&lt;/code&gt; or
&lt;code&gt;mod&lt;/code&gt; should be the same:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; f a b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;mod&lt;/span&gt; b&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The output assembly is:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;.L105:
        movq    %rdi, %rcx
        sarq    $1, %rcx     // b &amp;gt;&amp;gt; 1
        movq    (%rsp), %rax
        sarq    $1, %rax     // a &amp;gt;&amp;gt; 1
        testq   %rcx, %rcx   // b != 0
        je      .L107
        cqto
        idivq   %rcx         // a % b
        jmp     .L106
.L107:
        movq    caml_backtrace_pos@GOTPCREL(%rip), %rax
        xorq    %rbx, %rbx
        movl    %ebx, (%rax)
        movq    caml_exn_Division_by_zero@GOTPCREL(%rip), %rax
        call    caml_raise_exn@PLT
.L106:
        salq    $1, %rdx     // x &amp;lt;&amp;lt; 1
        incq    %rdx         // x + 1
        movq    %rbx, %rax&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;where idiomatically the same C code produce:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;.L2:
        movl    -12(%rbp), %eax
        cltd
        idivl   -8(%rbp)
        movl    %edx, -4(%rbp)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Of course, we can notice firstly the exception in OCaml (&lt;code&gt;Divided_by_zero&lt;/code&gt;) -
which is pretty good because it protects us against an interrupt from assembly
(and keep the trace). Then, we need to &lt;em&gt;untag&lt;/em&gt; &lt;code&gt;a&lt;/code&gt; and &lt;code&gt;b&lt;/code&gt; with &lt;code&gt;sarq&lt;/code&gt; assembly
operation. We do, as the C code, &lt;code&gt;idiv&lt;/code&gt; and then we must &lt;em&gt;retag&lt;/em&gt; returned value
&lt;code&gt;x&lt;/code&gt; with &lt;code&gt;salq&lt;/code&gt; and &lt;code&gt;incq&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;So in some parts, it should be more interesting to use &lt;code&gt;Nativeint&lt;/code&gt;. However, by
default, a &lt;code&gt;nativeint&lt;/code&gt; is boxed. &lt;em&gt;boxed&lt;/em&gt; means that the value is allocated in
the OCaml heap alongside a header.&lt;/p&gt;
&lt;p&gt;Of course, this is not what we want so, if our &lt;code&gt;nativeint ref&lt;/code&gt; (to have
side-effect, like &lt;code&gt;x&lt;/code&gt;) stay inside a function and then, you return the real
value with the deref &lt;code&gt;!&lt;/code&gt; operator, OCaml, by a good planet alignment, can
directly use registers and real integers. So it should be possible to avoid
these needed conversions.&lt;/p&gt;
&lt;h3 id=&quot;readability-versus-performance&quot;&gt;&lt;a href=&quot;#readability-versus-performance&quot; aria-label=&quot;readability versus performance permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Readability versus performance&lt;/h3&gt;
&lt;p&gt;We use this optimization only in few parts of the code. In fact, switch
between &lt;code&gt;int&lt;/code&gt; and &lt;code&gt;nativeint&lt;/code&gt; is little bit noisy:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;hold &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; Nativeint&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;logor &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;hold Nativeint&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;shift&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;left &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;of&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;int &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;unsafe&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;uint8 d&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;i &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;pos&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;bits&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In the end, we only gained 0.5Mb/s of inflation rate, so it's not worthwhile
to do systematically this optimization. Especially that the gain is not very
big. But this case show a more troubling problem: loss of readability.&lt;/p&gt;
&lt;p&gt;In fact, we can optimize more and more a code (OCaml or C) but we lost, step by
step, readability. You should be afraid by the implementation of &lt;code&gt;strlen&lt;/code&gt; for
example. In the end, the loss of readability makes it harder to understand the purpose
of the code, leading to errors whenever some other person (or you in 10 years time)
tries to make a change.&lt;/p&gt;
&lt;p&gt;And we think that this kind of optimization is not the way of OCaml in general
where we prefer to produce an understandable and abstracted code than a cryptic
and super fast one.&lt;/p&gt;
&lt;p&gt;Again, &lt;code&gt;flambda&lt;/code&gt; wants to fix this problem and let the compiler to do this
optimization. The goal is to be able to write a fast code without any pain.&lt;/p&gt;
&lt;h2 id=&quot;exceptions&quot;&gt;&lt;a href=&quot;#exceptions&quot; aria-label=&quot;exceptions permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Exceptions&lt;/h2&gt;
&lt;p&gt;If you remember our &lt;a href=&quot;https://tarides.com/blog/2019-02-08-release-of-base64.html&quot;&gt;article&lt;/a&gt; about the release of &lt;code&gt;base64&lt;/code&gt;, we talked a
bit about exceptions and used them as a &lt;em&gt;jump&lt;/em&gt;. In fact, it's pretty
common for an OCaml developer to break the control-flow with an exception.
Behind this common design/optimization, it's about calling convention.&lt;/p&gt;
&lt;p&gt;Indeed, choose the &lt;em&gt;jump&lt;/em&gt; word to describe OCaml exception is not the best where
we don't use &lt;code&gt;setjmp&lt;/code&gt;/&lt;code&gt;longjmp&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;In the details, when you start a code with a &lt;code&gt;try .. with&lt;/code&gt;, OCaml saves a &lt;em&gt;trap&lt;/em&gt;
in the stack which contains information about the &lt;code&gt;with&lt;/code&gt;, the catcher. Then,
when you &lt;code&gt;raise&lt;/code&gt;, you &lt;em&gt;jump&lt;/em&gt; directly to this trap and can just discard several
stack frames (and, by this way, you did not check each return codes).&lt;/p&gt;
&lt;p&gt;In several places and mostly in the &lt;em&gt;hot-loop&lt;/em&gt;, we use this &lt;em&gt;pattern&lt;/em&gt;. However,
it completely breaks the control flow and can be error-prone.&lt;/p&gt;
&lt;p&gt;To limit errors and because this pattern is usual, we prefer to use a &lt;em&gt;local&lt;/em&gt;
exception which will be used only inside the function. By this way, we enforce
the fact that exception should not (and can not) be caught by something else
than inside the function.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;exception&lt;/span&gt; Break &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;

    &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;try&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;while&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;max &lt;span class=&quot;token operator&quot;&gt;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
          &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; bl&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;count&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;max&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; raise&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;notrace Break
        &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; decr max &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt; Break &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This code above produce this assembly code:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;.L105:
        pushq   %r14
        movq    %rsp, %r14
.L103:
        cmpq    $3, %rdi              // while !max &amp;gt;= 1
        jl      .L102
        movq    -4(%rbx,%rdi,4), %rsi // bl_count,(!max)
        cmpq    $1, %rsi              // bl_count.(!max) != 0
        je      .L104
        movq    %r14, %rsp
        popq    %r14
        ret                           // raise_notrace Break
.L104:
        addq    $-2, %rdi             // decr max
        movq    %rdi, 16(%rsp)
        jmp     .L103&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Where the &lt;code&gt;ret&lt;/code&gt; is the &lt;code&gt;raise_notrace Break&lt;/code&gt;. A &lt;code&gt;raise_notrace&lt;/code&gt; is needed,
otherwise, you will see:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;        movq    caml_backtrace_pos@GOTPCREL(%rip), %rbx
        xorq    %rdi, %rdi
        movl    %edi, (%rbx)
        call    caml_raise_exn@PLT&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Instead the &lt;code&gt;ret&lt;/code&gt; assembly code. Indeed, in this case, we need to store where we
raised the exception.&lt;/p&gt;
&lt;h2 id=&quot;unrolling&quot;&gt;&lt;a href=&quot;#unrolling&quot; aria-label=&quot;unrolling permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Unrolling&lt;/h2&gt;
&lt;p&gt;When we showed the optimization done by &lt;code&gt;gcc&lt;/code&gt; when the string is aligned, &lt;code&gt;gcc&lt;/code&gt;
did another optimization. Instead of setting the string byte per byte, it decides to
update it 4 bytes per 4 bytes.&lt;/p&gt;
&lt;p&gt;This kind of this optimization is an &lt;em&gt;unroll&lt;/em&gt; and we did it in &lt;code&gt;decompress&lt;/code&gt;.
Indeed, when we reach the &lt;em&gt;copy&lt;/em&gt; &lt;em&gt;opcode&lt;/em&gt; emitted by the &lt;a href=&quot;https://en.wikipedia.org/wiki/LZ77_and_LZ78&quot;&gt;lz77&lt;/a&gt;
compressor, we want to &lt;em&gt;blit&lt;/em&gt; &lt;em&gt;length&lt;/em&gt; byte(s) from a source to the outputs
flow. It can appear that this &lt;code&gt;memcpy&lt;/code&gt; can be optimized to copy 4 bytes per 4
bytes – 4 bytes is generally a good idea where it's the size of an &lt;code&gt;int32&lt;/code&gt; and
should fit under any architectures.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; blit src src&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;off dst dst&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;off &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;if&lt;/span&gt; dst&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;off – src&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;off &lt;span class=&quot;token operator&quot;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;then&lt;/span&gt; slow&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;blit src src&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;off dst dst&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;off
  &lt;span class=&quot;token keyword&quot;&gt;else&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; len0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;land&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; len1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; len &lt;span class=&quot;token operator&quot;&gt;asr&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;to&lt;/span&gt; len1 – &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; unsafe&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;uint32 src &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;src&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;off &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
      unsafe&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;set&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;uint32 dst &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;off &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; v &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

    &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;to&lt;/span&gt; len0 – &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; len1 &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; i &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; unsafe&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;get&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;uint8 src &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;src&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;off &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
      unsafe&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;set&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;uint8 dst &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;dst&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;off &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; v &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
    &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In this code, at the beginning, we copy 4 bytes per 4 bytes and if &lt;code&gt;len&lt;/code&gt; is not
a multiple of 4, we start the &lt;em&gt;trailing&lt;/em&gt; loop to copy byte per byte then. In
this context, OCaml can &lt;em&gt;unbox&lt;/em&gt; &lt;code&gt;int32&lt;/code&gt; and use registers. So this function does
not deal with the heap, and by this way, with the garbage collector.&lt;/p&gt;
&lt;h3 id=&quot;results-1&quot;&gt;&lt;a href=&quot;#results-1&quot; aria-label=&quot;results 1 permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Results&lt;/h3&gt;
&lt;p&gt;In the end, we gained an extra 10Mb/s of inflation rate. The &lt;code&gt;blit&lt;/code&gt; function is the
most important function when it comes to inflating the window to an output flow.
As the specialization on the &lt;code&gt;min&lt;/code&gt; function, this is one of the biggest optimization on
&lt;code&gt;decompress&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&quot;hot-loop&quot;&gt;&lt;a href=&quot;#hot-loop&quot; aria-label=&quot;hot loop permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;&lt;em&gt;hot-loop&lt;/em&gt;&lt;/h2&gt;
&lt;p&gt;A common design about decompression (but we can find it on hash implementation
too), is the &lt;em&gt;hot-loop&lt;/em&gt;. An &lt;em&gt;hot-loop&lt;/em&gt; is mainly a loop on the most common
operation in your process. In the context of &lt;code&gt;decompress&lt;/code&gt;, the &lt;em&gt;hot-loop&lt;/em&gt; is
about a repeated translation from bits-sequence to byte(s) from the inputs flow
to the outputs flow and the window.&lt;/p&gt;
&lt;p&gt;The main idea behind the &lt;em&gt;hot-loop&lt;/em&gt; is to initialize all information needed for
the translation before to start the &lt;em&gt;hot-loop&lt;/em&gt;. Then, it's mostly an imperative
loop with a &lt;em&gt;pattern-matching&lt;/em&gt; which corresponds to the current state of the
global computation.&lt;/p&gt;
&lt;p&gt;In OCaml, we can take this opportunity to use &lt;code&gt;int ref&lt;/code&gt; (or &lt;code&gt;nativeint ref&lt;/code&gt;), and then, they will be translated into registers (which is the fastest
area to store something).&lt;/p&gt;
&lt;p&gt;Another deal inside the &lt;em&gt;hot-loop&lt;/em&gt; is to avoid any allocation – and it's why we
talk about &lt;code&gt;int&lt;/code&gt; or &lt;code&gt;nativeint&lt;/code&gt;. Indeed, a more complex structure like an option
will add a blocker to the garbage collection (a call to &lt;code&gt;caml_call_gc&lt;/code&gt;).&lt;/p&gt;
&lt;p&gt;Of course, this kind of design is completely wrong if we think in a functional
way. However, this is the (biggest?) advantage of OCaml: hide this ugly/hacky
part inside a functional interface.&lt;/p&gt;
&lt;p&gt;In the API, we talked about a state which represents the &lt;em&gt;inflation&lt;/em&gt; (or the
&lt;em&gt;deflation&lt;/em&gt;). At the beginning, the goal is to store into some references
essentials values like the position into the inputs flow, bits available,
dictionary, etc. Then, we launch the &lt;em&gt;hot-loop&lt;/em&gt; and only at the end, we update the state.&lt;/p&gt;
&lt;p&gt;So we keep the optimal design about &lt;em&gt;inflation&lt;/em&gt; and the functional way outside
the &lt;em&gt;hot-loop&lt;/em&gt;.&lt;/p&gt;
&lt;h2 id=&quot;caml_modify&quot;&gt;&lt;a href=&quot;#caml_modify&quot; aria-label=&quot;caml_modify permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;caml_modify&lt;/h2&gt;
&lt;p&gt;One issue that we need to consider is the call to &lt;code&gt;caml_modify&lt;/code&gt;. In
fact, for a complex data-structure like an &lt;code&gt;int array&lt;/code&gt; or a &lt;code&gt;int option&lt;/code&gt; (so,
other than an integer or a boolean or an &lt;em&gt;immediate&lt;/em&gt; value), values can move to the
major heap.&lt;/p&gt;
&lt;p&gt;In this context, &lt;code&gt;caml_modify&lt;/code&gt; is used to assign a new value into your mutable
block. It is a bit slower than a simple assignment but needed to
ensure pointer correspondence between minor heap and major heap.&lt;/p&gt;
&lt;p&gt;With this OCaml code for example:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;mutable&lt;/span&gt; v &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; int option &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; f t v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; v&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We produce this assembly:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;asm&quot;&gt;&lt;pre class=&quot;language-asm&quot;&gt;&lt;code class=&quot;language-asm&quot;&gt;camlExample__f_1004:
        subq    $8, %rsp
        movq    %rax, %rdi
        movq    %rbx, %rsi
        call    caml_modify@PLT
        movq    $1, %rax
        addq    $8, %rsp
        ret&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Where we see the call to &lt;code&gt;caml_modify&lt;/code&gt; which will be take care about the
assignment of &lt;code&gt;v&lt;/code&gt; into &lt;code&gt;t.v&lt;/code&gt;. This call is needed mostly because the type of &lt;code&gt;t.v&lt;/code&gt; is not an &lt;em&gt;immediate&lt;/em&gt; value like an integer. So, for many values in the
&lt;em&gt;inflator&lt;/em&gt; and the &lt;em&gt;deflator&lt;/em&gt;, we mostly use integers.&lt;/p&gt;
&lt;p&gt;Of course, at some points, we use &lt;code&gt;int array&lt;/code&gt; and set them at some specific
points of the &lt;em&gt;inflator&lt;/em&gt; – where we inflated the dictionary. However, the impact
of &lt;code&gt;caml_modify&lt;/code&gt; is not very clear where it is commonly pretty fast.&lt;/p&gt;
&lt;p&gt;Sometimes, however, it can be a real bottleneck in your computation and
this depends on how long your values live in the heap. A little program (which is
not very reproducible) can show that:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;init &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;int&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;of&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;string Sys&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Random&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;int &lt;span class=&quot;token number&quot;&gt;256&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; pr fmt &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Format&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;printf fmt

&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; t0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;mutable&lt;/span&gt; v &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; int option &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; t1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; v &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; int option &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; f0 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;t0 &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; t0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;to&lt;/span&gt; Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length t – &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; t0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt;
             &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Some &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; v
             &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; None&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Some i
             &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; None&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; None &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
     t0&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;v &lt;span class=&quot;token operator&quot;&gt;&amp;lt;-&lt;/span&gt; v
  &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; t0

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; f1 &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;t1 &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; t1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; t1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; ref t1 &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;for&lt;/span&gt; i &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;0&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;to&lt;/span&gt; Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length t – &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;do&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; v &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;t1&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; t&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt;
             &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Some &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; v&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; v
             &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; None&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Some i
             &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; None&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; None &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
     t1 &lt;span class=&quot;token operator&quot;&gt;:=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; v &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;done&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;!&lt;/span&gt;t1

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; t0 &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; t0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; v&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; None &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; t1 &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; t1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;{&lt;/span&gt; v&lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; None &lt;span class=&quot;token punctuation&quot;&gt;}&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; time0 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Unix&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gettimeofday &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  ignore &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;f0 t0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; time1 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Unix&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gettimeofday &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  ignore &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;f1 t1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; time2 &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Unix&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;gettimeofday &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;

  pr &lt;span class=&quot;token string&quot;&gt;&quot;f0: %f ns\n%!&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;time1 &lt;span class=&quot;token operator&quot;&gt;-.&lt;/span&gt; time0&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  pr &lt;span class=&quot;token string&quot;&gt;&quot;f1: %f ns\n%!&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;time2 &lt;span class=&quot;token operator&quot;&gt;-.&lt;/span&gt; time1&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;

  &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In our bare-metal server, if you launch the program with 1000, the &lt;code&gt;f0&lt;/code&gt;
computation, even if it has &lt;code&gt;caml_modify&lt;/code&gt; will be the fastest. However, if you
launch the program with 1000000000, &lt;code&gt;f1&lt;/code&gt; will be the fastest.&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;$ ./a.out 1000
f0: 0.000006 ns
f1: 0.000015 ns
$ ./a.out 1000000000
f0: 7.931782 ns
f1: 5.719370 ns&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;h3 id=&quot;about-decompress&quot;&gt;&lt;a href=&quot;#about-decompress&quot; aria-label=&quot;about decompress permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;About &lt;code&gt;decompress&lt;/code&gt;&lt;/h3&gt;
&lt;p&gt;At the beginning, our choice was made to have, as @dbuenzli does, mutable
structure to represent state. Then, @yallop did a big patch to update it to an
immutable state and we won 9Mb/s on &lt;em&gt;inflation&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;However, the new version is more focused on the &lt;em&gt;hot-loop&lt;/em&gt; and it is 3
times faster than before.&lt;/p&gt;
&lt;p&gt;As we said, the deal about &lt;code&gt;caml_modify&lt;/code&gt; is not clear and depends a lot about
how long your data lives in the heap and how many times you want to update it.
If we localize &lt;code&gt;caml_modify&lt;/code&gt; only on few places, it should be fine. But it still
is one of the most complex question about (macro?) optimization.&lt;/p&gt;
&lt;h2 id=&quot;smaller-representation&quot;&gt;&lt;a href=&quot;#smaller-representation&quot; aria-label=&quot;smaller representation permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Smaller representation&lt;/h2&gt;
&lt;p&gt;We've discussed the impact that integer types can have on the use of immediate
values. More generally, the choice of type to represent your values can have
significant performance implications.&lt;/p&gt;
&lt;p&gt;For example, a dictionary which associates a bits-sequence (an integer) to the
length of it &lt;strong&gt;AND&lt;/strong&gt; the byte, it can be represented by a: &lt;code&gt;(int * int) array&lt;/code&gt;, or
more idiomatically &lt;code&gt;{ len: int; byte: int; } array&lt;/code&gt; (which is structurally the
same).&lt;/p&gt;
&lt;p&gt;However, that means an allocation for each bytes to represent every bytes.
Extraction of it will need an allocation if &lt;code&gt;find : bits:int -&gt; { len: int; byte: int; }&lt;/code&gt; is not inlined as we said. And about memory, the array can be
really &lt;em&gt;heavy&lt;/em&gt; in your heap.&lt;/p&gt;
&lt;p&gt;At this point, we used &lt;code&gt;spacetime&lt;/code&gt; to show how many blocks we allocated for a
common &lt;em&gt;inflation&lt;/em&gt; and we saw that we allocate a lot. The choice was made to use
a smaller representation. Where &lt;code&gt;len&lt;/code&gt; can not be upper than 15 according RFC 1951
and when byte can represent only 256 possibilities (and should fit under one
byte), we can decide to merge them into one integer (which can have, at least,
31 bits).&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; static&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;literal&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;tree &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;12&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;140&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;76&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; static&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;literal&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;tree &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Array&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;map &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;len&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; byte&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;len &lt;span class=&quot;token operator&quot;&gt;lsl&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;8&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;lor&lt;/span&gt; byte&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; static&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;literal&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;tree&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In the code above, we just translate the static dictionary (for a STATIC DEFLATE
block) to a smaller representation where &lt;code&gt;len&lt;/code&gt; will be the left part of the
integer and &lt;code&gt;byte&lt;/code&gt; will be the right part. Of course, it's depends on what you
want to store.&lt;/p&gt;
&lt;p&gt;Another point is readability. &lt;a href=&quot;https://github.com/mirage/ocaml-cstruct#ppx&quot;&gt;&lt;code&gt;cstruct-ppx&lt;/code&gt;&lt;/a&gt; and
&lt;a href=&quot;https://bitbucket.org/thanatonauts/bitstring/src&quot;&gt;&lt;code&gt;bitstring&lt;/code&gt;&lt;/a&gt; can help you but &lt;code&gt;decompress&lt;/code&gt;
wants to depend only on OCaml.&lt;/p&gt;
&lt;h2 id=&quot;conclusion&quot;&gt;&lt;a href=&quot;#conclusion&quot; aria-label=&quot;conclusion permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;
&lt;p&gt;We conclude with some closing advice about optimising your OCaml programs:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;Optimization is specific to your task&lt;/strong&gt;. The points highlighted in this
article may not fit your particular problem, but they are intended to give you
ideas. Our optimizations were only possible because we completely assimilated
the ideas of &lt;code&gt;zlib&lt;/code&gt; and had a clear vision of what we really needed to
optimize (like &lt;code&gt;blit&lt;/code&gt;).
&lt;br/&gt;&lt;br/&gt;
As your first project, this article can not help you a lot to optimize your
code where it's mostly about &lt;em&gt;micro&lt;/em&gt;-optimization under a specific context
(&lt;em&gt;hot-loop&lt;/em&gt;). But it helps you to understand what is really done by the
compiler – which is still really interesting.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Optimise only with respect to an oracle&lt;/strong&gt;. All optimizations were done
because we did a comparison point between the old implementation of
&lt;code&gt;decompress&lt;/code&gt; and &lt;code&gt;zlib&lt;/code&gt; as oracles. Optimizations can change the semantics of your
code and you should systematically take care at any step about expected
behaviors. So it's a long run.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;Use the predictability of the OCaml compiler to your advantage&lt;/strong&gt;. For sure,
the compiler does not optimize a lot your code – but it sill produce realistic
programs if we think about performance. For many cases, &lt;strong&gt;you don't need&lt;/strong&gt; to
optimize your OCaml code. And the good point is about expected behavior.
&lt;br/&gt;&lt;br/&gt;
The mind-link between the OCaml and the assembly exists (much more than the C
and the assembly sometimes where we let the C compiler to optimize the code).
The cool fact is to keep a mental-model about what is going on on your code
easily without to be afraid by what the compiler can produce. And, in some
critical parts like &lt;a href=&quot;https://github.com/mirage/eqaf&quot;&gt;eqaf&lt;/a&gt;, it's really needed.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;We have not discussed benchmarking, which is another hard issue: who should you
compare with? where? how? For example, a global comparison between &lt;code&gt;zlib&lt;/code&gt; and
&lt;code&gt;decompress&lt;/code&gt; is not very relevant in many ways – especially because of the
garbage collector. This could be another article!&lt;/p&gt;
&lt;p&gt;Finally, all of these optimizations should be done by &lt;code&gt;flambda&lt;/code&gt;; the difference
between compiling &lt;code&gt;decompress&lt;/code&gt; with or without &lt;code&gt;flambda&lt;/code&gt; is not very big. We
optimized &lt;code&gt;decompress&lt;/code&gt; by hand mostly to keep compatibility with OCaml (since
&lt;code&gt;flambda&lt;/code&gt; needs another switch) and, in this way, to gain an understanding of
&lt;code&gt;flambda&lt;/code&gt; optimizations so that we can use it effectively!&lt;/p&gt;</content><id>https://tarides.com/blog/2019-09-13-decompress-experiences-with-ocaml-optimization.html</id><title type="text">Decompress: Experiences with OCaml optimization</title><updated>2019-09-13T00:00:00-00:00</updated><author><name>Romain Calascibetta</name></author></entry><entry><summary xml:base="http://math.andrej.com/feed/" type="html">Joel Hamkins advertised the following theorem on Twitter: Theorem: All complete ordered fields are isomorphic. The standard proof posted by Joel has two parts: A complete ordered field is archimedean. Using the fact that the rationals are dense in an archimedean field, we construct an isomorphism between any two complete ordered fields. The second step is constructive, but the first one is proved using excluded middle, as follows. Suppose $F$ is a complete ordered field. If $b \in F$ is an upper bound for the natural numbers, construed as a subset of $F$, then so $b - 1$, but then no element of $F$ can be the least upper bound of $\mathbb{N}$. By excluded middle, above every $x \in F$ there is $n \in \mathbb{N}$. So I asked myself and the constructive news mailing list what the constructive status of the theorem is. But something was amiss, as Fred Richman immediately asked me to provide an example of a complete ordered field. Why would he do that, don't we have the MacNeille reals? After agreeing on definitions, Toby Bartels gave the answer, which I am taking the liberty to adapt a bit and present here. I am probably just reinventing the wheel, so if someone knows an original reference, please provide it in the comments. The theorem holds constructively, but for a bizarre reason: if there exists a complete ordered field, then the law of excluded middle holds, and the standard proof is valid!</summary><source><updated>2020-03-15T17:46:54-00:00</updated><subtitle type="text">A blog about mathematics for computers</subtitle><link type="text/html" href="http://math.andrej.com/" rel="alternate"/><link type="application/atom+xml" href="http://math.andrej.com/feed.xml" rel="self"/><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><id>http://math.andrej.com/feed.xml</id><title xml:base="http://math.andrej.com/feed/" type="html">Mathematics and Computation</title><author><name>Andrej Bauer</name></author></source><published>2019-09-08T22:00:00-00:00</published><link title="On complete ordered fields" type="text/html" href="http://math.andrej.com/2019/09/09/on-complete-ordered-fields/" rel="alternate"/><content xml:base="http://math.andrej.com/feed/" type="html">&lt;p&gt;&lt;a href=&quot;http://jdh.hamkins.org&quot;&gt;Joel Hamkins&lt;/a&gt; advertised the following theorem on Twitter:&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Theorem:&lt;/strong&gt; &lt;em&gt;All &lt;a href=&quot;https://en.wikipedia.org/wiki/Least-upper-bound_property&quot;&gt;complete&lt;/a&gt; &lt;a href=&quot;https://en.wikipedia.org/wiki/Ordered_field&quot;&gt;ordered&lt;/a&gt; fields are isomorphic.&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;a href=&quot;https://twitter.com/JDHamkins/status/1169935061480804352?s=20&quot;&gt;The standard proof&lt;/a&gt; posted by Joel has two parts:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;A complete ordered field is archimedean.&lt;/li&gt;
  &lt;li&gt;Using the fact that the rationals are dense in an archimedean field, we construct an isomorphism between any two complete ordered fields.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;The second step is constructive, but the first one is proved using excluded middle, as follows. Suppose $F$ is a complete ordered field. If $b \in F$ is an upper bound for the natural numbers, construed as a subset of $F$, then so $b - 1$, but then no element of $F$ can be the least upper bound of $\mathbb{N}$. By excluded middle, above every $x \in F$ there is $n \in \mathbb{N}$.&lt;/p&gt;

&lt;p&gt;So I asked myself and the &lt;a href=&quot;https://groups.google.com/forum/#!topic/constructivenews/4jncQ9axrxI&quot;&gt;constructive news mailing list&lt;/a&gt; what the constructive status of the theorem is. But something was amiss, as &lt;a href=&quot;http://math.fau.edu/richman/&quot;&gt;Fred Richman&lt;/a&gt; immediately asked me to provide an example of a complete ordered field. Why would he do that, don't we have the &lt;a href=&quot;https://ncatlab.org/nlab/show/MacNeille+real+number&quot;&gt;MacNeille reals&lt;/a&gt;? After agreeing on definitions, &lt;a href=&quot;http://tobybartels.name&quot;&gt;Toby Bartels&lt;/a&gt; gave the answer, which I am taking the liberty to adapt a bit and present here. I am probably just reinventing the wheel, so if someone knows an original reference, please provide it in the comments.&lt;/p&gt;

&lt;p&gt;The theorem holds constructively, but for a bizarre reason: if there exists a complete ordered field, then the law of excluded middle holds, and the standard proof is valid!&lt;/p&gt;

&lt;!--more--&gt;

&lt;p&gt;As there are many constructive versions of order and completeness, let me spell out the definitions that are well adapted to the oddities of constructive mathematics. In classical logic these are all equivalent to the usual ones. Having to disentangle definitions when passing to constructive mathematics is a bit like learning how to be careful when passing from commutative to non-commutative algebra.&lt;/p&gt;

&lt;p&gt;A &lt;strong&gt;partial order&lt;/strong&gt; $\leq$ on a set $P$ is a reflexive, transitive and antisymmetric relation on $P$.&lt;/p&gt;

&lt;p&gt;We are interested in &lt;strong&gt;linearly&lt;/strong&gt; ordered fields, but constructively we need to take care, as the usual linearity, $x \leq y \lor y \leq x$, is quite difficult to satisfy, and may fail for reals.&lt;/p&gt;

&lt;p&gt;A &lt;strong&gt;strict order&lt;/strong&gt; on a set $P$ is a relation $&amp;lt;$ which is:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;irreflexive: $\lnot (x &amp;lt; x)$,&lt;/li&gt;
  &lt;li&gt;tight: $\lnot (x &amp;lt; y \lor y &amp;lt; x) \Rightarrow x = y$,&lt;/li&gt;
  &lt;li&gt;weakly linear: $x &amp;lt; y \Rightarrow x &amp;lt; z \lor z &amp;lt; y$&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;The &lt;strong&gt;associated&lt;/strong&gt; partial order is defined by $x \leq y \Leftrightarrow \lnot (y &amp;lt; x)$. The reflexivity, antisymmetry and transitivity of $\leq$ follow respectively from irreflexivity, tightness, and weak linearity of $&amp;lt;$.&lt;/p&gt;

&lt;p&gt;Next, an element $x \in P$ is an &lt;strong&gt;upper bound&lt;/strong&gt; for $S \subseteq P$ when $y \leq x$ for all $y \in P$. An element $x \in P$ is the &lt;em&gt;supremum&lt;/em&gt; of $S \subseteq P$ if it is an upper bound for $S$, and for every $y &amp;lt; x$ there exists $z \in S$ such that $y &amp;lt; z$. A poset $P$ is &lt;strong&gt;(Dedekind-MacNeille) complete&lt;/strong&gt; when every inhabited bounded subset has a supremum (for the classically trained, $S \subseteq P$ is &lt;em&gt;inhabited&lt;/em&gt; when there exists $x \in S$, and this is &lt;em&gt;not&lt;/em&gt; the same as $S \neq \emptyset$).&lt;/p&gt;

&lt;p&gt;A basic exercise is to give a non-trivial complete order, i.e., a strict order $&amp;lt;$ whose associated partial order $\leq$ is complete.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Theorem:&lt;/strong&gt; &lt;em&gt;If there exists a non-trivial complete order then excluded middle holds.&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;em&gt;Proof.&lt;/em&gt; Suppose $&amp;lt;$ is a strict order on a set $P$ whose associated order $\leq$ is complete, and there exist $a, b \in P$ such that $a &amp;lt; b$. Let $\phi$ be any proposition. Consider the set $S = \lbrace x \in P \mid x = a \lor (\phi \land x = b)\rbrace$. Observe that $\phi$ is equivalent to $b \in S$. Because $a \in S \subseteq \lbrace a, b\rbrace$, the set $S$ is inhabited and bounded, so let $s$ be its supremum. We know that $a &amp;lt; s$ or $s &amp;lt; b$, from which we can decide $\phi$:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;If $a &amp;lt; s$ then $b \in S$: indeed, there exists $c \in S$ such that $a &amp;lt; c$, but then $c = b$. In this case $\phi$ holds.&lt;/li&gt;
  &lt;li&gt;If $s &amp;lt; b$ then $\lnot(b \in S)$: if we had $b \in S$ then $S = \lbrace a, b \rbrace$ and $b = s &amp;lt; b$, which is impossible. In this case $\lnot\phi$. $\Box$&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;This immediately gives us the desired theorem.&lt;/p&gt;

&lt;blockquote&gt;
  &lt;p&gt;&lt;strong&gt;Theorem (constructive):&lt;/strong&gt; &lt;em&gt;All complete ordered fields are isomorphic.&lt;/em&gt;&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;&lt;em&gt;Proof.&lt;/em&gt; The definition of a complete ordered field requires $0 &amp;lt; 1$, therefore excluded middle holds. Now proceed with the usual classical proof. $\Box$&lt;/p&gt;

&lt;p&gt;This is very odd, as I always thought that the MacNeille reals form a MacNeille complete ordered field. Recall that a &lt;a href=&quot;https://ncatlab.org/nlab/show/MacNeille+real+number&quot;&gt;MacNeille real&lt;/a&gt; is a pair $(L, U)$ of subsets of $\mathbb{Q}$ such that:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;$U$ is the set of upper bounds of $L$: $u \in U$ if, and only if, $\ell \leq u$ for all $\ell \in L$,&lt;/li&gt;
  &lt;li&gt;$L$ is the set of lower bounds of $U$: $\ell \in L$ if, and only if, $\ell \leq u$ for all $u \in U$,&lt;/li&gt;
  &lt;li&gt;$L$ and $U$ are inhabited.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;Furthermore, the MacNeille reals are complete, as they are just the &lt;a href=&quot;https://ncatlab.org/nlab/show/MacNeille+completion&quot;&gt;MacNeille completion&lt;/a&gt; of the rationals. We may define a strict order on them by
stipulating that, for $x = (L_x, U_x)$ and $y = (L_y, U_y)$,
$$x &amp;lt; y \iff \exists q \in U_x . \exists r \in L_y \,.\, q &amp;lt; r.$$
According to Peter Johnstone (Sketches of an Elephant, D4.7), the MacNeille reals form a commutative unital ring in which $x$ is invertible if, and only if, $x &amp;lt; 0 \lor x &amp;gt; 0$. So apparently, the weak linearity of the strict order is problematic.&lt;/p&gt;

&lt;p&gt;What if we relax completeness? Two standard notions of completeness are:&lt;/p&gt;

&lt;ol&gt;
  &lt;li&gt;An ordered field $F$ is &lt;strong&gt;Cauchy-complete&lt;/strong&gt; if every Cauchy sequence has a limit in $F$.&lt;/li&gt;
  &lt;li&gt;An ordered field $F$ is &lt;strong&gt;Dedekind-complete&lt;/strong&gt; if every Dedekind cut determines an element of $F$.&lt;/li&gt;
&lt;/ol&gt;

&lt;p&gt;It is easy enough to find non-isomorphic Cauchy-complete fields. Order the field $\mathbb{Q}(x)$ of rational functions with rational coefficients by stipulating that it extends the order of $\mathbb{Q}$ and that $q &amp;lt; x$ for all $q \in \mathbb{Q}$. The Cauchy-completion of $\mathbb{Q}(x)$ is a Cauchy complete field which is not isomorphic to $\mathbb{Q}$. Caveat: I am speaking off the top of my head, do not trust this paragraph! (Or any other for that matter.)&lt;/p&gt;

&lt;p&gt;Regarding Dedekind completeness, it is important constructively that we take
&lt;em&gt;two-sided&lt;/em&gt; Dedekind cuts, i.e., pairs $(L, U)$ of subsets of $F$ such that&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;$L$ is lower-rounded: $q \in L \iff \exists r \in L . q &amp;lt; r$,&lt;/li&gt;
  &lt;li&gt;$U$ is upper-rounded: $r \in U \iff \exists q \in U . q &amp;lt; r$,&lt;/li&gt;
  &lt;li&gt;the cut is bounded: $L$ and $U$ are inhabited,&lt;/li&gt;
  &lt;li&gt;the cut is disjoint: $L \cap U = \emptyset$,&lt;/li&gt;
  &lt;li&gt;the cut is located: if $q &amp;lt; r$ then $L \in q$ or $r \in U$.&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Dedekind completeness states that for every Dedekind cut $(L, U)$ in $F$ there exists a unique $x \in F$ such that $L = \lbrace y \in F \mid y &amp;lt; x\rbrace$ and $U = \lbrace y \in F \mid x &amp;lt; y\rbrace$. Constructively this is a weaker form of completeness than the Dedekind-MacNeille one, but classically they coincide. Thus we cannot hope to exhibit constructively two non-isomorphic Dedekind-complete ordered fields (because constructive results are also classically valid). But perhaps there is a model of constructive mathematics where such strange fields exist. Does anyone know of one?&lt;/p&gt;</content><id>http://math.andrej.com/2019/09/09/on-complete-ordered-fields</id><title xml:base="http://math.andrej.com/feed/" type="html">On complete ordered fields</title><updated>2019-09-08T22:00:00-00:00</updated><author><name>Andrej Bauer</name></author></entry><entry><source><updated>2019-12-11T00:00:00-00:00</updated><link title="Tarides RSS Feed" type="text/html" href="https://tarides.com" rel="related"/><link title="Tarides RSS Feed" type="application/rss+xml" href="https://tarides.com/feed.xml" rel="self"/><generator>GatsbyJS</generator><id>https://tarides.com</id><title type="text">Tarides RSS Feed</title><author><name>Tarides</name></author></source><link href="https://tarides.com/blog/2019-09-04-an-introduction-to-fuzzing-ocaml-with-afl-crowbar-and-bun" rel="alternate"/><content xml:base="https://tarides.com/feed.xml" type="html">&lt;p&gt;&lt;a href=&quot;http://lcamtuf.coredump.cx/afl/&quot;&gt;American Fuzzy Lop&lt;/a&gt; or AFL is a &lt;em&gt;fuzzer&lt;/em&gt;: a program that tries to find bugs in
other programs by sending them various auto-generated inputs. This article covers the
basics of AFL and shows an example of fuzzing a parser written in OCaml. It also introduces two
extensions: the &lt;a href=&quot;https://github.com/stedolan/crowbar/&quot;&gt;Crowbar&lt;/a&gt; library which can be used to fuzz any kind of OCaml program or
function and the &lt;a href=&quot;https://github.com/yomimono/ocaml-bun/&quot;&gt;Bun&lt;/a&gt; tool for integrating fuzzing into your CI.&lt;/p&gt;
&lt;p&gt;All of the examples given in this article are available on GitHub at
&lt;a href=&quot;https://github.com/NathanReb/ocaml-afl-examples&quot;&gt;ocaml-afl-examples&lt;/a&gt;. The &lt;code&gt;README&lt;/code&gt; contains all the information you need to understand,
build and fuzz them yourself.&lt;/p&gt;
&lt;h2 id=&quot;what-is-afl&quot;&gt;&lt;a href=&quot;#what-is-afl&quot; aria-label=&quot;what is afl permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;What is AFL?&lt;/h2&gt;
&lt;p&gt;AFL actually isn't &lt;em&gt;just&lt;/em&gt; a fuzzer but a set of tools. What makes it so good is that it doesn't just
blindly send random input to your program hoping for it to crash; it inspects the execution paths
of the program and uses that information to figure out which mutations to apply to the previous
inputs to trigger new execution paths. This approach allows for much more efficient and reliable
fuzzing (as it will try to maximize coverage) but requires the binaries to be instrumented so the
execution can be monitored.&lt;/p&gt;
&lt;p&gt;AFL provides wrappers for the common C compilers that you can use to produce the instrumented
binaries along with the CLI fuzzing client: &lt;code&gt;afl-fuzz&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;afl-fuzz&lt;/code&gt; is straight-forward to use. It takes an input directory containing a few initial valid
inputs to your program, an output directory and the instrumented binary. It will then repeatedly
mutate the inputs and feed them to the program, registering the ones that lead to crashes or
hangs in the output directory.&lt;/p&gt;
&lt;p&gt;Because it works in such a way, it makes it very easy to fuzz a parser.&lt;/p&gt;
&lt;p&gt;To fuzz a &lt;code&gt;parse.exe&lt;/code&gt; binary, that takes a file as its first command-line argument and parses it,
you can invoke &lt;code&gt;afl-fuzz&lt;/code&gt; in the following way:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ afl-fuzz -i inputs/ -o findings/ /path/to/parse.exe @@&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;code&gt;findings/&lt;/code&gt; directory is where &lt;code&gt;afl-fuzz&lt;/code&gt; will write the crashes it finds, it will create it
for you if it doesn't exist.
The &lt;code&gt;inputs/&lt;/code&gt; directory contains one or more valid input files for your
program. By valid we mean &quot;that don't crash your program&quot;.
Finally the &lt;code&gt;@@&lt;/code&gt; part tells &lt;code&gt;afl-fuzz&lt;/code&gt; where on the command line the input file should be passed to
your program, in our case, as the first argument.&lt;/p&gt;
&lt;p&gt;Note that it is possible to supply &lt;code&gt;afl-fuzz&lt;/code&gt; with more detail about how to invoke your program. If
you need to pass it command-line options for instance, you can run it as:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ afl-fuzz -i inputs/ -o findings/ -- /path/to/parse.exe --option=value @@&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If you wish to fuzz a program that takes its input from standard input, you can also do that by removing the
&lt;code&gt;@@&lt;/code&gt; from the &lt;code&gt;afl-fuzz&lt;/code&gt; invocation.&lt;/p&gt;
&lt;p&gt;Once &lt;code&gt;afl-fuzz&lt;/code&gt; starts, it will draw a fancy looking table on the standard output to keep you
updated about its progress. From there, you'll mostly be interested in is the top right
corner which contains the number of crashes and hangs it has found so far:&lt;/p&gt;
&lt;p&gt;&lt;span
      class=&quot;gatsby-resp-image-wrapper&quot;
      style=&quot;position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 680px;&quot;
    &gt;
      &lt;a
    class=&quot;gatsby-resp-image-link&quot;
    href=&quot;/static/893fd2c3d0dfbb1c576fd016b6963e96/ec5f3/afl_example_output.png&quot;
    style=&quot;display: block&quot;
    target=&quot;_blank&quot;
    rel=&quot;noopener&quot;
  &gt;
    &lt;span
    class=&quot;gatsby-resp-image-background-image&quot;
    style=&quot;padding-bottom: 63.66083445491252%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAANCAYAAACpUE5eAAAACXBIWXMAAA7EAAAOxAGVKw4bAAACKUlEQVQ4y2VS2babMBCzwcFsZl8MSbgh5LY9/f//UzW+pSdtH+YYG1nSyKOUUvi3nFPwXqFtFfr+a1VtC9XlUNyH0v/fCxUlCVRRQOU5dFUhSizy7IKiNMjzC8sgywwSYkxmEWcxojTmHZITH+4WJVQcw7CUTVOUdY1+GDAvK4lKPJ8HhmHCPC9YeOb9grHvscxzcJHpGN+7Dp/cv1h74eBTGoojIS/RTRN6/hi8D4Tb/Y5xHEm2oGkaFMFdBitutEZmDL65Aj+aGj/7DodN4NmpFoe5c6hIVpOsvl5RcD/QjRD2XDUdRQSm/HY8ayiW09EYU9CO2OyKLmW+kcblcoFydFCuKyq6cSwhFDJPgYyuNB2ljEUEHXEd15wRVO3IWGZiF9RVjegkrJjfRKKRLguGfDyfIa+JpK28LB0mbGcikWcHg+Aoeh0HPOcJgzwOMVppxNJyRYcdQaO44/f18UDJwOXV9O9REGVxLVGI84LOF2J37h98TEUy6cQwW5XwZ0HChu1YEo37jv7jI4gIgeRYyThFUXAQy0oBy/OaOEsB4Yj02TLBd5J5vnTJWXyxZfne6XTjheM4OOjur+EV4pmOVzHCqZApOM85zzkm/pipVPLn6/XCSoFt20KG8jBB+Y1QMr0yTxkrEZMYTGRCF0r6lv6lNVG63W4BEDIL+XyRCEbqJJTOBC+rnzkBk4NJmKGwSgn4ff2TGevcv2NPIRmp1KZQJUWNxi/nyymBFR80ewAAAABJRU5ErkJggg=='); background-size: cover; display: block;&quot;
  &gt;&lt;/span&gt;
  &lt;img
        class=&quot;gatsby-resp-image-image&quot;
        alt=&quot;Example output from afl-fuzz&quot;
        title=&quot;Example output from afl-fuzz&quot;
        src=&quot;/static/893fd2c3d0dfbb1c576fd016b6963e96/5e3e6/afl_example_output.png&quot;
        srcset=&quot;/static/893fd2c3d0dfbb1c576fd016b6963e96/924ad/afl_example_output.png 170w,
/static/893fd2c3d0dfbb1c576fd016b6963e96/6103d/afl_example_output.png 340w,
/static/893fd2c3d0dfbb1c576fd016b6963e96/5e3e6/afl_example_output.png 680w,
/static/893fd2c3d0dfbb1c576fd016b6963e96/ec5f3/afl_example_output.png 743w&quot;
        sizes=&quot;(max-width: 680px) 100vw, 680px&quot;
        loading=&quot;lazy&quot;
      /&gt;
  &lt;/a&gt;
    &lt;/span&gt;&lt;/p&gt;
&lt;p&gt;You might need to change some of your CPU settings to achieve better performance while fuzzing.
&lt;code&gt;afl-fuzz&lt;/code&gt;'s output will tell you if that's the case and guide you through the steps required to
make that happen.&lt;/p&gt;
&lt;h2 id=&quot;using-afl-to-fuzz-an-ocaml-parser&quot;&gt;&lt;a href=&quot;#using-afl-to-fuzz-an-ocaml-parser&quot; aria-label=&quot;using afl to fuzz an ocaml parser permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Using AFL to fuzz an OCaml parser&lt;/h2&gt;
&lt;p&gt;First of all, if you want to fuzz an OCaml program with AFL you'll need to produce an instrumented
binary. &lt;code&gt;afl-fuzz&lt;/code&gt; has an option to work with regular binaries but you'd lose a lot of what makes it
efficient. To instrument your binary you can simply install a &lt;code&gt;+afl&lt;/code&gt; opam switch and build your
executable from there. AFL compiler variants are available from OCaml &lt;code&gt;4.05.0&lt;/code&gt; onwards. To install such
a switch you can run:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ opam switch create fuzzing-switch 4.07.1+afl&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If your program already parses the standard input or a file given to it via the command line, you
can simply build the executable from your &lt;code&gt;+afl&lt;/code&gt; switch and adapt the above examples. If it doesn't,
it's still easy to fuzz any parsing function.&lt;/p&gt;
&lt;p&gt;Imagine we have a &lt;code&gt;simple-parser&lt;/code&gt; library which exposes the following &lt;code&gt;parse_int&lt;/code&gt; function:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; parse&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;int&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; string &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;int&lt;span class=&quot;token punctuation&quot;&gt;,&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token operator&quot;&gt;&gt;&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Msg&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; string&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; result
&lt;span class=&quot;token comment&quot;&gt;(** Parse the given string as an int or return [Error (`Msg _)].
    Does not raise, usually... *)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We want to use AFL to make sure our function is robust and won't crash when receiving unexpected
inputs. As you can see the function returns a result and isn't supposed to raise exceptions. We want
to make sure that's true.&lt;/p&gt;
&lt;p&gt;To find crashes, AFL traps the signals sent by your program. That means that it will consider
uncaught OCaml exceptions as crashes. That's good because it makes it really simple to write a
&lt;code&gt;fuzz_me.ml&lt;/code&gt; executable that fits what &lt;code&gt;afl-fuzz&lt;/code&gt; expects:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; file &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Sys&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;argv&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; ic &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; open&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;in file &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; length &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; in&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;channel&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;length ic &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; content &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; really&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;input&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;string ic length &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  close&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;in ic&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt;
  ignore &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Simple&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;parser&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;parse&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;int content&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We have to provide example inputs to AFL so we can write a &lt;code&gt;valid&lt;/code&gt; file to the &lt;code&gt;inputs/&lt;/code&gt; directory
containing &lt;code&gt;123&lt;/code&gt; and an &lt;code&gt;invalid&lt;/code&gt; file containing &lt;code&gt;not an int&lt;/code&gt;. Both should parse without crashing
and make good starting point for AFL as they should trigger different execution paths.&lt;/p&gt;
&lt;p&gt;Because we want to make sure AFL does find crashes we can try to hide a bug in our function:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; parse&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;int s &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;init &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;String&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;length s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;String&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;get s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;'a'&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;'b'&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token string&quot;&gt;'c'&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; failwith &lt;span class=&quot;token string&quot;&gt;&quot;secret crash&quot;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;
      &lt;span class=&quot;token keyword&quot;&gt;match&lt;/span&gt; int&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;of&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;string&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;opt s &lt;span class=&quot;token keyword&quot;&gt;with&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; None &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Error &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token type variable&quot;&gt;`Msg&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Printf&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sprintf &lt;span class=&quot;token string&quot;&gt;&quot;Not an int: %S&quot;&lt;/span&gt; s&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;
      &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; Some i &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; Ok i&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we just have to build our native binary from the right switch and let &lt;code&gt;afl-fuzz&lt;/code&gt; do the rest:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ afl-fuzz -i inputs/ -o findings/ ./fuzz_me.exe @@&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It should find that the &lt;code&gt;abc&lt;/code&gt; input leads to a crash rather quickly. Once it does, you'll see it in
the top right corner of its output as shown in the picture from the previous section.&lt;/p&gt;
&lt;p&gt;At this point you can interrupt &lt;code&gt;afl-fuzz&lt;/code&gt; and have a look at the content of the &lt;code&gt;findings/crashes&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;$ ls findings/crashes/
id:000000,sig:06,src:000111,op:havoc,rep:16  README.txt&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you can see it contains a &lt;code&gt;README.txt&lt;/code&gt; which will give you some details about the &lt;code&gt;afl-fuzz&lt;/code&gt;
invocation used to find the crashes and how to reproduce them in the folder and a file of the form
&lt;code&gt;id:...,sig:...,src:...,op:...,rep:...&lt;/code&gt; per crash it found. Here there's just one:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;$ cat findings/crashes/id:000000,sig:06,src:000111,op:havoc,rep:16
abc&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As expected it contains our special input that triggers our secret crash. We can rerun the program
with that input ourselves to make sure it does trigger it:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;$ ./fuzz_me.exe findings/crashes/id:000000,sig:06,src:000111,op:havoc,rep:16
Fatal error: exception Failure(&amp;quot;secret crash&amp;quot;)&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;No surprise here, it does trigger our uncaught exception and crashes shamefully.&lt;/p&gt;
&lt;h2 id=&quot;using-crowbar-and-afl-for-property-based-testing&quot;&gt;&lt;a href=&quot;#using-crowbar-and-afl-for-property-based-testing&quot; aria-label=&quot;using crowbar and afl for property based testing permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Using Crowbar and AFL for property-based testing&lt;/h2&gt;
&lt;p&gt;This works well but only being able to fuzz parsers is quite a limitation. That's where &lt;a href=&quot;https://github.com/stedolan/crowbar/&quot;&gt;Crowbar&lt;/a&gt;
comes into play.&lt;/p&gt;
&lt;p&gt;Crowbar is a property-based testing framework. It's much like Haskell's &lt;a href=&quot;http://hackage.haskell.org/package/QuickCheck&quot;&gt;QuickCheck&lt;/a&gt;.
To test a given function, you define how its arguments are shaped, a set of properties the result
should satisfy and it will make sure they hold with any combinations of randomly generated
arguments.
Let's clarify that with an example.&lt;/p&gt;
&lt;p&gt;I wrote a library called &lt;code&gt;Awesome_list&lt;/code&gt; and I want to test its &lt;code&gt;sort&lt;/code&gt; function:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; sort&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; int list &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; int list
&lt;span class=&quot;token comment&quot;&gt;(** Sorts the given list of integers. Result list is sorted in increasing
    order, most of the time... *)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I want to make sure it really works so I'm going to use Crowbar to generate a whole lot of
lists of integers and verify that when I sort them with &lt;code&gt;Awesome_list.sort&lt;/code&gt; the result is, well...
sorted.&lt;/p&gt;
&lt;p&gt;We'll write our tests in a &lt;code&gt;fuzz_me.ml&lt;/code&gt; file.
First we need to tell Crowbar how to generate arguments for our function. It exposes some
combinators to help you do that:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; int&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;list &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; Crowbar&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;list &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;range &lt;span class=&quot;token number&quot;&gt;10&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here we're telling Crowbar to generate lists of any size, containing integers ranging from 0
to 10. Crowbar also exposes more complex and custom generator combinators so don't worry,
you can use it to build more complex arguments.&lt;/p&gt;
&lt;p&gt;Now we need to define our property. Once again it's pretty simple, we just want the output to be
sorted:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; is&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;sorted l &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;rec&lt;/span&gt; is&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;sorted &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token boolean&quot;&gt;true&lt;/span&gt;
    &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; hd&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;hd'&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;as&lt;/span&gt; tl&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; hd &lt;span class=&quot;token operator&quot;&gt;&amp;lt;=&lt;/span&gt; hd' &lt;span class=&quot;token operator&quot;&gt;&amp;amp;&amp;amp;&lt;/span&gt; is&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;sorted tl
  &lt;span class=&quot;token keyword&quot;&gt;in&lt;/span&gt;
  Crowbar&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;check &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;is&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;sorted l&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;All that's left to do now is to register our test:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt;
  Crowbar&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;add&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;test &lt;span class=&quot;token operator&quot;&gt;~&lt;/span&gt;name&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;&lt;span class=&quot;token string&quot;&gt;&quot;Awesome_list.sort&quot;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;int&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;list&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
      &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;fun&lt;/span&gt; l &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; is&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;sorted &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;Awesome&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;list&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sort l&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and to compile that &lt;code&gt;fuzz_me.ml&lt;/code&gt; file to a binary. Crowbar will take care of the magic.&lt;/p&gt;
&lt;p&gt;We can run that binary in &quot;Quickcheck&quot; mode where it will either try a certain amount of random
inputs or keep trying until one of the properties breaks depending on the command-line options
we pass it.
What we're interested in here is its less common &quot;AFL&quot; mode. Crowbar made it so our executable
can be used with &lt;code&gt;afl-fuzz&lt;/code&gt; just like that:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;$ afl-fuzz -i inputs -o findings -- ./fuzz_me.exe @@&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;What will happen then is that our &lt;code&gt;fuzz_me.exe&lt;/code&gt; binary will read the inputs provided by &lt;code&gt;afl-fuzz&lt;/code&gt;
and use it to determine which test to run and how to generate the arguments to pass to our function.
If the properties are satisfied, the binary will exit normally; if they aren't, it will make sure
that &lt;code&gt;afl-fuzz&lt;/code&gt; interprets that as a crash by raising an exception.&lt;/p&gt;
&lt;p&gt;A nice side-effect of Crowbar's approach is that &lt;code&gt;afl-fuzz&lt;/code&gt; will still be able to pick up
crashes. For instance, if we implement &lt;code&gt;Awesome_list.sort&lt;/code&gt; as:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; sort &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;function&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;2&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;3&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; failwith &lt;span class=&quot;token string&quot;&gt;&quot;secret crash&quot;&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt;&lt;span class=&quot;token number&quot;&gt;6&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;5&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;;&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;4&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
  &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; l &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; List&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;sort Pervasives&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;compare l&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;and use AFL and Crowbar to fuzz-test our function, it will find two crashes: one for the input
&lt;code&gt;[1; 2; 3]&lt;/code&gt; which triggers a crash and one for &lt;code&gt;[4; 5; 6]&lt;/code&gt; for which the &lt;code&gt;is_sorted&lt;/code&gt;
property won't hold.&lt;/p&gt;
&lt;p&gt;The content of the input files found by &lt;code&gt;afl-fuzz&lt;/code&gt; itself won't be of much help as it needs to be
interpreted by Crowbar to build the arguments that were passed to the function to trigger the bug.
We can invoke the &lt;code&gt;fuzz_me.exe&lt;/code&gt; binary ourselves on one of the files in &lt;code&gt;findings/crashes&lt;/code&gt;
and the Crowbar binary will replay the test and give us some more helpful information about what
exactly is going on:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;sh&quot;&gt;&lt;pre class=&quot;language-sh&quot;&gt;&lt;code class=&quot;language-sh&quot;&gt;$ ./fuzz_me.exe findings/crashes/id\:000000\,sig\:06\,src\:000011\,op\:flip1\,pos\:5 
Awesome_list.sort: ....
Awesome_list.sort: FAIL

When given the input:

    [1; 2; 3]
    
the test threw an exception:

    Failure(&amp;quot;secret crash&amp;quot;)
    Raised at file &amp;quot;stdlib.ml&amp;quot;, line 33, characters 17-33
    Called from file &amp;quot;awesome-list/fuzz/fuzz_me.ml&amp;quot;, line 11, characters 78-99
    Called from file &amp;quot;src/crowbar.ml&amp;quot;, line 264, characters 16-19
    
Fatal error: exception Crowbar.TestFailure
$ ./fuzz_me.exe findings/crashes/id\:000001\,sig\:06\,src\:000027\,op\:arith16\,pos\:5\,val\:+7 
Awesome_list.sort: ....
Awesome_list.sort: FAIL

When given the input:

    [4; 5; 6]
    
the test failed:

    check false
    
Fatal error: exception Crowbar.TestFailure&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can see the actual inputs as well as distinguish the one that broke the invariant from the one
that triggered a crash.&lt;/p&gt;
&lt;h2 id=&quot;using-bun-to-run-fuzz-testing-in-ci&quot;&gt;&lt;a href=&quot;#using-bun-to-run-fuzz-testing-in-ci&quot; aria-label=&quot;using bun to run fuzz testing in ci permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Using &lt;code&gt;bun&lt;/code&gt; to run fuzz testing in CI&lt;/h2&gt;
&lt;p&gt;While AFL and Crowbar provide no guarantees they can give you confidence that your implementation
is not broken. Now that you know how to use them, a natural follow-up is to want to run fuzz tests
in your CI to enforce that level of confidence.&lt;/p&gt;
&lt;p&gt;Problem is, AFL isn't very CI friendly. First it has this refreshing output that isn't going to look
great on your travis builds output and it doesn't tell you much besides that it could or couldn't find
crashes or invariant infrigements&lt;/p&gt;
&lt;p&gt;Hopefully, like most problems, this one has a solution:
&lt;a href=&quot;https://github.com/yomimono/ocaml-bun/&quot;&gt;&lt;code&gt;bun&lt;/code&gt;&lt;/a&gt;.
&lt;code&gt;bun&lt;/code&gt; is a CLI wrapper around &lt;code&gt;afl-fuzz&lt;/code&gt;, written in OCaml, that helps you get the best out of AFL
effortlessly. It mostly does two things:&lt;/p&gt;
&lt;p&gt;The first is that it will run several &lt;code&gt;afl-fuzz&lt;/code&gt; processes in parallel
(one per core by default). &lt;code&gt;afl-fuzz&lt;/code&gt; starts with a bunch of deterministic steps. In my experience,
using parallel processes during this phase rarely proved very useful as they tend to find the same
bugs or slight variations of those bugs. It only achieves its full potential in the second phase of
fuzzing.&lt;/p&gt;
&lt;p&gt;The second thing, which is the one we're the most interested in, is that &lt;code&gt;bun&lt;/code&gt; provides a useful
and CI-friendly summary of what's going on with all the fuzzing processes so far. When one of them
finds a crash, it will stop all processes and pretty-print all of the bug-triggering inputs to help
you reproduce and debug them locally. See an example &lt;code&gt;bun&lt;/code&gt; output after a crash was found:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;Crashes found! Take a look; copy/paste to save for reproduction:
1432	echo JXJpaWl0IA== | base64 -d &amp;gt; crash_0.$(date -u +%s)
1433	echo NXJhkV8QAA== | base64 -d &amp;gt; crash_1.$(date -u +%s)
1434	echo J3Jh//9qdGFiYmkg | base64 -d &amp;gt; crash_2.$(date -u +%s)
1435	09:35.32:[ERROR]All fuzzers finished, but some crashes were found!&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Using &lt;code&gt;bun&lt;/code&gt; is very similar to using &lt;code&gt;afl-fuzz&lt;/code&gt;. Going back to our first parser example, we can
fuzz it with &lt;code&gt;bun&lt;/code&gt; like this:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;$ bun --input inputs/ --output findings/ /path/to/parse.exe&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;You'll note that you don't need to provide the &lt;code&gt;@@&lt;/code&gt; anymore. &lt;code&gt;bun&lt;/code&gt; assumes that it should pass the
input as the first argument of your to-be-fuzzed binary.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;bun&lt;/code&gt; also comes with an alternative &lt;code&gt;no-kill&lt;/code&gt; mode which lets all the fuzzers run indefinitely
instead of terminating them whenever a crash is discovered. It will regularly keep you updated on
the number of crashes discovered so far and when terminated will pretty-print each of them just like
it does in regular mode.&lt;/p&gt;
&lt;p&gt;This mode can be convenient if you suspect your implementation may contain a lot of bugs and
you don't want to go through the whole process of fuzz testing it to only find a single bug.&lt;/p&gt;
&lt;p&gt;You can use it in CI by running &lt;code&gt;bun --no-kill&lt;/code&gt; via &lt;code&gt;timeout&lt;/code&gt;. For instance:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;timeout --preserve-status 60m bun --no-kill --input inputs --output findings ./fuzz_me.exe&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;will fuzz &lt;code&gt;fuzz_me.exe&lt;/code&gt; for an hour no matter what happens. When &lt;code&gt;timeout&lt;/code&gt; terminates &lt;code&gt;bun&lt;/code&gt;, it will
provide you with a handful of bugs to fix!&lt;/p&gt;
&lt;h2 id=&quot;final-words&quot;&gt;&lt;a href=&quot;#final-words&quot; aria-label=&quot;final words permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Final words&lt;/h2&gt;
&lt;p&gt;I really want to encourage you to use those tools and fuzzing in general.
Crowbar and &lt;code&gt;bun&lt;/code&gt; are fairly new so you will probably encounter bugs or find that it lacks a feature
you want but combined with AFL they make for very nice tools to effectively test
critical components of your OCaml code base or infrastructure and detect newly-introduced bugs.
They are already used accross the MirageOS ecosystem where it has been used to fuzz the TCP/IP stack
&lt;a href=&quot;https://github.com/mirage/mirage-tcpip&quot;&gt;mirage-tcpip&lt;/a&gt; and the DHCP implementation &lt;a href=&quot;https://github.com/mirage/charrua&quot;&gt;charrua&lt;/a&gt; thanks to
&lt;a href=&quot;https://github.com/yomimono/somerandompacket&quot;&gt;somerandompacket&lt;/a&gt;.
You can consult Crowbar's &lt;a href=&quot;https://github.com/stedolan/crowbar/issues/2&quot;&gt;hall of fame&lt;/a&gt; to find out about bugs uncovered by this
approach.&lt;/p&gt;
&lt;p&gt;I also encourage anyone interested to join us in using this promising toolchain, report those bugs,
contribute those extra features and help the community build more robust software.&lt;/p&gt;
&lt;p&gt;Finally if you wish to learn more about how to efficienly use fuzzing for testing I recommend the
excellent &lt;a href=&quot;https://blog.regehr.org/archives/1687&quot;&gt;Write Fuzzable Code&lt;/a&gt; article by John Regehr.&lt;/p&gt;</content><id>https://tarides.com/blog/2019-09-04-an-introduction-to-fuzzing-ocaml-with-afl-crowbar-and-bun.html</id><title type="text">An introduction to fuzzing OCaml with AFL, Crowbar and Bun</title><updated>2019-09-04T00:00:00-00:00</updated><author><name>Nathan Rebours</name></author></entry><entry><summary xml:base="http://math.andrej.com/feed/" type="html">Published as arXiv:1807.05923. Abstract: This note recapitulates and expands the contents of a tutorial on the mathematical theory of algebraic effects and handlers which I gave at the Dagstuhl seminar 18172 &quot;Algebraic effect handlers go mainstream&quot;. It is targeted roughly at the level of a doctoral student with some amount of mathematical training, or at anyone already familiar with algebraic effects and handlers as programming concepts who would like to know what they have to do with algebra. We draw an uninterrupted line of thought between algebra and computational effects. We begin on the mathematical side of things, by reviewing the classic notions of universal algebra: signatures, algebraic theories, and their models. We then generalize and adapt the theory so that it applies to computational effects. In the last step we replace traditional mathematical notation with one that is closer to programming languages.</summary><source><updated>2020-03-15T17:46:54-00:00</updated><subtitle type="text">A blog about mathematics for computers</subtitle><link type="text/html" href="http://math.andrej.com/" rel="alternate"/><link type="application/atom+xml" href="http://math.andrej.com/feed.xml" rel="self"/><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><id>http://math.andrej.com/feed.xml</id><title xml:base="http://math.andrej.com/feed/" type="html">Mathematics and Computation</title><author><name>Andrej Bauer</name></author></source><published>2019-09-02T22:00:00-00:00</published><link title="What is algebraic about algebraic effects?" type="text/html" href="http://math.andrej.com/2019/09/03/what-is-algebraic-about-algebraic-effects/" rel="alternate"/><content xml:base="http://math.andrej.com/feed/" type="html">&lt;p&gt;Published as &lt;a href=&quot;https://arxiv.org/abs/1807.05923&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;arXiv:1807.05923&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Abstract:&lt;/strong&gt; This note recapitulates and expands the contents of a tutorial on the mathematical theory of algebraic effects and handlers which I gave at the Dagstuhl seminar 18172 &lt;a href=&quot;https://www.dagstuhl.de/en/program/calendar/semhp/?semnr=18172&quot;&gt;&quot;Algebraic effect handlers go mainstream&quot;&lt;/a&gt;. It is targeted roughly at the level of a doctoral student with some amount of mathematical training, or at anyone already familiar with algebraic effects and handlers as programming concepts who would like to know what they have to do with algebra. We draw an uninterrupted line of thought between algebra and computational effects. We begin on the mathematical side of things, by reviewing the classic notions of universal algebra: signatures, algebraic theories, and their models. We then generalize and adapt the theory so that it applies to computational effects. In the last step we replace traditional mathematical notation with one that is closer to programming languages.&lt;/p&gt;</content><id>http://math.andrej.com/2019/09/03/what-is-algebraic-about-algebraic-effects</id><title xml:base="http://math.andrej.com/feed/" type="html">What is algebraic about algebraic effects?</title><updated>2019-09-02T22:00:00-00:00</updated><author><name>Andrej Bauer</name></author></entry><entry><summary xml:base="http://math.andrej.com/feed/" type="html">You may have noticed that lately I have had trouble with the blog. It was dying periodically because the backend database kept crashing. It was high time I moved away from Wordpress anyway, so I bit the bullet and ported the blog.</summary><source><updated>2020-03-15T17:46:54-00:00</updated><subtitle type="text">A blog about mathematics for computers</subtitle><link type="text/html" href="http://math.andrej.com/" rel="alternate"/><link type="application/atom+xml" href="http://math.andrej.com/feed.xml" rel="self"/><generator uri="https://jekyllrb.com/" version="4.0.0">Jekyll</generator><id>http://math.andrej.com/feed.xml</id><title xml:base="http://math.andrej.com/feed/" type="html">Mathematics and Computation</title><author><name>Andrej Bauer</name></author></source><published>2019-09-02T22:00:00-00:00</published><link title="The blog moved from Wordpress to Jekyll" type="text/html" href="http://math.andrej.com/2019/09/03/the-blog-moved-from-wordpress-to-jekyll/" rel="alternate"/><content xml:base="http://math.andrej.com/feed/" type="html">&lt;p&gt;You may have noticed that lately I have had trouble with the blog. It was dying
periodically because the backend database kept crashing. It was high time I
moved away from Wordpress anyway, so I bit the bullet and ported the blog.&lt;/p&gt;

&lt;!--more--&gt;

&lt;p&gt;All in all, it was a typical system administration experience: lots of
installing Ruby and Node.js packages, figuring out which of several equivalent
tools actually is worth using, dealing with scarce and obsolete documentation (a
blog post is &lt;em&gt;not&lt;/em&gt; a good substitute for proper documentation), etc. But all the
tools are out there, it's just a simple matter of installing them:&lt;/p&gt;

&lt;ul&gt;
  &lt;li&gt;&lt;a href=&quot;https://wordpress.org/plugins/jekyll-exporter/&quot;&gt;Jekyll Exporter&lt;/a&gt; - an exporter from Wordpress to Jekyll&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://jekyllrb.com&quot;&gt;Jekyll&lt;/a&gt; - static pages blog, free of databases, with support for Markdown&lt;/li&gt;
  &lt;li&gt;&lt;a href=&quot;https://staticman.net&quot;&gt;Staticman&lt;/a&gt; - a backend for blog comments&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;I decided to make the blog repository
&lt;a href=&quot;https://github.com/andrejbauer/mathematics-and-computation&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;mathematics-and-computation&lt;/code&gt;&lt;/a&gt;
public, as there is no good reason to keep it private. In fact, this way people
can contribute by making pull requests (see the
&lt;a href=&quot;https://github.com/andrejbauer/mathematics-and-computation/blob/master/README.md&quot;&gt;&lt;code class=&quot;highlighter-rouge&quot;&gt;README.md&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;

&lt;p&gt;I will use this post to test the working on the new blog, and especially the
comments, so please excuse silly comments below.&lt;/p&gt;</content><id>http://math.andrej.com/2019/09/03/the-blog-moved-from-wordpress-to-jekyll</id><title xml:base="http://math.andrej.com/feed/" type="html">The blog moved from Wordpress to Jekyll</title><updated>2019-09-02T22:00:00-00:00</updated><author><name>Andrej Bauer</name></author></entry><entry><source><updated>2020-03-23T08:47:03-00:00</updated><logo>http://www.ocamlpro.com/wp-content/uploads/2018/02/apple-touch-icon-152x152-150x150.png</logo><link title="OCamlPro" type="text/html" href="http://www.ocamlpro.com" rel="related"/><link title="OCamlPro" type="application/rss+xml" href="http://www.ocamlpro.com/feed/" rel="self"/><generator>https://wordpress.org/?v=4.9.13</generator><id>http://www.ocamlpro.com</id><title type="text">OCamlPro</title><author><name>OCamlPro</name></author></source><link href="http://www.ocamlpro.com/2019/08/30/ocamlpros-compiler-team-work-update/" rel="alternate"/><link href="http://www.ocamlpro.com/2019/08/30/ocamlpros-compiler-team-work-update/#comments" rel="related"/><content xml:base="http://www.ocamlpro.com/feed/" type="html">&lt;p&gt;The OCaml compiler team at OCamlPro is happy to present some of the work recently done jointly with JaneStreet&amp;#8217;s team.&lt;/p&gt;
&lt;p&gt;A lot of work has been done towards a new framework for optimizations in the compiler, called Flambda2, aiming at solving the shortcomings that became apparent in the Flambda optimization framework (see below for more details). While that work is in progress, the team also worked on some more short-term improvements, notably on the current Flambda optimization framework, as well as some compiler modifications that will benefit Flambda2.&lt;/p&gt;
&lt;blockquote&gt;&lt;p&gt;&lt;em&gt;This work is funded by JaneStreet &lt;img src=&quot;https://s.w.org/images/core/emoji/11/72x72/1f642.png&quot; alt=&quot;🙂&quot; class=&quot;wp-smiley&quot; style=&quot;height: 1em; max-height: 1em;&quot; /&gt;&lt;br /&gt;
&lt;/em&gt;&lt;/p&gt;&lt;/blockquote&gt;
&lt;h2&gt;Short-term improvements&lt;/h2&gt;
&lt;h3&gt;Recursive values compilation&lt;/h3&gt;
&lt;p&gt;OCaml supports quite a large range of recursive definitions. In addition to recursive (and mutually-recursive) functions, one can also define regular values recursively, as for the infinite list &lt;code&gt;let rec l = 0 :: l&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;Not all recursive constructions are allowed, of course. For instance, the definition &lt;code&gt;let rec x = x&lt;/code&gt; is rejected because there is no way to actually build a value that would behave correctly.&lt;/p&gt;
&lt;p&gt;The basic rule for deciding whether a definition is allowed or not is made under the assumption that recursive values (except for functions, mostly) are compiled by first allocating space in the heap for the recursive values, binding the recursively defined variables to the allocated (but not yet initialized) values. The defining expressions are then evaluated, yielding new values (that can contain references the non-initialized values). Finally, the fields of these new values are copied one-by-one into the corresponding fields of the initial values.&lt;/p&gt;
&lt;p&gt;For this approach to work, some restrictions need to apply:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the compiler needs to be able to compute the size of the values beforehand (these values must be allocated values, in order to avoid defining an integer recursively),&lt;/li&gt;
&lt;li&gt;and since during the evaluation of the defining expressions their fields are not valid, one cannot write any code that may read these fields, like pattern-matching on the value, or passing the value to some function (or storing it in a mutable field of some record).&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;All of those restrictions have recently been reworked and formalized based on work from Alban Reynaud during an internship at Inria, reviewed and completed by Gabriel Scherer and Jeremy Yallop.&lt;/p&gt;
&lt;p&gt;Unfortunately, this work only covers checking whether the recursive definitions are allowed or not; actual compilation is done later in the compiler, in one place for bytecode and another for native code, and these pieces of code have not been linked with the new check so there have been a few cases where the check allowed code that wasn&amp;#8217;t actually compiled correctly.&lt;/p&gt;
&lt;p&gt;Since we didn&amp;#8217;t want to deal with it directly in our new version of Flambda, we had started working on a patch to move the compilation of recursive values up in the compilation pipeline, before the split between bytecode and native code. After some amount of hacking (we discovered that compilation of classes creates recursive value bindings that would not pass the earlier recursive check&amp;#8230;), we have a patch that is mostly ready for review and will soon start engaging with the rest of the compiler team with the aim of integrating it into the compiler.&lt;/p&gt;
&lt;h3&gt;Separate compilation of recursive modules, compilation units as functors&lt;/h3&gt;
&lt;p&gt;Some OCaml developers like to encapsulate each type definition in its own module, with an interface that can expose the needed types and functions, while abstracting away as much of the actual implementation as possible. It is then common to have each of these modules in its own file, to simplify management and avoid unseemly big files.&lt;/p&gt;
&lt;p&gt;However, this breaks down when one needs to define several types that depend on each other. The usual solutions are either to use recursive modules, which have the drawback of requiring all the modules to be in the same compilation unit, leading to very big files (we have seen a real case of a more than 10,000-lines file), or make each module parametric in the other modules, translating them into functors, and then instantiate all the functors when building the outwards-facing interface.&lt;/p&gt;
&lt;p&gt;To address these issues, we have been working on two main patches to improve the life of developers facing these problems.&lt;/p&gt;
&lt;p&gt;The first one allows compiling several different files as mutually recursive modules, reusing the approach used to compile regular recursive modules. In practice, this will allow developers using recursive modules extensively to properly separate not only the different modules from each other, but also the implementation and interfaces into a &lt;code&gt;.ml&lt;/code&gt; and &lt;code&gt;.mli&lt;/code&gt; files. This would of course need some additional support from the different build tools, but we&amp;#8217;re confident we can get at least &lt;code&gt;dune&lt;/code&gt; to support the feature.&lt;/p&gt;
&lt;p&gt;The second one allows compiling a single compilation unit as a functor instead of a regular module. The arguments of the functor would be specified on the command line, their signature taken from their corresponding interface file. This can be useful not only to break recursive dependencies, like the previous patch (though in a different way), but also to help developers relying on multiple implementations of a same &lt;code&gt;.mli&lt;/code&gt; interface functorize their code with minimal effort.&lt;/p&gt;
&lt;p&gt;These two improvements will also benefit packs, whereas recursive compilation units could be packed in a single module and packs could be functorized themselves.&lt;/p&gt;
&lt;h3&gt;Small improvements to Flambda&lt;/h3&gt;
&lt;p&gt;We are still committed to maintain the Flambda part of the compiler. Few bugs have been found, so we concentrate our efforts on small features that either yield overall performance gains or allow naive code patterns to be compiled as efficiently as their equivalent but hand-optimized versions.&lt;/p&gt;
&lt;p&gt;As an example, one optimization that we should be able to submit soon looks for cases where an immutable block is allocated but an immutable block with the same exact fields and tag already exists.&lt;/p&gt;
&lt;p&gt;This can be demonstrated with the following example:&lt;/p&gt;
&lt;pre class=&quot;code highlight&quot; lang=&quot;ocaml&quot;&gt;&lt;span id=&quot;LC1&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result_bind&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;function&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;LC2&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;  &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Ok&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;f&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;LC3&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;  &lt;span class=&quot;o&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Error&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Error&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;e&lt;/span&gt;&lt;/span&gt;
&lt;/pre&gt;
&lt;p&gt;The usual way to avoid the extra allocation of &lt;code&gt;Error e&lt;/code&gt; is to write the clause as &lt;code&gt;| (Error e) as r -&amp;gt; r&lt;/code&gt;. With this new patch, the redundant allocation will be detected and removed automatically! This can be even more interesting with inlining:&lt;/p&gt;
&lt;pre class=&quot;code highlight&quot; lang=&quot;ocaml&quot;&gt;&lt;span id=&quot;LC1&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;my_f&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;LC2&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;  &lt;span class=&quot;k&quot;&gt;if&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;(* some condition *)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;LC3&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;  &lt;span class=&quot;k&quot;&gt;then&lt;/span&gt; &lt;span class=&quot;nc&quot;&gt;Ok&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;x&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;LC4&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;  &lt;span class=&quot;k&quot;&gt;else&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;(* something else *)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;LC5&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;&lt;/span&gt;
&lt;span id=&quot;LC6&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;&lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;_&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;LC7&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;  &lt;span class=&quot;c&quot;&gt;(* ... *)&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;LC8&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;  &lt;span class=&quot;k&quot;&gt;let&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;r&lt;/span&gt; &lt;span class=&quot;o&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;result_bind&lt;/span&gt; &lt;span class=&quot;n&quot;&gt;my_f&lt;/span&gt; &lt;span class=&quot;c&quot;&gt;(* some argument *)&lt;/span&gt; &lt;span class=&quot;k&quot;&gt;in&lt;/span&gt;&lt;/span&gt;
&lt;span id=&quot;LC9&quot; class=&quot;line&quot; lang=&quot;ocaml&quot;&gt;  &lt;span class=&quot;c&quot;&gt;(* ... *)&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;
&lt;p&gt;In this example, inlining &lt;code&gt;result_bind&lt;/code&gt; then &lt;code&gt;my_f&lt;/code&gt; can match the allocation &lt;code&gt;Ok x&lt;/code&gt; in &lt;code&gt;my_f&lt;/code&gt; with the pattern matching in &lt;code&gt;result_bind&lt;/code&gt;. This removes an allocation that would be very hard to remove otherwise. We expect these patterns to occur quite often with some programming styles relying on a great deal of abstraction and small independent functions.&lt;/p&gt;
&lt;h2&gt;Flambda 2.0&lt;/h2&gt;
&lt;p&gt;We are building on the work done for Flambda and the experience of its users to develop Flambda 2.0, the next optimization framework.&lt;/p&gt;
&lt;p&gt;Our goal is to build a framework for analyzing the costs and benefits of code transformations. The framework focuses on reducing the runtime cost of abstractions and removing as many short-lived allocations as possible.&lt;/p&gt;
&lt;p&gt;The aim of Flambda 2.0 is roughly the same as the original Flambda. So why did we decide to write a new framework instead of patching the existing one? Several points led us to this decision.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;An invariant on the representation of closures that ensured that every closure had a unique identifier, which was convenient for a number of reasons, turned out to be quite expensive to maintain and prevented some optimizations.&lt;/li&gt;
&lt;li&gt;The internal representation of Flambda terms included too many different cases that were either redundant or not relevant to the optimizations we were interested in, making a lot of code more complicated than necessary.&lt;/li&gt;
&lt;li&gt;The ANF-like representation we used was not perfect. We wanted an easier way to do control flow optimizations, which led us to choose a CPS-like representation for Flambda 2.0.&lt;/li&gt;
&lt;li&gt;Finally, the original Flambda was thought of as an alternative to the closure conversion and inlining algorithms performed by the &lt;code&gt;Closure&lt;/code&gt; module of the compiler, translating from the &lt;code&gt;Lambda&lt;/code&gt; representation to &lt;code&gt;Clambda&lt;/code&gt;. However, a number of optimizations (most importantly unboxing) are done during the next phase of compilation, &lt;code&gt;Cmmgen&lt;/code&gt;, which translates to the &lt;code&gt;Cmm&lt;/code&gt; representation. The original Flambda had trouble to estimate correctly which optimizations would trigger and what would their benefit be. It may be noted that correctly estimating benefit is a key in Flambda&amp;#8217;s algorithms, and we know of a number of cases where Flambda is not as good as it could be because it couldn&amp;#8217;t predict the unboxing opportunities that inlining would have allowed. Flambda 2.0 will go from &lt;code&gt;Lambda&lt;/code&gt; to &lt;code&gt;Cmm&lt;/code&gt;, and will handle all transformations done in both &lt;code&gt;Closure&lt;/code&gt; and &lt;code&gt;Cmmgen&lt;/code&gt; in a single framework.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;These improvements are still very much a work in progress. We have not reached the point where other developers can try out the new framework on their codebases yet.&lt;/p&gt;
&lt;p&gt;This does not mean there are no news to enjoy before our efforts show on the mainstream compiler! While working on Flambda 2.0, we did deploy a number of patches on the compiler both before and after the Flambda stage. We proposed all the changes independant enough to be proposed on their own. Some of these fixes have been merged already. Others are still under discussion and some, like the recursive values patch mentioned above, are still waiting for cleanup or documentation before submission.&lt;/p&gt;
</content><category term="flambda2"/><id>http://www.ocamlpro.com/?p=1975</id><title type="text">OCamlPro’s compiler team work update</title><updated>2019-08-30T00:00:29-00:00</updated><author><name>OCamlPro</name></author></entry><entry><source><updated>2020-02-20T00:00:00-00:00</updated><link title="Jane Street Tech Blog" type="text/html" href="https://blog.janestreet.com" rel="related"/><link title="Jane Street Tech Blog" type="application/rss+xml" href="https://blog.janestreet.com/feed.xml" rel="self"/><id>https://blog.janestreet.com</id><title type="text">Jane Street Tech Blog</title><author><name>Jane Street</name></author></source><link href="https://blog.janestreet.com/what-the-interns-have-wrought-2019/" rel="alternate"/><content xml:base="https://blog.janestreet.com/feed.xml" type="html">&lt;p&gt;Jane Street’s intern program yet again is coming to an end, which is a
nice opportunity to look back over the summer and see what they’ve
accomplished.&lt;/p&gt;

</content><id>https://blog.janestreet.com/what-the-interns-have-wrought-2019/</id><title type="text">What the interns have wrought, 2019 edition</title><updated>2019-08-30T00:00:00-00:00</updated><author><name>Jane Street</name></author></entry><entry><source><updated>2019-12-11T00:00:00-00:00</updated><link title="Tarides RSS Feed" type="text/html" href="https://tarides.com" rel="related"/><link title="Tarides RSS Feed" type="application/rss+xml" href="https://tarides.com/feed.xml" rel="self"/><generator>GatsbyJS</generator><id>https://tarides.com</id><title type="text">Tarides RSS Feed</title><author><name>Tarides</name></author></source><link href="https://tarides.com/blog/2019-08-26-decompress-the-new-decompress-api" rel="alternate"/><content xml:base="https://tarides.com/feed.xml" type="html">&lt;p&gt;&lt;a href=&quot;https://tools.ietf.org/html/rfc1951&quot;&gt;RFC 1951&lt;/a&gt; is one of the most used standards. Indeed,
when you launch your Linux kernel, it inflates itself according &lt;a href=&quot;https://zlib.net/&quot;&gt;zlib&lt;/a&gt;
standard, a superset of RFC 1951. Being a widely-used standard, we decided to
produce an OCaml implementation. In the process, we learned many lessons about
developing OCaml where we would normally use C. So, we are glad to present
&lt;a href=&quot;https://github.com/mirage/decompress&quot;&gt;&lt;code&gt;decompress&lt;/code&gt;&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;One of the many users of RFC 1951 is &lt;a href=&quot;https://git-scm.com/&quot;&gt;Git&lt;/a&gt;, which uses it to pack data
objects into a &lt;a href=&quot;https://git-scm.com/book/en/v2/Git-Internals-Packfiles&quot;&gt;PACK file&lt;/a&gt;. At the request of &lt;a href=&quot;https://github.com/samoht&quot;&gt;@samoht&lt;/a&gt;,
&lt;code&gt;decompress&lt;/code&gt; appeared some years ago as a Mirage-compatible replacement for zlib
to be used for compiling a &lt;a href=&quot;https://mirage.io/&quot;&gt;MirageOS&lt;/a&gt; unikernel with
&lt;a href=&quot;https://github.com/mirage/ocaml-git/&quot;&gt;ocaml-git&lt;/a&gt;. Today, this little project passes a major release with
substantial improvements in several domains.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;decompress&lt;/code&gt; provides an API for inflating and deflating &lt;em&gt;flows&lt;/em&gt;&lt;code&gt;[1]&lt;/code&gt;. The main
goal is to provide a &lt;em&gt;platform-agnostic&lt;/em&gt; library: one which may be compiled on
any platform, including JavaScript. We surely cannot be faster than C
implementations like &lt;a href=&quot;https://github.com/facebook/zstd&quot;&gt;zstd&lt;/a&gt; or &lt;a href=&quot;https://github.com/lz4/lz4&quot;&gt;lz4&lt;/a&gt;, but we can play some
optimisation tricks to help bridge the gap. Additionally, OCaml can protect the
user against lot of bugs via the type-system &lt;em&gt;and&lt;/em&gt; the runtime too (e.g. using
array bounds checking). &lt;a href=&quot;https://github.com/mirleft/ocaml-tls&quot;&gt;&lt;code&gt;ocaml-tls&lt;/code&gt;&lt;/a&gt; was implemented partly in
response to the famous &lt;a href=&quot;https://en.wikipedia.org/wiki/Heartbleed&quot;&gt;failure&lt;/a&gt; of &lt;code&gt;openssl&lt;/code&gt;; a vulnerability
which could not exist in OCaml.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;[1]&lt;/code&gt;: A &lt;em&gt;flow&lt;/em&gt;, in MirageOS land, is an abstraction which wants to receive
and/or transmit something under a standard. So it's usual to say a &lt;em&gt;TLS-flow&lt;/em&gt;
for example.&lt;/p&gt;
&lt;h2 id=&quot;api-design&quot;&gt;&lt;a href=&quot;#api-design&quot; aria-label=&quot;api design permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;API design&lt;/h2&gt;
&lt;p&gt;The API should be the most difficult part of designing a library - it reveals
what we can do and how we should do it. In this way, an API should:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;strong&gt;constrain the user to avoid security issues&lt;/strong&gt;; too much freedom can be a bad
thing. As an example, consider the &lt;code&gt;Hashtbl.create&lt;/code&gt; function, which allows the
user to pass &lt;code&gt;~random:false&lt;/code&gt; to select a fixed hash function. The resulting
hashtable suffers deterministic key collisions, which can be exploited by an
attacker.
&lt;br/&gt;&lt;br/&gt;
An example of good security-awareness in API design can be seen in
&lt;a href=&quot;https://github.com/mirage/digestif&quot;&gt;digestif&lt;/a&gt;, which provided an &lt;code&gt;unsafe_compare&lt;/code&gt; instead of the common
&lt;code&gt;compare&lt;/code&gt; function (before &lt;code&gt;eqaf.0.5&lt;/code&gt;). In this way, it enforced the user to
create an alias of it if they want to use a hash in a &lt;code&gt;Map&lt;/code&gt; – however, by this
action, they should know that they are not protected against a timing-attack.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;allow some degrees of freedom to fit within many environments&lt;/strong&gt;; a
constrained API cannot support a hostile context. For example, when compiling
to an &lt;a href=&quot;https://mirage.io/blog/2018-esp32-booting&quot;&gt;ESP32&lt;/a&gt; target, even small details such as the length of a stream
input buffer must be user-definable. When deploying to a server, memory
consumption should be deterministic.
&lt;br/&gt;&lt;br/&gt;
Of course, this is made difficult when too much freedom will enable misuse of
the API – an example is &lt;a href=&quot;https://github.com/ocaml/dune&quot;&gt;dune&lt;/a&gt; which wants consciously to limit the user
about what they can do with it.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;imply an optimal design of how to use it&lt;/strong&gt;. Possibilities should serve the
user, but these can make the API harder to understand; this is why
documentation is important. Your API should tell your users how it wants to
be treated.&lt;/li&gt;
&lt;/ol&gt;
&lt;h3 id=&quot;a-dbuenzli-api&quot;&gt;&lt;a href=&quot;#a-dbuenzli-api&quot; aria-label=&quot;a dbuenzli api permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;A dbuenzli API&lt;/h3&gt;
&lt;p&gt;From our experiences with protocol/format, one design stands out: the
&lt;em&gt;&lt;a href=&quot;https://github.com/dbuenzli/&quot;&gt;dbuenzli&lt;/a&gt; API&lt;/em&gt;. If you look into some famous libraries in the OCaml
eco-system, you probably know &lt;a href=&quot;https://github.com/dbuenzli/uutf&quot;&gt;uutf&lt;/a&gt;, &lt;a href=&quot;https://github.com/dbuenzli/jsonm&quot;&gt;jsonm&lt;/a&gt; or &lt;a href=&quot;https://github.com/dbuenzli/xmlm&quot;&gt;xmlm&lt;/a&gt;. All
of these libraries provide the same API for computing a Unicode/JSON/XML flow –
of course, the details are not the same.&lt;/p&gt;
&lt;p&gt;From a MirageOS perspective, even if they use the &lt;code&gt;in_channel&lt;/code&gt;/&lt;code&gt;out_channel&lt;/code&gt;
abstraction rather than a &lt;a href=&quot;https://github.com/mirage/mirage-flow&quot;&gt;Mirage flow&lt;/a&gt;, these libraries
are system-agnostic since they let the user to choose input and output buffers.
Most importantly, they don't use the standard OCaml &lt;code&gt;Unix&lt;/code&gt; module, which cannot
be used in a unikernel.&lt;/p&gt;
&lt;p&gt;The APIs are pretty consistent and try to do their &lt;em&gt;best-effort&lt;/em&gt;&lt;code&gt;[2]&lt;/code&gt; of
decoding. The design has a type &lt;em&gt;state&lt;/em&gt; which represents the current system
status; the user passes this to &lt;code&gt;decode&lt;/code&gt;/&lt;code&gt;encode&lt;/code&gt; to carry out the processing.
Of course, these functions have a side-effect on the state internally, but
this is hidden from the user. One advantage of including states in a design is
that the underlying implementation is very amenable to compiler optimisations (e.g.
tail-call optimisation). Internally, of course, we have a &lt;em&gt;porcelain&lt;/em&gt;&lt;code&gt;[3]&lt;/code&gt;
implementation where any details can have an rational explanation.&lt;/p&gt;
&lt;p&gt;In the beginning, &lt;code&gt;decompress&lt;/code&gt; wanted to follow the same interface without the
mutability (a choice about performances) and it did. Then, the hard test was to
use it in a bigger project; in this case, &lt;a href=&quot;https://github.com/mirage/ocaml-git/&quot;&gt;ocaml-git&lt;/a&gt;. An iterative
process was used to determine what was really needed, what we should not provide
(like special cases) and what we should provide to reach an uniform API that is
not too difficult to understand.&lt;/p&gt;
&lt;p&gt;From this experience, we finalised the initial &lt;code&gt;decompress&lt;/code&gt; API and it did not
change significantly for 4 versions (2 years).&lt;/p&gt;
&lt;p&gt;&lt;code&gt;[2]&lt;/code&gt;: &lt;em&gt;best-effort&lt;/em&gt; means an user control on the error branch where we don't
leak exception (or more generally, any interrupts)&lt;/p&gt;
&lt;p&gt;&lt;code&gt;[3]&lt;/code&gt;: &lt;em&gt;porcelain&lt;/em&gt; means implicit invariants held in the mind of the programmer
(or the assertions/comments).&lt;/p&gt;
&lt;h2 id=&quot;the-new-decompress-api&quot;&gt;&lt;a href=&quot;#the-new-decompress-api&quot; aria-label=&quot;the new decompress api permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;The new &lt;code&gt;decompress&lt;/code&gt; API&lt;/h2&gt;
&lt;p&gt;The new &lt;code&gt;decompress&lt;/code&gt; keeps the same inflation logic, but drastically changes the
deflator to make the &lt;em&gt;flush&lt;/em&gt; operation clearer. For many purposes, people don't
want to hand-craft their compressed flows – they just want
&lt;code&gt;of_string&lt;/code&gt;/&lt;code&gt;to_string&lt;/code&gt; functions. However, in some contexts (like a PNG
encoder/decoder), the user should be able to play with &lt;code&gt;decompress&lt;/code&gt; in detail
(OpenPGP needs this too in &lt;a href=&quot;https://tools.ietf.org/html/rfc4880&quot;&gt;RFC 4880&lt;/a&gt;).&lt;/p&gt;
&lt;h3 id=&quot;the-zlib-format&quot;&gt;&lt;a href=&quot;#the-zlib-format&quot; aria-label=&quot;the zlib format permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;The Zlib format&lt;/h3&gt;
&lt;p&gt;Both &lt;code&gt;decompress&lt;/code&gt; and zlib use &lt;em&gt;&lt;a href=&quot;https://zlib.net/feldspar.html&quot;&gt;Huffman coding&lt;/a&gt;&lt;/em&gt;, an algorithm
for building a dictionary of variable-length codewords for a given set of
symbols (in this case, bytes). The most common byte is assigned the shortest bit
sequence; less common bytes are assigned longer codewords. Using this
dictionary, we just translate each byte into its codeword and we should achieve
a good compression ratio. Of course, there are other details, such as the fact
that all Huffman codes are &lt;a href=&quot;https://en.wikipedia.org/wiki/Prefix_code&quot;&gt;prefix-free&lt;/a&gt;. The compression can be
taken further with the &lt;a href=&quot;https://en.wikipedia.org/wiki/LZ77_and_LZ78&quot;&gt;LZ77&lt;/a&gt; algorithm.&lt;/p&gt;
&lt;p&gt;The &lt;em&gt;&lt;a href=&quot;https://zlib.net/&quot;&gt;zlib&lt;/a&gt;&lt;/em&gt; format, a superset of the &lt;a href=&quot;https://tools.ietf.org/html/rfc1951&quot;&gt;RFC 1951&lt;/a&gt; format, is easy
to understand. We will only consider the RFC 1951 format, since zlib adds only
minor details (such as checksums). It consists of several blocks: DEFLATE
blocks, each with a little header, and the contents. There are 3 kinds of
DEFLATE blocks:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;a FLAT block; no compression, just a &lt;em&gt;blit&lt;/em&gt; from inputs to the current block.&lt;/li&gt;
&lt;li&gt;a FIXED block; compressed using a pre-computed Huffman code.&lt;/li&gt;
&lt;li&gt;a DYNAMIC block; compressed using a user-specified Huffman code.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The FIXED block uses a Huffman dictionary that is computed when the OCaml runtime
is initialised. DYNAMIC blocks use dictionaries specified by the user, and so
these must be transmitted alongside the data (&lt;em&gt;after being compressed with
another Huffman code!&lt;/em&gt;). The inflator decompresses this DYNAMIC dictionary and uses
it to do the &lt;em&gt;reverse&lt;/em&gt; translation from bit sequences to bytes.&lt;/p&gt;
&lt;h3 id=&quot;inflator&quot;&gt;&lt;a href=&quot;#inflator&quot; aria-label=&quot;inflator permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Inflator&lt;/h3&gt;
&lt;p&gt;The design of the inflator did not change a lot from the last version of
&lt;code&gt;decompress&lt;/code&gt;. Indeed, it's about to take an input, compute it and return an
output like a flow. Of course, the error case can be reached.&lt;/p&gt;
&lt;p&gt;So the API is pretty-easy:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; decode &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; decoder &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Await&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Flush&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`End&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Malformed&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; string &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As you can see, we have 4 cases: one which expects more inputs (&lt;code&gt;Await&lt;/code&gt;), the
second which asks to the user to flush internal buffer (&lt;code&gt;Flush&lt;/code&gt;), the &lt;code&gt;End&lt;/code&gt; case
when we reach the end of the flow and the &lt;code&gt;Malformed&lt;/code&gt; case when we encounter an
error.&lt;/p&gt;
&lt;p&gt;For each case, the user can do several operations. Of course, about the &lt;code&gt;Await&lt;/code&gt;
case, they can refill the contents with an other inputs buffer with:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; src &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; decoder &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; bigstring &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; off&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;int &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;int &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; unit&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This function provides the decoder a new input with &lt;code&gt;len&lt;/code&gt; bytes to read
starting at &lt;code&gt;off&lt;/code&gt; in the given &lt;code&gt;bigstring&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;In the &lt;code&gt;Flush&lt;/code&gt; case, the user wants some information like how many bytes are
available in the current output buffer. Then, we should provide an action to
&lt;em&gt;flush&lt;/em&gt; this output buffer. In the end, this output buffer should be given by
the user (how many bytes they want to allocate to store outputs flow).&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; src &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Channel&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; in&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;channel &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Manual&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`String&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; string &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; dst&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;rem &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; decoder &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; int
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; flush &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; decoder &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; unit
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; decoder &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; src &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; o&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;bigstring &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; w&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;bigstring &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; decoder&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The last function, &lt;code&gt;decoder&lt;/code&gt;, is the most interesting. It lets the user, at the
beginning, choose the context in which they want to inflate inputs. So they
choose:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;src&lt;/code&gt;, where come from inputs flow&lt;/li&gt;
&lt;li&gt;&lt;code&gt;o&lt;/code&gt;, output buffer&lt;/li&gt;
&lt;li&gt;&lt;code&gt;w&lt;/code&gt;, window buffer&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;o&lt;/code&gt; will be used to store inflated outputs, &lt;code&gt;dst_rem&lt;/code&gt; will give to us how many
bytes inflator stored in &lt;code&gt;o&lt;/code&gt; and &lt;code&gt;flush&lt;/code&gt; will just set &lt;code&gt;decoder&lt;/code&gt; to be able to
recompute the flow.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;w&lt;/code&gt; is needed for &lt;a href=&quot;https://en.wikipedia.org/wiki/LZ77_and_LZ78&quot;&gt;lz77&lt;/a&gt; compression. However, as we said, we let
the user give us this intermediate buffer. The idea behind that is to let the
user prepare an &lt;em&gt;inflation&lt;/em&gt;. For example, in &lt;a href=&quot;https://github.com/mirage/ocaml-git/&quot;&gt;ocaml-git&lt;/a&gt;, instead of
allocating &lt;code&gt;w&lt;/code&gt; systematically when we want to decompress a Git object, we
allocate &lt;code&gt;w&lt;/code&gt; one time per threads and all are able to use it and &lt;strong&gt;re-use&lt;/strong&gt; it.
In this way, we avoid systematic allocations (and allocate only once time) which
can have a serious impact about performances.&lt;/p&gt;
&lt;p&gt;The design is pretty close to one idea, a &lt;em&gt;description&lt;/em&gt; step by the &lt;code&gt;decoder&lt;/code&gt;
function and a real computation loop with the &lt;code&gt;decode&lt;/code&gt; function. The idea is to
prepare the inflation with some information (like &lt;code&gt;w&lt;/code&gt; and &lt;code&gt;o&lt;/code&gt;) before the main
(and the most expensive) computation. Internally we do that too (but it's mostly
about a macro-optimization).&lt;/p&gt;
&lt;p&gt;It's the purpose of OCaml in general, be able to have a powerful way to describe
something (with constraints). In our case, we are very limited to what we need
to describe. But, in others libraries like &lt;a href=&quot;https://github.com/inhabitedtype/angstrom&quot;&gt;angstrom&lt;/a&gt;, the description
step is huge (describe the parser according to the BNF) and then, we use it to
the main computation, in the case of angstrom, the parsing (another
example is [cmdliner][cmdliner]).&lt;/p&gt;
&lt;p&gt;This is why &lt;code&gt;decoder&lt;/code&gt; can be considered as the main function where &lt;code&gt;decode&lt;/code&gt; can
be wrapped under a stream.&lt;/p&gt;
&lt;h3 id=&quot;deflator&quot;&gt;&lt;a href=&quot;#deflator&quot; aria-label=&quot;deflator permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Deflator&lt;/h3&gt;
&lt;p&gt;The deflator is a new (complex) deal. Indeed, behind it we have two concepts:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the encoder (according to RFC 1951)&lt;/li&gt;
&lt;li&gt;the compressor&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;For this new version of &lt;code&gt;decompress&lt;/code&gt;, we decide to separate these concepts where
one question leads all: how to put my compression algorithm? (instead to use
&lt;a href=&quot;https://en.wikipedia.org/wiki/LZ77_and_LZ78&quot;&gt;LZ77&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;In fact, if you are interested in compression, several algorithms exist and, in
some context, it's preferable to use &lt;a href=&quot;https://en.wikipedia.org/wiki/Lempel%E2%80%93Ziv%E2%80%93Markov_chain_algorithm&quot;&gt;lzwa&lt;/a&gt; for example or rabin's
fingerprint (with &lt;a href=&quot;https://github.com/mirage/duff&quot;&gt;duff&lt;/a&gt;), etc.&lt;/p&gt;
&lt;h4 id=&quot;functor&quot;&gt;&lt;a href=&quot;#functor&quot; aria-label=&quot;functor permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Functor&lt;/h4&gt;
&lt;p&gt;The first idea was to provide a &lt;em&gt;functor&lt;/em&gt; which expects an implementation of the
compression algorithm. However, the indirection of a functor comes with (big)
performance cost. Consider the following functor example:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; S &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;sig&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; t
  &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; add &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; t
  &lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; one &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; t
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;module&lt;/span&gt; Make &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;S &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; succ x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; S&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;add x S&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;one &lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;include&lt;/span&gt; Make &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;&lt;span class=&quot;token keyword&quot;&gt;struct&lt;/span&gt;
  &lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; t &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; int
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; add a b &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; a &lt;span class=&quot;token operator&quot;&gt;+&lt;/span&gt; b
  &lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; one &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token number&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;end&lt;/span&gt;&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;let&lt;/span&gt; f x &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; succ x&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Currently, with OCaml 4.07.1, the &lt;code&gt;f&lt;/code&gt; function will be a &lt;code&gt;caml_apply2&lt;/code&gt;. We might
wish for a simple &lt;a href=&quot;https://en.wikipedia.org/wiki/Inline_expansion&quot;&gt;&lt;em&gt;inlining&lt;/em&gt;&lt;/a&gt; optimisation, allowing &lt;code&gt;f&lt;/code&gt; to become an
&lt;code&gt;addq&lt;/code&gt; instruction (indeed, &lt;a href=&quot;https://caml.inria.fr/pub/docs/manual-ocaml/flambda.html&quot;&gt;&lt;code&gt;flambda&lt;/code&gt;&lt;/a&gt; does this), but optimizing
functors is hard. As we learned from &lt;a href=&quot;https://github.com/chambart&quot;&gt;Pierre Chambart&lt;/a&gt;, it is possible
for the OCaml compiler to optimize functors directly, but this requires
respecting several constraints that are difficult to respect in practice.&lt;/p&gt;
&lt;h4 id=&quot;split-encoder-and-compressor&quot;&gt;&lt;a href=&quot;#split-encoder-and-compressor&quot; aria-label=&quot;split encoder and compressor permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;Split encoder and compressor&lt;/h4&gt;
&lt;p&gt;So, the choice was done to made the encoder which respects RFC 1951 and the
compressor under some constraints. However, this is not what &lt;a href=&quot;https://zlib.net/&quot;&gt;zlib&lt;/a&gt; did
and, by this way, we decided to provide a new design/API which did not follow,
in first instance, zlib (or some others implementations like
&lt;a href=&quot;https://github.com/richgel999/miniz&quot;&gt;miniz&lt;/a&gt;).&lt;/p&gt;
&lt;p&gt;To be fair, the choice from zlib and miniz comes from the first
point about API and the context where they are used. The main problem is the
shared queue between the encoder and the compressor. In C code, it can be hard
for the user to deal with it (where they are liable for buffer overflows).&lt;/p&gt;
&lt;p&gt;In OCaml and for &lt;code&gt;decompress&lt;/code&gt;, the shared queue can be well-abstracted and API
can ensure assumptions (like bounds checking).&lt;/p&gt;
&lt;p&gt;Even if this design is much more complex than before, coverage tests are better
where we can separately test the encoder and the compressor. It breaks down the
initial black-box where compression was intrinsec with encoding – which was
error-prone. Indeed, &lt;code&gt;decompress&lt;/code&gt; had a bug about generation of
Huffman codes but we never reached it because the (bad)
compressor was not able to produce something (a specific lengh with a specific
distance) to get it.&lt;/p&gt;
&lt;p&gt;NOTE: you have just read the main reason for the new version of &lt;code&gt;decompress&lt;/code&gt;!&lt;/p&gt;
&lt;h4 id=&quot;the-compressor&quot;&gt;&lt;a href=&quot;#the-compressor&quot; aria-label=&quot;the compressor permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;The compressor&lt;/h4&gt;
&lt;p&gt;The compressor is the most easy part. The goal is to produce from an inputs
flow, an outputs flow which is an other (more compacted) representation. This
representation consists to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;A &lt;em&gt;literal&lt;/em&gt;, the byte as is&lt;/li&gt;
&lt;li&gt;A &lt;em&gt;copy&lt;/em&gt; code with an &lt;em&gt;offset&lt;/em&gt; and a &lt;em&gt;length&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The last one say to copy &lt;em&gt;length&lt;/em&gt; byte(s) from &lt;em&gt;offset&lt;/em&gt;. For example, &lt;code&gt;aaaa&lt;/code&gt; can
be compressed as &lt;code&gt;[ Literal 'a'; Copy (offset:1, len:3) ]&lt;/code&gt;. By this way, instead
to have 4 bytes, we have only 2 elements which will be compressed then by an
&lt;a href=&quot;https://zlib.net/feldspar.html&quot;&gt;Huffman coding&lt;/a&gt;. This is the main idea of the &lt;a href=&quot;https://en.wikipedia.org/wiki/LZ77_and_LZ78&quot;&gt;lz77&lt;/a&gt;
compression.&lt;/p&gt;
&lt;p&gt;However, the compressor should need to deal with the encoder. An easy interface,
&lt;em&gt;à la &lt;a href=&quot;https://github.com/dbuenzli/uutf&quot;&gt;uutf&lt;/a&gt;&lt;/em&gt; should be:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; compress &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; state &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Literal&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; char &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Copy&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;(&lt;/span&gt;int &lt;span class=&quot;token operator&quot;&gt;*&lt;/span&gt; int&lt;span class=&quot;token punctuation&quot;&gt;)&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`End&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Await&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;But as I said, we need to feed a queue instead.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;At this point, the purpose of the queue is not clear and not really explained.
The signature above still is a valid and understandable design. Then, we can
imagine passing &lt;code&gt;Literal&lt;/code&gt; and &lt;code&gt;Copy&lt;/code&gt; directly to the encoder. However, we should
(for performance purpose) use a delaying tactic between the compressor and the
deflator&lt;sup id=&quot;fnref-4&quot;&gt;&lt;a href=&quot;#fn-4&quot; class=&quot;footnote-ref&quot;&gt;4&lt;/a&gt;&lt;/sup&gt;.&lt;/p&gt;
&lt;p&gt;Behind this idea, it's to be able to implement an &lt;em&gt;hot-loop&lt;/em&gt; on the encoder
which will iter inside the shared queue and &lt;em&gt;transmit&lt;/em&gt;/&lt;em&gt;encode&lt;/em&gt; contents
directly to the outputs buffer.&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;So, when we make a new &lt;code&gt;state&lt;/code&gt;, we let the user supply their queue:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;text&quot;&gt;&lt;pre class=&quot;language-text&quot;&gt;&lt;code class=&quot;language-text&quot;&gt;val state : src -&amp;gt; w:bistring -&amp;gt; q:queue -&amp;gt; state
val compress : state -&amp;gt; [ `Flush | `Await | `End ]&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The &lt;code&gt;Flush&lt;/code&gt; case appears when the queue is full. Then, we refind the &lt;code&gt;w&lt;/code&gt; window
buffer which is needed to produce the &lt;code&gt;Copy&lt;/code&gt; code. A &lt;em&gt;copy code&lt;/em&gt; is limited
according RFC 1951 where &lt;em&gt;offset&lt;/em&gt; can not be upper than the length of the window
(commonly 32ko). &lt;em&gt;length&lt;/em&gt; is limited too to &lt;code&gt;258&lt;/code&gt; (an arbitrary choice).&lt;/p&gt;
&lt;p&gt;Of course, about the &lt;code&gt;Await&lt;/code&gt; case, the compressor comes with a &lt;code&gt;src&lt;/code&gt; function as
the inflator. Then, we added some accessors, &lt;code&gt;literals&lt;/code&gt; and &lt;code&gt;distances&lt;/code&gt;. The
compressor does not build the &lt;a href=&quot;https://zlib.net/feldspar.html&quot;&gt;Huffman coding&lt;/a&gt; which needs
frequencies, so we need firstly to keep counters about that inside the state and
a way to get them (and pass them to the encoder).&lt;/p&gt;
&lt;p&gt;&lt;code&gt;[4]&lt;/code&gt;: About that, you should be interesting by the reason of &lt;a href=&quot;https://www.reddit.com/r/unix/comments/6gxduc/how_is_gnu_yes_so_fast/&quot;&gt;why GNU yes is so
fast&lt;/a&gt; where the secret is just about buffering.&lt;/p&gt;
&lt;h4 id=&quot;the-encoder&quot;&gt;&lt;a href=&quot;#the-encoder&quot; aria-label=&quot;the encoder permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;The encoder&lt;/h4&gt;
&lt;p&gt;Finally, we can talk about the encoder which will take the shared queue filled
by the compressor and provide an RFC 1951 compliant output flow.&lt;/p&gt;
&lt;p&gt;However, we need to consider a special &lt;em&gt;detail&lt;/em&gt;. When we want to make a
DYNAMIC block from frequencies and then encode the inputs flow, we can reach a
case where the shared queue contains an &lt;em&gt;opcode&lt;/em&gt; (a &lt;em&gt;literal&lt;/em&gt; or a &lt;em&gt;copy&lt;/em&gt;) which
does not appear in our dictionary.&lt;/p&gt;
&lt;p&gt;In fact, if we want to encode &lt;code&gt;[ Literal 'a'; Literal 'b' ]&lt;/code&gt;, we will not try to
make a dictionary which will contains the 256 possibilities of a byte but we
will only make a dictionary from frequencies which contains only &lt;code&gt;'a'&lt;/code&gt; and
&lt;code&gt;'b'&lt;/code&gt;. By this way, we can reach a case where the queue contains an &lt;em&gt;opcode&lt;/em&gt;
(like &lt;code&gt;Literal 'c'&lt;/code&gt;) which can not be encoded by the &lt;em&gt;pre-determined&lt;/em&gt;
Huffman coding – remember, the DYNAMIC block &lt;strong&gt;starts&lt;/strong&gt; with
the dictionary.&lt;/p&gt;
&lt;p&gt;Another point is about inputs. The encoder expects, of course, contents from
the shared queue but it wants from the user the way to encode contents: which
block we want to emit. So it has two entries:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;the shared queue&lt;/li&gt;
&lt;li&gt;an &lt;em&gt;user-entry&lt;/em&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;So for many real tests, we decided to provide this kind of API:&lt;/p&gt;
&lt;div class=&quot;gatsby-highlight&quot; data-language=&quot;ocaml&quot;&gt;&lt;pre class=&quot;language-ocaml&quot;&gt;&lt;code class=&quot;language-ocaml&quot;&gt;&lt;span class=&quot;token keyword&quot;&gt;type&lt;/span&gt; dst &lt;span class=&quot;token operator&quot;&gt;=&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Channel&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; out&lt;span class=&quot;token punctuation&quot;&gt;_&lt;/span&gt;channel &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Buffer&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; Buffer&lt;span class=&quot;token punctuation&quot;&gt;.&lt;/span&gt;t &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Manual&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;

&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; encoder &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; dst &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; q&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;queue &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; encoder
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; encode &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; encoder &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Block&lt;/span&gt; &lt;span class=&quot;token keyword&quot;&gt;of&lt;/span&gt; block &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Flush&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Await&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;[&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Ok&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Partial&lt;/span&gt; &lt;span class=&quot;token operator&quot;&gt;|&lt;/span&gt; &lt;span class=&quot;token type variable&quot;&gt;`Block&lt;/span&gt; &lt;span class=&quot;token punctuation&quot;&gt;]&lt;/span&gt;
&lt;span class=&quot;token keyword&quot;&gt;val&lt;/span&gt; dst &lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt; encoder &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; bigstring &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; off&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;int &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; len&lt;span class=&quot;token punctuation&quot;&gt;:&lt;/span&gt;int &lt;span class=&quot;token operator&quot;&gt;-&gt;&lt;/span&gt; unit&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;As expected, we take the shared queue to make a new encoder. Then, we let the
user to specify which kind of block they want to encode by the &lt;code&gt;Block&lt;/code&gt;
operation.&lt;/p&gt;
&lt;p&gt;The &lt;code&gt;Flush&lt;/code&gt; operation tries to encode all elements present inside the shared
queue according to the current block and feed the outputs buffer. From it, the
encoder can returns some values:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Ok&lt;/code&gt; and the encoder encoded all &lt;em&gt;opcode&lt;/em&gt; from the shared queue&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Partial&lt;/code&gt;, the outputs buffer is not enough to encode all &lt;em&gt;opcode&lt;/em&gt;, the user
should flush it and give to us a new empty buffer with &lt;code&gt;dst&lt;/code&gt;. Then, they must
continue with the &lt;code&gt;Await&lt;/code&gt; operation.&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Block&lt;/code&gt;, the encoder reachs an &lt;em&gt;opcode&lt;/em&gt; which can not be encoded with the
current block (the current dictionary). Then, the user must continue with a new
&lt;code&gt;Block&lt;/code&gt; operation.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;The hard part is about the &lt;em&gt;ping-pong&lt;/em&gt; game between the user and the encoder
where a &lt;code&gt;Block&lt;/code&gt; expects a &lt;code&gt;Block&lt;/code&gt; response from the user and a &lt;code&gt;Partial&lt;/code&gt; expects
an &lt;code&gt;Await&lt;/code&gt; response. But this design reveals something higher about zlib
this time: the &lt;em&gt;flush&lt;/em&gt; mode.&lt;/p&gt;
&lt;h4 id=&quot;the-flush-mode&quot;&gt;&lt;a href=&quot;#the-flush-mode&quot; aria-label=&quot;the flush mode permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;The &lt;em&gt;flush&lt;/em&gt; mode&lt;/h4&gt;
&lt;p&gt;Firstly, we talk about &lt;em&gt;mode&lt;/em&gt; because zlib does not allow the user to
decide what they want to do when we reach a &lt;code&gt;Block&lt;/code&gt; or a &lt;code&gt;Ok&lt;/code&gt; case. So, it
defines some &lt;a href=&quot;https://www.bolet.org/~pornin/deflate-flush.html&quot;&gt;under-specified &lt;em&gt;modes&lt;/em&gt;&lt;/a&gt; to apply a policy of what
to do in this case.&lt;/p&gt;
&lt;p&gt;In &lt;code&gt;decompress&lt;/code&gt;, we followed the same design and see that it may be not a good
idea where the logic is not very clear and the user wants may be an another
behavior. It was like a &lt;em&gt;black-box&lt;/em&gt; with a &lt;em&gt;black-magic&lt;/em&gt;.&lt;/p&gt;
&lt;p&gt;Because we decided to split encoder and compressor, the idea of the &lt;em&gt;flush mode&lt;/em&gt;
does not exists anymore where the user explicitly needs to give to the encoder
what they want (make a new block? which block? keep frequencies?). So we broke
the &lt;em&gt;black-box&lt;/em&gt;. But, as we said, it was possible mostly because we can abstract
safely the shared queue between the compressor and the encoder.&lt;/p&gt;
&lt;p&gt;OCaml is an expressive language and we can really talk about a queue where, in
C, it will be just an other &lt;em&gt;array&lt;/em&gt;. As we said, the deal is about performance,
but now, we allow the user the possibility to write their code in this corner-case
which is when they reachs &lt;code&gt;Block&lt;/code&gt;. Behaviors depends only on them.&lt;/p&gt;
&lt;h2 id=&quot;apis-in-general&quot;&gt;&lt;a href=&quot;#apis-in-general&quot; aria-label=&quot;apis in general permalink&quot; class=&quot;anchor&quot;&gt;&lt;svg aria-hidden=&quot;true&quot; focusable=&quot;false&quot; height=&quot;16&quot; version=&quot;1.1&quot; viewBox=&quot;0 0 16 16&quot; width=&quot;16&quot;&gt;&lt;path fill-rule=&quot;evenodd&quot; d=&quot;M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z&quot;&gt;&lt;/path&gt;&lt;/svg&gt;&lt;/a&gt;APIs in general&lt;/h2&gt;
&lt;p&gt;The biggest challenge of building a library is defining the API - you must
strike a compromise between allowing the user the flexibility to express their
use-case and constraining the user to avoid API misuse. If at all possible,
provide an &lt;em&gt;intuitive&lt;/em&gt; API: force the user not to need to think about security
issues, memory consumption or performance.&lt;/p&gt;
&lt;p&gt;Avoid making your API so expressive that it becomes unusable, but beware that
this sets hard limits on your users: the current &lt;code&gt;decompress&lt;/code&gt; API can be used to
build &lt;code&gt;of_string&lt;/code&gt; / &lt;code&gt;to_string&lt;/code&gt; functions, but the opposite is not true - you
definitely cannot build a stream API from &lt;code&gt;of_string&lt;/code&gt; / &lt;code&gt;to_string&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;The best advice when designing a library is to keep in mind what you &lt;strong&gt;really&lt;/strong&gt;
want and let the other details fall into place gradually. It is very important
to work in an iterative loop of repeatedly trying to use your library; only this
can highlight bad design, corner-cases and details.&lt;/p&gt;
&lt;p&gt;Finally, use and re-use it on your tests (important!) and inside higher-level
projects to give you interesting questions about your design. The last version
of &lt;code&gt;decompress&lt;/code&gt; was not used in &lt;a href=&quot;https://github.com/mirage/ocaml-git/&quot;&gt;ocaml-git&lt;/a&gt; mostly because the flush
mode was unclear.&lt;/p&gt;</content><id>https://tarides.com/blog/2019-08-26-decompress-the-new-decompress-api.html</id><title type="text">Decompress: The New Decompress API</title><updated>2019-08-26T00:00:00-00:00</updated><author><name>Romain Calascibetta</name></author></entry></feed>